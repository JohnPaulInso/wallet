<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SmartWallet - Calendar</title>
    <link rel="icon" type="image/png" href="applogo.png?v=4">
    <link rel="apple-touch-icon" href="applogo.png?v=4">
    
    <!-- Material UI CSS & Premium Fonts -->
    <link href="https://cdn.muicss.com/mui-0.10.3/css/mui.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="manifest" href="manifest.json?v=1">
    <meta name="theme-color" content="#121212">

    <style>
        * { box-sizing: border-box; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        
        /* Native App Feel - Disable all link behaviors */
        a, a:visited, a:hover, a:active, a:focus {
            text-decoration: none !important;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-drag: none;
        }
        /* Disable text selection highlighting */
        ::selection { background: transparent; }
        ::-moz-selection { background: transparent; }

        html, body { background: #ffffff; margin: 0; padding: 0; min-height: 100vh; display: flex; justify-content: center; font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; touch-action: manipulation; overscroll-behavior-y: contain; }
        
        /* HIDE ALL SCROLLBARS - Native App Feel */
        * { scrollbar-width: none; -ms-overflow-style: none; }
        *::-webkit-scrollbar { display: none; width: 0; height: 0; }
        
        .mobile-wrapper { 
            width: 100%; 
            max-width: 430px; 
            background: #f8fafc; 
            height: 100vh;
            position: relative; 
            box-shadow: 0 0 50px rgba(0,0,0,0.1); 
            display: flex; 
            flex-direction: column; 
            align-items: stretch;
            overflow-x: hidden; 
            overflow-y: auto;
            padding-bottom: 90px;
            overscroll-behavior-y: contain;
        }
        @media (min-width: 431px) { .mobile-wrapper { height: 100vh; overflow-y: auto; } }

        #header { 
            padding: 15px 24px 10px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            background: #fff; 
            position: fixed; 
            top: 0; 
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 430px;
            z-index: 1000; 
            border-bottom: 1px solid rgba(0,0,0,0.02); 
            transition: all 0.3s ease; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); 
        }
        .header-spacer { height: 70px; flex-shrink: 0; }
        #header.shrunk { padding: 12px 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .greeting-section { line-height: 1.2; transition: all 0.3s ease; }
        .greeting-text { font-size: 11px; color: #94a3b8; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; transition: all 0.3s ease; }
        #header.shrunk .greeting-text { font-size: 9px; letter-spacing: 1px; }
        .user-name { font-size: 18px; font-weight: 800; color: #1e293b; transition: all 0.3s ease; }
        #header.shrunk .user-name { font-size: 15px; }
        
        .header-logo { width: 48px; height: 30px; border-radius: 4px; object-fit: cover; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #header.shrunk .header-logo { width: 40px; height: 25px; }
        
        #profile-badge { transition: all 0.3s ease; cursor: pointer; width: 42px; height: 42px; border-radius: 50%; background: #f1f5f9; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #profile-badge img { width: 100%; height: 100%; object-fit: cover; display: none; position: absolute; top: 0; left: 0; }
        #profile-badge i { font-size: 24px; color: #94a3b8; display: block; }
        #profile-badge.has-pic i { opacity: 0; pointer-events: none; }
        #profile-badge.has-pic img { display: block; }

        /* PROFILE DROPDOWN MENU */
        .profile-container { position: relative; }
        .profile-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.12);
            min-width: 200px;
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 2000;
            border: 1px solid #f1f5f9;
            padding: 6px;
        }
        .profile-dropdown.active { display: flex; animation: dropIn 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes dropIn { from { opacity: 0; transform: translateY(-10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .dropdown-item {
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13.5px;
            font-weight: 700;
            color: #475569;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s;
        }
        .dropdown-item:hover { background: #f8fafc; color: #1e293b; }
        .dropdown-item i { font-size: 20px; color: #94a3b8; }
        .dropdown-item.logout { color: #ef4444; margin-top: 4px; border-top: 1px solid #f1f5f9; border-radius: 0 0 10px 10px; }
        .dropdown-item.logout i { color: #ef4444; }
        .dropdown-header { padding: 10px 14px 6px; font-size: 11px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }

        .main-content { padding: 0 24px; width: 100%; }

        /* CALENDAR STYLES */
        .calendar-card { background: #fff; border-radius: 28px; padding: 20px 16px; margin-top: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.06); border: 1px solid #f1f5f9; width: 100%; overflow: hidden; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 8px; }
        .current-month { font-size: 18px; font-weight: 800; color: #1e293b; letter-spacing: -0.3px; }
        .nav-btns { display: flex; gap: 8px; }
        .nav-btn { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); color: #64748b; }
        .nav-btn:hover { background: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; transform: scale(1.05); }
        .nav-btn:active { transform: scale(0.95); }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; width: 100%; }
        .weekday { text-align: center; font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; padding-bottom: 8px; }
        
        .day-cell { 
            min-height: 80px; 
            border-radius: 14px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 6px 2px;
            position: relative; 
            cursor: pointer; 
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); 
            border: 1.5px solid transparent;
            background: #fafbfc;
            overflow: hidden;
        }
        .day-cell:hover { 
            background: #f1f5f9; 
            border-color: #cbd5e1;
            transform: translateY(-2px);
        }
        .day-cell.today { 
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); 
            border-color: #3b82f6;
        }
        .day-cell.selected { 
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); 
            color: #fff; 
            border-color: #1d4ed8;
            box-shadow: 0 6px 15px rgba(37, 99, 235, 0.3);
            z-index: 10;
        }
        .day-cell.other-month { opacity: 0.2; pointer-events: none; background: transparent; }
        .day-num { 
            font-size: 14px; 
            font-weight: 800; 
            margin-bottom: 4px;
            color: #1e293b;
        }
        .day-cell.selected .day-num { color: #fff; }
        
        /* Amount Chips on Calendar */
        .day-amounts { 
            display: flex; 
            flex-direction: column; 
            gap: 2px; 
            width: 100%;
            padding: 0 4px;
        }
        .amount-chip { 
            display: flex; 
            align-items: center; 
            justify-content: center;
            padding: 2px 4px; 
            border-radius: 6px; 
            font-size: 8px; 
            font-weight: 800;
            gap: 2px;
            white-space: nowrap;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .amount-chip.income { 
            background: #dcfce7; 
            color: #16a34a;
            border: none;
        }
        .amount-chip.expense { 
            background: #fee2e2; 
            color: #ef4444;
            border: none;
        }
        .day-cell.selected .amount-chip { 
            background: rgba(255,255,255,0.2); 
            color: #fff;
            border-color: rgba(255,255,255,0.3);
            backdrop-filter: blur(4px);
        }
        .day-cell.selected .amount-chip.expense { color: #fff; }
        .day-cell.selected .amount-chip.income { color: #fff; }
        .amount-chip i { display: none; }

        /* TRANSACTION LIST DESIGN (Same as main index) */
        .day-details { margin-top: 24px; }
        .details-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 0 4px; }
        .details-date { font-size: 15px; font-weight: 800; color: #1e293b; }
        .no-txns { text-align: center; padding: 40px 20px; color: #94a3b8; border: 2px dashed #e2e8f0; border-radius: 20px; font-size: 13px; font-weight: 600; background: #fafbfc; margin-bottom: 12px; }

        .txn-chip { 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            padding: 12px 16px; 
            background: #fff; 
            border-radius: 18px; 
            margin-bottom: 0px; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03); 
            border: 1px solid #f1f5f9;
            transition: all 0.2s ease;
        }
        .txn-chip:active { transform: scale(0.98); }
        
        .txn-chip-icon { 
            width: 48px; 
            height: 48px; 
            border-radius: 14px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            position: relative;
            flex-shrink: 0;
            background: #f8fafc;
        }
        /* CATEGORY COLORS */
        .cat-online { background: #ffedd5 !important; color: #ea580c !important; }
        .cat-shopping { background: #dbeafe !important; color: #1d4ed8 !important; }
        .cat-vehicle { background: #f3e8ff !important; color: #7e22ce !important; }
        .cat-aqua { background: #e0f2fe !important; color: #0369a1 !important; }
        .cat-trading { background: #ecfdf5 !important; color: #059669 !important; }
        .cat-service-magenta { background: #fdf2f8 !important; color: #be185d !important; }
        .cat-food { background: #fef3c7 !important; color: #d97706 !important; }
        .cat-life { background: #f0fdf4 !important; color: #16a34a !important; }
        .cat-financial { background: #fee2e2 !important; color: #dc2626 !important; }
        .cat-education { background: #eff6ff !important; color: #1d4ed8 !important; }
        .cat-income { background: #dcfce7 !important; color: #16a34a !important; }

        .txn-chip-icon i { font-size: 24px; color: inherit; }
        
        .txn-chip-info { flex: 1; display: flex; flex-direction: column; gap: 0.5px; min-width: 0; }
        .txn-chip-name { font-size: 12px; font-weight: 700; color: #1e293b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .txn-chip-meta { font-size: 9.5px; color: #94a3b8; font-weight: 500; display: flex; align-items: center; gap: 4px; }
        .txn-chip-note { font-size: 10px; font-weight: 700; margin-top: 1px; }
        
        .txn-chip-amount-wrapper { text-align: right; flex-shrink: 0; }
        .txn-chip-amount { font-size: 12.5px; font-weight: 700; color: #1e293b; }
        .txn-chip.income .txn-chip-amount { color: #10B981; }
        .txn-chip.expense .txn-chip-amount { color: #ef4444; }
        .txn-chip-status { font-size: 9px; color: #cbd5e1; font-weight: 600; }


        /* SUMMARY PILLS */
        .summary-pills { display: flex; gap: 12px; margin-bottom: 20px; }
        .summary-pill { flex: 1; padding: 14px; border-radius: 18px; display: flex; flex-direction: column; gap: 4px; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .tx-category { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }
        .pill-label { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.8px; }
        .pill-value { font-size: 17px; font-weight: 800; }
        .expense-pill .pill-value { color: #ef4444; }
        .income-pill .pill-value { color: #16a34a; }

        /* MODERN PULL-TO-REFRESH SPINNER */
        .ptr-container { position: absolute; top: 0; left: 0; width: 100%; height: 0; display: flex; justify-content: center; z-index: 100; pointer-events: none; }
        .ptr-spinner { width: 40px; height: 40px; border-radius: 50%; background: #fff; box-shadow: 0 3px 12px rgba(0,0,0,0.15), 0 1px 4px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; transform: translateY(-60px) scale(0.6); opacity: 0; transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s ease; }
        .ptr-spinner.visible { opacity: 1; }
        .ptr-spinner.refreshing { transform: translateY(0) scale(1) !important; opacity: 1; }
        .ptr-spinner svg { width: 24px; height: 24px; transition: transform 0.2s linear; }
        .ptr-spinner.refreshing svg { animation: ptrSpin 0.8s linear infinite; }
        @keyframes ptrSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .ptr-spinner .ptr-circle { fill: none; stroke: #3b82f6; stroke-width: 3; stroke-linecap: round; stroke-dasharray: 60; stroke-dashoffset: 60; transform-origin: center; transition: stroke-dashoffset 0.2s ease; }
        .ptr-spinner.refreshing .ptr-circle { stroke-dashoffset: 15; animation: ptrDash 1.2s ease-in-out infinite; }
        @keyframes ptrDash { 0% { stroke-dashoffset: 55; transform: rotate(0deg); } 50% { stroke-dashoffset: 15; } 100% { stroke-dashoffset: 55; transform: rotate(360deg); } }
        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; height: 75px; background: #fff; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-around; align-items: stretch; padding: 0 10px; z-index: 1000; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: #94a3b8; cursor: pointer; text-decoration: none; transition: all 0.2s; border-radius: 12px; margin: 6px 4px; }
        .nav-item:hover { background: #f1f5f9; color: #1e293b; text-decoration: none !important; }
        .nav-item.active { color: #121212; }
        .nav-item i { font-size: 24px; transition: transform 0.2s; }
        .nav-item:hover i { transform: translateY(-2px); }
        .nav-item span { font-size: 11px; font-weight: 700; }

        /* GUEST GATE OVERLAY */
        .guest-gate-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(18, 18, 18, 0.6); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .guest-gate-card { background: #fff; padding: 32px 24px; border-radius: 28px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); width: 100%; max-width: 340px; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .guest-gate-btn { background: #121212; color: #fff; border: none; padding: 14px 28px; border-radius: 50px; font-weight: 800; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: transform 0.2s; width: 100%; justify-content: center; }
        .guest-gate-btn:active { transform: scale(0.96); }

        /* CUSTOM CONTENT SECTION */
        .custom-section { margin-top: 32px; padding: 24px; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 28px; color: #fff; position: relative; overflow: hidden; box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
        .custom-section::after { content: ''; position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 60%); pointer-events: none; }
        .custom-title { font-size: 18px; font-weight: 800; margin-bottom: 10px; letter-spacing: -0.2px; }
        .custom-desc { font-size: 13px; color: #cbd5e1; line-height: 1.7; }
        .custom-btn { margin-top: 18px; background: #fff; color: #1e293b; border: none; padding: 14px 22px; border-radius: 16px; font-weight: 800; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); }
        .custom-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .custom-btn:active { transform: translateY(0); }


        /* TOAST */
        .toast-container { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 12px 24px; border-radius: 50px; font-size: 14px; font-weight: 600; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); z-index: 2000; display: flex; align-items: center; gap: 8px; opacity: 0; pointer-events: none; transition: all 0.3s; }
        .toast-container.show { opacity: 1; bottom: 110px; pointer-events: auto; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); z-index: 3000; display: none; align-items: center; justify-content: center; animation: fadeIn 0.2s; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: #fff; border-radius: 28px; width: 95%; max-width: 400px; max-height: 85vh; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 24px 64px rgba(0,0,0,0.2); animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-header { padding: 20px 24px 16px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: #fff; z-index: 10; flex-shrink: 0; }
        .modal-title { font-size: 18px; font-weight: 800; color: #1e293b; letter-spacing: -0.2px; }
        .modal-close { width: 32px; height: 32px; border-radius: 50%; background: #f8fafc; border: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); color: #64748b; }
        .modal-close:hover { background: #fee2e2; color: #dc2626; border-color: #fecaca; transform: scale(1.1) rotate(90deg); }
        .modal-close:active { transform: scale(0.95) rotate(90deg); }
        .modal-body { padding: 16px 20px 20px; flex: 1; overflow-y: auto; }
        .modal-category-group { margin-bottom: 20px; }
        .modal-category-header { font-size: 11px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .modal-category-icon { width: 28px; height: 28px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px; background: currentColor; }
        .modal-cat-txns { display: flex; flex-direction: column; gap: 4px; }
        
        .modal-summary { 
            background: #f8fafc; 
            border-top: 1px solid #f1f5f9;
            padding: 20px 24px; 
            position: sticky; 
            bottom: 0;
            z-index: 20;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.05);
        }
        .modal-summary-box {
            background: #fff;
            border-radius: 20px;
            padding: 18px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.02);
        }
        .modal-summary-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .modal-summary-row:last-child { margin-bottom: 0; padding-top: 12px; border-top: 1px solid #f1f5f9; }
        .modal-summary-label { font-size: 11.5px; font-weight: 700; color: #64748b; }
        .modal-summary-value { font-size: 13px; font-weight: 800; }
        .modal-summary-row.total .modal-summary-label { font-size: 13px; color: #1e293b; font-weight: 800; }
        .modal-summary-row.total .modal-summary-value { font-size: 15px; color: #ef4444; font-weight: 800; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(40px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body>

    <div class="mobile-wrapper">
        <!-- GUEST LOGIN GATE -->
        <div id="guestGate" class="guest-gate-overlay">
            <div class="guest-gate-card">
                <div style="width: 64px; height: 64px; border-radius: 20px; background: #f8fafc; display: flex; align-items: center; justify-content: center;">
                    <i class="material-icons" style="font-size: 32px; color: #121212;">lock</i>
                </div>
                <div>
                    <h2 style="font-size: 22px; font-weight: 900; color: #121212; margin: 0 0 10px 0;">Sign in Required</h2>
                    <p style="font-size: 14px; color: #64748b; margin: 0; line-height: 1.6;">To view your spending history and calendar, please sign in with Google first.</p>
                </div>
                <button class="guest-gate-btn" onclick="handleAuthClick()">
                    <svg viewBox="0 0 48 48" width="20px" xmlns="http://www.w3.org/2000/svg"><path d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z" fill="#FFF"/></svg>
                    Continue with Google
                </button>
            </div>
        </div>

        <!-- MODERN PULL-TO-REFRESH SPINNER -->
        <div class="ptr-container" id="ptrContainer">
            <div class="ptr-spinner" id="ptrSpinner">
                <svg viewBox="0 0 24 24">
                    <circle class="ptr-circle" cx="12" cy="12" r="10" />
                </svg>
            </div>
        </div>

        <div id="header">
            <div class="header-logo-box" style="display: flex; align-items: center; gap: 12px;">
                <!-- Dynamic Card Icon -->
                <svg id="header-card-icon" class="header-logo" viewBox="0 0 48 30" xmlns="http://www.w3.org/2000/svg">
                    <!-- Card Background -->
                    <rect width="48" height="30" rx="4" fill="#1a1a1a" id="card-bg"/>
                    
                    <!-- Mastercard Logo (bottom right) -->
                    <g transform="translate(32, 20)">
                        <circle cx="4" cy="4" r="3.5" fill="#eb001b" opacity="0.9"/>
                        <circle cx="8" cy="4" r="3.5" fill="#f79e1b" opacity="0.9"/>
                    </g>
                    
                    <!-- Card Chip (optional detail) -->
                    <rect x="6" y="8" width="8" height="6" rx="1" fill="#d4af37" opacity="0.3"/>
                </svg>
                
                <div class="greeting-section">
                    <div class="greeting-text">Hello,</div>
                    <div class="user-name" id="user-display-name">Guest</div>
                </div>
            </div>
            <div class="profile-container">
            <div id="profile-badge" onclick="toggleProfileDropdown(event)">
                <i class="material-icons">person</i>
                <img id="user-pic" src="" alt="Profile" referrerpolicy="no-referrer">
            </div>
            <div id="profile-dropdown" class="profile-dropdown">
                <div class="dropdown-item" onclick="handleAuthClick()">
                    <i class="material-icons">sync</i>
                    <span>Google Sync</span>
                </div>
                <div class="dropdown-item logout" onclick="handleSignout()">
                    <i class="material-icons">logout</i>
                    <span>Log Out</span>
                </div>
            </div>
        </div>
        </div>
        
        <!-- HEADER SPACER -->
        <div class="header-spacer"></div>

        <div class="main-content" style="padding: 0 24px;">
            <div class="calendar-card">
                <div class="calendar-header">
                    <div class="current-month" id="calendar-title">January 2026</div>
                    <div class="nav-btns">
                        <div class="nav-btn" onclick="changeMonth(-1)"><i class="material-icons">chevron_left</i></div>
                        <div class="nav-btn" onclick="changeMonth(1)"><i class="material-icons">chevron_right</i></div>
                    </div>
                </div>

                <div class="calendar-grid" id="calendar-grid">
                    <div class="weekday">S</div>
                    <div class="weekday">M</div>
                    <div class="weekday">T</div>
                    <div class="weekday">W</div>
                    <div class="weekday">T</div>
                    <div class="weekday">F</div>
                    <div class="weekday">S</div>
                    <!-- Days injected here -->
                </div>
            </div>



            <div class="custom-section">
                <div class="custom-title">Financial Insights</div>
                <div class="custom-desc">Your daily spending patterns are visualized above. Green chips denote income, while red chips reflect expenses for specifically that date.</div>
                <button class="custom-btn">
                    <span>Analyze Monthly Plan</span>
                    <i class="material-icons" style="font-size: 18px;">arrow_forward</i>
                </button>
            </div>
        </div>

        <!-- BOTTOM NAV -->
        <div class="bottom-nav">
            <a href="javascript:void(0)" class="nav-item" onclick="window.location.href='index.html'; return false;" oncontextmenu="return false;" draggable="false">
                <i class="material-icons">account_balance_wallet</i>
                <span>Wallet</span>
            </a>
            <a href="#" class="nav-item active" onclick="return false;" oncontextmenu="return false;" draggable="false">
                <i class="material-icons">calendar_today</i>
                <span>Calendar</span>
            </a>
            <a href="javascript:void(0)" class="nav-item" onclick="window.location.href='accounts.html'; return false;" oncontextmenu="return false;" draggable="false">
                <i class="material-icons">account_balance</i>
                <span>Accounts</span>
            </a>
            <a href="javascript:void(0)" class="nav-item" onclick="window.location.href='goals.html'; return false;" oncontextmenu="return false;" draggable="false">
                <i class="material-icons">track_changes</i>
                <span>Goals</span>
            </a>
        </div>
    </div>

    <div id="toast-box" class="toast-container">
        <i class="material-icons">check_circle</i>
        <span id="toast-msg"></span>
    </div>

    <!-- MODAL -->
    <div id="txn-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-date-title">Transactions</div>
                <div class="modal-close" onclick="closeModal()">
                    <i class="material-icons" style="font-size: 18px;">close</i>
                </div>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Transaction details will be injected here -->
            </div>
            <div id="modal-footer-summary"></div>
        </div>
    </div>

    <script src="nav-state.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBHDN0xLi98qjYYjUf2RDCn5gJK0dzTk_M",
            authDomain: "atome-wallet.firebaseapp.com",
            projectId: "atome-wallet",
            storageBucket: "atome-wallet.firebasestorage.app",
            messagingSenderId: "64186651619",
            appId: "1:64186651619:web:cd7d426cfb663aab6606d6"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.getCollectionName = (accId) => {
            if (accId === 'atome') return "transactions";
            if (accId === 'bpi') return "bpi_transactions";
            return `txns_${accId}`;
        };

        const CATEGORIES = [
            { id: 'Online shopping', icon: 'shopping_bag', label: 'Online Shopping', cls: 'cat-online' },
            { id: 'Shopping', icon: 'shopping_cart', label: 'Shopping', cls: 'cat-shopping' },
            { id: 'Vehicle', icon: 'local_gas_station', label: 'Vehicle', cls: 'cat-vehicle' },
            { id: 'Food & Drinks', icon: 'restaurant', label: 'Food & Drinks', cls: 'cat-food' },
            { id: 'Service', icon: 'settings_cell', label: 'Service', cls: 'cat-service-magenta' },
            { id: 'Trade Copier', icon: 'hub', label: 'Trade Copier', cls: 'cat-aqua' },
            { id: 'Trading Expenses', icon: 'insights', label: 'Trading Expenses', cls: 'cat-trading' },
            { id: 'Life & Entertainment', icon: 'confirmation_number', label: 'Life & Ent.', cls: 'cat-life' },
            { id: 'Financial Expenses', icon: 'payments', label: 'Financial Expenses', cls: 'cat-financial' },
            { id: 'Transportation', icon: 'directions_bus', label: 'Transportation', cls: 'cat-vehicle' },
            { id: 'Travel', icon: 'flight', label: 'Travel', cls: 'cat-aqua' },
            { id: 'Education', icon: 'school', label: 'Education', cls: 'cat-education' },
            { id: 'Sport', icon: 'fitness_center', label: 'Sport', cls: 'cat-life' },
            { id: 'Income', icon: 'savings', label: 'Income', cls: 'cat-income' }
        ];

        function displayCategoryName(id) {
            const cat = CATEGORIES.find(c => c.id === id);
            return cat ? cat.label : id;
        }

        function getMerchantDisplay(name = '', t = {}) {
            let raw = name.toUpperCase();
            let cleaned = name.replace(/\s+PHL$/i, '').replace(/\s+CEBU\s+CITY\s+PHL$/i, '').replace(/\s+CEBU\s+CITY$/i, '').replace(/\s+DUBAI\s+ARE$/i, '').replace(/\s+LONDON\s+GBR$/i, '').replace(/\s+PH\s+PHL$/i, '').replace(/\s+PH$/i, '').trim();
            if (cleaned.toUpperCase().includes('GADC') || cleaned.toUpperCase().includes('MCDONALDS') || cleaned.toUpperCase().includes('MCDO')) {
                let u = cleaned.toUpperCase();
                if (u.includes('SOUTHCBU') || u.includes('325CLN')) cleaned = 'MCDONALDS SOUTH CEBU';
                else { cleaned = cleaned.replace(/(GADC|MCDONALDS|MCDO)/i, 'MCDONALDS').trim(); cleaned = cleaned.replace(/MCDONALDS\s+\d+[A-Z]*/i, 'MCDONALDS').trim(); }
            }
            if (cleaned.toUpperCase().includes('JOLLIBEE')) cleaned = cleaned.replace(/JB\d+\s+\w+/i, '').trim();
            if (cleaned.toUpperCase().includes('RIBSHACK')) cleaned = cleaned.replace(/PH\d+/i, '').trim();
            if (cleaned.toUpperCase().includes('SHOPEE')) cleaned = 'SHOPEE PH';
            if (cleaned.toUpperCase().includes('TRADERSCONNECT')) cleaned = 'TRADERS CONNECT';
            if (cleaned.toUpperCase().includes('TIKTOK SHOP')) cleaned = 'TIKTOK SHOP';
            if (cleaned.toUpperCase().includes('SPOTIFY')) cleaned = 'SPOTIFY';
            let display = { name: cleaned, category: 'Financial expenses', icon: 'payments', catClass: 'cat-financial' };
            if (t.manualCategory) {
                const userCat = CATEGORIES.find(c => c.id === t.manualCategory);
                if (userCat) {
                    display.category = userCat.id;
                    display.icon = userCat.icon;
                    const catMap = { 'Online shopping': 'cat-online', 'Shopping': 'cat-shopping', 'Vehicle': 'cat-vehicle', 'Trade Copier': 'cat-aqua', 'Trading Expenses': 'cat-trading', 'Service': 'cat-service-magenta', 'Food & Drinks': 'cat-food', 'Life & Entertainment': 'cat-life', 'Financial Expenses': 'cat-financial', 'Transportation': 'cat-vehicle', 'Travel': 'cat-aqua', 'Education': 'cat-education', 'Sport': 'cat-life', 'Income': 'cat-income' };
                    display.catClass = userCat.cls || catMap[userCat.id] || 'cat-financial';
                    return display;
                }
            }
            const mapping = { 'MR DIY BGCC BOGO': 'MR DIY BOGO', 'MR DIY ZBOG BOGO': 'MR DIY BOGO', 'TEC FUEL SAN REMIGIO': 'TECFUEL SAN REMIGIO', 'J AND L SHOPPING BOGO': 'J AND L MALL BOGO', 'TECFUEL BOGO CEBU': 'TECFUEL BOGO', 'KKV SM J Mall Cebu': 'KKV SM J MALL CEBU', 'SM STORE-CEBU': 'SM STORE - CEBU CITY', 'GLOBE-BILLSPAY PH': 'GLOBE / GOMO LOAD', 'SHELL FILLWISE BOGO CEBU': 'SHELL BOGO CEBU', 'GLOBE WEBLOADING EC PH': 'GLOBE / GOMO LOAD', 'WATSONS HISOLER BLDG B': 'WATSONS HISOLER BLDG BOGO', 'SUPER METRO S/M-BOGO': 'SUPER METRO BOGO', 'SM SUPERMARKET SM SRP CEBU': 'SM SUPERMARKET SRP', 'OCTAGON AYALA CENTRAL CEBU': 'OCTAGON AYALA CENTRAL CEBU', 'STARBUCKS 540 CENTRAL CEBU CITY': 'STARBUCKS 540 CENTRAL CEBU CITY', 'ICE SKATING SM SRP CEB': 'ICE SKATING SM SRP CEBU', 'TAP SURE LEVERAGE FUND': 'TAP SURE LEVERAGE FUND', 'MRCRMT': 'MRCRMT', 'tradersconnect.com': 'TRADERS CONNECT', 'TRADERSCONNECT': 'TRADERS CONNECT' };
            const finalRaw = cleaned.toUpperCase();
            if (mapping[cleaned]) display.name = mapping[cleaned];
            else if (mapping[finalRaw]) display.name = mapping[finalRaw];
            if (finalRaw.includes('SHOPEE') || finalRaw.includes('TIKTOK') || finalRaw.includes('LAZADA') || finalRaw.includes('SHEIN') || finalRaw.includes('TEMU') || finalRaw.includes('SHOPIFY')) { display.category = 'Online shopping'; display.icon = 'shopping_bag'; }
            else if (finalRaw.includes('JOLLIBEE') || finalRaw.includes('MCDO') || finalRaw.includes('7 11') || finalRaw.includes('7/11') || finalRaw.includes('KFC') || finalRaw.includes('STARBUCKS') || finalRaw.includes('RIBSHACK')) { display.category = 'Food & Drinks'; display.icon = 'restaurant'; }
            else if (finalRaw.includes('SHELL') || finalRaw.includes('PETRON') || finalRaw.includes('CALTEX') || finalRaw.includes('TECFUEL') || finalRaw.includes('FUEL') || finalRaw.includes('SEAOIL')) { display.category = 'Vehicle'; display.icon = 'local_gas_station'; }
            else if (finalRaw.includes('TRADERS CONNECT') || finalRaw.includes('IC MARKETS') || finalRaw.includes('EXNESS') || finalRaw.includes('TRADERSCONNECT')) { display.category = 'Trading Expenses'; display.icon = 'insights'; }
            const catMap = { 'Online shopping': 'cat-online', 'Shopping': 'cat-shopping', 'Vehicle': 'cat-vehicle', 'Trade Copier': 'cat-aqua', 'Trading Expenses': 'cat-trading', 'Service': 'cat-service-magenta', 'Food & Drinks': 'cat-food', 'Life & Entertainment': 'cat-life', 'Financial Expenses': 'cat-financial', 'Transportation': 'cat-vehicle', 'Travel': 'cat-aqua', 'Education': 'cat-education', 'Sport': 'cat-life', 'Income': 'cat-income' };
            display.catClass = catMap[display.category] || 'cat-financial';
            return display;
        }


        const currentAccount = localStorage.getItem('wallet_current_account') || 'atome';
        let currentViewDate = new Date();
        let selectedDate = new Date();
        window.allTxns = [];
        
        // Initialize NavState features
        if (window.NavState) {
            window.NavState.loadProfile();
            window.NavState.loadCardColor();
        }
        
        // Apply Header Theme from Current Account
        function applyAccountTheme(accId) {
            const cardBg = document.getElementById('card-bg');
            if (cardBg) {
                const accounts = JSON.parse(localStorage.getItem('wallet_accounts') || '[]');
                const acc = accounts.find(a => a.id === accId);
                if (acc) {
                    cardBg.setAttribute('fill', acc.color);
                } else {
                    // Fallback
                    if (accId === 'bpi') cardBg.setAttribute('fill', '#931B1B');
                    else if (accId === 'atome') cardBg.setAttribute('fill', '#121212');
                    else cardBg.setAttribute('fill', '#1a1a1a');
                }
            }
        }
        applyAccountTheme(currentAccount);

        // FAST PATH: Early rendering from cache to achieve "instant" load
        const lastUid = localStorage.getItem('wallet_last_uid');
        if (lastUid) {
            console.log('âš¡ Fast Path: Rendering Calendar from cache...');
            loadData(lastUid); 
        }

        onAuthStateChanged(auth, (user) => {
            const isAnon = !user || user.isAnonymous;
            const gate = document.getElementById('guestGate');
            if (gate) gate.style.display = isAnon ? 'flex' : 'none';

            if (user) {
                // Save UID for future instant loads
                localStorage.setItem('wallet_last_uid', user.uid);
                
                if (!user.isAnonymous) {
                    // Update Cache
                    localStorage.setItem('user_name', user.displayName || 'User');
                    localStorage.setItem('user_pic', user.photoURL || '');
                }
                if (window.NavState) {
                    window.NavState.loadProfile();
                } else {
                    updateProfileUI(user);
                }
                loadData(user.uid);
            } else {
                updateProfileUI({ isAnonymous: true });
                renderCalendar();
            }
        });

        function updateProfileUI(user) {
            const dropdown = document.getElementById('profile-dropdown');
            if (!dropdown) return;
            
            if (user.isAnonymous) {
                 dropdown.innerHTML = `
                    <div class="dropdown-header">Guest Session</div>
                    <div class="dropdown-item" onclick="toggleDarkMode()">
                        <i class="material-icons" id="theme-icon">dark_mode</i>
                        <span id="theme-text">Dark Mode</span>
                    </div>
                    <div class="dropdown-item" onclick="handleAuthClick()">
                        <i class="material-icons">cloud_upload</i>
                        <span>Sign in with Google</span>
                    </div>
                 `;
                 document.getElementById('user-display-name').innerText = 'Guest';
                 document.getElementById('profile-badge').classList.remove('has-pic');
            } else {
                 dropdown.innerHTML = `
                    <div class="dropdown-header">${user.email || 'User'}</div>
                    <div class="dropdown-item" onclick="toggleDarkMode()">
                        <i class="material-icons" id="theme-icon">dark_mode</i>
                        <span id="theme-text">Dark Mode</span>
                    </div>
                    <div class="dropdown-item" onclick="handleAuthClick()">
                        <i class="material-icons">swap_horiz</i>
                        <span>Switch Account</span>
                    </div>
                     <div class="dropdown-item logout" onclick="handleSignout()">
                        <i class="material-icons">logout</i>
                        <span>Log Out</span>
                    </div>
                 `;
                 
                  // Only update if not handled by NavState
                  if (!window.NavState) {
                      const name = localStorage.getItem('user_name') || 'User';
                      const parts = name.trim().split(/\s+/);
                      const displayName = parts.length >= 2 ? `${parts[0]} ${parts[1]}` : parts[0];
                      document.getElementById('user-display-name').innerText = displayName;
                  }
                 
                 const pic = localStorage.getItem('user_pic');
                 if (pic) {
                     const picEl = document.getElementById('user-pic');
                     const badge = document.getElementById('profile-badge');
                     picEl.src = pic;
                     badge.classList.add('has-pic');
                 }
            }
            
            // Sync theme UI
            const currentTheme = localStorage.getItem('theme_preference') || 'light';
            const icon = document.getElementById('theme-icon');
            const text = document.getElementById('theme-text');
            if (icon) icon.innerText = currentTheme === 'light' ? 'dark_mode' : 'light_mode';
            if (text) text.innerText = currentTheme === 'light' ? 'Dark Mode' : 'Light Mode';
            if (currentTheme === 'dark') document.body.classList.add('dark-mode');
        }

        // DARK MODE TOGGLE
        window.toggleDarkMode = () => {
            const currentTheme = localStorage.getItem('theme_preference') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme_preference', newTheme);
            
            if (newTheme === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            
            const icon = document.getElementById('theme-icon');
            const text = document.getElementById('theme-text');
            if (icon) icon.innerText = newTheme === 'light' ? 'dark_mode' : 'light_mode';
            if (text) text.innerText = newTheme === 'light' ? 'Dark Mode' : 'Light Mode';
        };

        // PROFILE DROPDOWN LOGIC
        window.toggleProfileDropdown = (e) => {
            e.stopPropagation();
            const dropdown = document.getElementById('profile-dropdown');
            dropdown.classList.toggle('active');
        };

        window.addEventListener('click', (e) => {
            const dropdown = document.getElementById('profile-dropdown');
            if (dropdown && dropdown.classList.contains('active')) {
                const badge = document.getElementById('profile-badge');
                if (!badge.contains(e.target)) {
                    dropdown.classList.remove('active');
                }
            }
        });

        window.handleAuthClick = async () => {
            const provider = new GoogleAuthProvider();
            provider.addScope('https://www.googleapis.com/auth/gmail.readonly');
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('Auth Failure:', error);
            }
        };

        window.handleSignout = async () => {
            if (confirm('Sign out?')) {
                try {
                    await auth.signOut();
                    window.location.reload();
                } catch (e) {
                    console.error('Sign out error:', e);
                }
            }
        };

        // Header Shrink Logic
        const header = document.getElementById('header');
        const scrollContainer = document.querySelector('.mobile-wrapper');
        const handleScroll = (container) => {
            if (container.scrollTop > 50) header.classList.add('shrunk');
            else header.classList.remove('shrunk');
        };
        if (scrollContainer) scrollContainer.addEventListener('scroll', () => handleScroll(scrollContainer));
        window.addEventListener('scroll', () => handleScroll(window.document.documentElement));

        function loadData(providedUid = null) {
            const currentAcc = localStorage.getItem('wallet_current_account') || 'atome';
            applyAccountTheme(currentAcc);
            
            const uid = providedUid || auth.currentUser?.uid;
            if (!uid) return;

            const cacheKey = `wallet_cache_${uid}_${currentAcc}`;
            
            // 1. Instant Cache Load
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                try {
                    const data = JSON.parse(cached);
                    if (data.txns) {
                        window.allTxns = data.txns || [];
                        renderCalendar();
                    }
                } catch(e) {}
            }

            const collectionName = window.getCollectionName(currentAcc);
            const q = query(collection(db, "users", uid, collectionName), orderBy("date", "desc"));
            
            onSnapshot(q, (snap) => {
                const txns = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(t => !t.deleted);
                
                // Compare with current to avoid redundant render
                const isSame = window.allTxns && window.allTxns.length === txns.length && 
                               txns.slice(0, 5).every((t, i) => 
                                   window.allTxns[i] && window.allTxns[i].id === t.id
                               );

                if (isSame) return;

                window.allTxns = txns;
                
                // Update Cache
                localStorage.setItem(cacheKey, JSON.stringify({
                    txns: txns,
                    timestamp: Date.now()
                }));
                
                renderCalendar();
            });
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const title = document.getElementById('calendar-title');
            
            if (!grid || !title) return;
            
            // Clear existing days
            const dayCells = grid.querySelectorAll('.day-cell');
            dayCells.forEach(d => d.remove());

            const year = currentViewDate.getFullYear();
            const month = currentViewDate.getMonth();
            title.innerText = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(currentViewDate);

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            // Previous month padding
            for (let i = firstDay - 1; i >= 0; i--) {
                const cell = document.createElement('div');
                cell.className = 'day-cell other-month';
                cell.innerHTML = `<span class="day-num">${daysInPrevMonth - i}</span>`;
                grid.appendChild(cell);
            }

            // Current month days
            const today = new Date();
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const cellDate = new Date(year, month, d);
                
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                if (today.toDateString() === cellDate.toDateString()) cell.classList.add('today');
                if (selectedDate && selectedDate.toDateString() === cellDate.toDateString()) cell.classList.add('selected');

                const robustParse = (val) => {
                    if (typeof val === 'number') return val;
                    if (typeof val === 'string') return parseFloat(val.replace(/,/g, '')) || 0;
                    return 0;
                };

                // Calculate totals for this day
                const dayTxns = window.allTxns.filter(t => {
                    if (!t.date) return false;
                    const tDate = String(t.date).includes('T') ? String(t.date).split('T')[0] : String(t.date);
                    return tDate === dateStr && !t.refund;
                });
                
                let totalExpenses = 0;
                let totalIncome = 0;
                
                try {
                    dayTxns.forEach(t => {
                        const mapped = getMerchantDisplay(t.merchant, t);
                        const amt = t.manualAmount !== undefined ? robustParse(t.manualAmount) : (robustParse(t.amount) || 0);
                        
                        // Rule: Expenses only count for calendar total if NOT excluded.
                        if (mapped.category === 'Income') {
                            totalIncome += amt;
                        } else {
                            if (!t.excluded) totalExpenses += amt;
                        }
                    });
                } catch (error) {}

                // Build amount chips
                let amountChipsHTML = '<div class="day-amounts">';
                if (totalExpenses > 0) {
                    const formattedExpense = totalExpenses >= 1000 
                        ? `-${(totalExpenses / 1000).toFixed(1)}k` 
                        : `-${Math.round(totalExpenses)}`;
                    amountChipsHTML += `<div class="amount-chip expense">${formattedExpense}</div>`;
                }
                if (totalIncome > 0) {
                    const formattedIncome = totalIncome >= 1000 
                        ? `+${(totalIncome / 1000).toFixed(1)}k` 
                        : `+${Math.round(totalIncome)}`;
                    amountChipsHTML += `<div class="amount-chip income">${formattedIncome}</div>`;
                }
                amountChipsHTML += '</div>';

                cell.innerHTML = `<span class="day-num">${d}</span>${amountChipsHTML}`;
                cell.onclick = () => {
                    selectedDate = new Date(year, month, d);
                    renderCalendar();
                    openModal(selectedDate);
                };
                grid.appendChild(cell);
            }
        }




        window.changeMonth = (delta) => {
            currentViewDate.setMonth(currentViewDate.getMonth() + delta);
            renderCalendar();
        };



        function createTxnChip(t, mapped, amt, type) {
            const chip = document.createElement('div');
            chip.className = `txn-chip ${type}`;
            const isIncome = mapped.category === 'Income';
            if (t.excluded && !isIncome) chip.style.opacity = '0.5';
            
            const name = type === 'income' ? 'INCOME' : (mapped.name || 'Unknown');
            const category = displayCategoryName(mapped.category);
            const dateStr = new Date(t.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            
            // Note color based on category
            const noteColor = type === 'income' ? '#16a34a' : (mapped.catClass === 'cat-online' ? '#ea580c' : 
                              mapped.catClass === 'cat-shopping' ? '#1d4ed8' : 
                              mapped.catClass === 'cat-vehicle' ? '#7e22ce' : 
                              mapped.catClass === 'cat-aqua' ? '#0369a1' : 
                              mapped.catClass === 'cat-trading' ? '#059669' : 
                              mapped.catClass === 'cat-service-magenta' ? '#be185d' : 
                              mapped.catClass === 'cat-food' ? '#d97706' : 
                              mapped.catClass === 'cat-life' ? '#16a34a' : 
                              mapped.catClass === 'cat-financial' ? '#dc2626' : 
                              mapped.catClass === 'cat-education' ? '#1d4ed8' : '#1e293b');

            // LOGO DETECTION (Same as index)
            const mUpper = name.toUpperCase();
            let logo = null;
            if (mUpper.includes('JOLLIBEE')) logo = 'logos/jollibee.png';
            else if (mUpper.includes('MCDO') || mUpper.includes('MCDONALDS')) logo = 'logos/mcdo.png';
            else if (mUpper.includes('SHELL')) logo = 'logos/shell.png';
            else if (mUpper.includes('SHOPEE')) logo = 'logos/shopee.png';
            else if (mUpper.includes('LAZADA')) logo = 'logos/lazada.jpg';
            else if (mUpper.includes('GLOBE') || mUpper.includes('GOMO')) logo = 'logos/globe.png';
            else if (mUpper.includes('SM') || mUpper.includes('SM STORE') || mUpper.includes('SM SUPERMARKET')) logo = 'logos/sm.png';
            else if (mUpper.includes('SPOTIFY')) logo = 'logos/spotify.png';
            else if (mUpper.includes('TIKTOK')) logo = 'logos/tiktokshop.png';
            else if (mUpper.includes('TECFUEL') || mUpper.includes('TEC FUEL')) logo = 'logos/tecfuel.png';
            else if (mUpper.includes('TRADERS')) logo = 'logos/tradersconnect.png';
            else if (mUpper.includes('7/11') || mUpper.includes('7 11')) logo = 'logos/711.png';
            else if (mUpper.includes('AYALA')) logo = 'logos/ayala.png';
            else if (mUpper.includes('J AND LMall') || mUpper.includes('JANL')) logo = 'logos/jandlmall.png'; // Fix typo in check
            else if (mUpper.includes('MR DIY') || mUpper.includes('MR.DIY')) logo = 'logos/mrdiy.png';
            else if (mUpper.includes('WATSONS')) logo = 'logos/watsons.png';
            else if (mUpper.includes('METRO') || mUpper.includes('SUPERMETRO')) logo = 'logos/supermetro.png';
            else if (mUpper.includes('SEAOIL')) logo = 'logos/seaoil.png';
            else if (mUpper.includes('PETRON')) logo = 'logos/petron.png';

            const logoHTML = logo ? `
                <div style="position: absolute; bottom: -4px; right: -4px; width: 22px; height: 22px; background: white; border-radius: 50%; padding: 2px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; z-index: 2; border: 1.5px solid #fff;">
                    <img src="${logo}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 50%;">
                </div>` : '';

            chip.innerHTML = `
                <div class="txn-chip-icon ${mapped.catClass || ''}">
                    <i class="material-icons">${mapped.icon}</i>
                    ${logoHTML}
                </div>
                <div class="txn-chip-info">
                    <span class="txn-chip-name">${name}</span>
                    <div class="txn-chip-meta">
                        <span>${dateStr}</span>
                        <span>â€¢</span>
                        <span>${category}</span>
                    </div>
                    ${t.note ? `<div class="txn-chip-note" style="color: ${noteColor}">${t.note}</div>` : ''}
                </div>
                <div class="txn-chip-amount-wrapper">
                    <div class="txn-chip-amount">${type === 'expense' ? '-' : '+'} â‚±${amt.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
                    <div class="txn-chip-status">Atome Card</div>
                </div>
            `;
            return chip;
        }

        // MODAL FUNCTIONS
        window.openModal = (date) => {
            const modal = document.getElementById('txn-modal');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer-summary');
            const modalTitle = document.getElementById('modal-date-title');
            
            // Clear modal immediately to prevent stale data
            modalBody.innerHTML = '';
            modalFooter.innerHTML = '';
            
            const options = { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' };
            modalTitle.innerText = date.toLocaleDateString('en-US', options);
            
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const dStr = String(date.getDate()).padStart(2, '0');
            const dateStr = `${y}-${m}-${dStr}`;
            
            // Fix: Use robust normalization to match renderCalendar precisely
            const dayTxns = window.allTxns.filter(t => {
                if (!t.date) return false;
                const tDate = String(t.date).includes('T') ? String(t.date).split('T')[0] : String(t.date);
                return tDate === dateStr && !t.refund;
            });
            
            if (dayTxns.length === 0) {
                modalBody.innerHTML = `<div class="no-txns">No transactions recorded for this day.</div>`;
                modal.classList.add('show');
                return;
            }
            
            // Group transactions by category
            const categoryGroups = {};
            let totalExpenses = 0;
            let totalIncome = 0;
            
            const robustParse = (val) => {
                if (typeof val === 'number') return val;
                if (typeof val === 'string') return parseFloat(val.replace(/,/g, '')) || 0;
                return 0;
            };

            dayTxns.forEach(t => {
                const mapped = getMerchantDisplay(t.merchant, t);
                const amt = t.manualAmount !== undefined ? robustParse(t.manualAmount) : (robustParse(t.amount) || 0);
                const category = mapped.category;
                const isIncome = category === 'Income';
                
                if (!categoryGroups[category]) {
                    categoryGroups[category] = {
                        icon: mapped.icon,
                        transactions: [],
                        isIncome: isIncome,
                        id: category
                    };
                }
                
                categoryGroups[category].transactions.push(t);
                
                if (isIncome) totalIncome += amt;
                else {
                    // Only add to expense total if NOT excluded
                    if (!t.excluded) totalExpenses += amt;
                }
            });
            
            // Render modal content
            let html = '';
            const sortedCategoryIds = Object.keys(categoryGroups).sort((a, b) => {
                if (a === 'Income') return 1;
                if (b === 'Income') return -1;
                return 0;
            });
            
            sortedCategoryIds.forEach(catId => {
                const group = categoryGroups[catId];
                const catInfo = CATEGORIES.find(c => c.id === catId) || { label: catId, icon: group.icon, cls: 'cat-financial' };
                
                // Get header colors based on category
                let headerStyle = '';
                if (group.isIncome) {
                    headerStyle = 'background: #dcfce7; color: #16a34a;';
                } else {
                    const colorMap = {
                        'cat-online': 'background: #ffedd5; color: #ea580c;',
                        'cat-shopping': 'background: #dbeafe; color: #1d4ed8;',
                        'cat-vehicle': 'background: #f3e8ff; color: #7e22ce;',
                        'cat-aqua': 'background: #e0f2fe; color: #0369a1;',
                        'cat-trading': 'background: #ecfdf5; color: #059669;',
                        'cat-service-magenta': 'background: #fdf2f8; color: #be185d;',
                        'cat-food': 'background: #fef3c7; color: #d97706;',
                        'cat-life': 'background: #f0fdf4; color: #16a34a;',
                        'cat-financial': 'background: #fee2e2; color: #dc2626;',
                        'cat-education': 'background: #eff6ff; color: #1d4ed8;'
                    };
                    headerStyle = colorMap[catInfo.cls] || 'background: #fee2e2; color: #ef4444;';
                }

                html += `
                    <div class="modal-category-group" data-cat="${catId}">
                        <div class="modal-category-header">
                            <div class="modal-category-icon" style="${headerStyle}">
                                <i class="material-icons" style="font-size: 14px;">${group.icon}</i>
                            </div>
                            <span>${catInfo.label}</span>
                        </div>
                        <div class="modal-cat-txns"></div>
                    </div>
                `;
            });
            
            modalBody.innerHTML = html;
            
            // Add summary to footer
            const netAmount = totalIncome - totalExpenses;
            modalFooter.innerHTML = `
                <div class="modal-summary">
                    <div class="modal-summary-box">
                        <div class="modal-summary-row">
                            <div class="modal-summary-label">Total Expenses</div>
                            <div class="modal-summary-value" style="color: #ef4444;">- â‚±${totalExpenses.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
                        </div>
                        <div class="modal-summary-row">
                            <div class="modal-summary-label">Total Income</div>
                            <div class="modal-summary-value" style="color: #16a34a;">+ â‚±${totalIncome.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
                        </div>
                        <div class="modal-summary-row total">
                            <div class="modal-summary-label">Net Balance</div>
                            <div class="modal-summary-value" style="color: ${netAmount >= 0 ? '#16a34a' : '#ef4444'};">${netAmount >= 0 ? '+' : ''} â‚±${netAmount.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
                        </div>
                    </div>
                </div>
            `;
            
            modalBody.innerHTML = html;
            
            // Inject transaction chips into categories
            sortedCategoryIds.forEach(catId => {
                const group = categoryGroups[catId];
                const groupDiv = modalBody.querySelector(`.modal-category-group[data-cat="${catId}"]`);
                const listDiv = groupDiv.querySelector('.modal-cat-txns');
                
                group.transactions.forEach(t => {
                    const mapped = getMerchantDisplay(t.merchant, t);
                    const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                    const type = mapped.category === 'Income' ? 'income' : 'expense';
                    listDiv.appendChild(createTxnChip(t, mapped, amt, type));
                });
            });

            modal.classList.add('show');
            if (window.NavState) window.NavState.pushModalState('txn-modal', () => modal.classList.remove('show'));
        };

        window.closeModal = () => {
            const modal = document.getElementById('txn-modal');
            modal.classList.remove('show');
            if (window.NavState) window.NavState.popModalState('txn-modal');
        };

        // Close modal when clicking outside
        document.getElementById('txn-modal').addEventListener('click', (e) => {
            if (e.target.id === 'txn-modal') {
                closeModal();
            }
        });

        // INITIALIZE
        renderCalendar();

        // NavState Init
        if (window.NavState) {
            window.NavState.quickInit('calendar.html', () => {
                // Initial load
            });
        }

    </script>
    <script>
        // MODERN MATERIAL DESIGN PULL-TO-REFRESH
        (function() {
            const spinner = document.getElementById('ptrSpinner');
            const circle = spinner ? spinner.querySelector('.ptr-circle') : null;
            const mobileWrapper = document.querySelector('.mobile-wrapper') || document.body;
            let startY = 0;
            let pulling = false;
            let isRefreshing = false;
            const pullThreshold = 100; // Distance needed to trigger refresh
            const maxPull = 140; // Maximum pull distance
            
            if (!spinner || !circle) return;
            
            mobileWrapper.addEventListener('touchstart', (e) => {
                if (isRefreshing) return;
                if (mobileWrapper.scrollTop <= 0) {
                    startY = e.touches[0].clientY;
                    pulling = true;
                }
            }, { passive: true });
            
            mobileWrapper.addEventListener('touchmove', (e) => {
                if (!pulling || isRefreshing || mobileWrapper.scrollTop > 0) return;
                
                const currentY = e.touches[0].clientY;
                const pullDistance = Math.max(0, currentY - startY);
                
                if (pullDistance > 10) {
                    e.preventDefault();
                    
                    // Calculate progress with resistance (diminishing returns)
                    const resistance = 0.5;
                    const resistedPull = Math.min(pullDistance * resistance, maxPull);
                    const progress = Math.min(pullDistance / pullThreshold, 1);
                    
                    // Show spinner dropping down
                    spinner.classList.add('visible');
                    spinner.style.transform = `translateY(${resistedPull - 60}px) scale(${0.6 + progress * 0.4}) rotate(${pullDistance * 2}deg)`;
                    
                    // Animate the SVG circle stroke
                    const dashOffset = 60 - (progress * 45); // Fill from 0 to ~75%
                    circle.style.strokeDashoffset = dashOffset;
                    circle.style.transform = `rotate(${pullDistance * 3}deg)`;
                }
            }, { passive: false });
            
            mobileWrapper.addEventListener('touchend', () => {
                if (!pulling || isRefreshing) return;
                pulling = false;
                
                const currentTransform = spinner.style.transform;
                const yMatch = currentTransform.match(/translateY\(([^p]+)px\)/);
                const currentY = yMatch ? parseFloat(yMatch[1]) : -80;
                
                if (currentY > 30) {
                    // Trigger refresh!
                    isRefreshing = true;
                    
                    // Haptic feedback
                    if (navigator.vibrate) navigator.vibrate([10, 30, 10]);
                    
                    // Animate to refreshing state
                    spinner.classList.add('refreshing');
                    circle.style.strokeDashoffset = '';
                    circle.style.transform = '';
                    
                    // Trigger sync
                    console.log('ðŸ”„ Pull-to-refresh: Syncing calendar');
                    
                    // Force a fresh fetch from Firestore
                    const uid = localStorage.getItem('wallet_last_uid');
                    if (typeof loadData === 'function' && uid) {
                        loadData(uid);
                    } else {
                        window.location.reload();
                    }
                    
                    // Hide after delay
                    setTimeout(() => {
                        spinner.classList.remove('refreshing', 'visible');
                        spinner.style.transform = '';
                        circle.style.strokeDashoffset = '60';
                        isRefreshing = false;
                    }, 1800);
                } else {
                    // Cancel - spring back
                    spinner.classList.remove('visible');
                    spinner.style.transform = '';
                    circle.style.strokeDashoffset = '60';
                    circle.style.transform = '';
                }
            });
        })();
    </script>
    </div> <!-- Close mobile-wrapper -->
</body>
</html>
