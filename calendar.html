<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SmartWallet - Calendar</title>
    <link rel="icon" type="image/png" href="applogo.png?v=3">
    <link rel="apple-touch-icon" href="applogo.png">
    
    <!-- Material UI CSS & Premium Fonts -->
    <link href="https://cdn.muicss.com/mui-0.10.3/css/mui.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1d4ed8">

    <style>
        * { box-sizing: border-box; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; touch-action: manipulation; }
        html, body { background: #f0f2f5; margin: 0; padding: 0; min-height: 100vh; display: flex; justify-content: center; font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }
        
        .mobile-wrapper { width: 100%; max-width: 430px; background: #fff; min-height: 100vh; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow-x: hidden; overflow-y: auto; padding-bottom: 90px; }
        @media (min-width: 431px) { .mobile-wrapper { height: 100vh; overflow-y: scroll; } }

        #header { padding: 30px 24px 20px; display: flex; align-items: center; justify-content: space-between; background: #fff; position: sticky; top: 0; z-index: 500; border-bottom: 1px solid rgba(0,0,0,0.02); box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .header-title { font-size: 24px; font-weight: 800; color: #1e293b; }
        
        .mui-container { width: 100%; max-width: 100% !important; margin: 0; padding: 0 20px; }

        /* CALENDAR STYLES */
        .calendar-card { background: #fff; border-radius: 28px; padding: 20px 16px; margin-top: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.06); border: 1px solid #f1f5f9; width: 100%; overflow: hidden; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 8px; }
        .current-month { font-size: 18px; font-weight: 800; color: #1e293b; letter-spacing: -0.3px; }
        .nav-btns { display: flex; gap: 8px; }
        .nav-btn { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); color: #64748b; }
        .nav-btn:hover { background: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; transform: scale(1.05); }
        .nav-btn:active { transform: scale(0.95); }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; width: 100%; }
        .weekday { text-align: center; font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; padding-bottom: 8px; }
        
        .day-cell { 
            min-height: 80px; 
            border-radius: 14px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 6px 2px;
            position: relative; 
            cursor: pointer; 
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); 
            border: 1.5px solid transparent;
            background: #fafbfc;
            overflow: hidden;
        }
        .day-cell:hover { 
            background: #f1f5f9; 
            border-color: #cbd5e1;
            transform: translateY(-2px);
        }
        .day-cell.today { 
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); 
            border-color: #3b82f6;
        }
        .day-cell.selected { 
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); 
            color: #fff; 
            border-color: #1d4ed8;
            box-shadow: 0 6px 15px rgba(37, 99, 235, 0.3);
            z-index: 10;
        }
        .day-cell.other-month { opacity: 0.2; pointer-events: none; background: transparent; }
        .day-num { 
            font-size: 14px; 
            font-weight: 800; 
            margin-bottom: 4px;
            color: #1e293b;
        }
        .day-cell.selected .day-num { color: #fff; }
        
        /* Amount Chips on Calendar */
        .day-amounts { 
            display: flex; 
            flex-direction: column; 
            gap: 2px; 
            width: 100%;
            padding: 0 4px;
        }
        .amount-chip { 
            display: flex; 
            align-items: center; 
            justify-content: center;
            padding: 2px 4px; 
            border-radius: 6px; 
            font-size: 7px; 
            font-weight: 800;
            gap: 2px;
            white-space: nowrap;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .amount-chip.income { 
            background: #dcfce7; 
            color: #16a34a;
        }
        .amount-chip.expense { 
            background: #fee2e2; 
            color: #ef4444;
        }
        .day-cell.selected .amount-chip { 
            background: rgba(255,255,255,0.2); 
            color: #fff;
            border-color: rgba(255,255,255,0.3);
            backdrop-filter: blur(4px);
        }
        .day-cell.selected .amount-chip.expense { color: #fff; }
        .day-cell.selected .amount-chip.income { color: #fff; }
        .amount-chip i { font-size: 8px; }

        /* TRANSACTION LIST DESIGN (Same as main index) */
        .day-details { margin-top: 24px; }
        .details-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 0 4px; }
        .details-date { font-size: 15px; font-weight: 800; color: #1e293b; }
        .no-txns { text-align: center; padding: 40px 20px; color: #94a3b8; border: 2px dashed #e2e8f0; border-radius: 20px; font-size: 13px; font-weight: 600; background: #fafbfc; }

        .txn-chip { 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            padding: 16px; 
            background: #fff; 
            border-radius: 18px; 
            margin-bottom: 12px; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03); 
            border: 1px solid #f1f5f9;
            transition: all 0.2s ease;
        }
        .txn-chip:active { transform: scale(0.98); }
        
        .txn-chip-icon { 
            width: 48px; 
            height: 48px; 
            border-radius: 14px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            position: relative;
            flex-shrink: 0;
            background: #f8fafc;
        }
        /* CATEGORY COLORS */
        .cat-online { background: #ffedd5 !important; color: #ea580c !important; }
        .cat-shopping { background: #dbeafe !important; color: #1d4ed8 !important; }
        .cat-vehicle { background: #f3e8ff !important; color: #7e22ce !important; }
        .cat-aqua { background: #e0f2fe !important; color: #0369a1 !important; }
        .cat-trading { background: #ecfdf5 !important; color: #059669 !important; }
        .cat-service-magenta { background: #fdf2f8 !important; color: #be185d !important; }
        .cat-food { background: #fef3c7 !important; color: #d97706 !important; }
        .cat-life { background: #f0fdf4 !important; color: #16a34a !important; }
        .cat-financial { background: #fee2e2 !important; color: #dc2626 !important; }
        .cat-education { background: #eff6ff !important; color: #1d4ed8 !important; }
        .cat-income { background: #dcfce7 !important; color: #16a34a !important; }

        .txn-chip-icon i { font-size: 24px; color: inherit; }
        
        .txn-chip-info { flex: 1; display: flex; flex-direction: column; gap: 2px; min-width: 0; }
        .txn-chip-name { font-size: 13px; font-weight: 700; color: #1e293b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .txn-chip-meta { font-size: 10px; color: #64748b; font-weight: 500; display: flex; align-items: center; gap: 6px; }
        .txn-chip-note { font-size: 10px; color: #f97316; font-weight: 600; margin-top: 2px; }
        
        .txn-chip-amount-wrapper { text-align: right; flex-shrink: 0; }
        .txn-chip-amount { font-size: 14px; font-weight: 700; color: #1e293b; }
        .txn-chip.income .txn-chip-amount { color: #10B981; }
        .txn-chip.expense .txn-chip-amount { color: #ef4444; }
        .txn-chip-status { font-size: 9px; color: #94a3b8; font-weight: 600; }


        /* SUMMARY PILLS */
        .summary-pills { display: flex; gap: 12px; margin-bottom: 20px; }
        .summary-pill { flex: 1; padding: 14px; border-radius: 18px; display: flex; flex-direction: column; gap: 4px; border: 1px solid #f1f5f9; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .pill-label { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.8px; }
        .pill-value { font-size: 17px; font-weight: 800; }
        .expense-pill .pill-value { color: #ef4444; }
        .income-pill .pill-value { color: #16a34a; }

        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; height: 80px; background: #fff; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-around; align-items: center; padding: 0 10px; z-index: 1000; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #94a3b8; cursor: pointer; text-decoration: none; padding: 10px; transition: all 0.2s; }
        .nav-item:hover { text-decoration: none !important; color: #1d4ed8; }
        .nav-item.active { color: #1d4ed8; }
        .nav-item i { font-size: 24px; }
        .nav-item span { font-size: 11px; font-weight: 700; }

        /* CUSTOM CONTENT SECTION */
        .custom-section { margin-top: 32px; padding: 24px; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 28px; color: #fff; position: relative; overflow: hidden; box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
        .custom-section::after { content: ''; position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 60%); pointer-events: none; }
        .custom-title { font-size: 18px; font-weight: 800; margin-bottom: 10px; letter-spacing: -0.2px; }
        .custom-desc { font-size: 13px; color: #cbd5e1; line-height: 1.7; }
        .custom-btn { margin-top: 18px; background: #fff; color: #1e293b; border: none; padding: 14px 22px; border-radius: 16px; font-weight: 800; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); }
        .custom-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .custom-btn:active { transform: translateY(0); }


        /* TOAST */
        .toast-container { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 12px 24px; border-radius: 50px; font-size: 14px; font-weight: 600; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); z-index: 2000; display: flex; align-items: center; gap: 8px; opacity: 0; pointer-events: none; transition: all 0.3s; }
        .toast-container.show { opacity: 1; bottom: 110px; pointer-events: auto; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); z-index: 3000; display: none; align-items: center; justify-content: center; animation: fadeIn 0.2s; }
        .modal-overlay.show { display: flex; }
        .modal-content { 
            background: #fff; 
            border-radius: 32px; 
            width: 92%; 
            max-width: 400px; 
            max-height: 85vh; 
            display: flex;
            flex-direction: column;
            box-shadow: 0 24px 64px rgba(0,0,0,0.2); 
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            overflow: hidden;
        }
        .modal-header { 
            padding: 24px 24px 16px; 
            border-bottom: 1px solid #f1f5f9; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: #fff; 
            z-index: 10; 
            flex-shrink: 0;
        }
        .modal-title { font-size: 16px; font-weight: 800; color: #1e293b; letter-spacing: -0.2px; }
        .modal-close { width: 36px; height: 36px; border-radius: 50%; background: #f8fafc; border: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); color: #64748b; }
        .modal-close:hover { background: #fee2e2; color: #dc2626; border-color: #fecaca; transform: scale(1.1) rotate(90deg); }
        .modal-close:active { transform: scale(0.95) rotate(90deg); }
        .modal-body { padding: 20px 24px; overflow-y: auto; flex: 1; }
        .modal-category-group { margin-bottom: 24px; }
        .modal-category-header { font-size: 11px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .modal-category-icon { width: 28px; height: 28px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .modal-cat-txns { display: flex; flex-direction: column; gap: 8px; }
        
        #modal-footer { 
            padding: 16px 24px 24px; 
            background: #fff; 
            border-top: 1px solid #f1f5f9; 
            flex-shrink: 0;
        }
        .modal-summary { 
            background: #f8fafc; 
            border-radius: 20px; 
            padding: 16px; 
            border: 1px solid #e2e8f0; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); 
        }
        .modal-summary-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .modal-summary-divider { height: 1px; background: #e2e8f0; margin: 12px 0; }
        .modal-summary-label { font-size: 11px; font-weight: 700; color: #64748b; }
        .modal-summary-value { font-size: 13px; font-weight: 800; }
        .modal-summary-net { text-align: center; }
        .modal-summary-net .label { font-size: 12px; font-weight: 800; color: #1e293b; margin-bottom: 2px; display: block; }
        .modal-summary-net .value { font-size: 18px; font-weight: 800; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(40px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body>

    <div class="mobile-wrapper">
        <div id="header">
            <div class="header-title">Calendar</div>
            <div id="profile-badge" style="width: 40px; height: 40px; border-radius: 50%; background: #f1f5f9; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <i class="material-icons" style="color: #94a3b8;">person</i>
                <img id="user-pic" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
            </div>
        </div>

        <div class="mui-container">
            <div class="calendar-card">
                <div class="calendar-header">
                    <div class="current-month" id="calendar-title">January 2026</div>
                    <div class="nav-btns">
                        <div class="nav-btn" onclick="changeMonth(-1)"><i class="material-icons">chevron_left</i></div>
                        <div class="nav-btn" onclick="changeMonth(1)"><i class="material-icons">chevron_right</i></div>
                    </div>
                </div>

                <div class="calendar-grid" id="calendar-grid">
                    <div class="weekday">S</div>
                    <div class="weekday">M</div>
                    <div class="weekday">T</div>
                    <div class="weekday">W</div>
                    <div class="weekday">T</div>
                    <div class="weekday">F</div>
                    <div class="weekday">S</div>
                    <!-- Days injected here -->
                </div>
            </div>



            <div class="custom-section">
                <div class="custom-title">Financial Insights</div>
                <div class="custom-desc">Your daily spending patterns are visualized above. Green chips denote income, while red chips reflect expenses for specifically that date.</div>
                <button class="custom-btn">
                    <span>Analyze Monthly Plan</span>
                    <i class="material-icons" style="font-size: 18px;">arrow_forward</i>
                </button>
            </div>
        </div>

        <!-- BOTTOM NAV -->
        <div class="bottom-nav">
            <a href="index.html" class="nav-item">
                <i class="material-icons">account_balance_wallet</i>
                <span>Wallet</span>
            </a>
            <a href="calendar.html" class="nav-item active">
                <i class="material-icons">calendar_today</i>
                <span>Calendar</span>
            </a>
            <a href="accounts.html" class="nav-item">
                <i class="material-icons">account_balance</i>
                <span>Accounts</span>
            </a>
            <a href="goals.html" class="nav-item">
                <i class="material-icons">track_changes</i>
                <span>Goals</span>
            </a>
        </div>
    </div>

    <div id="toast-box" class="toast-container">
        <i class="material-icons">check_circle</i>
        <span id="toast-msg"></span>
    </div>

    <!-- MODAL -->
    <div id="txn-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-date-title">Transactions</div>
                <div class="modal-close" onclick="closeModal()">
                    <i class="material-icons" style="font-size: 18px;">close</i>
                </div>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Transaction details will be injected here -->
            </div>
            <div id="modal-footer"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBHDN0xLi98qjYYjUf2RDCn5gJK0dzTk_M",
            authDomain: "atome-wallet.firebaseapp.com",
            projectId: "atome-wallet",
            storageBucket: "atome-wallet.firebasestorage.app",
            messagingSenderId: "64186651619",
            appId: "1:64186651619:web:cd7d426cfb663aab6606d6"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentViewDate = new Date();
        let selectedDate = new Date();
        window.allTxns = [];

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Profile
                if (!user.isAnonymous) {
                    if (user.photoURL) {
                        const pic = document.getElementById('user-pic');
                        pic.src = user.photoURL;
                        pic.style.display = 'block';
                        document.querySelector('#profile-badge i').style.display = 'none';
                    }
                }
                loadData(user.uid);
            } else {
                // No user logged in - still show calendar with no transactions
                renderCalendar();
            }
        });

        function loadData(uid) {
            const q = query(collection(db, "users", uid, "transactions"), orderBy("date", "desc"));
            onSnapshot(q, (snap) => {
                window.allTxns = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(t => !t.deleted);
                renderCalendar();
            });
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const title = document.getElementById('calendar-title');
            
            if (!grid || !title) return;
            
            // Clear existing days
            const dayCells = grid.querySelectorAll('.day-cell');
            dayCells.forEach(d => d.remove());

            const year = currentViewDate.getFullYear();
            const month = currentViewDate.getMonth();
            title.innerText = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(currentViewDate);

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            // Previous month padding
            for (let i = firstDay - 1; i >= 0; i--) {
                const cell = document.createElement('div');
                cell.className = 'day-cell other-month';
                cell.innerHTML = `<span class="day-num">${daysInPrevMonth - i}</span>`;
                grid.appendChild(cell);
            }

            // Current month days
            const today = new Date();
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const cellDate = new Date(year, month, d);
                
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                if (today.toDateString() === cellDate.toDateString()) cell.classList.add('today');
                if (selectedDate && selectedDate.toDateString() === cellDate.toDateString()) cell.classList.add('selected');

                // Calculate totals for this day (only included transactions)
                const dayTxns = window.allTxns.filter(t => t.date === dateStr && !t.excluded && !t.refund);
                
                let totalExpenses = 0;
                let totalIncome = 0;
                
                try {
                    dayTxns.forEach(t => {
                        const mapped = getMerchantDisplay(t.merchant, t);
                        const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                        
                        if (mapped.category === 'Income') {
                            totalIncome += amt;
                        } else {
                            totalExpenses += amt;
                        }
                    });
                } catch (error) {}

                // Build amount chips
                let amountChipsHTML = '<div class="day-amounts">';
                if (totalIncome > 0) {
                    const formattedIncome = totalIncome >= 1000 
                        ? `${(totalIncome / 1000).toFixed(1)}k` 
                        : `${Math.round(totalIncome)}`;
                    amountChipsHTML += `<div class="amount-chip income"><i class="material-icons">trending_up</i> ${formattedIncome}</div>`;
                }
                if (totalExpenses > 0) {
                    const formattedExpense = totalExpenses >= 1000 
                        ? `${(totalExpenses / 1000).toFixed(1)}k` 
                        : `${Math.round(totalExpenses)}`;
                    amountChipsHTML += `<div class="amount-chip expense"><i class="material-icons">trending_down</i> ${formattedExpense}</div>`;
                }
                amountChipsHTML += '</div>';

                cell.innerHTML = `<span class="day-num">${d}</span>${amountChipsHTML}`;
                cell.onclick = () => {
                    selectedDate = new Date(year, month, d);
                    renderCalendar();
                    openModal(selectedDate);
                };
                grid.appendChild(cell);
            }
        }




        window.changeMonth = (delta) => {
            currentViewDate.setMonth(currentViewDate.getMonth() + delta);
            renderCalendar();
        };

        // Shared Logic Imports/Mocks
        const CATEGORIES = [
            { id: 'Online shopping', icon: 'shopping_bag', label: 'Online Shopping', cls: 'cat-online' },
            { id: 'Shopping', icon: 'shopping_cart', label: 'Shopping', cls: 'cat-shopping' },
            { id: 'Vehicle', icon: 'local_gas_station', label: 'Vehicle', cls: 'cat-vehicle' },
            { id: 'Food & Drinks', icon: 'restaurant', label: 'Food & Drinks', cls: 'cat-food' },
            { id: 'Service', icon: 'settings_cell', label: 'Service', cls: 'cat-service-magenta' },
            { id: 'Trade Copier', icon: 'hub', label: 'Trade Copier', cls: 'cat-aqua' },
            { id: 'Trading Expenses', icon: 'insights', label: 'Trading Expenses', cls: 'cat-trading' },
            { id: 'Life & Entertainment', icon: 'confirmation_number', label: 'Life & Ent.', cls: 'cat-life' },
            { id: 'Financial Expenses', icon: 'payments', label: 'Financial Expenses', cls: 'cat-financial' },
            { id: 'Transportation', icon: 'directions_bus', label: 'Transportation', cls: 'cat-vehicle' },
            { id: 'Travel', icon: 'flight', label: 'Travel', cls: 'cat-aqua' },
            { id: 'Education', icon: 'school', label: 'Education', cls: 'cat-education' },
            { id: 'Sport', icon: 'fitness_center', label: 'Sport', cls: 'cat-life' },
            { id: 'Income', icon: 'savings', label: 'Income', cls: 'cat-income' }
        ];

        function displayCategoryName(id) {
            const cat = CATEGORIES.find(c => c.id === id);
            return cat ? cat.label : id;
        }

        function getMerchantDisplay(name = '', t = {}) {
            let raw = name.toUpperCase();
            
            // 1. GENERAL CLEANUP (Remove PHL, Locations, messy suffixes)
            let cleaned = name
                .replace(/\s+PHL$/i, '')
                .replace(/\s+CEBU\s+CITY\s+PHL$/i, '')
                .replace(/\s+CEBU\s+CITY$/i, '')
                .replace(/\s+DUBAI\s+ARE$/i, '')
                .replace(/\s+LONDON\s+GBR$/i, '')
                .replace(/\s+PH\s+PHL$/i, '')
                .replace(/\s+PH$/i, '')
                .trim();
            
            // 2. PATTERN REPLACEMENT
            if (cleaned.toUpperCase().includes('GADC') || cleaned.toUpperCase().includes('MCDONALDS') || cleaned.toUpperCase().includes('MCDO')) {
                let u = cleaned.toUpperCase();
                if (u.includes('SOUTHCBU') || u.includes('325CLN')) {
                    cleaned = 'MCDONALDS SOUTH CEBU';
                } else {
                    cleaned = cleaned.replace(/(GADC|MCDONALDS|MCDO)/i, 'MCDONALDS').trim();
                    cleaned = cleaned.replace(/MCDONALDS\s+\d+[A-Z]*/i, 'MCDONALDS').trim();
                }
            }
            
            if (cleaned.toUpperCase().includes('JOLLIBEE')) {
                cleaned = cleaned.replace(/JB\d+\s+\w+/i, '').trim();
            }

            if (cleaned.toUpperCase().includes('RIBSHACK')) {
                 cleaned = cleaned.replace(/PH\d+/i, '').trim();
            }

            if (cleaned.toUpperCase().includes('SHOPEE')) {
                cleaned = 'SHOPEE PH';
            }

            if (cleaned.toUpperCase().includes('TRADERSCONNECT')) {
                cleaned = 'TRADERS CONNECT';
            }

            if (cleaned.toUpperCase().includes('TIKTOK SHOP')) {
                cleaned = 'TIKTOK SHOP';
            }

            if (cleaned.toUpperCase().includes('SPOTIFY')) {
                cleaned = 'SPOTIFY';
            }

            let display = { name: cleaned, category: 'Financial expenses', icon: 'payments', catClass: 'cat-financial' };

            // 3. MANUAL OVERRIDE
            if (t.manualCategory) {
                const userCat = CATEGORIES.find(c => c.id === t.manualCategory);
                if (userCat) {
                    display.category = userCat.id;
                    display.icon = userCat.icon;
                    const catMap = {
                        'Online shopping': 'cat-online',
                        'Shopping': 'cat-shopping',
                        'Vehicle': 'cat-vehicle',
                        'Trade Copier': 'cat-aqua',
                        'Trading Expenses': 'cat-trading',
                        'Service': 'cat-service-magenta',
                        'Food & Drinks': 'cat-food',
                        'Life & Entertainment': 'cat-life',
                        'Financial Expenses': 'cat-financial',
                        'Transportation': 'cat-vehicle',
                        'Travel': 'cat-aqua',
                        'Education': 'cat-education',
                        'Sport': 'cat-life',
                        'Income': 'cat-income'
                    };
                    display.catClass = userCat.cls || catMap[userCat.id] || 'cat-financial';
                    return display;
                }
            }

            // 4. EXACT OVERRIDES
            const mapping = {
                'MR DIY BGCC BOGO': 'MR DIY BOGO',
                'MR DIY ZBOG BOGO': 'MR DIY BOGO',
                'TEC FUEL SAN REMIGIO': 'TECFUEL SAN REMIGIO',
                'J AND L SHOPPING BOGO': 'J AND L MALL BOGO',
                'TECFUEL BOGO CEBU': 'TECFUEL BOGO',
                'KKV SM J Mall Cebu': 'KKV SM J MALL CEBU',
                'SM STORE-CEBU': 'SM STORE - CEBU CITY',
                'GLOBE-BILLSPAY PH': 'GLOBE / GOMO LOAD',
                'SHELL FILLWISE BOGO CEBU': 'SHELL BOGO CEBU',
                'GLOBE WEBLOADING EC PH': 'GLOBE / GOMO LOAD',
                'WATSONS HISOLER BLDG B': 'WATSONS HISOLER BLDG BOGO',
                'SUPER METRO S/M-BOGO': 'SUPER METRO BOGO',
                'SM SUPERMARKET SM SRP CEBU': 'SM SUPERMARKET SRP',
                'OCTAGON AYALA CENTRAL CEBU': 'OCTAGON AYALA CENTRAL CEBU',
                'STARBUCKS 540 CENTRAL CEBU CITY': 'STARBUCKS 540 CENTRAL CEBU CITY',
                'ICE SKATING SM SRP CEB': 'ICE SKATING SM SRP CEBU',
                'TAP SURE LEVERAGE FUND': 'TAP SURE LEVERAGE FUND',
                'MRCRMT': 'MRCRMT',
                'tradersconnect.com': 'TRADERS CONNECT',
                'TRADERSCONNECT': 'TRADERS CONNECT'
            };

            const finalRaw = cleaned.toUpperCase();
            if (mapping[cleaned]) display.name = mapping[cleaned];
            else if (mapping[finalRaw]) display.name = mapping[finalRaw];

            // 5. CATEGORY DETECTION
            if (finalRaw.includes('SHOPEE') || finalRaw.includes('TIKTOK') || finalRaw.includes('LAZADA') || finalRaw.includes('SHEIN') || finalRaw.includes('TEMU') || finalRaw.includes('SHOPIFY')) {
                display.category = 'Online shopping';
                display.icon = 'shopping_bag';
                display.catClass = 'cat-online';
            } else if (finalRaw.includes('FUEL') || finalRaw.includes('SHELL') || finalRaw.includes('TECFUEL') || finalRaw.includes('PETRON') || finalRaw.includes('SEAOIL')) {
                display.category = 'Vehicle';
                display.icon = 'local_gas_station';
                display.catClass = 'cat-vehicle';
            } else if (finalRaw.includes('MR DIY') || finalRaw.includes('WATSONS') || finalRaw.includes('SM STORE') || finalRaw.includes('KKV') || finalRaw.includes('SHOPPING') || finalRaw.includes('MALL') || finalRaw.includes('METRO') || finalRaw.includes('SUPERMARKET') || finalRaw.includes('OCTAGON')) {
                display.category = 'Shopping';
                display.icon = 'shopping_cart';
                display.catClass = 'cat-shopping';
            } else if (finalRaw.includes('TRADERSCONNECT') || finalRaw.includes('TRADERS CONNECT')) {
                display.category = 'Trade Copier';
                display.icon = 'hub';
                display.catClass = 'cat-aqua';
            } else if (finalRaw.includes('EQUITY EDGE') || finalRaw.includes('ANALYTICS') || finalRaw.includes('TRADING') || finalRaw.includes('LEVERAGE FUND') || finalRaw.includes('MRCRMT')) {
                display.category = 'Trading Expenses';
                display.icon = 'insights';
                display.catClass = 'cat-trading';
            } else if (finalRaw.includes('GLOBE') || finalRaw.includes('GOMO') || finalRaw.includes('BILLSPAY')) {
                display.category = 'Service';
                display.icon = 'settings_cell';
                display.catClass = 'cat-service-magenta';
            } else if (finalRaw.includes('JOLLIBEE') || finalRaw.includes('MCDO') || finalRaw.includes('MCDONALDS') || finalRaw.includes('FOOD') || finalRaw.includes('RESTAURANT') || finalRaw.includes('STARBUCKS') || finalRaw.includes('RIBSHACK')) {
                display.category = 'Food & Drinks';
                display.icon = 'restaurant';
                display.catClass = 'cat-food';
            } else if (finalRaw.includes('ICE SKATING') || finalRaw.includes('CINEMA') || finalRaw.includes('ENTERTAINMENT') || finalRaw.includes('SPOTIFY') || finalRaw.includes('NETFLIX')) {
                display.category = 'Life & Entertainment';
                display.icon = 'confirmation_number';
                display.catClass = 'cat-life';
            } else {
                display.category = 'Financial expenses';
                display.icon = 'payments';
                display.catClass = 'cat-financial';
            }

            return display;
        }

        function createTxnChip(t, mapped, amt, type) {
            const chip = document.createElement('div');
            chip.className = `txn-chip ${type}`;
            if (t.excluded) chip.style.opacity = '0.5';
            
            const name = type === 'income' ? 'INCOME' : (mapped.name || 'Unknown');
            const category = displayCategoryName(mapped.category);
            const dateStr = new Date(t.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            // LOGO DETECTION
            const mUpper = name.toUpperCase();
            let logo = null;
            if (mUpper.includes('JOLLIBEE')) logo = 'logos/jollibee.png';
            else if (mUpper.includes('MCDO') || mUpper.includes('MCDONALDS')) logo = 'logos/mcdo.png';
            else if (mUpper.includes('SHELL')) logo = 'logos/shell.png';
            else if (mUpper.includes('SHOPEE')) logo = 'logos/shopee.png';
            else if (mUpper.includes('LAZADA')) logo = 'logos/lazada.jpg';
            else if (mUpper.includes('GLOBE') || mUpper.includes('GOMO')) logo = 'logos/globe.png';
            else if (mUpper.includes('SM') || mUpper.includes('SM STORE') || mUpper.includes('SM SUPERMARKET')) logo = 'logos/sm.png';
            else if (mUpper.includes('SPOTIFY')) logo = 'logos/spotify.png';
            else if (mUpper.includes('TIKTOK')) logo = 'logos/tiktokshop.png';
            else if (mUpper.includes('TECFUEL') || mUpper.includes('TEC FUEL')) logo = 'logos/tecfuel.png';
            else if (mUpper.includes('TRADERS')) logo = 'logos/tradersconnect.png';
            else if (mUpper.includes('7/11') || mUpper.includes('7 11')) logo = 'logos/711.png';

            const logoHTML = logo ? `
                <div style="position: absolute; bottom: -4px; right: -4px; width: 22px; height: 22px; background: white; border-radius: 50%; padding: 2px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; z-index: 2; border: 1.5px solid #fff;">
                    <img src="${logo}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 50%;">
                </div>` : '';

            chip.innerHTML = `
                <div class="txn-chip-icon ${mapped.catClass || ''}">
                    <i class="material-icons">${mapped.icon}</i>
                    ${logoHTML}
                </div>
                <div class="txn-chip-info">
                    <span class="txn-chip-name">${name}</span>
                    <div class="txn-chip-meta">
                        <span>${dateStr}</span>
                        <span>•</span>
                        <span>${category}</span>
                    </div>
                    ${t.note ? `<div class="txn-chip-note">${t.note}</div>` : ''}
                </div>
                <div class="txn-chip-amount-wrapper">
                    <div class="txn-chip-amount">${type === 'expense' ? '-' : '+'} ₱${amt.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
                    <div class="txn-chip-status">Wallet</div>
                </div>
            `;
            return chip;
        }

        // MODAL FUNCTIONS
        window.openModal = (date) => {
            const modal = document.getElementById('txn-modal');
            const modalBody = document.getElementById('modal-body');
            const modalTitle = document.getElementById('modal-date-title');
            
            const options = { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' };
            modalTitle.innerText = date.toLocaleDateString('en-US', options);
            
            // Fix: Use local date string instead of toISOString to avoid timezone shifting
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const dStr = String(date.getDate()).padStart(2, '0');
            const dateStr = `${y}-${m}-${dStr}`;
            
            // Filter to only show INCLUDED transactions (not excluded, not refunded)
            const dayTxns = window.allTxns.filter(t => t.date === dateStr && !t.excluded && !t.refund);
            
            if (dayTxns.length === 0) {
                modalBody.innerHTML = `<div class="no-txns">No transactions recorded for this day.</div>`;
                modal.classList.add('show');
                return;
            }
            
            // Group transactions by category
            const categoryGroups = {};
            let totalExpenses = 0;
            let totalIncome = 0;
            
            dayTxns.forEach(t => {
                const mapped = getMerchantDisplay(t.merchant, t);
                const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                const category = mapped.category;
                const isIncome = category === 'Income';
                
                if (!categoryGroups[category]) {
                    categoryGroups[category] = {
                        icon: mapped.icon,
                        transactions: [],
                        isIncome: isIncome
                    };
                }
                
                categoryGroups[category].transactions.push(t);
                
                if (isIncome) totalIncome += amt;
                else totalExpenses += amt;
            });
            
            // Render modal content
            let bodyHTML = '';
            
            const sortedCategories = Object.keys(categoryGroups).sort((a, b) => {
                if (a === 'Income') return 1;
                if (b === 'Income') return -1;
                return 0;
            });
            
            sortedCategories.forEach(category => {
                const group = categoryGroups[category];
                const catInfo = CATEGORIES.find(c => c.id === category) || { label: category, icon: 'payments' };
                
                bodyHTML += `
                    <div class="modal-category-group">
                        <div class="modal-category-header">
                            <div class="modal-category-icon" style="background: ${group.isIncome ? '#dcfce7' : '#fee2e2'}; color: ${group.isIncome ? '#16a34a' : '#ef4444'};">
                                <i class="material-icons">${group.icon}</i>
                            </div>
                            <span>${catInfo.label}</span>
                        </div>
                        <div class="modal-cat-txns"></div>
                    </div>
                `;
            });
            
            modalBody.innerHTML = bodyHTML;

            // Add summary to footer
            const netAmount = totalIncome - totalExpenses;
            document.getElementById('modal-footer').innerHTML = `
                <div class="modal-summary">
                    <div class="modal-summary-row">
                        <div class="modal-summary-label">Total Expenses</div>
                        <div class="modal-summary-value" style="color: #ef4444;">- ₱${totalExpenses.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
                    </div>
                    <div class="modal-summary-row">
                        <div class="modal-summary-label">Total Income</div>
                        <div class="modal-summary-value" style="color: #16a34a;">+ ₱${totalIncome.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
                    </div>
                    <div class="modal-summary-divider"></div>
                    <div class="modal-summary-net">
                        <span class="label">Net Balance</span>
                        <div class="value" style="color: ${netAmount >= 0 ? '#16a34a' : '#ef4444'};">${netAmount >= 0 ? '+' : ''} ₱${netAmount.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
                    </div>
                </div>
            `;
            
            // Inject transaction chips into categories
            sortedCategories.forEach(category => {
                const group = categoryGroups[category];
                const groupDiv = Array.from(modalBody.querySelectorAll('.modal-category-group')).find(d => d.querySelector('span').innerText === (CATEGORIES.find(c => c.id === category)?.label || category));
                const listDiv = groupDiv.querySelector('.modal-cat-txns');
                
                group.transactions.forEach(t => {
                    const mapped = getMerchantDisplay(t.merchant, t);
                    const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                    const type = mapped.category === 'Income' ? 'income' : 'expense';
                    listDiv.appendChild(createTxnChip(t, mapped, amt, type));
                });
            });

            modal.classList.add('show');
        };

        window.closeModal = () => {
            const modal = document.getElementById('txn-modal');
            modal.classList.remove('show');
        };

        // Close modal when clicking outside
        document.getElementById('txn-modal').addEventListener('click', (e) => {
            if (e.target.id === 'txn-modal') {
                closeModal();
            }
        });

        // INITIALIZE CALENDAR - Direct call at end of script
        renderCalendar();

    </script>
</body>
</html>
