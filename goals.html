<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="manifest" href="manifest.json?v=1">
    <title>Financial Goals - Smart Wallet</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --bg-primary: #fff;
            --bg-secondary: #f8fafc;
            --text-primary: #000000;
            --text-secondary: #4b5563;
            --card-bg: #fff;
            --header-bg: rgba(255, 255, 255, 0.95);
            --border-color: #e2e8f0;
            --accent-color: #00851F; /* Precise New Green */
            --accent-soft: rgba(0, 133, 31, 0.08); 
            --ai-blue: #e8f0fe;
            --ai-blue-text: #1a73e8;
            --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.04);
            --radius-xl: 20px; /* Reduced for uniformity with index.html */
            --radius-lg: 16px;
        }

        * { 
            box-sizing: border-box; 
            -webkit-user-select: none; 
            user-select: none; 
            touch-action: manipulation; 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Plus Jakarta Sans', sans-serif;
            scrollbar-width: none;
            -ms-overflow-style: none;
            -webkit-touch-callout: none;
        }
        *::-webkit-scrollbar { display: none; width: 0; height: 0; }

        /* Native App Feel - Disable all link behaviors */
        a, a:visited, a:hover, a:active, a:focus {
            text-decoration: none !important;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-drag: none;
        }
        /* Disable text selection highlighting */
        ::selection { background: transparent; }
        ::-moz-selection { background: transparent; }

        body, html { 
            margin: 0; 
            padding: 0; 
            background: #ffffff; 
            min-height: 100vh; 
            overflow-x: hidden;
        }

        /* Mobile Wrapper */
        .mobile-wrapper { 
            width: 100%; 
            max-width: 430px; 
            margin: 0 auto;
            background: var(--bg-secondary);
            height: 100vh;
            position: relative; 
            display: flex; 
            flex-direction: column; 
            align-items: stretch;
            padding-bottom: 160px; /* Increased for FAB clearance */
            box-shadow: 0 0 50px rgba(0,0,0,0.05);
            overflow-x: hidden;
            overflow-y: auto;
            overscroll-behavior-y: contain;
        }
        @media (min-width: 431px) { 
            .mobile-wrapper { 
                height: 100vh; 
                overflow-y: scroll; 
                overscroll-behavior-y: contain; 
            } 
        }

        .goals-list {
            width: 100%;
            height: 400px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }

        /* UNIFORM HEADER */
        #header {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 430px;
            padding: 15px 24px 10px;
            background: #fff;
            z-index: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .header-logo { width: 48px; height: 30px; border-radius: 4px; object-fit: cover; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .greeting-section { line-height: 1.2; }
        .greeting-text { font-size: 11px; color: #94a3b8; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; }
        .user-name { font-size: 18px; font-weight: 800; color: #1e293b; }

        /* PROFILE DROPDOWN MENU */
        .profile-container { position: relative; }
        #profile-badge { width: 42px; height: 42px; border-radius: 50%; background: #f1f5f9; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #profile-badge img { width: 100%; height: 100%; object-fit: cover; display: none; position: absolute; top: 0; left: 0; }
        #profile-badge i { font-size: 24px; color: #94a3b8; display: block; }
        #profile-badge.has-pic i { opacity: 0; pointer-events: none; }
        #profile-badge.has-pic img { display: block; }
        #profile-badge.has-pic img { display: block; }

        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; height: 75px; background: #fff; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-around; align-items: stretch; padding: 0 10px; z-index: 1000; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: #94a3b8; cursor: pointer; text-decoration: none; transition: all 0.2s; border-radius: 12px; margin: 6px 4px; }
        .nav-item:hover { background: #f1f5f9; color: #1e293b; text-decoration: none !important; }
        .nav-item.active { color: #121212; }
        .nav-item i { font-size: 24px; transition: transform 0.2s; }
        .nav-item:hover i { transform: translateY(-2px); }
        .nav-item span { font-size: 11px; font-weight: 700; }

        .profile-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.12);
            min-width: 200px;
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 2000;
            border: 1px solid #f1f5f9;
            padding: 6px;
        }
        .profile-dropdown.active { display: flex; animation: dropIn 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes dropIn { from { opacity: 0; transform: translateY(-10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .dropdown-item {
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13.5px;
            font-weight: 700;
            color: #475569;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s;
        }
        .dropdown-item:hover { background: #f8fafc; color: #1e293b; }
        .dropdown-item i { font-size: 20px; color: #94a3b8; }
        .mui-container { width: 100%; max-width: 100% !important; margin: 0; padding: 0 20px; }
        .dropdown-item.logout { color: #ef4444; margin-top: 4px; border-top: 1px solid #f1f5f9; }
        .dropdown-item.logout i { color: #ef4444; }
        .dropdown-header { padding: 10px 14px 6px; font-size: 11px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }

        .header-spacer { height: 70px; flex-shrink: 0; }

        /* Summary Card */
        .summary-card {
            background: #fff;
            padding: 24px;
            border-radius: 28px;
            display: flex;
            align-items: center;
            gap: 24px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.02);
            transition: all 0.3s ease;
            margin: 20px 24px 10px;
        }
        .summary-info { flex: 1; position: relative; }
        .privacy-toggle { position: absolute; top: -5px; right: 0; cursor: pointer; color: #94a3b8; transition: all 0.2s; padding: 5px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .privacy-toggle:hover { background: #f1f5f9; color: #1e293b; }
        .privacy-toggle i { font-size: 20px; }

        .privacy-active .privacy-toggle { color: #16a34a; }

        .summary-target {
            font-size: 13px;
            opacity: 0.4;
            font-weight: 700;
            margin-left: 2px;
        }

        .progress-ring-container {
            position: relative;
            width: 90px;
            height: 90px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .progress-percentage {
            position: absolute;
            font-size: 16px;
            font-weight: 900;
            letter-spacing: -0.5px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .summary-info {
            flex: 1;
        }

        .summary-label {
            font-size: 10px;
            font-weight: 800;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 4px;
        }

        .summary-value {
            font-size: 28px;
            font-weight: 900;
            color: #000;
            letter-spacing: -1.2px;
            transition: filter 0.3s ease;
        }

        /* Time Forecast Section - Card Style */
        /* SKELETON LOADER */
        .skeleton { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton-text { height: 14px; width: 60%; margin-bottom: 8px; }
        .skeleton-circle { width: 48px; height: 48px; border-radius: 50%; }

        .skeleton-card {
            height: 90px;
            background: #fff;
            border-radius: 24px;
            margin: 0 24px 12px;
            display: flex;
            align-items: center;
            padding: 0 24px;
            gap: 16px;
            box-shadow: var(--shadow-soft);
            width: calc(100% - 48px);
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .forecast-card {
            background: linear-gradient(135deg, #eff6ff 0%, #e0e7ff 100%);
            border-radius: 24px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 14px;
            margin: 0 24px 20px;
            border: 1px solid rgba(191, 219, 254, 0.5);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.05);
            transition: all 0.3s ease;
            flex-shrink: 0;
            width: auto; /* Stretches to fill margin if parent is stretch */
        }

        .forecast-icon {
            width: 40px;
            height: 40px;
            background: #fff;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4f46e5;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.12);
            flex-shrink: 0;
        }

        .forecast-text {
            font-size: 11.5px;
            font-weight: 600;
            color: #1e40af;
            line-height: 1.4;
        }
        
        .forecast-text b { font-weight: 800; }

        /* Goal Cards */
        .goal-card {
            background: var(--card-bg);
            padding: 16px 20px; 
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 0 24px 12px; 
            box-shadow: var(--shadow-soft);
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border: 1px solid var(--border-color);
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        .goal-card.excluded {
            opacity: 0.4 !important;
            filter: grayscale(100%) !important;
            background: #f5f5f5 !important;
        }
        
        .goal-card.excluded * {
            filter: grayscale(100%) !important;
        }
        
        .goal-card.excluded .goal-icon-box,
        .goal-card.excluded .progress-bar-fill {
            filter: grayscale(100%) saturate(0%) !important;
            opacity: 0.5 !important;
        }

        .sortable-ghost { opacity: 0.3; background: var(--accent-soft); }

        .goal-card.popped {
            transform: scale(1.04);
            z-index: 2300 !important;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            background: #fff;
            border-color: transparent;
        }

        .goal-card img, .goal-icon-box {
            pointer-events: none;
            -webkit-user-drag: none;
        }
        .goal-icon-box { pointer-events: auto; }

        .goal-card:active:not(.popped) {
            transform: scale(0.98);
            background: #fdfdfd;
        }

        .goal-icon-box {
            width: 42px; /* Making square smaller as requested */
            height: 42px;
            border-radius: 11px; 
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 20px;
            transition: transform 0.2s;
        }

        .goal-center {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .goal-title {
            font-size: 14px;
            font-weight: 800;
            color: #1a1a1a;
            letter-spacing: -0.3px;
            display: flex;
            align-items: center;
            gap: 6px;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .atome-shield-badge {
            font-size: 7px;
            background: #121212;
            color: #c0ff00;
            padding: 1px 3px;
            border-radius: 4px;
            font-weight: 900;
            text-transform: uppercase;
        }

        .progress-bar-bg {
            height: 6px; /* Back to thicker as requested */
            background: #f1f5f9;
            border-radius: 100px;
            overflow: hidden;
            width: 100%;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 10px;
            background: var(--accent-color);
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .goal-right {
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 90px;
        }

        .goal-amount {
            font-size: 15px;
            font-weight: 900;
            color: #000;
            letter-spacing: -0.4px;
            padding-right: 4px;
        }

        .goal-percent {
            font-size: 8.5px;
            color: #94a3b8;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .deposit-btn {
            margin-top: 4px;
            background: var(--accent-soft);
            border: 1px solid rgba(7, 99, 13, 0.1);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 800;
            color: var(--accent-color);
            cursor: pointer;
            transition: all 0.2s;
        }
        .deposit-btn:hover { background: #e6ffe6; }

        /* Floating Action Button */
        .fab { 
            position: fixed; 
            bottom: 100px; 
            right: calc(50% - 215px + 28px); 
            width: 62px; 
            height: 62px; 
            border-radius: 50%; 
            background: #07630D; 
            color: #fff; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-shadow: 0 10px 25px rgba(5, 150, 105, 0.3); 
            z-index: 999; 
            cursor: pointer; 
            border: none; 
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.2s; 
        }
        .fab:active { transform: scale(0.9); background: #054a0a; }
        .fab i { font-size: 32px; }

        @media (max-width: 430px) {
            .fab { right: 28px; }
        }

        /* Skeleton Loaders */
        .skeleton {
            background: #f1f5f9;
            background: linear-gradient(110deg, #f1f5f9 8%, #f8fafc 18%, #f1f5f9 33%);
            background-size: 200% 100%;
            animation: shimmer 1.5s linear infinite;
            border-radius: 28px;
        }

        @keyframes shimmer {
            to { background-position-x: -200%; }
        }

        .skeleton-circle { width: 48px; height: 48px; border-radius: 12px; flex-shrink: 0; }

        .fade-in {
            animation: fadeInContent 0.5s ease-out forwards;
            opacity: 0;
        }

        @keyframes fadeInContent {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #goals-skeleton {
            transition: opacity 0.3s ease;
        }

        /* REFINED CONTEXT MENU */
        .context-menu-backdrop {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 2200;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .context-menu-backdrop.show { opacity: 1; display: block; }

        .context-menu-wrapper {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: transparent;
            z-index: 2400;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .context-menu-wrapper.show { opacity: 1; display: flex; }

        .ios-menu {
            position: absolute;
            width: 180px; 
            background: #ffffff;
            border-radius: 16px; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2500;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .ios-menu.show { transform: scale(1); opacity: 1; }

        /* GOALS SKELETON */
        .skeleton-goal {
            background: #fff;
            padding: 16px 20px;
            border-radius: 24px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            border: 1px solid #f1f5f9;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            animation: shimmer 1.5s infinite linear;
            background: linear-gradient(90deg, #fff 25%, #f8fafc 50%, #fff 75%);
            background-size: 200% 100%;
        }
        .skeleton-goal-icon { width: 42px; height: 42px; border-radius: 11px; background: rgba(0,0,0,0.03); flex-shrink: 0; }
        .skeleton-goal-info { flex: 1; display: flex; flex-direction: column; gap: 6px; }
        .skeleton-goal-line { height: 14px; background: rgba(0,0,0,0.03); border-radius: 4px; }
        .skeleton-goal-line.short { width: 30%; }
        .skeleton-goal-line.medium { width: 60%; }
        .skeleton-goal-progress { height: 6px; background: rgba(0,0,0,0.02); border-radius: 100px; width: 100%; margin-top: 8px; }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .ios-menu-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13.5px;
            font-weight: 700;
            color: #000;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f1f5f9;
        }
        .ios-menu-item:last-child { border-bottom: none; }
        .ios-menu-item:active { background: #f8fafc; }
        
        /* Specific action colors as requested */
        .ios-menu-item i { font-size: 20px; }
        .ios-menu-item.edit { color: #2563eb; }
        .ios-menu-item.edit i { color: #2563eb; }
        .ios-menu-item.danger { color: #ef4444; }
        .ios-menu-item.danger i { color: #ef4444; }
        .ios-menu-item.toggle-state { color: #64748b; }
        .ios-menu-item.toggle-state.active { color: #00851F; }

        /* FADE-IN ANIMATION */
        .fade-in {
            animation: fadeInAnim 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            opacity: 0;
        }
        @keyframes fadeInAnim {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Bottom Nav Sync from calendar.html */
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; height: 75px; background: #fff; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-around; align-items: stretch; padding: 0 10px; z-index: 1000; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: #94a3b8; cursor: pointer; text-decoration: none; transition: all 0.2s; border-radius: 12px; margin: 6px 4px; }
        .nav-item:hover { background: #f1f5f9; color: #1e293b; text-decoration: none !important; }
        .nav-item.active { color: #121212; }
        .nav-item i { font-size: 24px; transition: transform 0.2s; }
        .nav-item:hover i { transform: translateY(-2px); }
        .nav-item span { font-size: 11px; font-weight: 700; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        .modal-overlay.blur-bg {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .modal-card {
            background: var(--card-bg);
            width: 100%;
            max-width: 340px;
            border-radius: 28px;
            padding: 24px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.1);
            animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalPop {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-title {
            font-size: 18px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 20px;
            letter-spacing: -0.5px;
        }

        .form-group { margin-bottom: 16px; }
        .form-label { font-size: 11px; font-weight: 800; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px; display: block; }
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 2px solid #f1f5f9;
            font-size: 14px;
            font-weight: 700;
            outline: none;
            transition: border-color 0.2s;
        }
        .form-input:focus { border-color: var(--accent-color); }

        .modal-btn {
            width: 100%;
            padding: 14px;
            border-radius: 14px;
            border: none;
            font-size: 14px;
            font-weight: 800;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }

        .primary-btn { background: #121212; color: #fff; margin-top: 8px; }
        .primary-btn:active { transform: scale(0.98); }
        .ghost-btn { background: transparent; color: var(--text-secondary); margin-top: 4px; }
        .ghost-btn:active { opacity: 0.7; transform: scale(0.98); }

        .add-goal-btn:active { transform: scale(0.95); opacity: 0.8; }
        .deposit-btn:active { transform: scale(0.95); background: #e2e8f0; }
        
        .goal-card-actions { display: none; }

        .delete-btn {
            background: #fff;
            border: 1px solid #fee2e2;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 800;
            color: #ef4444;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .delete-btn:active { transform: scale(0.95); background: #fef2f2; }
        .delete-btn i { font-size: 14px; }

        /* ICON SELECTOR GRID */
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 12px;
            max-height: 280px;
            overflow-y: scroll;
            overflow-x: hidden;
            padding: 4px;
            -webkit-overflow-scrolling: touch;
            width: 100%;
            box-sizing: border-box;
        }

        .icon-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px 8px;
            border-radius: 16px;
            border: 2px solid #f1f5f9;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #fff;
        }

        .icon-item:hover { border-color: var(--accent-color); background: var(--bg-secondary); }
        .icon-item.active { 
            border-color: var(--accent-color); 
            background: var(--accent-soft);
            box-shadow: 0 4px 12px rgba(0, 133, 31, 0.1);
        }

        .icon-item-box {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        .icon-item:active .icon-item-box { transform: scale(0.9); }
        .icon-item-box i { font-size: 20px; }
        .icon-item-label {
            font-size: 9px;
            font-weight: 800;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
        }
        .icon-item.active .icon-item-label { color: var(--accent-color); }

        @keyframes fillProgress {
            from { width: 0; }
        }

        /* TOAST NOTIFICATION */
        .toast-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #121212;
            color: #fff;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 700;
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .toast-container.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* CUSTOM DELETE MODAL */
        #deleteModal .modal-card {
            max-width: 320px;
            text-align: center;
        }
        #deleteModal .modal-title {
            color: #ef4444;
            margin-bottom: 12px;
        }
        .delete-warning {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 24px;
            line-height: 1.5;
            font-weight: 600;
        }
        .modal-btn.danger-btn {
            background: #ef4444;
            color: #fff;
        }
        .modal-btn.danger-btn:active {
            background: #dc2626;
            transform: scale(0.98);
        }

        /* MODERN PULL-TO-REFRESH - Material Design Style */
        .ptr-container {
            position: fixed;
            top: 75px; /* Lower position below header */
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 430px;
            height: 80px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            z-index: 400; /* Behind header z-index of 500 */
            pointer-events: none;
            padding-top: 5px;
        }
        .ptr-spinner {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 3px 12px rgba(0,0,0,0.15), 0 1px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateY(-60px) scale(0.6);
            opacity: 0;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s ease;
        }
        .ptr-spinner.visible {
            opacity: 1;
        }
        .ptr-spinner.refreshing {
            transform: translateY(0) scale(1) !important;
            opacity: 1;
        }
        .ptr-spinner svg {
            width: 24px;
            height: 24px;
            transition: transform 0.2s linear;
        }
        .ptr-spinner.refreshing svg {
            animation: ptrSpin 0.8s linear infinite;
        }
        @keyframes ptrSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Progress arc */
        .ptr-spinner .ptr-circle {
            fill: none;
            stroke: #00851F;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-dasharray: 60;
            stroke-dashoffset: 60;
            transform-origin: center;
            transition: stroke-dashoffset 0.2s ease;
        }
        .ptr-spinner.refreshing .ptr-circle {
            stroke-dashoffset: 15;
            animation: ptrDash 1.2s ease-in-out infinite;
        }
        @keyframes ptrDash {
            0% { stroke-dashoffset: 55; transform: rotate(0deg); }
            50% { stroke-dashoffset: 15; }
            100% { stroke-dashoffset: 55; transform: rotate(360deg); }
        }
    </style>

</head>
<body>
    <div class="mobile-wrapper">
        <!-- Header -->
        <div id="header">
            <div class="header-logo-box" style="display: flex; align-items: center; gap: 12px;">
                <!-- Dynamic Card Icon -->
                <svg id="header-card-icon" class="header-logo" viewBox="0 0 48 30" xmlns="http://www.w3.org/2000/svg">
                    <rect width="48" height="30" rx="4" fill="#1a1a1a" id="card-bg"/>
                    <g transform="translate(32, 20)">
                        <circle cx="4" cy="4" r="3.5" fill="#eb001b" opacity="0.9"/>
                        <circle cx="8" cy="4" r="3.5" fill="#f79e1b" opacity="0.9"/>
                    </g>
                    <rect x="6" y="8" width="8" height="6" rx="1" fill="#d4af37" opacity="0.3"/>
                </svg>
                
                <div class="greeting-section">
                    <div class="greeting-text">Hello,</div>
                    <div class="user-name" id="user-display-name">Guest</div>
                </div>
            </div>
            <div class="profile-container">
                <div id="profile-badge" onclick="window.toggleProfileDropdown(event)">
                    <i class="material-icons">person</i>
                    <img id="user-pic" src="" alt="Profile" referrerpolicy="no-referrer">
                </div>
                <div id="profile-dropdown" class="profile-dropdown">
                    <!-- Dropdown items will be injected via script or hardcoded if simple -->
                    <div class="dropdown-header">Account</div>
                    <div class="dropdown-item" onclick="window.location.href='index.html'">
                        <i class="material-icons">account_balance_wallet</i>
                        <span>Wallet</span>
                    </div>
                    <div class="dropdown-item logout" onclick="window.handleSignout()">
                        <i class="material-icons">logout</i>
                        <span>Log Out</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="header-spacer"></div>

        <!-- MODERN PULL-TO-REFRESH SPINNER -->
        <div class="ptr-container" id="ptrContainer">
            <div class="ptr-spinner" id="ptrSpinner">
                <svg viewBox="0 0 24 24">
                    <circle class="ptr-circle" cx="12" cy="12" r="10" />
                </svg>
            </div>
        </div>

        <!-- Title Section (Since header is now uniform) -->
        <div style="background: var(--bg-secondary); padding: 30px 24px 12px; border-bottom: 1px solid rgba(0,0,0,0.02);"> 
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 style="margin: 0; font-size: 26px; font-weight: 900; color: #000; letter-spacing: -1.2px;">Financial Goals</h1>
            </div>
        </div>

        <!-- Summary Card Skeleton (Initially Shown) -->
        <div class="summary-card" id="totalSummary" style="margin: 20px 24px 20px; height: 150px; display: none;">
            <!-- Content will be injected but we need it wide -->
        </div>

        <!-- Wide Summary Skeleton -->
        <div id="summarySkeleton" class="skeleton-card" style="height: 150px; margin: 20px 24px;">
            <div class="skeleton-circle skeleton" style="width: 80px; height: 80px; border-radius: 50%;"></div>
            <div style="flex: 1;">
                <div class="skeleton-text skeleton" style="width: 50%; height: 16px; margin-bottom: 15px;"></div>
                <div class="skeleton-text skeleton" style="width: 80%; height: 32px;"></div>
            </div>
        </div>

        <!-- Time Forecast Skeleton -->
        <div class="forecast-card skeleton" id="forecastSkeleton" style="min-height: 90px; border: none; margin: 0 24px 20px; background: rgba(224, 236, 255, 0.5); display: flex; align-items: center; padding: 0 24px; gap: 16px;">
            <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.7); border-radius: 12px; flex-shrink: 0;"></div>
            <div style="flex: 1;">
                <div style="width: 100%; height: 10px; background: rgba(255,255,255,0.7); border-radius: 5px; margin-bottom: 10px;"></div>
                <div style="width: 60%; height: 10px; background: rgba(255,255,255,0.7); border-radius: 5px;"></div>
            </div>
        </div>

        <!-- Goals Section Label -->
        <div style="padding: 0 28px; margin-bottom: 12px; margin-top: 10px;">
            <span style="font-size: 11px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.8px;">Your Financial Goals</span>
        </div>

        <!-- Goals List -->
        <div class="goals-list" id="goalsContainer" style="position: relative;">
            <!-- Wide Skeletons Wrap -->
            <div id="goals-skeleton" style="position: absolute; top: 0; left: 0; right: 0; z-index: 10; background: #f8fafc; transition: opacity 0.5s ease; pointer-events: none;">
                <div class="skeleton-card">
                    <div class="skeleton-circle skeleton"></div>
                    <div style="flex: 1;">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-text" style="width: 85%;"></div>
                    </div>
                </div>
                <div class="skeleton-card">
                    <div class="skeleton-circle skeleton"></div>
                    <div style="flex: 1;">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-text" style="width: 85%;"></div>
                    </div>
                </div>
                <div class="skeleton-card">
                    <div class="skeleton-circle skeleton"></div>
                    <div style="flex: 1;">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-text" style="width: 85%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- High-Fidelity Context Menu -->
        <div class="context-menu-backdrop" id="contextMenuBackdrop" onclick="window.closeContextMenu()"></div>
        <div class="context-menu-wrapper" id="contextMenuOverlay" onclick="window.closeContextMenu()">
            <div class="ios-menu" id="iosMenu" onclick="event.stopPropagation()">
                <div class="ios-menu-item edit" onclick="window.openGoalEdit()">
                    <i class="material-icons">edit</i>
                    <span>Edit Goal</span>
                </div>
                <div class="ios-menu-item danger" onclick="window.confirmDeleteGoal()">
                    <i class="material-icons">delete</i>
                    <span>Delete</span>
                </div>
            </div>
        </div>

        <!-- Edit Goal Modal -->
        <div class="modal-overlay" id="editModal">
            <div class="modal-card">
                <div class="modal-title">Edit Goal</div>
                <div class="form-group">
                    <label class="form-label">Goal Name</label>
                    <input type="text" id="editGoalTitle" class="form-input" placeholder="e.g. Dream House">
                </div>
                <div class="form-group">
                    <label class="form-label">Target Amount (PHP)</label>
                    <input type="number" id="editGoalTarget" class="form-input" placeholder="500000">
                </div>
                <div class="form-group">
                    <label class="form-label">Select Icon</label>
                    <div class="icon-grid" id="editIconGrid">
                        <!-- Icons injected via JS -->
                    </div>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button class="modal-btn primary-btn" onclick="window.saveEditedGoal()">Save Changes</button>
                    <button class="modal-btn ghost-btn" onclick="window.closeModals()">Cancel</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="javascript:void(0)" class="nav-item" onclick="window.location.href='index.html'; return false;" oncontextmenu="return false;" draggable="false">
            <i class="material-icons">account_balance_wallet</i>
            <span>Wallet</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" onclick="window.location.href='calendar.html'; return false;" oncontextmenu="return false;" draggable="false">
            <i class="material-icons">calendar_today</i>
            <span>Calendar</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" onclick="window.location.href='accounts.html'; return false;" oncontextmenu="return false;" draggable="false">
            <i class="material-icons">account_balance</i>
            <span>Accounts</span>
        </a>
        <a href="#" class="nav-item active" onclick="return false;" oncontextmenu="return false;" draggable="false">
            <i class="material-icons">track_changes</i>
            <span>Goals</span>
        </a>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast-container">Action successful</div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="openAddModal()">
        <i class="material-icons">add</i>
    </button>

    <!-- Add Goal Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal-card">
            <div class="modal-title">New Financial Goal</div>
            <div class="form-group">
                <label class="form-label">Goal Title</label>
                <input type="text" id="goalTitle" class="form-input" placeholder="e.g. Emergency Fund">
            </div>
            <div class="form-group">
                <label class="form-label">Target Amount (PHP)</label>
                <input type="text" id="goalTarget" class="form-input" placeholder="20,000" oninput="window.formatCurrencyInput(this)">
            </div>
            <div class="form-group">
                <label class="form-label">Select Icon</label>
                
                <!-- Custom Image Preview -->
                <img id="customImagePreview" class="custom-image-preview mobile-hidden" src="" alt="Custom icon" style="width: 100%; height: 80px; border-radius: 12px; object-fit: cover; margin-bottom: 12px; display: none; border: 2px solid #00851F;">
                
                <div class="icon-grid" id="addIconGrid">
                    <!-- Icons injected via JS -->
                </div>
                
                <!-- Upload Button -->
                <div style="margin-top: 12px;">
                    <input type="file" id="customImageInput" accept="image/*" hidden onchange="window.handleImageUpload(event)">
                    <button class="modal-btn" onclick="document.getElementById('customImageInput').click()" style="background: #f8fafc; color: #64748b; border: 2px dashed #e2e8f0;">
                        <i class="material-icons">add_photo_alternate</i>
                        Upload Custom Image
                    </button>
                </div>
            </div>
            <button class="modal-btn primary-btn" onclick="window.saveGoal()" style="margin-top: 20px;">Create Goal</button>
            <button class="modal-btn ghost-btn" onclick="window.closeModals()">Cancel</button>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-card">
            <div class="modal-title">Delete Goal?</div>
            <p class="delete-warning">Are you sure you want to delete this goal? This action cannot be undone.</p>
            <div style="display: flex; gap: 12px;">
                <button class="modal-btn danger-btn" onclick="window.confirmDeleteActual()">Delete</button>
                <button class="modal-btn ghost-btn" onclick="window.closeModals()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="depositModal">
        <div class="modal-card">
            <div class="modal-title">Deposit to Goal</div>
            <div class="form-group">
                <label class="form-label">Amount (PHP)</label>
                <input type="text" id="depositAmount" class="form-input" placeholder="1,000" oninput="window.formatCurrencyInput(this)">
            </div>
            <button class="modal-btn primary-btn" id="confirmDepositBtn">Confirm Deposit</button>
            <button class="modal-btn ghost-btn" onclick="window.closeModals()">Cancel</button>
        </div>
    </div>

    <!-- UI & Firebase Logic -->
    <script src="nav-state.js"></script>
    <script type="module">
        import { 
            auth, db, onAuthStateChanged, 
            collection, addDoc, getDocs, query, orderBy, where, doc, updateDoc, deleteDoc, serverTimestamp,
            getDoc
        } from "./firebase-config.js";

        // Global check for NavState
        const nav = window.NavState;

        // State Management
        let goals = [];
        let currentUser = null;
        window.selectedGoalId = null; 
        let selectedIcon = 'savings';
        let dynamicMonthlySavings = 0;

        const AVAILABLE_ICONS = [
            { id: 'savings', label: 'Savings', icon: 'savings', bg: '#f0fdf4', color: '#00851F' },
            { id: 'shield', label: 'Shield', icon: 'verified_user', bg: '#f0fdf4', color: '#00851F' },
            { id: 'travel', label: 'Travel', icon: 'flight', bg: '#f0f9ff', color: '#0284c7' },
            { id: 'directions_car', label: 'Vehicle', icon: 'directions_car', bg: '#f5f3ff', color: '#8b5cf6' },
            { id: 'home', label: 'Home', icon: 'home', bg: '#f0fdf4', color: '#22c55e' },
            { id: 'shopping', label: 'Shopping', icon: 'shopping_bag', bg: '#fff7ed', color: '#ea580c' },
            { id: 'favorite', label: 'Health', icon: 'favorite', bg: '#fff1f2', color: '#ef4444' },
            { id: 'education', label: 'School', icon: 'school', bg: '#eff6ff', color: '#1d4ed8' },
            { id: 'trading', label: 'Trading', icon: 'trending_up', bg: '#ecfeff', color: '#0891b2' },
            { id: 'investment', label: 'Invest', icon: 'diamond', bg: '#fdf4ff', color: '#a855f7' },
            { id: 'wedding', label: 'Wedding', icon: 'favorite_border', bg: '#fdf2f8', color: '#ec4899' },
            { id: 'medical', label: 'Medical', icon: 'local_hospital', bg: '#fef2f2', color: '#dc2626' },
            { id: 'gaming', label: 'Gaming', icon: 'sports_esports', bg: '#f5f3ff', color: '#7c3aed' },
            { id: 'tech', label: 'Tech', icon: 'phone_iphone', bg: '#f8fafc', color: '#475569' },
            { id: 'fitness', label: 'Fitness', icon: 'fitness_center', bg: '#fef3c7', color: '#d97706' },
            { id: 'emergency', label: 'Emergency', icon: 'emergency', bg: '#fee2e2', color: '#ef4444' }
        ];

        // Global UI functions (Synchronous enough for responsive buttons)
        // Gesture State
        let pressTimer;
        let isLongPress = false;

        window.startPress = function(e, id) {
            if (e.type === 'mousedown' && e.button !== 0) return;
            
            isLongPress = false;
            pressTimer = setTimeout(() => {
                isLongPress = true;
                // Don't open context menu if we're dragging, 
                // but keep it for legacy if needed. 
                // For now, sorting handle is the icon.
                window.openContextMenu(e, id);
            }, 600); 
        }

        window.cancelPress = function() {
            clearTimeout(pressTimer);
        }

        window.showToast = function(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        window.handleCardClick = function(id) {
            if (!isLongPress) {
                window.openDepositModal(id);
            }
        }

        window.openAddModal = function() {
            window.closeContextMenu();
            selectedIcon = 'savings';
            renderIconGrid('addIconGrid');
            const modal = document.getElementById('addModal');
            modal.style.display = 'flex';
            if (nav) nav.pushModalState('addModal', () => modal.style.display = 'none');
        }

        window.formatCurrencyInput = function(input) {
            let selectionStart = input.selectionStart;
            let originalLength = input.value.length;
            let val = input.value.replace(/\D/g, '');
            if (val === '') {
                input.value = '';
                return;
            }
            let formatted = parseInt(val).toLocaleString();
            input.value = formatted;
            let diff = formatted.length - originalLength;
            input.setSelectionRange(selectionStart + diff, selectionStart + diff);
        }

        window.openDepositModal = function(id) {
            window.selectedGoalId = id;
            const modal = document.getElementById('depositModal');
            modal.style.display = 'flex';
            if (nav) nav.pushModalState('depositModal', () => modal.style.display = 'none');
            const input = document.getElementById('depositAmount');
            if (input) setTimeout(() => input.focus(), 100);
        }

        window.openContextMenu = function(e, id) {
            window.selectedGoalId = id;
            const card = document.querySelector(`[data-id="${id}"]`);
            if (!card) return;

            // Mark card as popped
            document.querySelectorAll('.goal-card').forEach(c => c.classList.remove('popped'));
            card.classList.add('popped');

            const overlay = document.getElementById('contextMenuOverlay');
            const backdrop = document.getElementById('contextMenuBackdrop');
            const menu = document.getElementById('iosMenu');
            
            const goal = goals.find(g => g.id === id);
            const isExcluded = goal?.isExcluded === true;
            
            // Update Menu Items for Include/Exclude
            menu.innerHTML = `
                <div class="ios-menu-item edit" onclick="window.openGoalEdit()">
                    <i class="material-icons">edit</i>
                    <span>Edit Goal</span>
                </div>
                <div class="ios-menu-item toggle-state" style="color: ${isExcluded ? '#3b82f6' : '#ef4444'}" onclick="window.toggleGoalInclusion('${id}')">
                    <i class="material-icons">${isExcluded ? 'check_circle_outline' : 'block'}</i>
                    <span>${isExcluded ? 'Include' : 'Exclude'}</span>
                </div>
                <div class="ios-menu-item danger" onclick="window.confirmDeleteGoal()">
                    <i class="material-icons">delete</i>
                    <span>Delete</span>
                </div>
            `;

            backdrop.style.display = 'block';
            overlay.style.display = 'flex';

            if (nav) nav.pushModalState('contextMenu', () => window.closeContextMenu());
            
            // Positioning Logic
            const rect = card.getBoundingClientRect();
            const menuWidth = 180;
            const menuHeight = 150; 

            let topPos, leftPos;
            const spaceBelow = window.innerHeight - rect.bottom;

            if (spaceBelow >= menuHeight + 12) {
                topPos = rect.bottom + 12;
            } else {
                topPos = rect.top - menuHeight - 12;
            }

            // Align to the right of the card
            leftPos = rect.right - menuWidth;
            leftPos = Math.max(12, Math.min(leftPos, window.innerWidth - menuWidth - 24));

            menu.style.top = `${topPos}px`;
            menu.style.left = `${leftPos}px`;
            menu.style.width = `${menuWidth}px`;

            setTimeout(() => {
                backdrop.classList.add('show');
                overlay.classList.add('show');
                menu.classList.add('show');
            }, 10);

            if (window.navigator.vibrate) window.navigator.vibrate(60);
        }

        window.openGoalEdit = function() {
            if (window.selectedGoalId) {
                window.location.href = 'edit-goal.html?id=' + window.selectedGoalId;
            }
        }

        window.closeContextMenu = function() {
            const overlay = document.getElementById('contextMenuOverlay');
            const backdrop = document.getElementById('contextMenuBackdrop');
            const menu = document.getElementById('iosMenu');
            
            overlay.classList.remove('show');
            backdrop.classList.remove('show');
            menu.classList.remove('show');
            document.querySelectorAll('.goal-card').forEach(c => c.classList.remove('popped'));
            
            if (nav) nav.popModalState('contextMenu');

            setTimeout(() => {
                overlay.style.display = 'none';
                backdrop.style.display = 'none';
            }, 300);
        }

        window.openEditModal = function() {
            window.closeContextMenu();
            const goal = goals.find(g => g.id === window.selectedGoalId);
            if (!goal) return;
            
            document.getElementById('editGoalTitle').value = goal.title;
            document.getElementById('editGoalTarget').value = goal.targetAmount;
            selectedIcon = goal.icon || 'savings';
            
            renderIconGrid('editIconGrid');
            window.renderIconGrid('editIconGrid', selectedIcon);
            const modal = document.getElementById('editModal');
            modal.style.display = 'flex';
            if (nav) nav.pushModalState('editModal', () => modal.style.display = 'none');
        }

        window.renderIconGrid = function(gridId, selectedVal) {
            const grid = document.getElementById(gridId);
            if (!grid) return;
            
            grid.innerHTML = '';
            AVAILABLE_ICONS.forEach(icon => {
                const item = document.createElement('div');
                item.className = `icon-item ${selectedIcon === icon.id ? 'active' : ''}`;
                item.onclick = () => {
                    selectedIcon = icon.id;
                    // Hide custom image preview if an icon is selected
                    const preview = document.getElementById('customImagePreview');
                    if(preview) preview.style.display = 'none';
                    
                    window.renderIconGrid(gridId, selectedIcon);
                };
                
                item.innerHTML = `
                    <div class="icon-item-box" style="background: ${icon.bg}; color: ${icon.color};">
                        <i class="material-icons">${icon.icon}</i>
                    </div>
                    <span class="icon-item-label">${icon.label}</span>
                `;
                grid.appendChild(item);
            });
        };

        window.handleImageUpload = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Info = e.target.result;
                selectedIcon = base64Info; // Store base64 string as the icon
                
                const preview = document.getElementById('customImagePreview');
                if (preview) {
                    preview.src = base64Info;
                    preview.style.display = 'block';
                }
                
                // Clear active state from grid
                const grid = document.getElementById('addIconGrid');
                if (grid) {
                   const activeItems = grid.querySelectorAll('.icon-item.active');
                   activeItems.forEach(el => el.classList.remove('active'));
                }
            };
            reader.readAsDataURL(file);
        };    
        
        window.selectIcon = function(iconId, containerId) {
            selectedIcon = iconId;
            window.renderIconGrid(containerId, selectedIcon);
        }

        window.saveEditedGoal = async function() {
            const title = document.getElementById('editGoalTitle').value;
            const target = parseFloat(document.getElementById('editGoalTarget').value.replace(/,/g, ''));
            
            if (!title || isNaN(target)) return;
            
            try {
                const goalRef = doc(db, `users/${currentUser.uid}/goals`, selectedGoalId);
                await updateDoc(goalRef, {
                    title: title,
                    targetAmount: target,
                    icon: selectedIcon,
                    updatedAt: serverTimestamp()
                });
                
                window.closeModals();
                loadGoals();
            } catch (error) {
                console.error("Error editing goal:", error);
            }
        }

        window.confirmDeleteGoal = function() {
            window.closeContextMenu();
            const modal = document.getElementById('deleteModal');
            modal.style.display = 'flex';
            if (nav) nav.pushModalState('deleteModal', () => modal.style.display = 'none');
        }

        window.confirmDeleteActual = async function() {
            if (!selectedGoalId || !currentUser) return;
            try {
                await deleteDoc(doc(db, `users/${currentUser.uid}/goals`, selectedGoalId));
                window.closeModals();
                loadGoals();
            } catch (error) {
                console.error("Error deleting goal:", error);
            }
        }

        window.closeModals = function() {
            document.querySelectorAll('.modal-overlay').forEach(m => {
                if (m.style.display === 'flex') {
                    if (nav) nav.popModalState(m.id);
                    m.style.display = 'none';
                }
            });
            selectedGoalId = null;
        }

        window.toggleProfileDropdown = function(e) {
            if (e) e.stopPropagation();
            document.getElementById('profile-dropdown').classList.toggle('active');
        }

        window.onclick = (e) => {
            if (!e.target.closest('.profile-container')) {
                const dropdown = document.getElementById('profile-dropdown');
                if (dropdown) dropdown.classList.remove('active');
            }
            if (e.target.classList.contains('modal-overlay')) window.closeModals();
            if (e.target.classList.contains('context-menu-wrapper')) closeContextMenu();
        }

        // Local Storage Caching
        function getCachedGoals() {
            const cached = localStorage.getItem(`goals_${currentUser?.uid}`);
            return cached ? JSON.parse(cached) : null;
        }

        function setCachedGoals(data) {
            if (currentUser) {
                localStorage.setItem(`goals_${currentUser.uid}`, JSON.stringify(data));
            }
        }

        // Authentication & Initialization
        // Initialize Privacy Mode
        function initPrivacyMode() {
            const isPrivacyActive = localStorage.getItem('wallet_privacy_mode') === 'true';
            const wrapper = document.querySelector('.mobile-wrapper');
            const icon = document.getElementById('privacy-icon');
            
            if (isPrivacyActive && wrapper) {
                wrapper.classList.add('privacy-active');
                if (icon) icon.innerText = 'visibility_off';
                // Delay slightly to ensure content is in DOM
                setTimeout(applyPrivacyMasking, 100);
            }
        }

        // Helper function to naturally mask numbers (5,200  ****)
        function maskNumber(text) {
            if (!text) return text;
            // Uniform masking for everything: just 4 asterisks, no currency/percent
            return '****';
        }

        function applyPrivacyMasking() {
            const elements = document.querySelectorAll('.summary-value, .goal-balance, .milestone-amount, .txn-amount, .goal-amount, .goal-percent');
            elements.forEach(el => {
                // Store original value if not already stored
                if (!el.hasAttribute('data-original')) {
                    el.setAttribute('data-original', el.innerHTML);
                }
                el.innerHTML = maskNumber(el.getAttribute('data-original'));
            });
        }

        function removePrivacyMasking() {
            const elements = document.querySelectorAll('.summary-value, .goal-balance, .milestone-amount, .txn-amount, .goal-amount, .goal-percent');
            elements.forEach(el => {
                if (el.hasAttribute('data-original')) {
                    el.innerHTML = el.getAttribute('data-original');
                }
            });
        }

        window.togglePrivacy = (e) => {
            if (e) e.stopPropagation();
            const wrapper = document.querySelector('.mobile-wrapper');
            const icon = document.getElementById('privacy-icon');
            const isActive = wrapper.classList.toggle('privacy-active');
            
            localStorage.setItem('wallet_privacy_mode', isActive);
            if (icon) icon.innerText = isActive ? 'visibility_off' : 'visibility';
            
            // Apply or remove masking
            if (isActive) {
                applyPrivacyMasking();
            } else {
                removePrivacyMasking();
            }
            
            // Haptic Feedback
            if (navigator.vibrate) navigator.vibrate(10);
        };

        onAuthStateChanged(auth, async (user) => {
            initPrivacyMode();
            if (user && !user.isAnonymous) {
                currentUser = user;
                loadSafeSpendConfig(); // Fetch dynamic results
                
                // Extract full first name (first 2 words)
                const fullName = user.displayName || 'User';
                const parts = fullName.trim().split(/\s+/);
                const displayName = parts.length >= 2 ? `${parts[0]} ${parts[1]}` : parts[0];
                
                const nameEl = document.getElementById('user-display-name');
                if (nameEl) nameEl.textContent = displayName;
                
                // Update profile picture
                const badge = document.getElementById('profile-badge');
                const picEl = document.getElementById('user-pic');
                if (picEl && user.photoURL) {
                    picEl.src = user.photoURL;
                    picEl.style.display = 'block';
                    if (badge) badge.classList.add('has-pic');
                }

                // Initial load from cache for speed
                const cached = getCachedGoals();
                if (cached) {
                    goals = cached;
                    renderGoals();
                } else {
                    // Show skeleton if no cache
                    const skeleton = document.getElementById('goals-skeleton');
                    if (skeleton) skeleton.style.display = 'block';
                }

                // Always fetch fresh from Firestore
                await loadGoals();
                
                // Save to NavState for persistence across pages
                if (window.NavState) {
                    window.NavState.saveProfile(fullName, user.photoURL || '', user.email);
                }

                // Check for URL messages
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('msg')) {
                    const msg = urlParams.get('msg');
                    if (msg === 'updated') window.showToast('Goal updated successfully');
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            } else {
                // PERSISTENCE FIX: Wait a moment for session to restore before kicking to login
                const lastAuthType = localStorage.getItem('wallet_auth_type');
                if (lastAuthType === 'google') {
                    console.log(' Protected Page: Waiting for Google session to restore...');
                    setTimeout(() => {
                        if (!auth.currentUser) {
                            console.log(' Session lost. Redirecting to login.');
                            window.location.href = 'index.html';
                        }
                    }, 3000); // 3 second grace period for protected pages
                } else {
                    window.location.href = 'index.html';
                }
            }
        });

        window.handleSignout = async function() {
            if (confirm('Sign out?')) {
                try {
                    localStorage.clear();
                    await auth.signOut();
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error("Signout error:", error);
                }
            }
        };

        async function loadGoals() {
            if (!currentUser) return;
            try {
                const goalsRef = collection(db, `users/${currentUser.uid}/goals`);
                const querySnapshot = await getDocs(goalsRef);
                goals = [];
                querySnapshot.forEach((doc) => {
                    goals.push({ id: doc.id, ...doc.data() });
                });
                // Sort by custom order first, then fallback to createdAt
                goals.sort((a, b) => (a.order ?? 999) - (b.order ?? 999) || (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                
                // Update cache
                setCachedGoals(goals);
                
                renderGoals();
                initSortable();

                // Simply fade out skeleton and show content instantly
                setTimeout(() => {
                    const goalsSkeleton = document.getElementById('goals-skeleton');
                    const summarySkeleton = document.getElementById('summarySkeleton');
                    
                    // Fade out skeletons
                    if (goalsSkeleton) goalsSkeleton.style.opacity = '0';
                    if (summarySkeleton) summarySkeleton.style.opacity = '0';
                    
                    // After skeleton fade completes, remove them and show content instantly
                    setTimeout(() => {
                        if (goalsSkeleton) goalsSkeleton.style.display = 'none';
                        if (summarySkeleton) summarySkeleton.style.display = 'none';
                        
                        // Show content instantly (no fade-in animation)
                        document.querySelectorAll('.summary-card, .forecast-card, .goal-card').forEach((el) => {
                            el.style.opacity = '1';
                            el.style.display = 'flex';
                        });
                    }, 500); // Wait for skeleton fade out
                }, 100);
            } catch (error) {
                console.error("Error loading goals:", error);
            }
        }

        function renderGoals() {
            const container = document.getElementById('goalsContainer');
            const totalSummary = document.getElementById('totalSummary');
            const forecastCard = document.getElementById('forecastSkeleton');
            
            const summarySkeleton = document.getElementById('summarySkeleton');
            
            // Remove skeleton class if we have data
            if (summarySkeleton) summarySkeleton.style.display = 'none';
            totalSummary.style.display = 'flex';
            
            if (forecastCard) {
                forecastCard.style.height = 'auto';
            }

            if (goals.length === 0) {
                totalSummary.innerHTML = `
                    <div style="flex: 1; text-align: center;">
                        <div class="summary-label">Set your first goal to track progress</div>
                        <div class="summary-value">0.00</div>
                    </div>
                `;
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                        <div style="font-size: 64px; margin-bottom: 16px;"></div>
                        <h3 style="color: var(--text-primary); margin-bottom: 8px;">No goals yet</h3>
                        <p style="font-size: 14px; line-height: 1.5;">Start your financial journey by adding your first goal. Whether it's an emergency fund or a dream vacation!</p>
                        <button class="modal-btn primary-btn" style="width: auto; padding: 12px 24px; margin-top: 20px;" onclick="openAddModal()">Add Your First Goal</button>
                    </div>
                `;
                totalSummary.style.display = 'none';
                if (forecastCard) forecastCard.style.display = 'none';
                return;
            }

            // Normal state
            totalSummary.style.display = 'flex';
            if (forecastCard) forecastCard.style.display = 'flex';
            container.innerHTML = '';

            // Update Summary Card HTML
            totalSummary.innerHTML = `
                <div class="progress-ring-container">
                    <svg width="90" height="90" viewBox="0 0 90 90">
                        <circle class="progress-ring-track" stroke="var(--accent-soft)" stroke-width="8" fill="transparent" r="36" cx="45" cy="45"/>
                        <circle class="progress-ring-circle" id="summaryRing" stroke="var(--accent-color)" stroke-width="8" stroke-linecap="round" fill="transparent" r="36" cx="45" cy="45" stroke-dasharray="226.2" stroke-dashoffset="226.2"/>
                    </svg>
                    <div class="progress-percentage" id="summaryPercent" style="color: var(--text-primary)">0%</div>
                </div>
                <div class="summary-info">
                    <div class="privacy-toggle" onclick="togglePrivacy(event)">
                        <i class="material-icons" id="privacy-icon">visibility</i>
                    </div>
                    <div class="summary-label">Total Goal Balance</div>
                    <div class="summary-value" id="total-goal-balance">0.00</div>
                </div>
            `;
            updateSummary();
            renderGoalsActualPart();
        }

        window.updateSummary = function() {
            if (!goals) return;
            const includedGoals = goals.filter(g => g.isExcluded !== true);
            const totalSaved = includedGoals.reduce((sum, g) => sum + (g.currentAmount || 0), 0);
            const totalTarget = includedGoals.reduce((sum, g) => sum + (g.targetAmount || 0), 0);
            const overallPercent = totalTarget > 0 ? Math.round((totalSaved / totalTarget) * 100) : 0;

            const balEl = document.getElementById('total-goal-balance');
            if (balEl) {
                balEl.innerHTML = `${totalSaved.toLocaleString()}<span class="summary-target">/ ${totalTarget.toLocaleString()}</span>`;
            }
            
            const pctEl = document.getElementById('summaryPercent');
            if (pctEl) pctEl.innerText = `${overallPercent}%`;
            
            const circle = document.getElementById('summaryRing');
            if (circle) {
                const radius = 36;
                const circumference = 2 * Math.PI * radius;
                circle.style.strokeDashoffset = circumference - (Math.min(100, overallPercent) / 100 * circumference);
            }

            const remaining = includedGoals.reduce((sum, g) => sum + Math.max(0, g.targetAmount - (g.currentAmount || 0)), 0);
            updateForecast(remaining);
        }

        function initSortable() {
            const el = document.getElementById('goalsContainer');
            if (!window.Sortable || !el) return;
            if (el.sortable) el.sortable.destroy();
            el.sortable = new Sortable(el, {
                animation: 150,
                handle: '.goal-icon-box',
                ghostClass: 'sortable-ghost',
                onEnd: async function() {
                    const items = el.querySelectorAll('.goal-card');
                    const updates = [];
                    items.forEach((item, index) => {
                        const id = item.getAttribute('data-id');
                        const goal = goals.find(g => g.id === id);
                        if (goal) {
                            goal.order = index;
                            updates.push(updateDoc(doc(db, `users/${currentUser.uid}/goals`, id), { order: index }));
                        }
                    });
                    try { await Promise.all(updates); window.showToast('New order saved'); } catch (e) { }
                }
            });
        }

        window.toggleGoalInclusion = async function(id) {
            if (!currentUser) return;
            window.closeContextMenu();
            const goal = goals.find(g => g.id === id);
            if (!goal) return;
            const newState = !(goal.isExcluded === true);
            try {
                await updateDoc(doc(db, `users/${currentUser.uid}/goals`, id), { isExcluded: newState });
                goal.isExcluded = newState;
                renderGoals();
                
                // Re-apply fade-in to updated list
                document.querySelectorAll('.goal-card').forEach((el, i) => el.classList.add('fade-in'));
                
                window.showToast(newState ? 'Goal excluded from total' : 'Goal included in total');
            } catch (e) { }
        }

        function renderGoalsActualPart() { // Helper to not mess up renderGoals
            const container = document.getElementById('goalsContainer');
            const forecastCard = document.getElementById('forecastSkeleton');
            if (!container) return;

            // Update Forecast Card HTML
            if (forecastCard && (forecastCard.classList.contains('skeleton') || forecastCard.style.background.includes('rgba(224, 236, 255'))) {
                forecastCard.classList.remove('skeleton');
                forecastCard.style.height = 'auto'; 
                forecastCard.style.background = ''; // Use CSS gradient from class or default
                forecastCard.style.boxShadow = '0 10px 25px rgba(59, 130, 246, 0.1)';
                forecastCard.style.border = '1px solid rgba(147, 197, 253, 0.3)';
                forecastCard.innerHTML = `
                    <div class="forecast-icon" style="background: #fff; width: 36px; height: 36px; border-radius: 10px;">
                        <i class="material-icons" style="font-size: 20px; color: #4f46e5;">auto_awesome</i>
                    </div>
                    <div class="forecast-text" id="timeForecast" style="font-size: 11px; color: #1e3a8a;">
                        Analyzing your <b>Cash Flow</b>...
                    </div>
                `;
            }

            let totalCurrent = 0;
            let totalTarget = 0;

            goals.forEach(goal => {
                const percent = goal.targetAmount > 0 ? Math.min(100, Math.round(((goal.currentAmount || 0) / goal.targetAmount) * 100)) : 0;
                const isExcluded = goal.isExcluded === true;
                
                if (!isExcluded) {
                    totalCurrent += goal.currentAmount || 0;
                    totalTarget += goal.targetAmount || 0;
                }
                
                const card = document.createElement('div');
                card.className = `goal-card ${isExcluded ? 'excluded' : ''}`;
                card.setAttribute('data-id', goal.id);
                
                const iconConfig = getIconConfig(goal.icon || 'savings');
                
                // Handle custom image vs icon for the icon box
                const iconBoxContent = iconConfig.customImage 
                    ? `<img src="${iconConfig.customImage}" style="width: 100%; height: 100%; border-radius: inherit; object-fit: cover;" alt="Goal icon">`
                    : `<i class="material-icons">${iconConfig.icon}</i>`;

                card.innerHTML = `
                    <div class="goal-icon-box" 
                         style="background: ${iconConfig.bg}; color: ${iconConfig.color}; cursor: grab; overflow: hidden;"
                         oncontextmenu="return false;">
                        ${iconBoxContent}
                    </div>
                    <div class="goal-center" onclick="window.handleCardClick('${goal.id}')">
                        <div class="goal-title">
                            ${goal.title}
                            ${goal.isAtome ? '<span class="atome-shield-badge">Shield</span>' : ''}
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" style="width: ${percent}%;"></div>
                        </div>
                    </div>
                    <div class="goal-right" onclick="window.handleCardClick('${goal.id}')">
                        <div class="goal-amount">${(goal.currentAmount || 0).toLocaleString()}</div>
                        <div class="goal-percent">${percent}% / ${goal.targetAmount.toLocaleString()}</div>
                    </div>
                `;
                container.appendChild(card);
                
                // Event Handling for Context Menu (Long press on card, not icon)
                card.addEventListener('mousedown', (e) => {
                    if (e.target.closest('.goal-icon-box')) return;
                    window.startPress(e, goal.id);
                });
                card.addEventListener('touchstart', (e) => {
                    if (e.target.closest('.goal-icon-box')) return;
                    window.startPress(e, goal.id);
                }, {passive: true});
                card.addEventListener('mouseup', window.cancelPress);
                card.addEventListener('touchend', window.cancelPress);
                card.addEventListener('mouseleave', window.cancelPress);
            });
            
            updateSummary();
            
            // Apply privacy masking if active
            const isPrivacyActive = localStorage.getItem('wallet_privacy_mode') === 'true';
            if (isPrivacyActive) {
                applyPrivacyMasking();
            }
        }

        // Icon Design System Helper - Professional Material Icons
        function getIconConfig(type) {
            // Check if it's a custom image (base64 or URL)
            if (type && (type.startsWith('data:') || type.startsWith('http'))) {
                return { icon: null, bg: '#f8fafc', color: '#64748b', customImage: type };
            }
            
            // Find in available icons
            const found = AVAILABLE_ICONS.find(i => i.id === type);
            if (found) {
                return { icon: found.icon, bg: found.bg, color: found.color };
            }
            
            // Fallback
            return { icon: 'savings', bg: '#f0fdf4', color: '#00851F' };
        }

        async function loadSafeSpendConfig() {
            if (!currentUser) return;
            try {
                const configRef = doc(db, "users", currentUser.uid, "config", "safe_to_spend");
                const configSnap = await getDoc(configRef);
                if (configSnap.exists()) {
                    const data = configSnap.data();
                    if (data.savingsAmount) {
                        dynamicMonthlySavings = parseFloat(data.savingsAmount);
                        console.log(" Dynamic savings loaded:", dynamicMonthlySavings);
                        // Trigger recalculation if goals already loaded
                        window.updateSummary();
                    }
                }
            } catch (e) {
                console.error("Error loading safe_to_spend config:", e);
            }
        }

        function updateForecast(remaining) {
            const el = document.getElementById('timeForecast');
            if (!el) return;
            if (remaining <= 0) {
                el.innerHTML = `<b>Congratulations!</b> You have reached all your goals! `;
                return;
            }
            if (dynamicMonthlySavings <= 0) {
                el.innerHTML = `Set a <b>Monthly Savings</b> goal in your dashboard to see completion forecasts.`;
                return;
            }

            const monthsToComplete = Math.ceil(remaining / dynamicMonthlySavings);
            const targetDate = new Date();
            targetDate.setMonth(targetDate.getMonth() + monthsToComplete);
            el.innerHTML = `
                Based on your <b>${dynamicMonthlySavings.toLocaleString()}/mo</b> savings,<br>
                estimated completion is <b>${targetDate.toLocaleString('default', { month: 'long' })} ${targetDate.getFullYear()}</b>.
            `;
        }

        window.saveGoal = async function() {
            const title = document.getElementById('goalTitle').value;
            const target = parseFloat(document.getElementById('goalTarget').value.replace(/,/g, ''));

            if (!title || !target) return alert('Please fill in all fields');
            if (!currentUser) return;

            try {
                const newGoal = {
                    title: title, icon: selectedIcon, currentAmount: 0, targetAmount: target,
                    createdAt: serverTimestamp()
                };
                await addDoc(collection(db, `users/${currentUser.uid}/goals`), newGoal);
                document.getElementById('goalTitle').value = '';
                document.getElementById('goalTarget').value = '';
                window.closeModals();
                window.showToast('Goal created successfully');
                await loadGoals();
            } catch (error) {
                console.error("Error saving goal:", error);
            }
        }

        window.deleteGoal = async function(id) {
            if (!confirm("Are you sure you want to delete this goal?")) return;
            if (!currentUser) return;
            try {
                await deleteDoc(doc(db, `users/${currentUser.uid}/goals`, id));
                window.showToast('Goal deleted');
                await loadGoals();
            } catch (error) {
                console.error("Error deleting goal:", error);
            }
        }

        document.getElementById('confirmDepositBtn').onclick = async () => {
            const amount = parseFloat(document.getElementById('depositAmount').value.replace(/,/g, ''));
            if (!amount || amount <= 0 || !currentUser || !selectedGoalId) return;
            try {
                const goalRef = doc(db, `users/${currentUser.uid}/goals`, selectedGoalId);
                const goal = goals.find(g => g.id === selectedGoalId);
                if (goal) {
                    await updateDoc(goalRef, { currentAmount: (goal.currentAmount || 0) + amount });
                    
                    // Record Transaction History
                    await addDoc(collection(db, `users/${currentUser.uid}/goals/${selectedGoalId}/transactions`), {
                        amount: amount,
                        type: 'deposit',
                        timestamp: serverTimestamp()
                    });

                    if (window.confetti) {
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#00851F', '#ffffff'] });
                    }
                    document.getElementById('depositAmount').value = '';
                    window.closeModals();
                    window.showToast(`${amount.toLocaleString()} deposited!`);
                    await loadGoals();
                }
            } catch (error) {
                console.error("Error updating deposit:", error);
            }
        };

        // ===== NAVIGATION STATE & PULL-TO-REFRESH INITIALIZATION =====
        
        // Initialize pull-to-refresh
        let startY = 0;
        let currentY = 0;
        // MODERN MATERIAL DESIGN PULL-TO-REFRESH
        (function() {
            const spinner = document.getElementById('ptrSpinner');
            const circle = spinner ? spinner.querySelector('.ptr-circle') : null;
            const mobileWrapper = document.querySelector('.mobile-wrapper') || document.body;
            let startY = 0;
            let pulling = false;
            let isRefreshing = false;
            const pullThreshold = 100; // Distance needed to trigger refresh
            const maxPull = 140; // Maximum pull distance
            
            if (!spinner || !circle) return;
            
            mobileWrapper.addEventListener('touchstart', (e) => {
                if (isRefreshing) return;
                if (mobileWrapper.scrollTop <= 0) {
                    startY = e.touches[0].clientY;
                    pulling = true;
                }
            }, { passive: true });
            
            mobileWrapper.addEventListener('touchmove', (e) => {
                if (!pulling || isRefreshing || mobileWrapper.scrollTop > 0) return;
                
                const currentY = e.touches[0].clientY;
                const pullDistance = Math.max(0, currentY - startY);
                
                if (pullDistance > 10) {
                    e.preventDefault();
                    
                    // Calculate progress with resistance (diminishing returns)
                    const resistance = 0.5;
                    const resistedPull = Math.min(pullDistance * resistance, maxPull);
                    const progress = Math.min(pullDistance / pullThreshold, 1);
                    
                    // Show spinner dropping down
                    spinner.classList.add('visible');
                    spinner.style.transform = `translateY(${resistedPull - 60}px) scale(${0.6 + progress * 0.4}) rotate(${pullDistance * 2}deg)`;
                    
                    // Animate the SVG circle stroke
                    const dashOffset = 60 - (progress * 45); // Fill from 0 to ~75%
                    circle.style.strokeDashoffset = dashOffset;
                    circle.style.transform = `rotate(${pullDistance * 3}deg)`;
                }
            }, { passive: false });
            
            mobileWrapper.addEventListener('touchend', () => {
                if (!pulling || isRefreshing) return;
                pulling = false;
                
                const currentTransform = spinner.style.transform;
                const yMatch = currentTransform.match(/translateY\(([^p]+)px\)/);
                const currentY = yMatch ? parseFloat(yMatch[1]) : -80;
                
                if (currentY > 30) {
                    // Trigger refresh!
                    isRefreshing = true;
                    
                    // Haptic feedback
                    if (navigator.vibrate) navigator.vibrate([10, 30, 10]);
                    
                    // Animate to refreshing state
                    spinner.classList.add('refreshing');
                    circle.style.strokeDashoffset = '';
                    circle.style.transform = '';
                    
                    // Trigger sync
                    console.log(' Pull-to-refresh: Syncing goals');
                    
                    // Force a fresh fetch from Firestore
                    if (typeof loadGoals === 'function') {
                        loadGoals();
                    } else {
                        window.location.reload();
                    }
                    
                    // Hide after delay
                    setTimeout(() => {
                        spinner.classList.remove('refreshing', 'visible');
                        spinner.style.transform = '';
                        circle.style.strokeDashoffset = '60';
                        isRefreshing = false;
                    }, 1800);
                } else {
                    // Cancel - spring back
                    spinner.classList.remove('visible');
                    spinner.style.transform = '';
                    circle.style.strokeDashoffset = '60';
                    circle.style.transform = '';
                }
            });
        })();
        // Initialize NavState features
        if (window.NavState) {
            window.NavState.loadProfile();
            window.NavState.loadCardColor();
            
            // Setup navigation scroll-top behavior
            const navLinks = document.querySelectorAll('.bottom-nav a, .nav-item a');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    const href = link.getAttribute('href');
                    if (href === 'goals.html' || href === './goals.html') {
                        e.preventDefault();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    } else if (href) {
                        window.NavState.saveScrollPosition('goals.html');
                    }
                });
            });
            
            window.NavState.restoreScrollPosition('goals.html');
            
            window.NavState.quickInit('goals.html', () => {
                // Initial load handled by auth state
            });
        }
    </script>
    </div> <!-- Close mobile-wrapper -->
</body>
</html>
