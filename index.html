<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SmartWallet Sync - MUI HTML</title>
    
    <!-- Material UI CSS & Premium Fonts -->
    <link href="https://cdn.muicss.com/mui-0.10.3/css/mui.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1d4ed8">

    <style>
        * { box-sizing: border-box; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none; touch-action: manipulation; }
        html, body { background: #f0f2f5; margin: 0; padding: 0; min-height: 100vh; display: flex; justify-content: center; font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; touch-action: manipulation; }
        
        /* Mobile Wrapper with PC Scroll Simulation */
        .mobile-wrapper { width: 100%; max-width: 430px; background: #fff; min-height: 100vh; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow-x: hidden; overflow-y: auto; }
        @media (min-width: 431px) {
            .mobile-wrapper { height: 100vh; overflow-y: scroll; }
        }

        #header { padding: 30px 24px 10px; display: flex; align-items: center; justify-content: space-between; background: #fff; }
        .greeting-section { line-height: 1.2; }
        .greeting-text { font-size: 11px; color: #94a3b8; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; }
        .user-name { font-size: 24px; font-weight: 800; color: #1e293b; }
        
        #profile-badge { width: 42px; height: 42px; border-radius: 50%; background: #f1f5f9; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #profile-badge img { width: 100%; height: 100%; object-fit: cover; display: none; }
        #profile-badge i { font-size: 24px; color: #94a3b8; display: block; }
        #profile-badge.has-pic i { display: none; }
        #profile-badge.has-pic img { display: block; }

        /* PROFILE DROPDOWN MENU */
        .profile-container { position: relative; }
        .profile-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.12);
            min-width: 200px;
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 2000;
            border: 1px solid #f1f5f9;
            padding: 6px;
        }
        .profile-dropdown.active { display: flex; animation: dropIn 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes dropIn { from { opacity: 0; transform: translateY(-10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .dropdown-item {
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13.5px;
            font-weight: 700;
            color: #475569;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s;
        }
        .dropdown-item:hover { background: #f8fafc; color: #1e293b; }
        .dropdown-item i { font-size: 20px; color: #94a3b8; }
        .dropdown-item.logout { color: #ef4444; margin-top: 4px; border-top: 1px solid #f1f5f9; border-radius: 0 0 10px 10px; }
        .dropdown-item.logout i { color: #ef4444; }
        .dropdown-header { padding: 10px 14px 6px; font-size: 11px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }

        /* ATM CARD STYLE (RICH BLACK - REALISTIC) */
        .balance-card { 
            margin: 20px 24px; 
            padding: 24px 24px 20px 24px;
            background: linear-gradient(135deg, #1c1c1e 0%, #000000 100%); 
            border-radius: 24px; /* Slightly tighter radius for realism */
            color: #fff; 
            position: relative; 
            overflow: hidden; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), inset 0 0 0 1px rgba(255, 255, 255, 0.1); 
            min-height: 210px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        /* Matte Texture Overlay */
        .balance-card::before { 
            content: ''; 
            position: absolute; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
            opacity: 0.6;
            pointer-events: none;
            mix-blend-mode: overlay;
        }

        /* Subtle Spotlight */
        .balance-card::after {
            content: '';
            position: absolute;
            top: -50%; right: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 60%);
            pointer-events: none;
            transform: rotate(-15deg);
        }

        /* Generated EMV Chip */
        .card-chip {
            width: 42px;
            height: 32px;
            background: linear-gradient(135deg, #e2cba6 0%, #d4af37 50%, #b8860b 100%);
            border-radius: 6px;
            position: relative;
            margin-bottom: 20px;
            margin-top: 15px;
            box-shadow: inset 0 1px 2px rgba(255,255,255,0.2), 0 1px 2px rgba(0,0,0,0.2);
        }
        .card-chip::before {
            content: '';
            position: absolute;
            top: 50%; left: 0; width: 100%; height: 1px;
            background: rgba(0,0,0,0.2);
            box-shadow: 0 -8px 0 rgba(0,0,0,0.2), 0 8px 0 rgba(0,0,0,0.2);
        }
        .card-chip::after {
            content: '';
            position: absolute;
            left: 50%; top: 15%; width: 1px; height: 70%;
            background: rgba(0,0,0,0.2);
            box-shadow: -10px 0 0 rgba(0,0,0,0.2), 10px 0 0 rgba(0,0,0,0.2);
            border-radius: 4px; /* Soften lines a bit */
        }

        /* Wifi Icon (Contactless) */
        .contactless-icon {
            position: absolute;
            top: 28px;
            right: 28px;
            color: rgba(255,255,255,0.5);
            transform: rotate(90deg);
            font-size: 24px;
        }

        /* Concentric Circles - Removed for cleaner 'less obvious' look as requested */
        .card-bg-circles { display: none; } 

        .card-label { font-size: 10px; font-weight: 700; color: rgba(255,255,255,0.5); margin-bottom: 2px; text-transform: uppercase; letter-spacing: 1.5px; }
        /* Fixed Balance - Inter/System font for numbers looks better */
        .balance-amount { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 30px; font-weight: 800; letter-spacing: -1px; margin-bottom: auto; text-shadow: 0 4px 8px rgba(0,0,0,0.3); padding-top: 4px; }
        
        /* Footer area pushed to bottom */
        .card-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 12px; position: relative; z-index: 2; }
        
        .card-number-box { line-height: 1.4; }
        .card-number-label { font-size: 9px; font-weight: 700; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 2px; }
        .card-number { font-size: 13px; font-weight: 700; color: rgba(255,255,255,0.9); letter-spacing: 3px; font-family: monospace; }
        
        .mastercard-circles { display: flex; position: relative; width: 44px; height: 28px; }
        .circle { width: 28px; height: 28px; border-radius: 50%; position: absolute; }
        .circle-1 { background: rgba(255,255,255,0.2); left: 0; backdrop-filter: blur(2px); }
        .circle-2 { background: rgba(255,255,255,0.15); left: 16px; backdrop-filter: blur(2px); }

        /* INTEGRATED SYNC BAR - Glassmorphic Pill */
        .card-sync-bar { 
            background: rgba(255,255,255,0.05); 
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 12px; 
            padding: 10px 14px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-size: 11px; 
            font-weight: 600; 
            color: rgba(255,255,255,0.8); 
            border: 1px solid rgba(255,255,255,0.08); 
            margin-top: 10px; 
            transition: all 0.3s; 
            position: relative;
            z-index: 2;
            width: 100%;
        }
        .card-sync-bar.active { background: rgba(255,255,255,0.1); }
        .card-sync-bar .dot { width: 6px; height: 6px; border-radius: 50%; background: #4caf50; box-shadow: 0 0 6px rgba(76, 175, 80, 0.5); }
        .card-sync-bar.syncing .dot { background: #1d4ed8; box-shadow: 0 0 8px rgba(29, 78, 216, 0.6); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.3); } 100% { opacity: 1; transform: scale(1); } }

        .mui-container { width: 100%; max-width: 100% !important; margin: 0; padding: 0 24px 100px; }
        .control-panel { padding: 0; margin-bottom: 24px; background: transparent; box-shadow: none; }
        .status-labels { display: flex; gap: 10px; margin-bottom: 20px; }
        .status-chip { font-size: 11px; padding: 4px 10px; border-radius: 12px; border: 1px solid #e2e8f0; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-ready { border-color: #4caf50; color: #2e7d32; background: #f0fdf4; }
        .status-local { border-color: #f59e0b; color: #b45309; background: #fffbeb; }

        .sticky-banner { 
            position: fixed;
            top: 100px; /* Below header */
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 48px);
            max-width: 380px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: #1e293b; 
            z-index: 999; 
            display: none; 
            align-items: center; 
            justify-content: space-between; 
            padding: 12px 16px; 
            border-radius: 20px;
            border: 1px solid rgba(245, 158, 11, 0.3);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
        }
        .banner-pill-btn { 
            background: #1e293b; 
            color: #fff; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 12px; 
            font-weight: 700; 
            font-size: 12px; 
            cursor: pointer; 
            transition: all 0.2s; 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        .banner-pill-btn:hover { background: #0f172a; transform: scale(1.05); }
        .banner-btn:active { transform: translateY(0) scale(0.98); }
        .local-nudge { animation: amberPulse 2s infinite; }
        @keyframes amberPulse { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }

        /* ACCORDION */
        .month-accordion { margin-bottom: 16px; background: #fff; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #eef2f6; transition: box-shadow 0.2s; position: relative; }
        .month-accordion:hover { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .month-header { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; -webkit-user-select: none; user-select: none; }
        .month-header:hover { background: #f8fafc; }
        .month-header .month-title { font-weight: 700; font-size: 0.85rem; color: #1e293b; }
        .month-header .month-total { font-weight: 800; color: #1d4ed8; font-size: 0.85rem; }
        .month-header .expand-icon { transition: transform 0.3s; color: #64748b; }
        .month-header.collapsed .expand-icon { transform: rotate(-90deg); }
        
        .month-content { border-top: 1px solid #f1f5f9; max-height: 5000px; transition: max-height 0.4s ease; position: relative; z-index: 10; }
        .month-content.collapsed { max-height: 0; overflow: hidden; border-top: none; }

        /* TRANSACTION ITEM - PREMIUM REDESIGN */
        .txn-item { padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f8fafc; position: relative; transition: all 0.2s; background: #fff; }
        .txn-item:last-child { border-bottom: none; }
        .txn-item:hover { background-color: #f8fafc; }
        
        .txn-left { display: flex; align-items: center; gap: 15px; flex: 1; }
        .txn-icon-box { min-width: 48px; width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative; }
        .txn-icon-box i { font-size: 22px; }
        
        /* CATEGORY COLORS */
        .cat-online { background-color: #fff7ed; color: #f97316; } /* Orange */
        .cat-vehicle { background-color: #f5f3ff; color: #8b5cf6; } /* Purple */
        .cat-shopping { background-color: #dbeafe; color: #1d4ed8; } /* Soft Blue bg, Blue icon for Shopping */
        .cat-services { background-color: #f0fdf4; color: #22c55e; } /* Green - General Services */
        .cat-service-magenta { background-color: #fdf2f9; color: #d946ef; } /* Magenta - Telco/Specific Service */
        .cat-food { background-color: #fefce8; color: #eab308; } /* Yellow/Gold */
        .cat-life { background-color: #ecfdf5; color: #10b981; } /* Emerald */
        .cat-financial { background-color: #fef2f2; color: #ef4444; } /* Red */
        .cat-trading { background-color: #fff1f2; color: #ef4444; } /* Red - Trading */
        .cat-aqua { background-color: #ecfeff; color: #0891b2; } /* Dark Aqua/Cyan - Trade Copier */
        .cat-investments { background-color: #f0fdfa; color: #0d9488; } /* Teal/Dark Green */
        .cat-school { background-color: #eff6ff; color: #1d4ed8; } /* Blue */
        .cat-red { background-color: #fef2f2; color: #ef4444 !important; } /* Force Red for Financial */
        
        .txn-info { display: flex; flex-direction: column; }
        .txn-merchant { font-weight: 700; font-size: 0.95rem; color: #1e293b; margin-bottom: 3px; letter-spacing: -0.2px; }
        .txn-subtitle { font-size: 0.8rem; color: #64748b; font-weight: 500; display: flex; align-items: center; gap: 4px; }
        .txn-dot { font-size: 14px; opacity: 0.5; }
        
        .txn-right { display: flex; align-items: center; gap: 8px; }
        .txn-amount { font-weight: 800; font-size: 1rem; color: #0f172a; white-space: nowrap; }

        /* EXCLUDED STATE - Only fade content, keep actions clear */
        .txn-item.txn-excluded .txn-left,
        .txn-item.txn-excluded .txn-amount { opacity: 0.35; filter: grayscale(1); text-decoration: line-through; }
        
        /* HOVER ACTION */
        .txn-actions { opacity: 0; transition: opacity 0.2s; position: relative; z-index: 60; }
        .txn-item:hover .txn-actions { opacity: 1; }
        .action-btn { background: none; border: none; cursor: pointer; color: #94a3b8; padding: 4px; border-radius: 50%; display: flex; align-items: center; }
        .action-btn:hover { background: #f1f5f9; color: #475569; }
        
        /* DROPDOWN MENU */
        .dropdown-menu { display: none; position: absolute; right: 0; top: 100%; background: #fff; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); border-radius: 8px; z-index: 100; border: 1px solid #e2e8f0; padding: 4px 0; }
        .dropdown-menu.show { display: block; }
        .dropdown-item { padding: 10px 16px; font-size: 13px; color: #475569; display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600; white-space: nowrap; }
        .dropdown-item:hover { background: #f1f5f9; }
        .dropdown-item.danger { color: #ef4444; }
        .dropdown-item.danger:hover { background: #fef2f2; }

        /* CATEGORY COLORS */
        .cat-online { background: #ffedd5; color: #f97316; }
        .cat-shopping { background: #dbeafe; color: #3b82f6; }
        .cat-vehicle { background: #ede9fe; color: #8b5cf6; } 
        .cat-food { background: #fef9c3; color: #eab308; }
        .cat-life { background: #d1fae5; color: #10b981; } 
        .cat-service-magenta { background: #fce7f3; color: #d946ef; }
        .cat-aqua { background: #cffafe; color: #06b6d4; }
        .cat-trading { background: #fee2e2; color: #ef4444; }
        .cat-financial { background: #fee2e2; color: #ef4444; }
        .cat-education { background: #eff6ff; color: #1d4ed8; }
        .cat-income { background: #dcfce7; color: #16a34a; }

        /* MODAL STYLES */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-overlay.show { display: flex; }
        .custom-modal { background: #fff; width: 92%; max-width: 380px; border-radius: 20px; padding: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); animation: modalIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes modalIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header { font-size: 1.1rem; font-weight: 700; color: #0f172a; margin-bottom: 4px; }
        .modal-body { margin-bottom: 12px; }
        .cat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 16px; }
        .cat-option { border: 1px solid #e2e8f0; border-radius: 12px; padding: 8px; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; transition: all 0.2s; }
        .cat-option:hover { border-color: #1d4ed8; background: #eff6ff; }
        .cat-option.active { border-color: #1d4ed8; background: #eff6ff; box-shadow: 0 0 0 2px #1d4ed8; }
        .cat-option i { font-size: 24px; }
        .cat-option span { font-size: 12px; font-weight: 600; color: #475569; text-align: center; }
        .note-input { width: 100%; border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px 12px; font-size: 14px; min-height: 60px; resize: none; outline: none; transition: border-color 0.2s; color: #1e293b; }
        .note-input:focus { border-color: #1d4ed8; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 16px; margin-top: 8px; }
        .cancel-link { color: #1e293b; font-weight: 700; font-size: 13px; text-transform: uppercase; cursor: pointer; padding: 10px 16px; border-radius: 4px; transition: background 0.2s; }
        .cancel-link:hover { background: #f1f5f9; }

        /* NOTE DISPLAY - INLINE */
        .txn-note-inline { font-size: 11px; font-style: italic; max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; background: transparent !important; padding: 0 !important; }
        
        /* TOAST NOTIFICATION */
        
        /* TOAST NOTIFICATION */
        .toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 12px 24px; border-radius: 50px; font-size: 14px; font-weight: 600; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); z-index: 2000; display: flex; align-items: center; gap: 8px; opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .toast-container.show { opacity: 1; bottom: 30px; pointer-events: auto; }
        .toast-container i { color: #4ade80; }

        #log-container { background: #1e293b; color: #4ade80; padding: 15px; border-radius: 8px; font-family: 'Consolas', monospace; height: 140px; overflow-y: auto; font-size: 13px; margin-top: 30px; border: 1px solid #334155; line-height: 1.5; }
        .log-entry { margin-bottom: 6px; border-bottom: 1px solid #334155; padding-bottom: 4px; }
        .log-error { color: #f87171; font-weight: bold; }
        
        .loading-overlay { display: none; text-align: center; padding: 60px; color: #64748b; }
        .btn-sync { background-color: #1d4ed8; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s, transform 0.1s; }
        .btn-sync:hover { background-color: #2563eb; }
        .btn-sync:active { transform: scale(0.98); }
        .btn-sync:disabled { background-color: #94a3b8; cursor: not-allowed; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }

        /* PIE CHART STYLES - THICKER & MODERN */
        .chart-card { background: #fff; border-radius: 24px; padding: 24px; margin-bottom: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .chart-container { 
            position: relative; width: 220px; height: 220px; margin: 0 auto 24px; 
            filter: drop-shadow(0 0 15px rgba(29, 78, 216, 0.05)); 
        }
        
        .chart-segment {
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .chart-segment:hover {
            transform: scale(1.02);
        }
        .chart-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: #fff; width: 90px; height: 90px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: inset 0 4px 12px rgba(0,0,0,0.03); border: 4px solid #f8fafc; z-index: 10; pointer-events: none; gap: 2px; }
        .chart-center-label { font-size: 9px; color: #94a3b8; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; line-height: 1; margin: 0; }
        .chart-center-value { font-size: 16px; font-weight: 800; color: #0f172a; letter-spacing: -0.5px; line-height: 1; text-align: center; }
        
        /* Highlighted Transaction Styling */
        .premium-txn.highlight-txn { background-color: #f0fdf4 !important; border-left: 3px solid #4caf50; transition: background-color 0.3s; }
        
        /* Floating Chart Tooltip */
        #chart-tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(4px);
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            pointer-events: none;
            opacity: 0;
            transform: translate(-50%, -100%);
            transition: opacity 0.2s;
            z-index: 100;
            white-space: nowrap;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* SIMPLE LEGEND */
        .legend { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 15px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; color: #1e293b; font-weight: 600; }
        .legend-color { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; height: 75px; background: #fff; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-around; align-items: center; padding: 0 10px; z-index: 1000; box-shadow: 0 -5px 15px rgba(0,0,0,0.02); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #94a3b8; cursor: pointer; text-decoration: none; padding: 10px; transition: all 0.2s; }
        .nav-item:hover { text-decoration: none !important; color: #1d4ed8; }
        .nav-item.active { color: #1d4ed8; }
        .nav-item i { font-size: 24px; }
        .nav-item span { font-size: 11px; font-weight: 700; }

        /* FAB */
        .fab { position: fixed; bottom: 100px; right: calc(50% - 215px + 24px); width: 62px; height: 62px; border-radius: 50%; background: #1d4ed8; color: #fff; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(29, 78, 216, 0.3); z-index: 999; cursor: pointer; border: none; transition: transform 0.2s; }
        .fab:active { transform: scale(0.95); }
        .fab i { font-size: 32px; }
        
        @media (max-width: 430px) {
            .fab { right: 24px; }
            .bottom-nav { left: 0; transform: none; }
        }

        /* TREND CHART */
        .trend-card { background: #fff; border-radius: 20px; padding: 20px 24px 16px; margin-bottom: 24px; border: 1px solid #f1f5f9; box-shadow: 0 4px 20px rgba(0,0,0,0.02); }
        .trend-path { filter: drop-shadow(0 4px 6px rgba(29, 78, 216, 0.2)); }
        .trend-dot { fill: #fff; stroke: #1d4ed8; stroke-width: 2.5; }
        .trend-label { font-size: 10px; fill: #94a3b8; font-weight: 600; }
        
        /* RECENT ACTIVITIES PREMIUM LIST */
        .recent-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding: 0 4px; }
        .recent-header h3 { margin: 0; font-weight: 700; font-size: 13px; color: #64748b; text-transform: uppercase; letter-spacing: 1.2px; }
        .recent-header .see-all { color: #1d4ed8; font-size: 13px; font-weight: 800; text-decoration: none; text-transform: uppercase; }

        .premium-txn { padding: 12px 20px; display: flex; align-items: center; gap: 14px; border-bottom: 1px solid #f8fafc; background: #fff; }
        .premium-txn:last-child { border-bottom: none; }
        .premium-txn .icon-box { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; position: relative; }
        .premium-txn .txn-details { flex: 1; min-width: 0; }
        .premium-txn .txn-merch { font-weight: 800; color: #1e293b; letter-spacing: -0.3px; font-size: 12.5px; text-transform: uppercase; }
        .premium-txn .txn-sub { font-size: 11px; color: #94a3b8; font-weight: 500; }
        .premium-txn .txn-amount { font-weight: 800; color: #1e293b; text-align: right; font-size: 13px; }
        .premium-txn .txn-amount.large { color: #991b1b; }
        .premium-txn .txn-note { font-size: 11px; font-weight: 500; margin-top: 1px; }
        
        /* ACTIONS & DROPDOWN */
        .premium-txn .txn-actions { opacity: 1; z-index: 100; }
        .premium-txn .dropdown-menu { right: 0; top: 28px; }
        
        /* EXCLUDED STATE FOR PREMIUM TRANSACTIONS */
        .premium-txn.txn-excluded { opacity: 0.4; }
        .premium-txn.txn-excluded .txn-merch,
        .premium-txn.txn-excluded .txn-sub,
        .premium-txn.txn-excluded .txn-amount,
        .premium-txn.txn-excluded .txn-note { text-decoration: line-through; }
        .premium-txn.txn-excluded .icon-box { filter: grayscale(1); opacity: 0.5; }
        
        /* iOS-STYLE LONG-PRESS BLUR EFFECT */
        .blur-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; }
        .blur-overlay.active { display: block; }
        
        /* Global Blur for elements */
        .mobile-wrapper.blur-active { filter: blur(8px) brightness(0.9); -webkit-filter: blur(8px) brightness(0.9); transition: filter 0.3s; pointer-events: none; }
        .fab.blur-active, .bottom-nav.blur-active { filter: blur(10px) brightness(0.6); -webkit-filter: blur(10px) brightness(0.6); pointer-events: none; }
        
        /* Shadow for the elevated clone */
        .premium-txn.elevated-clone { position: fixed; z-index: 2001; background: #fff; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); transform: scale(1.02); pointer-events: auto; border: 1px solid rgba(0,0,0,0.05); }
        
        /* BRAND LOGO BADGE */
        .brand-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1.5px solid #fff;
            z-index: 10;
            overflow: hidden;
        }
        .brand-badge img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transform: scale(1.15);
        }

        .ios-action-menu { display: none; position: fixed; background: rgba(255,255,255,0.95); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); border-radius: 14px; padding: 4px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 2002; min-width: 180px; max-width: 200px; overflow: hidden; }
        .ios-action-menu.show { display: block; animation: menuSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes menuSlideIn { from { opacity: 0; transform: translateY(-10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        .ios-action-item { padding: 10px 14px; font-size: 13px; font-weight: 600; color: #1e293b; display: flex; align-items: center; gap: 8px; cursor: pointer; border-radius: 10px; transition: background 0.2s; -webkit-user-select: none; user-select: none; }
        .ios-action-item:hover { background: rgba(0,0,0,0.05); }
        .ios-action-item i { font-size: 18px; color: #3b82f6; }
        .ios-action-item.danger { color: #ef4444; }
        .ios-action-item.danger i { color: #ef4444; }
        .ios-action-item.warning { color: #f59e0b; }
        .ios-action-item.warning i { color: #f59e0b; }
    </style>
</head>
<body>

    <!-- CHART TOOLTIP -->
    <div id="chart-tooltip"></div>

    <div class="mobile-wrapper">
        <div id="header">
            <div class="greeting-section">
                <div class="greeting-text">GOOD MORNING</div>
                <div class="user-name" id="user-display-name">Guest</div>
            </div>
            <div class="profile-container">
            <div id="profile-badge" onclick="toggleProfileDropdown(event)">
                <i class="material-icons">person</i>
                <img id="user-pic" src="" alt="Profile">
            </div>
            <div id="profile-dropdown" class="profile-dropdown">
                <div class="dropdown-item" onclick="handleAuthClick()">
                    <i class="material-icons">sync</i>
                    <span>Google Sync</span>
                </div>
                <div class="dropdown-item logout" onclick="handleSignout()">
                    <i class="material-icons">logout</i>
                    <span>Log Out</span>
                </div>
            </div>
        </div>
        </div>

        <!-- RICH BLACK ATM CARD -->
        <div class="balance-card">
                <!-- Contactless Icon Removed -->
                <!-- EMV Chip Removed -->
                
                <div class="card-label">SPENDING BALANCE</div>
                <div class="balance-amount">PHP 0.00</div>
                
                <div class="card-footer">
                <div class="card-number-box">
                    <div class="card-number-label">Account Number</div>
                    <div class="card-number">**** **** 7312</div>
                </div>
                <div class="mastercard-circles">
                    <div class="circle circle-1"></div>
                    <div class="circle circle-2"></div>
                </div>
            </div>
            
            <!-- INTEGRATED SYNC BAR -->
            <div class="card-sync-bar" id="cardSyncBar">
                <div class="dot" id="syncDot"></div>
                <span id="syncStatusText">Gmail Synced</span>
            </div>
        </div>

        <div class="mui-container">
            <div class="control-panel">
                <div class="status-labels" style="justify-content: center; margin-bottom: 24px;">
                    <div id="gis-status" class="status-chip">GIS: Loading...</div>
                    <div id="db-status" class="status-chip">DB: Ready</div>
                </div>
                
                <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 30px;">
                    <button id="scan-btn" class="mui-btn mui-btn--flat" style="border-radius:20px; text-transform:none; font-weight:700; background:#f1f5f9; color:#475569;" onclick="handleScan(50)">
                        <i class="material-icons" style="font-size:18px; vertical-align:middle; margin-right:4px;">sync</i> Sync Gmail
                    </button>
                    <button class="mui-btn mui-btn--flat" style="border-radius:20px; text-transform:none; font-weight:700; background:#f1f5f9; color:#475569;" onclick="loadData()">History</button>
                </div>
            </div>

            <!-- EXPENSES STRUCTURE (WEB3 MODERN) -->
            <div id="chart-section" class="chart-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h3 style="margin: 0; font-size: 1.1rem; font-weight: 800; color: #1e293b; letter-spacing: -0.5px;">Expenses structure</h3>
                    <select id="chart-filter" onchange="filterChart()" class="mui-btn mui-btn--flat" style="font-size: 12px; font-weight: 600; color: #1e293b; background: #f8fafc; padding: 0 8px 0 12px; border-radius: 8px; height: 30px; text-transform: none; border: 1px solid #e2e8f0; outline: none; cursor: pointer; text-align: left; width: auto; min-width: 110px;">
                        <option value="today">Today</option>
                        <option value="this_month">This Month</option>
                        <option value="this_week">This Week</option>
                        <option value="last_week">Last Week</option>
                        <option value="first_15">First 15 of Month</option>
                        <option value="last_15">Last 15 of Month</option>
                        <option value="last_month">Last Month</option>
                        <option value="last_3_months">Last 3 Months</option>
                        <option value="last_6_months">Last 6 Months</option>
                        <option value="this_year">This Year</option>
                    </select>
                </div>

                <div style="display: flex; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <div style="font-size: 11px; color: #94a3b8; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Total Expenses</div>
                        <div style="font-size: 22px; font-weight: 800; color: #0f172a; letter-spacing: -0.5px;" id="expenses-total-summary">PHP 0.00</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 11px; color: #94a3b8; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">vs past period</div>
                        <div id="mom-growth-box" style="font-size: 22px; font-weight: 800; color: #ef4444; letter-spacing: -0.5px;"><span id="mom-growth"></span></div>
                    </div>
                </div>

                <div class="chart-container" id="chart-anim-container">
                    <svg id="pieChart" width="220" height="220" viewBox="0 0 240 240">
                        <g id="pieContent"></g>
                    </svg>
                    <div class="chart-center">
                        <div class="chart-center-label">TOTAL</div>
                        <div class="chart-center-value" id="chart-total-val">0</div>
                    </div>
                </div>
                <div id="chart-legend" class="legend">
                    <!-- Dynamic segments will go here -->
                </div>
            </div>

            <!-- TREND SECTION -->
            <div class="trend-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h3 style="margin: 0; font-size: 1.1rem; font-weight: 800; color: #1e293b;">Spending Trends</h3>
                    <select id="trend-filter" onchange="refreshTrendChart()" class="mui-btn mui-btn--flat" style="font-size: 11px; font-weight: 600; color: #1e293b; background: #f1f5f9; padding: 0 8px; border-radius: 6px; height: 26px; text-transform: none; border: none; outline: none; cursor: pointer;">
                        <option value="this_month" selected>This Month</option>
                        <option value="this_week">This Week</option>
                        <option value="last_3_months">Past 3 Months</option>
                        <option value="last_6_months">Past 6 Months</option>
                    </select>
                </div>
                <div style="height: 140px; width: 100%; position: relative; margin-bottom: 20px;">
                    <svg id="trendChart" width="100%" height="140" viewBox="0 0 400 140" preserveAspectRatio="none">
                        <defs>
                            <linearGradient id="trendGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#3b82f6; stop-opacity:0.1" />
                                <stop offset="100%" style="stop-color:#3b82f6; stop-opacity:0" />
                            </linearGradient>
                        </defs>
                        <path id="trendArea" d="" fill="url(#trendGradient)"></path>
                        <path id="trendPath" class="trend-path" d="" fill="none" stroke="#3b82f6" stroke-width="4" stroke-linecap="round"></path>
                        <g id="trendDots"></g>
                    </svg>
                    <div id="trend-labels" style="display: flex; justify-content: space-between; margin-top: 10px; padding: 0 5px;">
                        <span class="trend-label">Week 1</span>
                        <span class="trend-label">Week 2</span>
                        <span class="trend-label">Week 3</span>
                        <span class="trend-label">Week 4</span>
                    </div>
                </div>
                <div style="border-top: 1px dashed #e2e8f0; padding-top: 16px; display: flex; justify-content: space-between; align-items: center; padding-top: 16px;">
                    <span style="font-size: 13px; color: #64748b; font-weight: 600;">Period Total</span>
                    <span style="font-size: 1.1rem; font-weight: 800; color: #10b981;" id="trend-period-total">PHP 0.00</span>
                </div>
            </div>

            <div class="recent-header">
                <h3>Recent Transactions</h3>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="logo-toggle-wrapper" title="Toggle Brand Logos" onclick="toggleLogos()" style="background: #e0f2fe; padding: 4px 8px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                        <i class="material-icons" id="logo-toggle-icon" style="font-size: 16px; color: #0284c7;">visibility</i>
                        <span style="font-size: 11px; font-weight: 700; color: #0284c7;"></span>
                    </div>
                    <select id="txn-cat-filter" onchange="filterTxnList()" style="font-size: 10px; font-weight: 700; color: #64748b; background: #f8fafc; padding: 4px 8px; border-radius: 8px; border: 1px solid #e2e8f0; outline: none; cursor: pointer;">
                        <option value="all">All Items</option>
                    </select>
                </div>
            </div>

            <div id="loading-spinner" class="loading-overlay">
                <i class="material-icons spin" style="font-size: 48px; color: #1e293b;">sync</i>
            </div>

            <div id="history-container"></div>
            <div id="log-container"></div>
        </div>

        <button class="fab" onclick="openManualTxnModal()">
            <i class="material-icons">add</i>
        </button>

        <!-- BOTTOM NAV -->
        <div class="bottom-nav">
            <a href="index.html" class="nav-item active">
                <i class="material-icons">account_balance_wallet</i>
                <span>Wallet</span>
            </a>
            <a href="accounts.html" class="nav-item">
                <i class="material-icons">account_balance</i>
                <span>Accounts</span>
            </a>
            <a href="calendar.html" class="nav-item">
                <i class="material-icons">calendar_today</i>
                <span>Calendar</span>
            </a>
            <a href="goals.html" class="nav-item">
                <i class="material-icons">track_changes</i>
                <span>Goals</span>
            </a>
        </div>
    </div>

    <!-- iOS-STYLE BLUR OVERLAY (NOW AT BODY LEVEL) -->
    <div class="blur-overlay" id="blurOverlay" onclick="closeIOSMenu()"></div>
    <div class="ios-action-menu" id="iosActionMenu"></div>

    <script>
        // Global bridge for GIS callback to avoid module race condition
        window.gisLoaded = function() {
            if (window.initGISModule) window.initGISModule();
            else window.gisReadyPending = true;
        };
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, collection, serverTimestamp, getDocs, onSnapshot, query, orderBy, updateDoc, deleteDoc, deleteField, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBHDN0xLi98qjYYjUf2RDCn5gJK0dzTk_M",
            authDomain: "atome-wallet.firebaseapp.com",
            projectId: "atome-wallet",
            storageBucket: "atome-wallet.firebasestorage.app",
            messagingSenderId: "64186651619",
            appId: "1:64186651619:web:cd7d426cfb663aab6606d6",
            measurementId: "G-2SHWJ6S3Z3"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.closeModals = () => {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('show'));
        };


        // ENABLE OFFLINE PERSISTENCE
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                log('Persistence failed: Multiple tabs open');
            } else if (err.code == 'unimplemented') {
                log('Persistence not supported');
            }
        });

        // REGISTER SERVICE WORKER
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker Registered'))
                .catch(err => console.log('SW Registration Failed', err));
        }

        // GOOGLE AUTH CONSTANTS
        const CLIENT_ID = '64186651619-3eb9ki680f4c8q2g2mese3c8hhfur23b.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/userinfo.profile';
        let tokenClient;
        let accessToken = localStorage.getItem('g_access_token');
        let expiry = localStorage.getItem('g_token_expiry');

        if (window.location.search.includes('logout=true')) {
            // Force a deep reset on the first load after logout
            log('ðŸ§¹ Session purge complete. User isolated.', 'info');
        }

        // INITIALIZE APP
        window.addEventListener('DOMContentLoaded', async () => {
            log('SmartWallet Sync - v1.2 Active');
            const origin = window.location.origin;
            log('--- ðŸ›¡ï¸ FINAL AUTH FIX ---', 'warn');
            log('You see "Requested action is invalid" because your local server address is not authorized.', 'error');
            log('1. Go to Firebase Console > Authentication > Settings > Authorized Domains');
            log('2. Add BOTH "127.0.0.1" AND "localhost" to the list.', 'info');
            log('3. Current URL: ' + window.location.href);
            log('4. Ensure your server is running on ' + origin, 'info');
            log('-------------------------', 'warn');

            // 1. Immediate UI population from Cache
            const cachedName = localStorage.getItem('user_name');
            const cachedPic = localStorage.getItem('user_pic');
            if (cachedName) document.getElementById('user-display-name').innerText = cachedName;
            if (cachedPic) {
                const badge = document.getElementById('profile-badge');
                const picEl = document.getElementById('user-pic');
                picEl.src = cachedPic;
                badge.classList.add('has-pic');
            }
            
            // Safety: Check if GIS already loaded (async/defer race)
            if (typeof google !== 'undefined' && google.accounts) {
                window.gisLoaded();
            }
            
            // 2. Auth State Observer
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    log('Establishing secure local session...');
                    signInAnonymously(auth).catch(e => log('Local session error: ' + e.message, 'error'));
                    return;
                }

                const dbBadge = document.getElementById('db-status');
                dbBadge.innerText = user.isAnonymous ? 'Mode: Local (Unsynced)' : `Mode: Cloud (${user.email})`;
                dbBadge.className = 'status-chip ' + (user.isAnonymous ? 'status-local' : 'status-ready');
                log('Auth Detected: ' + (user.isAnonymous ? 'Guest' : user.email) + ' [UID: ' + user.uid + ']');
                if (!user.isAnonymous) log('Cloud Sync Active!', 'info');
                
                // Update Profile Dropdown Content
                const dropdown = document.getElementById('profile-dropdown');
                if (user.isAnonymous) {
                     dropdown.innerHTML = `
                        <div class="dropdown-header">Guest Session</div>
                        <div class="dropdown-item" onclick="handleAuthClick()">
                            <i class="material-icons">cloud_upload</i>
                            <span>Sign in with Google</span>
                        </div>
                     `;
                } else {
                     dropdown.innerHTML = `
                        <div class="dropdown-header">${user.email}</div>
                        <div class="dropdown-item" onclick="handleAuthClick()">
                            <i class="material-icons">swap_horiz</i>
                            <span>Switch Account</span>
                        </div>
                        <div class="dropdown-item logout" onclick="handleSignout()">
                            <i class="material-icons">logout</i>
                            <span>Log Out</span>
                        </div>
                     `;
                }

                if (user.isAnonymous) {
                     // Nudge to claim data
                     const profileBadge = document.getElementById('profile-badge');
                     profileBadge.style.border = '2px solid #f59e0b';
                     profileBadge.classList.add('local-nudge');
                     
                     // Create/Show Floating Pill
                     let banner = document.getElementById('local-banner');
                     if (!banner) {
                         banner = document.createElement('div');
                         banner.id = 'local-banner';
                         banner.innerHTML = `
                            <div style="display:flex; align-items:center; gap:10px;">
                                <i class="material-icons" style="color:#f59e0b; font-size:20px;">cloud_off</i>
                                <span style="font-size:12px; font-weight:800; color:#1e293b; letter-spacing:0.2px;">SYNC YOUR DATA</span>
                            </div>
                            <button onclick="handleAuthClick()" class="banner-pill-btn">SIGN IN</button>
                         `;
                         banner.className = 'sticky-banner';
                         const wrapper = document.querySelector('.mobile-wrapper');
                         if (wrapper) wrapper.prepend(banner);
                         else document.body.prepend(banner);
                     }
                     banner.style.display = 'flex';
                } else {
                     document.getElementById('profile-badge').style.border = 'none';
                     document.getElementById('profile-badge').classList.remove('local-nudge');
                     const banner = document.getElementById('local-banner');
                     if (banner) banner.style.display = 'none';
                }
                
                // Update Profile if synced
                if (!user.isAnonymous) {
                     document.getElementById('user-display-name').innerText = user.displayName?.split(' ')[0] || 'User';
                     if (user.photoURL) {
                         const picEl = document.getElementById('user-pic');
                         picEl.src = user.photoURL;
                         document.getElementById('profile-badge').classList.add('has-pic');
                     }
                }

                // Load Data for this UID
                await loadData();
                
                // Refresh global token state for handleScan
                accessToken = localStorage.getItem('g_access_token');
                expiry = localStorage.getItem('g_token_expiry');

                if (accessToken && expiry && Date.now() < parseInt(expiry)) {
                    // ADAPTIVE SYNC: Deep sync (400) if > 1 day, else Routine sync (25)
                    const lastDeepSync = localStorage.getItem('last_deep_sync');
                    const now = Date.now();
                    const dayInMs = 24 * 60 * 60 * 1000;
                    
                    if (!lastDeepSync || (now - parseInt(lastDeepSync)) > dayInMs) {
                        log('Initial deep sync (400 items)...');
                        setTimeout(() => {
                            handleScan(400);
                            localStorage.setItem('last_deep_sync', now);
                        }, 1000);
                    } else {
                        log('Routine quick sync (25 items)...');
                        setTimeout(() => handleScan(25), 1000);
                    }
                }
            });
        });

        // FETCH TRANSACTIONS FROM FIRESTORE (REAL-TIME LISTENER)
        window.unsubscribeSnapshot = null; // Store listener to detach later

        async function loadData() {
            const container = document.getElementById('history-container');
            const spinner = document.getElementById('loading-spinner');
            
            // If already listening, don't re-attach unless we are forcing a reset (handling logic elsewhere)
            // Ideally we clear it before calling loadData again if switching users.
            if (window.unsubscribeSnapshot) {
                window.unsubscribeSnapshot();
                window.unsubscribeSnapshot = null;
            }

            spinner.style.display = 'block';
            try {
                if (!auth.currentUser) return;
                const uid = auth.currentUser.uid;
                const isAnon = auth.currentUser.isAnonymous;
                
                const syncStatusText = document.getElementById('syncStatusText');
                if (syncStatusText) syncStatusText.innerText = isAnon ? 'Local Storage Only' : 'Cloud Live Sync';
                
                let q = query(collection(db, "users", uid, "transactions"), orderBy("date", "desc"));
                
                // DATA ISOLATION: Query ONLY the current user's path.
                // Replaced getDocs with onSnapshot
                window.unsubscribeSnapshot = onSnapshot(q, (snap) => {
                    let txns = [];
                    const batchUpdates = []; 

                    snap.docs.forEach(d => {
                        const data = d.data();
                        if (data.deleted) return; 

                        const t = { id: d.id, ...data };
                        txns.push(t);
                        
                        // PERSIST AUTOMATED FUEL NOTES (Only if missing)
                        if (!t.note) {
                            const mapped = getMerchantDisplay(t.merchant || '', t);
                            if (mapped.category === 'Vehicle') {
                                const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                                const autoNote = (amt > 250) ? "Car Refill" : "Motor Refill";
                                // Update locally for display
                                t.note = autoNote; 
                                // Silent background update to DB (doesn't trigger re-render loop if strictly checked)
                                // Note: Be careful with updateDoc triggering onSnapshot again. 
                                // Since we check !t.note, and we are setting it, it should stabilise.
                                updateDoc(doc(db, "users", uid, "transactions", t.id), { note: autoNote }); 
                            }
                        }
                    });
                    
                    // Store globally
                    window.allTxns = txns;

                    if (txns.length === 0) {
                        // EMPTY STATE
                        document.getElementById('expenses-total-summary').innerText = 'PHP 0.00';
                        document.getElementById('trend-period-total').innerText = 'PHP 0.00';
                        document.getElementById('chart-total-val').innerText = '0';
                        const balanceEl = document.querySelector('.balance-amount');
                        if (balanceEl) balanceEl.innerText = 'PHP 0.00';
                        
                        if (window.drawPieChart) window.drawPieChart([], 0);
                        if (window.drawTrendChart) window.drawTrendChart([]);

                        container.innerHTML = `
                            <div style="text-align:center; padding:60px 20px; color:#64748b; background: white; border-radius: 12px; border: 1px dashed #cbd5e1;">
                                <i class="material-icons" style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">inbox</i>
                                <p style="margin:0; font-weight: 500;">No transactions found.</p>
                                <p style="font-size: 13px; margin: 10px 0 0;">Click "Scan Gmail" to sync your Atome payments.</p>
                            </div>`;
                    } else {
                        renderHistory(txns);
                        // Persist filter
                        const savedFilter = localStorage.getItem('wallet_chart_filter') || 'this_month';
                        const filterEl = document.getElementById('chart-filter');
                        if (filterEl) {
                           filterEl.value = savedFilter;
                           filterChart();
                        }
                    }
                }, (error) => {
                    log('Snapshot Error: ' + error.message, 'error');
                });

                // Hide spinner immediately - don't wait for data to load
                spinner.style.display = 'none';

                window.highlightTransactions = (categoryName) => {
                    const items = document.querySelectorAll('.premium-txn');
                    items.forEach(item => {
                        item.classList.remove('highlight-txn');
                        const catElement = item.querySelector('.txn-sub span:last-child');
                        if (catElement && catElement.innerText === categoryName) {
                            item.classList.add('highlight-txn');
                        }
                    });
                    // Scroll to first highlighted
                    const first = document.querySelector('.highlight-txn');
                    if (first) first.scrollIntoView({ behavior: 'smooth', block: 'center' });
                };    
            } catch (e) { 
                log('Failed to load history: ' + e.message, 'error');
                spinner.style.display = 'none';
            }
        }
        window.loadData = loadData;

        // FILTERING LOGIC
        window.filterChart = () => {
            const filterEl = document.getElementById('chart-filter');
            const filter = filterEl.value;
            
            // Persist selection
            localStorage.setItem('wallet_chart_filter', filter);

            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const date = now.getDate();
            
            if (!window.allTxns) return;

            // Helper for week numbers
            const getWeek = (d) => {
                const onejan = new Date(d.getFullYear(), 0, 1);
                return Math.ceil((((d - onejan) / 86400000) + onejan.getDay() + 1) / 7);
            };

            const checkPeriod = (t, periodType, shift = 0) => {
                const d = new Date(t.date);
                const dYear = d.getFullYear();
                const dMonth = d.getMonth();
                const dDate = d.getDate();
                const dWeek = getWeek(d);
                const currentWeek = getWeek(now);

                if (periodType === 'today') {
                    // Current: Today (shift 0), Past: Yesterday (shift 1)
                    const target = new Date(now);
                    target.setDate(date - shift);
                    return dYear === target.getFullYear() && dMonth === target.getMonth() && dDate === target.getDate();
                }

                if (periodType === 'this_month') {
                    // Current (0): This Month, Past (1): Last Month
                    const targetMonth = (month - shift + 12) % 12;
                    const targetYear = year - Math.floor((12 - (month - shift) - 1) / 12); // Handle year wrap roughly, or simplified:
                    // Better:
                    const targetD = new Date(year, month - shift, 1);
                    return dMonth === targetD.getMonth() && dYear === targetD.getFullYear();
                }
                
                if (periodType === 'this_week') {
                     // Current (0): This week, Past (1): Last week
                     // Note: Simple logic assuming same year for simplicity or handling close year boundaries
                     if (shift === 0) return dWeek === currentWeek && dYear === year;
                     if (shift === 1) return dWeek === currentWeek - 1 && dYear === year;
                }
                
                if (periodType === 'last_week') {
                     // Current (0): Last week, Past (1): 2 weeks ago
                     if (shift === 0) return dWeek === currentWeek - 1 && dYear === year;
                     if (shift === 1) return dWeek === currentWeek - 2 && dYear === year;
                }

                if (periodType === 'first_15') {
                    // Current (0): <= 15th of THIS month
                    // Past (1): > 15th of PREVIOUS month
                    if (shift === 0) return dDate <= 15 && dMonth === month && dYear === year;
                    if (shift === 1) {
                        const prevMonthDate = new Date(year, month - 1, 1);
                        return dDate > 15 && dMonth === prevMonthDate.getMonth() && dYear === prevMonthDate.getFullYear();
                    }
                }
                
                if (periodType === 'last_15') {
                    // Current (0): > 15th of THIS month
                    // Past (1): <= 15th of THIS month
                    if (shift === 0) return dDate > 15 && dMonth === month && dYear === year;
                    if (shift === 1) return dDate <= 15 && dMonth === month && dYear === year;
                }
                
                if (periodType === 'last_month') {
                    // Current (0): Last month
                    // Past (1): 2 months ago
                    const targetDate = new Date(year, month - 1 - shift, 1);
                     return dMonth === targetDate.getMonth() && dYear === targetDate.getFullYear();
                }
                
                if (periodType === 'last_3_months') {
                    const limit = new Date(now);
                    limit.setMonth(limit.getMonth() - 3 - (shift * 3));
                    const upper = new Date(now);
                    if (shift > 0) upper.setMonth(upper.getMonth() - 3);
                    
                    return d >= limit && (shift === 0 || d < upper);
                }
                
                if (periodType === 'last_6_months') {
                    const limit = new Date(now);
                    limit.setMonth(limit.getMonth() - 6 - (shift * 6));
                    const upper = new Date(now);
                    if (shift > 0) upper.setMonth(upper.getMonth() - 6);
                    return d >= limit && (shift === 0 || d < upper);
                }
                
                if (periodType === 'this_year') {
                    return dYear === (year - shift);
                }
                
                return false;
            };

            const filtered = window.allTxns.filter(t => checkPeriod(t, filter, 0));
            const past = window.allTxns.filter(t => checkPeriod(t, filter, 1));
            
            const pastTotal = past.reduce((sum, t) => {
                 if (t.excluded || t.refund) return sum;
                 const mapped = getMerchantDisplay(t.merchant, t);
                 if (mapped.category === 'Income') return sum;
                 return sum + (t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0));
            }, 0);

            refreshChart(filtered, pastTotal);
        };

        // CHART LOGIC
        const categoryConfig = {
            'Online shopping': { color: '#f97316', class: 'cat-online' },
            'Vehicle': { color: '#8b5cf6', class: 'cat-vehicle' },
            'Shopping': { color: '#3b82f6', class: 'cat-shopping' },
            'Service': { color: '#d946ef', class: 'cat-service-magenta' },
            'Food & Drinks': { color: '#eab308', class: 'cat-food' },
            'Life & Entertainment': { color: '#10b981', class: 'cat-life' },
            'Trading Expenses': { color: '#ef4444', class: 'cat-trading' },
            'Trade Copier': { color: '#0891b2', class: 'cat-aqua' },
            'Financial Expenses': { color: '#ef4444', class: 'cat-financial' },
            'Transportation': { color: '#8b5cf6', class: 'cat-vehicle' },
            'Travel': { color: '#06b6d4', class: 'cat-aqua' },
            'Education': { color: '#1e40af', class: 'cat-shopping' }, /* Dark Blue */
            'Sport': { color: '#10b981', class: 'cat-life' },
            'Income': { color: '#16a34a', class: 'cat-income' } /* Green */
        };

        function refreshChart(txns, pastTotal = 0) {
            const chartSection = document.getElementById('chart-section');
            const totals = {};
            let grandTotal = 0;

            let incomeTotal = 0;
            let expenseTotal = 0;

            txns.forEach(t => {
                if (t.excluded || t.refund) return;
                const mapped = getMerchantDisplay(t.merchant, t);
                const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                let cat = mapped.category || 'Other';
                if (cat === 'Financial expenses') cat = 'Financial Expenses';
                if (cat === 'Trading expenses') cat = 'Trading Expenses';
                
                if (cat === 'Income') {
                    incomeTotal += amt;
                } else {
                    totals[cat] = (totals[cat] || 0) + amt;
                    expenseTotal += amt;
                }
            });
            
            grandTotal = expenseTotal; // Chart shows Expenses only

            // UPDATE WALLET BALANCE
            const balanceEl = document.querySelector('.balance-amount');
            if (balanceEl) {
                const balance = incomeTotal - expenseTotal;
                balanceEl.innerText = `PHP ${balance.toLocaleString(undefined, {minimumFractionDigits:2})}`;
            }

            // Always show progress even if zero
            chartSection.style.display = 'block';

            const segments = Object.entries(totals).map(([name, value]) => ({
                name,
                value,
                color: (categoryConfig[name] || categoryConfig['Other']).color,
                class: (categoryConfig[name] || categoryConfig['Other']).class
            })).sort((a, b) => b.value - a.value);

            // Update Summary Total
            const summaryTotalEl = document.getElementById('expenses-total-summary');
            if (summaryTotalEl) summaryTotalEl.innerText = `PHP ${grandTotal.toLocaleString(undefined, {minimumFractionDigits:2})}`;

            // Update Growth with passed pastTotal
            const growthEl = document.getElementById('mom-growth');
            const growthBox = document.getElementById('mom-growth-box');
            if (growthEl && growthBox) {
                if (pastTotal > 0) {
                    const diff = ((grandTotal - pastTotal) / pastTotal) * 100;
                    const diffAbs = Math.abs(Math.round(diff));
                    growthEl.innerText = `${diff >= 0 ? '+' : '-'}${diffAbs}%`;
                    growthBox.style.color = diff >= 0 ? '#ef4444' : '#10b981';
                } else {
                    growthEl.innerText = '+0%';
                    growthBox.style.color = '#94a3b8';
                }
            }
            
            drawPieChart(segments, grandTotal);
            
            // Update Center Label Default
            document.getElementById('chart-total-label').innerText = 'TOTAL';
            document.getElementById('chart-total-val').innerText = `â‚±${Math.round(grandTotal).toLocaleString()}`;
        }


        function drawTrendChart(txns) {
            const path = document.getElementById('trendPath');
            const area = document.getElementById('trendArea');
            const dots = document.getElementById('trendDots');
            const totalEl = document.getElementById('trend-period-total');
            const filterEl = document.getElementById('trend-filter'); // Correct ID for trend filter
            const filter = filterEl ? filterEl.value : 'this_month';
            
            if (!path || txns.length === 0) return;

            // Reset labels
            const labelsContainer = document.getElementById('trend-labels');
            if (labelsContainer) labelsContainer.innerHTML = '';

            const now = new Date();
            let periodTotal = 0;
            let dataPoints = [];
            let labels = [];

            if (filter === 'this_week') {
                // Group by Day (Sun-Sat) as requested
                dataPoints = [0,0,0,0,0,0,0];
                labels = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
                
                // Calculate Start of Week (Sunday)
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay()); // Go back to Sunday
                startOfWeek.setHours(0,0,0,0);

                txns.forEach(t => {
                    const d = new Date(t.date);
                    // Check exclusion, refund, and Income
                    const mappedTrn = getMerchantDisplay(t.merchant, t);
                    if (t.excluded || t.refund || d < startOfWeek || mappedTrn.category === 'Income') return; 

                    const diff = Math.floor((d - startOfWeek) / 86400000);
                    if (diff >= 0 && diff < 7) {
                        const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                        dataPoints[diff] += amt;
                        periodTotal += amt;
                    }
                });
            } else if (filter === 'last_6_months') {
                // Monthly View (6 Data Points)
                const monthsCount = 6;
                dataPoints = new Array(monthsCount).fill(0);
                
                // Generate labels (e.g. Jan, Feb)
                for (let i = monthsCount - 1; i >= 0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    labels.push(d.toLocaleString('default', { month: 'short' }));
                }

                const limitDate = new Date(now.getFullYear(), now.getMonth() - 5, 1); // Start of 6th month back

                txns.forEach(t => {
                    const d = new Date(t.date);
                    // Check exclusion, refund, and Income
                    const mappedTrn = getMerchantDisplay(t.merchant, t);
                    if (t.excluded || t.refund || d < limitDate || mappedTrn.category === 'Income') return;

                    // Calculate month difference
                    const monthDiff = (now.getFullYear() - d.getFullYear()) * 12 + (now.getMonth() - d.getMonth());
                    const idx = (monthsCount - 1) - monthDiff;
                    
                    if (idx >= 0 && idx < monthsCount) {
                        const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                        dataPoints[idx] += amt;
                        periodTotal += amt;
                    }
                });

            } else {
                // Default: Weekly Buckets (This Month: 4-5 weeks, 3M: 12 weeks)
                let weeksCount = 4;
                if (filter === 'last_3_months') weeksCount = 12;
                else if (filter === 'this_month') {
                    // Dynamic weeks in month
                    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    const used = firstDay.getDay() + lastDay.getDate();
                    weeksCount = Math.ceil(used / 7);
                }

                dataPoints = new Array(weeksCount).fill(0);
                
                let limitDate;
                if (filter === 'this_month') {
                     limitDate = new Date(now.getFullYear(), now.getMonth(), 1);
                } else {
                     limitDate = new Date(now);
                     limitDate.setDate(now.getDate() - (weeksCount * 7));
                }

                txns.forEach(t => {
                    const d = new Date(t.date);
                    // Check exclusion, refund, and Income
                    const mappedTrn = getMerchantDisplay(t.merchant, t);
                    if (t.excluded || t.refund || d < limitDate || mappedTrn.category === 'Income') return;
                    
                    let idx;
                    if (filter === 'this_month') {
                        // Week of the month (0-4)
                        const firstDay = new Date(d.getFullYear(), d.getMonth(), 1);
                        const dayOfWeek = firstDay.getDay(); // 0-6
                        const dayOfMonth = d.getDate();
                        const adjustedDate = dayOfMonth + dayOfWeek;
                        idx = Math.ceil(adjustedDate / 7) - 1;
                        if (idx >= weeksCount) idx = weeksCount - 1; // Clamp
                    } else {
                        // Rolling back from Now
                        const diffWeeks = Math.floor((now - d) / (7 * 86400000));
                        idx = (weeksCount - 1) - diffWeeks;
                    }

                    if (idx >= 0 && idx < weeksCount) {
                        const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                        dataPoints[idx] += amt;
                        periodTotal += amt;
                    }
                });

                // Labels
                for(let i=1; i<=weeksCount; i++) {
                    if (filter === 'this_month') {
                         labels.push(`Week ${i}`);
                    } else {
                        if (i % 4 === 1 || i === weeksCount) labels.push(`W${i}`);
                        else labels.push('');
                    }
                }
            }

            // Update Labels UI
            if (labelsContainer) {
                labels.forEach(l => {
                    const span = document.createElement('span');
                    span.className = 'trend-label';
                    // Simplify labels for small screens
                    span.innerText = l;
                    labelsContainer.appendChild(span);
                });
            }

            // Update Total
            totalEl.style.color = '#1d4ed8';
            totalEl.innerText = `PHP ${periodTotal.toLocaleString(undefined, {minimumFractionDigits:2})}`;

            const points = dataPoints;
            const max = Math.max(...points, 500) * 1.2;
            const w = 400;
            const h = 130; 
            const padding = 20; 
            const chartW = w - (padding * 2);
            const step = chartW / (points.length - 1 || 1);

            let d = "";
            let areaD = "";
            dots.innerHTML = '';

            const getPoint = (i) => {
                const x = padding + (i * step);
                const y = h - (points[i] / max) * h;
                return { x, y };
            };

            for (let i = 0; i < points.length; i++) {
                const p = getPoint(i);
                
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', p.x - step/2);
                rect.setAttribute('y', 0);
                rect.setAttribute('width', step);
                rect.setAttribute('height', h);
                rect.setAttribute('fill', 'transparent');
                rect.style.cursor = 'pointer';
                
                rect.onmouseenter = (e) => {
                    const tooltip = document.getElementById('chart-tooltip');
                    tooltip.innerHTML = `${labels[i] || 'Period'}<br><span style="color:#d1fae5">â‚±${Math.round(points[i]).toLocaleString()}</span>`;
                    tooltip.style.opacity = '1';
                    tooltip.style.left = `${e.pageX}px`;
                    tooltip.style.top = `${e.pageY - 10}px`;
                };
                rect.onmouseleave = () => document.getElementById('chart-tooltip').style.opacity = '0';
                dots.appendChild(rect);

                if (i === 0) {
                    d += `M ${p.x} ${p.y}`;
                    areaD += `M ${p.x} ${h} L ${p.x} ${p.y}`;
                } else {
                    const prev = getPoint(i - 1);
                    const cp1x = prev.x + (p.x - prev.x) / 2;
                    d += ` C ${cp1x} ${prev.y}, ${cp1x} ${p.y}, ${p.x} ${p.y}`;
                    areaD += ` C ${cp1x} ${prev.y}, ${cp1x} ${p.y}, ${p.x} ${p.y}`;
                }
            }

            const lastP = getPoint(points.length - 1);
            areaD += ` L ${lastP.x} ${h} Z`;
            path.setAttribute('d', d);
            area.setAttribute('d', areaD);
            path.setAttribute('stroke', '#1d4ed8'); 
        }

        function drawPieChart(segments, total) {
            const container = document.getElementById('chart-anim-container');
            const svgGroup = document.getElementById('pieContent');
            const legend = document.getElementById('chart-legend');
            const totalVal = document.getElementById('chart-total-val');
            
            svgGroup.innerHTML = '';
            legend.innerHTML = '';
            totalVal.innerText = total > 0 ? `â‚±${Math.round(total).toLocaleString()}` : "â‚±0";

            const centerX = 120; // Centered for the 240 viewBox
            const centerY = 120;
            const radius = 110; 
            const innerRadius = 70;
            let currentAngle = -90;
            
            // Handle Empty State (0 segments)
            if (segments.length === 0 || total === 0) {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', centerX);
                circle.setAttribute('cy', centerY);
                circle.setAttribute('r', radius);
                circle.setAttribute('fill', '#f1f5f9');
                svgGroup.appendChild(circle);
                
                legend.innerHTML = '<div style="font-size:12px; color:#94a3b8; font-weight:600; grid-column: span 2; text-align:center;">No data for this period</div>';
                return;
            }
            if (segments.length === 1) {
                const seg = segments[0];
                
                // Draw full donut
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                // Calculate d for full circle donut
                const d = [
                    `M ${centerX} ${centerY - radius}`,
                    `A ${radius} ${radius} 0 1 1 ${centerX} ${centerY + radius}`,
                    `A ${radius} ${radius} 0 1 1 ${centerX} ${centerY - radius}`,
                    `M ${centerX} ${centerY - innerRadius}`,
                    `A ${innerRadius} ${innerRadius} 0 1 0 ${centerX} ${centerY + innerRadius}`,
                    `A ${innerRadius} ${innerRadius} 0 1 0 ${centerX} ${centerY - innerRadius}`,
                    'Z'
                ].join(' ');

                path.setAttribute('d', d);
                path.setAttribute('fill', seg.color);
                path.setAttribute('fill-rule', 'evenodd');
                path.classList.add('chart-segment'); // Add animation
                path.style.cursor = 'pointer';
                path.onclick = () => {
                    document.getElementById('chart-total-label').innerText = seg.name;
                    document.getElementById('chart-total-val').innerText = `â‚±${Math.round(seg.value).toLocaleString()}`;
                    window.highlightTransactions(seg.name);
                };
                
                svgGroup.appendChild(path);
                
                // Legend
                const lItem = document.createElement('div');
                lItem.className = 'legend-item';
                lItem.innerHTML = `<div class="legend-color" style="background: ${seg.color}"></div><span>${seg.name}</span>`;
                legend.appendChild(lItem);
                
                return;
            }

            segments.forEach(seg => {
                const percent = (seg.value / total) * 100;
                if (percent < 0.5) return; 

                const angle = (seg.value / total) * 360;
                const endAngle = currentAngle + angle;

                const largeArc = angle > 180 ? 1 : 0;
                
                const x1 = centerX + radius * Math.cos((currentAngle * Math.PI) / 180);
                const y1 = centerY + radius * Math.sin((currentAngle * Math.PI) / 180);
                const x2 = centerX + radius * Math.cos((endAngle * Math.PI) / 180);
                const y2 = centerY + radius * Math.sin((endAngle * Math.PI) / 180);
                
                const ix1 = centerX + innerRadius * Math.cos((currentAngle * Math.PI) / 180);
                const iy1 = centerY + innerRadius * Math.sin((currentAngle * Math.PI) / 180);
                const ix2 = centerX + innerRadius * Math.cos((endAngle * Math.PI) / 180);
                const iy2 = centerY + innerRadius * Math.sin((endAngle * Math.PI) / 180);

                const d = [
                    `M ${x1} ${y1}`,
                    `A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2}`,
                    `L ${ix2} ${iy2}`,
                    `A ${innerRadius} ${innerRadius} 0 ${largeArc} 0 ${ix1} ${iy1}`,
                    'Z'
                ].join(' ');

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', d);
                path.setAttribute('fill', seg.color);
                path.setAttribute('stroke', '#fff');
                path.setAttribute('stroke-width', '4'); 
                path.style.transition = 'all 0.3s';
                
                // Interaction Events
                const showTooltip = (e) => {
                    const tooltip = document.getElementById('chart-tooltip');
                    tooltip.innerHTML = `${seg.name}<br><span style="color:#d1fae5">â‚±${Math.round(seg.value).toLocaleString()}</span>`;
                    tooltip.style.opacity = '1';
                    
                    // Logic to position tooltip near cursor
                    // We need to account for scrolling and absolute positioning
                    const rect = document.getElementById('pieChart').getBoundingClientRect();
                    // Because tooltip is fixed/absolute to body usually, or relative to container
                    // Let's rely on e.pageX/Y
                    tooltip.style.left = `${e.pageX}px`;
                    tooltip.style.top = `${e.pageY - 10}px`;
                };

                const hideTooltip = () => {
                    document.getElementById('chart-tooltip').style.opacity = '0';
                };

                path.onmouseenter = showTooltip;
                path.onmousemove = showTooltip;
                path.onmouseleave = hideTooltip;

                path.onclick = (e) => {
                    // Update Center Label
                    document.getElementById('chart-total-label').innerText = seg.name;
                    document.getElementById('chart-total-val').innerText = `â‚±${Math.round(seg.value).toLocaleString()}`;
                    window.highlightTransactions(seg.name);
                };
                
                svgGroup.appendChild(path);

                // Add to legend (Simple style)
                const lItem = document.createElement('div');
                lItem.className = 'legend-item';
                lItem.innerHTML = `
                    <div class="legend-color" style="background: ${seg.color}"></div>
                    <span>${seg.name}</span>
                `;
                legend.appendChild(lItem);

                currentAngle = endAngle;
            });

            // Animation trigger removed as requested (Visibility fix)
        }

        // RENDER ACCORDIONS
        function renderHistory(txns) {
            const container = document.getElementById('history-container');
            container.innerHTML = '';
            
            // refreshChart is now called via filterChart separately, but we still need trend
            drawTrendChart(txns);

            // Update ATM Card Balance - HARDCODED TO 0 AS REQUESTED
            const balanceEl = document.querySelector('.balance-amount');
            if (balanceEl) balanceEl.innerText = `PHP 0.00`;
            
            const groups = {};
            txns.forEach(t => {
                if (!t.date) return;

                const d = new Date(t.date);
                if (isNaN(d)) return;
                const key = d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                if (!groups[key]) groups[key] = { items: [], total: 0 };
                
                groups[key].items.push(t);
                // ONLY add to total if NOT excluded AND NOT Income AND NOT Refund
                const mappedSumCheck = getMerchantDisplay(t.merchant, t);
                if (!t.excluded && !t.refund && mappedSumCheck.category !== 'Income') {
                    const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                    groups[key].total += amt;
                }
            });

            const entries = Object.entries(groups);
            entries.forEach(([month, data], index) => {
                const accordion = document.createElement('div');
                accordion.className = 'month-accordion';
                
                const isFirst = index === 0;
                const header = document.createElement('div');
                header.className = `month-header ${!isFirst ? 'collapsed' : ''}`;
                header.innerHTML = `
                    <span class="month-title">${month}</span>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span class="month-total">â‚±${data.total.toLocaleString(undefined, {minimumFractionDigits:2})}</span>
                        <i class="material-icons expand-icon">expand_more</i>
                    </div>
                `;
                
                const content = document.createElement('div');
                content.className = `month-content ${!isFirst ? 'collapsed' : ''}`;
                
                data.items.forEach(t => {
                    const mapped = getMerchantDisplay(t.merchant, t);
                    const item = document.createElement('div');
                    // Prevent strikethrough for Income even if it might be technically excluded
                    const isIncome = mapped.category === 'Income';
                    const isRefund = t.refund || false;
                    // Don't strikethrough if it's Income or Refund
                    item.className = `premium-txn ${t.excluded && !isIncome && !isRefund ? 'txn-excluded' : ''}`;
                    const d = new Date(t.date);
                    const shortDate = d.toLocaleDateString('en-US', { day: '2-digit', month: 'short' });
                    const safeMerchant = (mapped.name).replace(/'/g, "\\'");
                    const amount = (t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0));
                    
                    // Automated Fuel Note Logic
                    let displayNote = t.note;
                    if (!displayNote) {
                        if (mapped.category === 'Vehicle') {
                            displayNote = (amount > 250) ? "Car Refill" : "Motor Refill";
                        }
                    }
                    
                    // INCOME OVERRIDES
                    let displayAmtColor = '';
                    let displayName = mapped.name;
                    let displayIconStyle = `background: ${mapped.catClass === 'cat-red' ? '#fee2e2' : ''}; color: ${mapped.catClass === 'cat-red' ? '#ef4444' : ''};`;
                    let refundChip = '';

                    // REFUND STYLING
                    if (t.refund) {
                        displayAmtColor = 'color: #f59e0b;'; // Gold
                        refundChip = '<span style="display: inline-block; background: #fef3c7; color: #d97706; font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 4px; margin-left: 6px; letter-spacing: 0.3px;">REFUNDED</span>';
                    }

                    if (mapped.category === 'Income') {
                        displayName = 'INCOME'; // Always name it INCOME
                        displayAmtColor = 'color: #16a34a;'; // Green Price
                        // Icon styling handled by cat-income class, but ensure overrides are clean
                    }

                    // LOGO DETECTION (Direct Injection)
                    const mUpper = mapped.name.toUpperCase();
                    let logo = null;
                    if (mUpper.includes('JOLLIBEE')) logo = 'logos/jollibee.png';
                    else if (mUpper.includes('MCDO') || mUpper.includes('MCDONALDS')) logo = 'logos/mcdo.png';
                    else if (mUpper.includes('SHELL')) logo = 'logos/shell.png';
                    else if (mUpper.includes('SHOPEE')) logo = 'logos/shopee.png';
                    else if (mUpper.includes('LAZADA')) logo = 'logos/lazada.jpg';
                    else if (mUpper.includes('GLOBE') || mUpper.includes('GOMO')) logo = 'logos/globe.png';
                    else if (mUpper.includes('SM') || mUpper.includes('SM STORE') || mUpper.includes('SM SUPERMARKET')) logo = 'logos/sm.png';
                    else if (mUpper.includes('SPOTIFY')) logo = 'logos/spotify.png';
                    else if (mUpper.includes('TIKTOK')) logo = 'logos/tiktokshop.png';
                    else if (mUpper.includes('TECFUEL') || mUpper.includes('TEC FUEL')) logo = 'logos/tecfuel.png';
                    else if (mUpper.includes('TRADERS')) logo = 'logos/tradersconnect.png';
                    else if (mUpper.includes('AYALA')) logo = 'logos/ayala.png';
                    else if (mUpper.includes('J AND L') || mUpper.includes('JANL')) logo = 'logos/jandlmall.png';
                    else if (mUpper.includes('MR DIY')) logo = 'logos/mrdiy.png';
                    else if (mUpper.includes('WATSONS')) logo = 'logos/watsons.png';
                    else if (mUpper.includes('METRO')) logo = 'logos/supermetro.png';
                    else if (mUpper.includes('SUPERMETRO')) logo = 'logos/supermetro.png';
                    else if (mUpper.includes('SEAOIL')) logo = 'logos/seaoil.png';
                    else if (mUpper.includes('PETRON')) logo = 'logos/petron.png';
                    else if (mUpper.includes('7/11')) logo = 'logos/711.png';
                    else if (mUpper.includes('7 11')) logo = 'logos/711.png';

                    const logoHTML = logo ? `<div class="brand-badge" style="display: ${typeof showLogos !== 'undefined' && showLogos ? 'flex' : 'none'}"><img src="${logo}"></div>` : '';

                    item.innerHTML = `
                        <div class="icon-box ${mapped.catClass}" style="${displayIconStyle} position: relative;">
                            <i class="material-icons">${mapped.icon}</i>
                            ${logoHTML}
                        </div>
                        <div class="txn-details" style="display: flex; flex-direction: column; gap: 2px;">
                            <div class="txn-merch" style="${mapped.category === 'Income' ? 'color: #16a34a;' : t.refund ? 'color: #f59e0b;' : ''}">${displayName}${refundChip}</div>
                            <div class="txn-sub">
                                <span>${shortDate}</span>
                                <span style="margin: 0 4px; opacity: 0.5;">â€¢</span>
                                <span>${displayCategoryName(mapped.category)}</span>
                            </div>
                            ${displayNote ? `<div class="txn-note" style="color: ${t.refund ? '#f59e0b' : (categoryConfig[mapped.category]?.color || '#94a3b8')}; opacity: 0.8;">${displayNote}</div>` : ''}
                        </div>
                        <div class="txn-right" style="display: flex; align-items: center; justify-content: flex-end;">
                            <div class="txn-amount ${amount >= 1000 ? 'large' : ''}" style="${displayAmtColor}">
                                â‚±${Math.abs(amount).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}
                            </div>
                        </div>
                    `;
                    
                    // Add long-press data attributes
                    item.dataset.txnId = t.id;
                    item.dataset.merchant = safeMerchant;
                    item.dataset.amount = amount;
                    item.dataset.excluded = t.excluded || false;
                    item.dataset.refund = t.refund || false;
                    item.dataset.category = mapped.category;
                    item.dataset.note = t.note || '';
                    
                    content.appendChild(item);
                });

                header.onclick = () => {
                    const isCollapsedNow = content.classList.toggle('collapsed');
                    header.classList.toggle('collapsed', isCollapsedNow);
                };
                
                accordion.appendChild(header);
                accordion.appendChild(content);
                container.appendChild(accordion);
            });
            
            // Setup long-press handlers after rendering
            setTimeout(() => setupLongPressHandlers(), 100);
        }

        // GOOGLE IDENTITY SERVICES
        function initGIS() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (resp) => {
                        if (resp.error) return log('Login failed: ' + resp.error, 'error');
                        accessToken = resp.access_token;
                        const expMs = Date.now() + (resp.expires_in * 1000);
                        localStorage.setItem('g_access_token', accessToken);
                        localStorage.setItem('g_token_expiry', expMs);
                        fetchUserProfile(accessToken);
                        handleScan(300);
                    },
                });
                const gisBadge = document.getElementById('gis-status');
                gisBadge.innerText = 'GIS: Ready';
                gisBadge.classList.add('status-ready');
            } catch (e) { log('GIS Init Error: ' + e.message, 'error'); }
        }

        // Expose init to global bridge
        window.initGISModule = initGIS;
        if (window.gisReadyPending) initGIS();

        async function fetchUserProfile(token) {
            try {
                const res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.name) {
                    const firstName = data.name.split(' ')[0];
                    document.getElementById('user-display-name').innerText = firstName;
                    
                    const badge = document.getElementById('profile-badge');
                    const picEl = document.getElementById('user-pic');
                    picEl.src = data.picture;
                    badge.classList.add('has-pic');
                    
                    // Cache for persistence
                    localStorage.setItem('user_name', firstName);
                    localStorage.setItem('user_pic', data.picture);
                }
            } catch (e) { log('Profile refresh fail: ' + e.message, 'error'); }
        }

        window.handleAuthClick = async () => {
            log('Starting Google Sign-In...');
            const prevUid = auth.currentUser?.uid;
            const isAnonymous = auth.currentUser?.isAnonymous;

            const provider = new GoogleAuthProvider();
            provider.addScope('https://www.googleapis.com/auth/gmail.readonly');
            
            try {
                log('Calling signInWithPopup... Browser should show a window.');
                const result = await signInWithPopup(auth, provider);
                log('Popup Result Received!');
                
                if (!result || !result.user) {
                    log('Popup closed, but no user data found.', 'error');
                    return;
                }
                
                log('Sign-in success! Email: ' + result.user.email);
                
                const credential = GoogleAuthProvider.credentialFromResult(result);
                if (credential) {
                    accessToken = credential.accessToken;
                    const expMs = Date.now() + 3600000; // Default 1 hour
                    localStorage.setItem('g_access_token', accessToken);
                    localStorage.setItem('g_token_expiry', expMs);
                    log('Google Access Token secured.');
                } else {
                    log('Warning: Google Credential not returned, Gmail sync might wait.', 'warn');
                }
                
                log('Sign-in successful.');
                
                const user = result.user;
                if (user.displayName) {
                    const firstName = user.displayName.split(' ')[0];
                    document.getElementById('user-display-name').innerText = firstName;
                    localStorage.setItem('user_name', firstName);
                }
                if (user.photoURL) {
                    const badge = document.getElementById('profile-badge');
                    const picEl = document.getElementById('user-pic');
                    picEl.src = user.photoURL;
                    badge.classList.add('has-pic');
                    localStorage.setItem('user_pic', user.photoURL);
                }

                /* DISABLED AUTO-MERGE FOR STRICT PRIVACY
                   Only sync what's in the specific user's folder.
                log('Checking for data to sync...');
                // ... (Migration logic removed)
                */
                log('Cloud account active. Loading isolated user data...');

                await loadData();
                handleScan(300);
            } catch (error) {
                log('Auth Error: ' + error.code, 'error');
                log('Message: ' + error.message, 'error');
                console.error('Detailed Auth Failure:', error);
                
                // Show high-visibility troubleshooter for common developer errors
                if (error.code === 'auth/invalid-action-code' || 
                    error.code === 'auth/unauthorized-domain' || 
                    error.code === 'auth/configuration-not-found' ||
                    error.message.includes('invalid action')) {
                    
                    const codeLabel = document.getElementById('auth-error-code');
                    if (codeLabel) {
                        codeLabel.innerText = error.code || 'Configuration Mismatch';
                        document.getElementById('auth-trouble-modal').classList.add('show');
                    }
                } else if (error.code === 'auth/popup-closed-by-user') {
                    showToast('Sign-in cancelled');
                } else {
                    showToast('Sign-in failed');
                }
            }
        };
        
        // PROFILE DROPDOWN LOGIC
        window.toggleProfileDropdown = (e) => {
            e.stopPropagation();
            const dropdown = document.getElementById('profile-dropdown');
            dropdown.classList.toggle('active');
        };

        // Close dropdown when clicking elsewhere
        window.addEventListener('click', (e) => {
            const dropdown = document.getElementById('profile-dropdown');
            if (dropdown && dropdown.classList.contains('active')) {
                const badge = document.getElementById('profile-badge');
                if (!badge.contains(e.target)) {
                    dropdown.classList.remove('active');
                }
            }
        });

        window.handleSignout = async () => {
            if (confirm('Sign out?')) {
                log('ðŸš¨ Initiating deep sign-out and data purge...');
                
                // Detach realtime listener
                if (window.unsubscribeSnapshot) {
                    window.unsubscribeSnapshot();
                    window.unsubscribeSnapshot = null;
                }

                localStorage.clear();
                window.allTxns = [];
                const historyContainer = document.getElementById('history-container');
                const logContainer = document.getElementById('log-container');
                if (historyContainer) historyContainer.innerHTML = '';
                if (logContainer) logContainer.innerHTML = '';
                
                try {
                    await auth.signOut();
                    // Hard reload to flush all memory states and clear persistence
                    window.location.href = window.location.origin + window.location.pathname + '?logout=true&t=' + Date.now();
                } catch (e) {
                    log('Sign out error: ' + e.message, 'error');
                }
            }
        };

        // GMAIL SCAN (OPTIMIZED WITH PARALLELISM)
        window.handleScan = async (limit) => {
            if (auth.currentUser?.isAnonymous) {
                if (confirm('Your data is currently in "Local Mode". Sign in with Google to sync notes and exclusions to the cloud?')) {
                    handleAuthClick();
                    return;
                }
            }

            const expiry = localStorage.getItem('g_token_expiry');
            const isExpired = !accessToken || !expiry || Date.now() > parseInt(expiry);
            
            if (isExpired) {
                log('Session expired. Prompting for re-authorization...');
                tokenClient.requestAccessToken({ prompt: '' }); // Request silent re-auth or prompt
                return; // The callback will trigger handleScan again
            }
            
            const btn = limit === 300 ? document.getElementById('scan-btn') : document.getElementById('deep-scan-btn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="material-icons spin" style="font-size:18px;">sync</i> Syncing...';
            const bar = document.getElementById('cardSyncBar');
            const statusText = document.getElementById('syncStatusText');
            if (bar) bar.classList.add('syncing');
            if (statusText) statusText.innerText = 'Scanning Gmail...';
            
            try {
                log(`Starting fast sync (Parallel processing)...`);
                let url = `https://gmail.googleapis.com/gmail/v1/users/me/messages?maxResults=${limit}&q=subject:"Transaction Confirmation" (from:Atome OR from:no-reply@atome.ph)`;
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${accessToken}` }});
                const data = await res.json();
                const msgs = data.messages || [];
                
                if (msgs.length === 0) {
                    log('No new transactions found.');
                } else {
                    log(`Parsing ${msgs.length} messages in parallel...`);
                    
                    // Parallel Processing with batches of 10
                    const batchSize = 10;
                    let savedCount = 0;
                    
                    for (let i = 0; i < msgs.length; i += batchSize) {
                        const batch = msgs.slice(i, i + batchSize);
                        const promises = batch.map(async (m) => {
                            try {
                                const detailRes = await fetch(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${m.id}`, { headers: { 'Authorization': `Bearer ${accessToken}` }});
                                const d = await detailRes.json();
                                const txn = parseAtomeEmail(d.snippet, d.internalDate);
                                if (txn) {
                                    if (!auth.currentUser) await signInAnonymously(auth);
                                    const uid = auth.currentUser.uid;
                                    await setDoc(doc(db, "users", uid, "transactions", txn.id), { ...txn, createdAt: serverTimestamp() }, { merge: true });
                                    return true;
                                }
                            } catch (err) { return false; }
                            return false;
                        });
                        
                        const results = await Promise.all(promises);
                        savedCount += results.filter(Boolean).length;
                        log(`Processed batch ${Math.floor(i/batchSize) + 1}...`);
                    }
                    
                    log(`Sync finished! ${savedCount} transactions processed.`);
                    // loadData(); // Removed for performance - Listener will auto-update
                }
            } catch (e) { log('Scan error: ' + e.message, 'error'); }
            finally {
              btn.disabled = false;
              btn.innerHTML = originalHTML;
              if (bar) bar.classList.remove('syncing');
              if (statusText) statusText.innerText = 'Gmail Synced';
            }
        };

        function parseAtomeEmail(text, ts) {
            const m = text.match(/payment of [^\d]*([\d,]+\.?\d*)\s+for\s+(.+?)\s+using/i);
            if (!m) return null;
            return {
                id: 'txn_' + ts,
                amount: parseFloat(m[1].replace(/,/g, '')),
                merchant: m[2].trim(),
                date: new Date(parseInt(ts)).toISOString().split('T')[0]
            };
        }

        // iOS-STYLE LONG-PRESS MENU
        let longPressTimer = null;
        let currentElevatedItem = null;
        let clonedItem = null;
        
        function setupLongPressHandlers() {
            document.querySelectorAll('.premium-txn').forEach(item => {
                // Remove old event listeners by cloning
                const newItem = item.cloneNode(true);
                item.parentNode.replaceChild(newItem, item);
                
                let startX, startY;
                
                const startLongPress = (e) => {
                    startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                    startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
                    
                    longPressTimer = setTimeout(() => {
                        showIOSMenu(newItem, e);
                    }, 500);
                };
                
                const cancelLongPress = (e) => {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                };
                
                const checkMove = (e) => {
                    const currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                    const currentY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                    const distance = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2));
                    
                    if (distance > 10) {
                        cancelLongPress();
                    }
                };
                
                newItem.addEventListener('mousedown', startLongPress);
                newItem.addEventListener('touchstart', startLongPress, { passive: true });
                newItem.addEventListener('mouseup', cancelLongPress);
                newItem.addEventListener('touchend', cancelLongPress);
                newItem.addEventListener('mousemove', checkMove);
                newItem.addEventListener('touchmove', checkMove, { passive: true });
                newItem.addEventListener('mouseleave', cancelLongPress);
            });
        }
        
        function showIOSMenu(item, event) {
            if (event.cancelable) event.preventDefault();
            
            const txnId = item.dataset.txnId;
            const merchant = item.dataset.merchant;
            const amount = parseFloat(item.dataset.amount);
            const isExcluded = item.dataset.excluded === 'true';
            const category = item.dataset.category;
            const note = item.dataset.note;
            
            // 1. Get exact position
            const rect = item.getBoundingClientRect();
            
            // 2. Hide original item
            currentElevatedItem = item;
            item.style.visibility = 'hidden';
            
            // 3. Create and position clone
            clonedItem = item.cloneNode(true);
            clonedItem.classList.add('elevated-clone');
            clonedItem.style.top = `${rect.top}px`;
            clonedItem.style.left = `${rect.left}px`;
            clonedItem.style.width = `${rect.width}px`;
            clonedItem.style.visibility = 'visible';
            clonedItem.onclick = closeIOSMenu; // Clicking clone also closes
            document.body.appendChild(clonedItem);
            
            // 4. Show blur and backdrop
            document.getElementById('blurOverlay').classList.add('active');
            document.querySelector('.mobile-wrapper').classList.add('blur-active');
            document.querySelector('.fab').classList.add('blur-active');
            document.querySelector('.bottom-nav').classList.add('blur-active');
            
            // 5. Build menu
            const menu = document.getElementById('iosActionMenu');
            const isRefund = item.dataset.refund === 'true';
            menu.innerHTML = `
                <div class="ios-action-item" onclick="handleIOSAction('edit', '${txnId}', '${merchant}', ${amount}, '${category}', \`${note.replace(/`/g, '\\`')}\`)">
                    <i class="material-icons">edit</i>
                    <span>Edit Transaction</span>
                </div>
                <div class="ios-action-item ${isExcluded ? '' : 'danger'}" onclick="handleIOSAction('exclude', '${txnId}', ${isExcluded}, '${merchant}')">
                    <i class="material-icons">${isExcluded ? 'add_circle' : 'block'}</i>
                    <span>${isExcluded ? 'Include' : 'Exclude'}</span>
                </div>
                <div class="ios-action-item warning" onclick="handleIOSAction('refund', '${txnId}', ${isRefund})">
                    <i class="material-icons">${isRefund ? 'undo' : 'sync_alt'}</i>
                    <span>${isRefund ? 'Unmark Refund' : 'Mark as Refund'}</span>
                </div>
                <div class="ios-action-item danger" onclick="handleIOSAction('delete', '${txnId}')">
                    <i class="material-icons">delete</i>
                    <span>Delete</span>
                </div>
            `;
            
            // 6. Position menu
            menu.classList.add('show'); // Show briefly to get offsetHeight
            const menuHeight = menu.offsetHeight || 180;
            const mobileWrapper = document.querySelector('.mobile-wrapper');
            const wrapperRect = mobileWrapper.getBoundingClientRect();
            
            menu.style.right = `${window.innerWidth - wrapperRect.right + 20}px`;
            
            // Decide if show above or below
            if (rect.bottom + menuHeight + 20 > window.innerHeight) {
                // Show above if not enough space below
                menu.style.top = `${rect.top - menuHeight - 12}px`;
            } else {
                // Show below
                menu.style.top = `${rect.bottom + 12}px`;
            }
            
            menu.style.transform = 'none';
        }
        
        window.closeIOSMenu = () => {
            document.getElementById('blurOverlay').classList.remove('active');
            document.getElementById('iosActionMenu').classList.remove('show');
            document.querySelector('.mobile-wrapper').classList.remove('blur-active');
            const fab = document.querySelector('.fab');
            const nav = document.querySelector('.bottom-nav');
            if (fab) fab.classList.remove('blur-active');
            if (nav) nav.classList.remove('blur-active');
            
            if (clonedItem) {
                clonedItem.remove();
                clonedItem = null;
            }
            if (currentElevatedItem) {
                currentElevatedItem.style.visibility = 'visible';
                currentElevatedItem = null;
            }
        };
        
        window.handleIOSAction = (action, txnId, ...args) => {
            closeIOSMenu();
            
            switch(action) {
                case 'edit':
                    openEditModal(txnId, args[0], args[1], args[2], args[3]);
                    break;
                case 'exclude':
                    toggleExclusion(txnId, args[1], args[0]);
                    break;
                case 'refund':
                    toggleRefund(txnId, args[0]);
                    break;
                case 'delete':
                    openDeleteModal(txnId);
                    break;
            }
        };

        window.toggleExclusion = async (id, merchant, isCurrentlyExcluded) => {
            if (auth.currentUser?.isAnonymous) {
                if (confirm('Your data is in "Local Mode". Sign in with Google to sync this exclusion to the cloud?')) {
                    handleAuthClick();
                    return;
                }
            }
            try {
                if (!auth.currentUser) return;
                const uid = auth.currentUser.uid;
                await updateDoc(doc(db, "users", uid, "transactions", id), { excluded: !isCurrentlyExcluded });
                showToast(isCurrentlyExcluded ? 'Transaction included' : 'Transaction excluded');
            } catch (e) { log('Toggle failed', 'error'); }
        };

        window.toggleRefund = async (id, isCurrentlyRefund) => {
            if (auth.currentUser?.isAnonymous) {
                if (confirm('Your data is in "Local Mode". Sign in with Google to sync changes to the cloud?')) {
                    handleAuthClick();
                    return;
                }
            }
            try {
                if (!auth.currentUser) return;
                const uid = auth.currentUser.uid;
                await updateDoc(doc(db, "users", uid, "transactions", id), { refund: !isCurrentlyRefund });
                showToast(isCurrentlyRefund ? 'Unmarked as refund' : 'Marked as refund');
            } catch (e) { log('Toggle refund failed', 'error'); }
        };

        // DELETE LOGIC
        window.openDeleteModal = (id) => {
            currentTxnId = id;
            document.getElementById('delete-modal').classList.add('show');
        };

        window.confirmDelete = async () => {
            if (auth.currentUser?.isAnonymous) {
                if (confirm('Your data is in "Local Mode". Sign in with Google to sync deletions to the cloud?')) {
                    handleAuthClick();
                    return;
                }
            }
            if (!currentTxnId) return;
            
            // Show loading state
            const modal = document.getElementById('delete-modal');
            const deleteBtn = modal.querySelector('button');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<i class="material-icons spin" style="font-size:18px;">sync</i> DELETING...';
            deleteBtn.style.opacity = '0.7';

            try {
                 if (!auth.currentUser) return;
                 const uid = auth.currentUser.uid;
                await updateDoc(doc(db, "users", uid, "transactions", currentTxnId), { deleted: true });
                showToast('Transaction deleted');
                closeModals();
            } catch (error) { 
                log("Error deleting: " + error.message, "error");
                showToast('Delete failed');
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalText;
                deleteBtn.style.opacity = '1';
            }
        };

        // --- CUSTOMIZATION MODALS ---
        let currentTxnId = null;
        const CATEGORIES = [
            { id: 'Online shopping', icon: 'shopping_bag', label: 'Online Shopping', cls: 'cat-online' },
            { id: 'Shopping', icon: 'shopping_cart', label: 'Shopping', cls: 'cat-shopping' },
            { id: 'Vehicle', icon: 'local_gas_station', label: 'Vehicle', cls: 'cat-vehicle' },
            { id: 'Food & Drinks', icon: 'restaurant', label: 'Food & Drinks', cls: 'cat-food' },
            { id: 'Service', icon: 'settings_cell', label: 'Service', cls: 'cat-service-magenta' },
            { id: 'Trade Copier', icon: 'hub', label: 'Trade Copier', cls: 'cat-aqua' },
            { id: 'Trading Expenses', icon: 'insights', label: 'Trading Expenses', cls: 'cat-trading' },
            { id: 'Life & Entertainment', icon: 'confirmation_number', label: 'Life & Ent.', cls: 'cat-life' },
            { id: 'Financial Expenses', icon: 'payments', label: 'Financial Expenses', cls: 'cat-financial' },
            { id: 'Transportation', icon: 'directions_bus', label: 'Transportation', cls: 'cat-vehicle' },
            { id: 'Travel', icon: 'flight', label: 'Travel', cls: 'cat-aqua' },
            { id: 'Education', icon: 'school', label: 'Education', cls: 'cat-education' },
            { id: 'Sport', icon: 'fitness_center', label: 'Sport', cls: 'cat-life' },
            { id: 'Income', icon: 'savings', label: 'Income', cls: 'cat-income' }
        ];

        // Populate Transaction History Category Filter
        const populateTxnFilter = () => {
            const filter = document.getElementById('txn-cat-filter');
            if (!filter) return;
            
            // Keep "All Items"
            const allOption = filter.options[0];
            filter.innerHTML = '';
            filter.appendChild(allOption);
            
            CATEGORIES.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.label; // We match against the label in filterTxnList
                opt.innerText = cat.label;
                filter.appendChild(opt);
            });
        };
        populateTxnFilter();

        window.closeModals = () => {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('show'));
            currentTxnId = null;
            
            // Restore body scroll
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.width = '';
        };

        // Close on outside click
        window.onclick = (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeModals();
            }
        };

        window.openCategoryModal = (id, merchant, currentCatId) => {
            currentTxnId = id;
            const grid = document.getElementById('cat-grid');
            grid.innerHTML = CATEGORIES.map(cat => `
                <div class="cat-option ${currentCatId === cat.id ? 'active' : ''}" onclick="window.saveCategory('${cat.id}')">
                    <i class="material-icons ${cat.cls}" style="padding: 10px; border-radius: 12px;">${cat.icon}</i>
                    <span>${cat.label}</span>
                </div>
            `).join('');
            document.getElementById('cat-modal').classList.add('show');
        };

        window.saveCategory = async (catId) => {
            if (auth.currentUser?.isAnonymous) {
                if (confirm('Your data is in "Local Mode". Sign in with Google to sync category changes to the cloud?')) {
                    handleAuthClick();
                    return;
                }
            }
            if (!currentTxnId) return;
            
            // Show loading overlay on modal
            const modal = document.getElementById('cat-modal');
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.9);display:flex;align-items:center;justify-content:center;border-radius:20px;z-index:9999;';
            overlay.innerHTML = '<i class="material-icons spin" style="font-size:32px;color:#1d4ed8;">sync</i>';
            modal.querySelector('.custom-modal').style.position = 'relative';
            modal.querySelector('.custom-modal').appendChild(overlay);

            try {
                if (!auth.currentUser) return;
                const uid = auth.currentUser.uid;
                await updateDoc(doc(db, "users", uid, "transactions", currentTxnId), { manualCategory: catId });
                showToast('Category updated');
                closeModals();
            } catch (error) { 
                log("Error saving category: " + error.message, "error");
                showToast('Update failed');
                overlay.remove();
            }
        };

        window.openNoteModal = (id, merchant, note) => {
            currentTxnId = id;
            const input = document.getElementById('note-text');
            const counter = document.getElementById('note-counter');
            input.value = note || '';
            counter.innerText = `${input.value.length}/30`;
            
            input.oninput = () => {
                counter.innerText = `${input.value.length}/30`;
            };

            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveNote();
                }
            };
            
            document.getElementById('note-modal').classList.add('show');
        };

        // Enforce Title Case Helper
        function toTitleCase(str) {
            return str.replace(/\w\S*/g, function(txt){
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            });
        }

        document.getElementById('save-note-btn').onclick = async () => {
            if (auth.currentUser?.isAnonymous) {
                if (confirm('Your data is in "Local Mode". Sign in with Google to sync your notes to the cloud?')) {
                    handleAuthClick();
                    return;
                }
            }
            if (!currentTxnId) return;
            let note = document.getElementById('note-text').value.trim();
            note = toTitleCase(note);

            // Disable button and show loading
            const btn = document.getElementById('save-note-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="material-icons spin" style="font-size:18px;">sync</i> SAVING...';
            btn.style.opacity = '0.7';

            try {
                if (!auth.currentUser) return;
                const uid = auth.currentUser.uid;
                await updateDoc(doc(db, "users", uid, "transactions", currentTxnId), { note: note });
                showToast('Note saved');
                closeModals();
            } catch (error) { 
                log("Error saving note: " + error.message, "error"); 
                showToast('Save failed');
                btn.disabled = false;
                btn.innerHTML = originalText;
                btn.style.opacity = '1';
            }
        };

        window.openPriceModal = (id, currentAmt) => {
            currentTxnId = id;
            const modal = document.getElementById('price-modal');
            const input = document.getElementById('price-input');
            input.value = currentAmt;
            modal.classList.add('show');
            setTimeout(() => input.focus(), 100);

            input.onkeydown = (e) => {
                if (e.key === 'Enter') savePrice();
            };
        };

        const savePrice = async () => {
            if (auth.currentUser?.isAnonymous) {
                if (confirm('Your data is in "Local Mode". Sign in with Google to sync prices to the cloud?')) {
                    handleAuthClick();
                    return;
                }
            }
            if (!currentTxnId) return;
            const val = document.getElementById('price-input').value;
            const amt = parseFloat(val);
            
            // Show loading overlay
            const modal = document.getElementById('price-modal');
            const saveBtn = modal.querySelector('button');
            const originalText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="material-icons spin" style="font-size:18px;">sync</i> SAVING...';
            saveBtn.style.opacity = '0.7';

            try {
                if (!auth.currentUser) return;
                const uid = auth.currentUser.uid;
                const docRef = doc(db, "users", uid, "transactions", currentTxnId);
                if (isNaN(amt) || val.trim() === "") {
                    await updateDoc(docRef, { manualAmount: deleteField() });
                } else {
                    await updateDoc(docRef, { manualAmount: amt });
                }
                showToast('Price updated');
                closeModals();
            } catch (error) { 
                log("Error saving price: " + error.message, "error"); 
                showToast('Update failed');
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
                saveBtn.style.opacity = '1';
            }
        };
        window.savePrice = savePrice;

        /* See listener above for save-note-btn, replaced to include title casing */

        function showToast(msg) {
            const toast = document.getElementById('toast-box');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function displayCategoryName(id) {
            const cat = CATEGORIES.find(c => c.id === id);
            return cat ? cat.label : id;
        }

        // MERCHANT MAPPING & CATEGORIZATION
        function getMerchantDisplay(name = '', t = {}) {
            let raw = name.toUpperCase();
            
            // 1. GENERAL CLEANUP (Remove PHL, Locations, messy suffixes)
            let cleaned = name
                .replace(/\s+PHL$/i, '')
                .replace(/\s+CEBU\s+CITY\s+PHL$/i, '')
                .replace(/\s+CEBU\s+CITY$/i, '')
                .replace(/\s+DUBAI\s+ARE$/i, '')
                .replace(/\s+LONDON\s+GBR$/i, '')
                .replace(/\s+PH\s+PHL$/i, '')
                .replace(/\s+PH$/i, '')
                .trim();
            
            // 2. PATTERN REPLACEMENT
            if (cleaned.toUpperCase().includes('GADC') || cleaned.toUpperCase().includes('MCDONALDS') || cleaned.toUpperCase().includes('MCDO')) {
                let u = cleaned.toUpperCase();
                if (u.includes('SOUTHCBU') || u.includes('325CLN')) {
                    cleaned = 'MCDONALDS SOUTH CEBU';
                } else {
                    // Standardize prefix
                    cleaned = cleaned.replace(/(GADC|MCDONALDS|MCDO)/i, 'MCDONALDS').trim();
                    // Strip alphanumeric codes like 325CLNS... but keep what's after if it looks like a name
                    cleaned = cleaned.replace(/MCDONALDS\s+\d+[A-Z]*/i, 'MCDONALDS').trim();
                }
            }
            
            if (cleaned.toUpperCase().includes('JOLLIBEE')) {
                cleaned = cleaned.replace(/JB\d+\s+\w+/i, '').trim();
            }

            if (cleaned.toUpperCase().includes('RIBSHACK')) {
                 cleaned = cleaned.replace(/PH\d+/i, '').trim();
            }

            if (cleaned.toUpperCase().includes('SHOPEE')) {
                cleaned = 'SHOPEE PH';
            }

            if (cleaned.toUpperCase().includes('TRADERSCONNECT')) {
                cleaned = 'TRADERS CONNECT';
            }

            if (cleaned.toUpperCase().includes('TIKTOK SHOP')) {
                cleaned = 'TIKTOK SHOP';
            }

            if (cleaned.toUpperCase().includes('SPOTIFY')) {
                cleaned = 'SPOTIFY';
            }

            let display = { name: cleaned, category: 'Financial expenses', icon: 'payments', catClass: 'cat-financial' };

            // 3. MANUAL OVERRIDE (USER CHOICE)
            if (t.manualCategory) {
                const userCat = CATEGORIES.find(c => c.id === t.manualCategory);
                if (userCat) {
                    display.category = userCat.id;
                    display.icon = userCat.icon;
                    // Find catClass
                    const catMap = {
                        'Online shopping': 'cat-online',
                        'Shopping': 'cat-shopping',
                        'Vehicle': 'cat-vehicle',
                        'Trade Copier': 'cat-aqua',
                        'Trading Expenses': 'cat-trading',
                        'Service': 'cat-service-magenta',
                        'Food & Drinks': 'cat-food',
                        'Life & Entertainment': 'cat-life',
                        'Financial Expenses': 'cat-financial',
                        'Transportation': 'cat-vehicle',
                        'Travel': 'cat-aqua',
                        'Education': 'cat-shopping', /* Blue */
                        'Sport': 'cat-life',
                        'Income': 'cat-income'
                    };
                    display.catClass = userCat.cls || catMap[userCat.id] || 'cat-financial';
                    return display;
                }
            }

            // 4. EXACT OVERRIDES
            const mapping = {
                'MR DIY BGCC BOGO': 'MR DIY BOGO',
                'MR DIY ZBOG BOGO': 'MR DIY BOGO',
                'TEC FUEL SAN REMIGIO': 'TECFUEL SAN REMIGIO',
                'J AND L SHOPPING BOGO': 'J AND L MALL BOGO',
                'TECFUEL BOGO CEBU': 'TECFUEL BOGO',
                'KKV SM J Mall Cebu': 'KKV SM J MALL CEBU',
                'SM STORE-CEBU': 'SM STORE - CEBU CITY',
                'GLOBE-BILLSPAY PH': 'GLOBE / GOMO LOAD',
                'SHELL FILLWISE BOGO CEBU': 'SHELL BOGO CEBU',
                'GLOBE WEBLOADING EC PH': 'GLOBE / GOMO LOAD',
                'WATSONS HISOLER BLDG B': 'WATSONS HISOLER BLDG BOGO',
                'SUPER METRO S/M-BOGO': 'SUPER METRO BOGO',
                'SM SUPERMARKET SM SRP CEBU': 'SM SUPERMARKET SRP',
                'OCTAGON AYALA CENTRAL CEBU': 'OCTAGON AYALA CENTRAL CEBU',
                'STARBUCKS 540 CENTRAL CEBU CITY': 'STARBUCKS 540 CENTRAL CEBU CITY',
                'ICE SKATING SM SRP CEB': 'ICE SKATING SM SRP CEBU',
                'TAP SURE LEVERAGE FUND': 'TAP SURE LEVERAGE FUND',
                'MRCRMT': 'MRCRMT',
                'TRADERSCONNECT.COM': 'TRADERS CONNECT',
                'TRADERSCONNECT': 'TRADERS CONNECT',
                'TRADERSCONNECT.COM': 'TRADERS CONNECT'
            };

            const finalRaw = cleaned.toUpperCase();
            if (mapping[cleaned]) display.name = mapping[cleaned];
            else if (mapping[finalRaw]) display.name = mapping[finalRaw];

            // 5. CATEGORY DETECTION
            if (finalRaw.includes('SHOPEE') || finalRaw.includes('TIKTOK') || finalRaw.includes('LAZADA') || finalRaw.includes('SHEIN') || finalRaw.includes('TEMU') || finalRaw.includes('SHOPIFY')) {
                display.category = 'Online shopping';
                display.icon = 'shopping_bag';
                display.catClass = 'cat-online';
            } else if (finalRaw.includes('FUEL') || finalRaw.includes('SHELL') || finalRaw.includes('TECFUEL') || finalRaw.includes('PETRON') || finalRaw.includes('SEAOIL')) {
                display.category = 'Vehicle';
                display.icon = 'local_gas_station';
                display.catClass = 'cat-vehicle';
            } else if (finalRaw.includes('MR DIY') || finalRaw.includes('WATSONS') || finalRaw.includes('SM STORE') || finalRaw.includes('KKV') || finalRaw.includes('SHOPPING') || finalRaw.includes('MALL') || finalRaw.includes('METRO') || finalRaw.includes('SUPERMARKET') || finalRaw.includes('OCTAGON')) {
                display.category = 'Shopping';
                display.icon = 'shopping_cart';
                display.catClass = 'cat-shopping';
            } else if (finalRaw.includes('TRADERSCONNECT') || finalRaw.includes('TRADERS CONNECT')) {
                display.category = 'Trade Copier';
                display.icon = 'hub';
                display.catClass = 'cat-aqua';
            } else if (finalRaw.includes('EQUITY EDGE') || finalRaw.includes('ANALYTICS') || finalRaw.includes('TRADING') || finalRaw.includes('LEVERAGE FUND') || finalRaw.includes('MRCRMT')) {
                display.category = 'Trading Expenses';
                display.icon = 'insights';
                display.catClass = 'cat-trading';
            } else if (finalRaw.includes('GLOBE') || finalRaw.includes('GOMO') || finalRaw.includes('BILLSPAY')) {
                display.category = 'Service';
                display.icon = 'settings_cell';
                display.catClass = 'cat-service-magenta';
            } else if (finalRaw.includes('JOLLIBEE') || finalRaw.includes('MCDO') || finalRaw.includes('MCDONALDS') || finalRaw.includes('FOOD') || finalRaw.includes('RESTAURANT') || finalRaw.includes('STARBUCKS') || finalRaw.includes('RIBSHACK')) {
                display.category = 'Food & Drinks';
                display.icon = 'restaurant';
                display.catClass = 'cat-food';
            } else if (finalRaw.includes('ICE SKATING') || finalRaw.includes('CINEMA') || finalRaw.includes('ENTERTAINMENT') || finalRaw.includes('SPOTIFY') || finalRaw.includes('NETFLIX')) {
                display.category = 'Life & Entertainment';
                display.icon = 'confirmation_number';
                display.catClass = 'cat-life';
            } else {
                display.category = 'Financial Expenses';
                display.icon = 'payments';
                display.catClass = 'cat-red';
            }

            return display;
        }

        function log(msg, type = 'info') {
            const container = document.getElementById('log-container');
            if (!container) return;
            const div = document.createElement('div');
            div.className = `log-entry ${type === 'error' ? 'log-error' : ''}`;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- MANUAL TRANSACTION LOGIC (INTEGRATED) ---
        let selectedManualCatId = 'Financial Expenses'; 
        let manualTxnType = 'expense';

        window.setTxnType = (type) => {
            manualTxnType = type;
            const btnExp = document.getElementById('btn-expense');
            const btnInc = document.getElementById('btn-income');
            
            if (type === 'expense') {
                btnExp.style.background = '#ef4444'; 
                btnExp.style.color = '#fff';
                btnExp.style.boxShadow = '0 4px 10px rgba(239, 68, 68, 0.3)';
                
                btnInc.style.background = 'transparent';
                btnInc.style.color = '#64748b';
                btnInc.style.boxShadow = 'none';
                
                // Show category section for expenses
                document.getElementById('category-section').style.display = 'block';
                selectedManualCatId = 'Financial Expenses';
            } else {
                btnInc.style.background = '#10b981';
                btnInc.style.color = '#fff';
                btnInc.style.boxShadow = '0 4px 10px rgba(16, 185, 129, 0.3)';
                
                btnExp.style.background = 'transparent';
                btnExp.style.color = '#64748b';
                btnExp.style.boxShadow = 'none';
                
                // Hide category section for income (only one category)
                document.getElementById('category-section').style.display = 'none';
                selectedManualCatId = 'Income';
            }
            renderManualCategories();
        };

        window.openManualTxnModal = () => {
            window.editingTxnId = null; // Clear edit mode
            document.getElementById('manual-amt').value = '';
            document.getElementById('manual-merchant').value = '';
            document.getElementById('manual-note').value = '';
            
            // Default Category
            selectedManualCatId = 'Financial Expenses';
            setTxnType('expense');
            
            // Set Date Input to Today
            const d = new Date().toISOString().split('T')[0];
            document.getElementById('manual-date').value = d;
            
            // Enable Button
            const btn = document.getElementById('done-btn');
            btn.style.pointerEvents = 'auto';
            btn.style.opacity = '1';
            
            // Update modal title
            document.getElementById('modal-title').innerText = 'New Transaction';

            renderManualCategories();
            document.getElementById('manual-txn-modal').classList.add('show');
            
            // Block body scroll
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
            
            setTimeout(() => document.getElementById('manual-amt').focus(), 300);
        };

        window.openEditModal = (txnId, merchant, amount, category, note) => {
            window.editingTxnId = txnId; // Set edit mode
            
            // Find the transaction to get all its data
            const txn = window.allTxns.find(t => t.id === txnId);
            if (!txn) return;
            
            // Populate fields
            document.getElementById('manual-amt').value = amount;
            document.getElementById('manual-merchant').value = merchant;
            document.getElementById('manual-note').value = note || '';
            
            // Set date
            const d = new Date(txn.date);
            document.getElementById('manual-date').value = d.toISOString().split('T')[0];
            
            // Set category
            selectedManualCatId = txn.manualCategory || category;
            
            // Determine type based on category
            if (category === 'Income') {
                setTxnType('income');
            } else {
                setTxnType('expense');
            }
            
            // Enable Button
            const btn = document.getElementById('done-btn');
            btn.style.pointerEvents = 'auto';
            btn.style.opacity = '1';
            
            // Update modal title
            document.getElementById('modal-title').innerText = 'Edit Transaction';

            renderManualCategories();
            document.getElementById('manual-txn-modal').classList.add('show');
            
            // Block body scroll
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
            
            setTimeout(() => document.getElementById('manual-amt').focus(), 300);
        };

        window.renderManualCategories = () => {
            const list = document.getElementById('manual-cat-list');
            // Filter out Income category when in expense mode
            const categoriesToShow = manualTxnType === 'expense' 
                ? CATEGORIES.filter(cat => cat.id !== 'Income')
                : CATEGORIES.filter(cat => cat.id === 'Income');
            
            list.innerHTML = categoriesToShow.map(cat => {
                const isSelected = cat.id === selectedManualCatId;
                let bgStyle = '#f1f5f9';
                let colorStyle = '#64748b';
                
                if (isSelected) {
                     if (cat.cls.includes('food')) { bgStyle = '#fefce8'; colorStyle = '#ca8a04'; } // Yellow
                     else if (cat.cls.includes('shopping')) { bgStyle = '#fff7ed'; colorStyle = '#f97316'; } // Orange
                     else if (cat.cls.includes('vehicle')) { bgStyle = '#f5f3ff'; colorStyle = '#8b5cf6'; }
                     else if (cat.cls.includes('cat-aqua')) { bgStyle = '#ecfeff'; colorStyle = '#0891b2'; } // Dark Aqua
                     else if (cat.cls.includes('Service')) { bgStyle = '#fdf4ff'; colorStyle = '#d946ef'; } // Magenta
                     else if (cat.cls.includes('cat-education')) { bgStyle = '#eff6ff'; colorStyle = '#1d4ed8'; } // Dark Blue
                     else if (cat.label.includes('Financial') || cat.label.includes('Trading')) { bgStyle = '#fef2f2'; colorStyle = '#ef4444'; } // Red
                     else { bgStyle = '#f0fdf4'; colorStyle = '#10b981'; } 
                }

                return `
                <div class="manual-cat-item ${isSelected ? 'selected' : ''}" onclick="selectManualCategory('${cat.id}')">
                    <div class="manual-cat-circle" style="background: ${bgStyle}; color: ${colorStyle};">
                        <i class="material-icons">${cat.icon}</i>
                    </div>
                    <span style="font-size: 11px; font-weight: 600; color: #1e293b; text-align: center;">${cat.label}</span>
                </div>
                `;
            }).join('');
        };

        window.selectManualCategory = (id) => {
            selectedManualCatId = id;
            renderManualCategories();
        };

        window.saveManualTxn = async () => {
            if (auth.currentUser?.isAnonymous) {
                if (confirm('Your data is in "Local Mode". Sign in with Google to permanently save this to the cloud?')) {
                    handleAuthClick();
                    return;
                }
            }
            const btn = document.getElementById('done-btn');
            const amtVal = document.getElementById('manual-amt').value;
            
            if (!amtVal || parseFloat(amtVal) <= 0) {
                showToast('Enter valid amount');
                return;
            }
            
            // Disable button
            btn.style.pointerEvents = 'none';
            btn.style.opacity = '0.5';
            
            let note = document.getElementById('manual-note').value.trim();
            // Enforce Title Case
            if (note) {
                note = note.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
            }

            const dateVal = document.getElementById('manual-date').value;
            const dateObj = dateVal ? new Date(dateVal) : new Date();
            
            const cat = CATEGORIES.find(c => c.id === selectedManualCatId);
            
            const merchantName = document.getElementById('manual-merchant').value.trim();
            
            try {
                if (!auth.currentUser) return;
                const uid = auth.currentUser.uid;
                
                // Check if editing or creating new
                if (window.editingTxnId) {
                    // UPDATE existing transaction
                    await updateDoc(doc(db, "users", uid, "transactions", window.editingTxnId), {
                        date: dateObj.toISOString(),
                        amount: parseFloat(amtVal),
                        manualAmount: parseFloat(amtVal),
                        merchant: merchantName || cat.label,
                        note: note || '',
                        manualCategory: selectedManualCatId,
                        category: selectedManualCatId,
                        type: manualTxnType
                    });
                    showToast('Transaction updated');
                } else {
                    // CREATE new transaction
                    const newTxn = {
                        date: dateObj.toISOString(),
                        amount: parseFloat(amtVal),
                        manualAmount: parseFloat(amtVal), 
                        merchant: merchantName || cat.label,
                        note: note || '',
                        manualCategory: selectedManualCatId,
                        category: selectedManualCatId,
                        type: manualTxnType
                    };
                    await addDoc(collection(db, "users", uid, "transactions"), newTxn);
                    showToast('Transaction saved');
                }
                
                closeModals();
            } catch (e) {
                console.error(e);
                showToast('Error saving');
                // Re-enable on error
                btn.style.pointerEvents = 'auto';
                btn.style.opacity = '1';
            }
        };

        // NEW: TRANSACTION FILTERS & LOGO TOGGLE
        let showLogos = true;
        
        window.toggleLogos = () => {
            showLogos = !showLogos;
            const icon = document.getElementById('logo-toggle-icon');
            const wrapper = document.querySelector('.logo-toggle-wrapper');
            
            if (showLogos) {
                icon.innerText = 'visibility';
                icon.style.color = '#0284c7';
                wrapper.style.background = '#e0f2fe';
                document.querySelectorAll('.brand-badge').forEach(b => b.style.display = 'flex');
            } else {
                icon.innerText = 'visibility_off';
                icon.style.color = '#94a3b8';
                wrapper.style.background = '#f1f5f9';
                document.querySelectorAll('.brand-badge').forEach(b => b.style.display = 'none');
            }
        };

        window.filterTxnList = () => {
            const cat = document.getElementById('txn-cat-filter').value;
            const accordions = document.querySelectorAll('.month-accordion');
            
            accordions.forEach(acc => {
                const txns = acc.querySelectorAll('.premium-txn');
                let visibleCount = 0;
                
                txns.forEach(t => {
                    const itemCat = t.querySelector('.txn-sub span:last-child')?.innerText || '';
                    const matchCat = (cat === 'all') || (itemCat.toLowerCase() === cat.toLowerCase());

                    if (matchCat) {
                        t.style.display = 'flex';
                        visibleCount++;
                    } else {
                        t.style.display = 'none';
                    }
                });

                // Hide the whole accordion if no visible items
                acc.style.display = visibleCount > 0 ? 'block' : 'none';
            });
        };

        // NEW: Independent Trend Chart Logic
        window.refreshTrendChart = () => {
            if (!window.allTxns) return;
            drawTrendChart(window.allTxns);
        };

        // Override injectBrandLogos to respect visibility
        const originalInject = injectBrandLogos;
        injectBrandLogos = () => {
            const txns = document.querySelectorAll('.premium-txn');
            txns.forEach(txn => {
                const merchantEl = txn.querySelector('.txn-merch');
                if (!merchantEl) return;
                const merchantName = merchantEl.textContent.toUpperCase();
                const iconBox = txn.querySelector('.icon-box');
                if (!iconBox || iconBox.querySelector('.brand-badge')) return;
                
                let logo = null;
                if (merchantName.includes('JOLLIBEE')) logo = 'logos/jollibee.png';
                else if (merchantName.includes('MCDO') || merchantName.includes('MCDONALDS')) logo = 'logos/mcdo.png';
                else if (merchantName.includes('SHELL')) logo = 'logos/shell.png';
                else if (merchantName.includes('SHOPEE')) logo = 'logos/shopee.png';
                else if (merchantName.includes('LAZADA')) logo = 'logos/lazada.jpg';
                else if (merchantName.includes('GLOBE') || merchantName.includes('GOMO')) logo = 'logos/globe.png';
                else if (merchantName.includes('SM ') || merchantName.includes('SM STORE') || merchantName.includes('SM SUPERMARKET')) logo = 'logos/sm.png';
                else if (merchantName.includes('SPOTIFY')) logo = 'logos/spotify.png';
                else if (merchantName.includes('TIKTOK')) logo = 'logos/tiktokshop.png';
                else if (merchantName.includes('TECFUEL') || merchantName.includes('TEC FUEL')) logo = 'logos/tecfuel.png';
                else if (merchantName.includes('TRADERS')) logo = 'logos/tradersconnect.png';
                else if (merchantName.includes('AYALA')) logo = 'logos/ayala.png';
                else if (merchantName.includes('J AND L') || merchantName.includes('JANL')) logo = 'logos/jandlmall.png';
                else if (merchantName.includes('MR DIY')) logo = 'logos/mrdiy.png';
                else if (merchantName.includes('WATSONS')) logo = 'logos/watsons.png';

                if (logo) {
                    const badge = document.createElement('div');
                    badge.className = 'brand-badge';
                    badge.innerHTML = `<img src="${logo}" alt="brand">`;
                    badge.style.display = showLogos ? 'flex' : 'none';
                    iconBox.appendChild(badge);
                }
            });
        };
    </script>
    
    <!-- CATEGORY MODAL -->
    <div id="cat-modal" class="modal-overlay">
        <div class="custom-modal">
            <div class="modal-header">Change Category</div>
            <p style="color: #64748b; font-size: 13px;">Select a new category for this transaction.</p>
            <div class="modal-body">
                <div id="cat-grid" class="cat-grid">
                    <!-- Categories injected here -->
                </div>
            </div>
            <div class="modal-actions">
                <div class="cancel-link" onclick="closeModals()">CANCEL</div>
            </div>
        </div>
    </div>

    <!-- NOTE MODAL -->
    <div id="note-modal" class="modal-overlay">
        <div class="custom-modal">
            <div class="modal-header">Add Note</div>
            <p style="color: #64748b; font-size: 13px;">Personalized note for this transaction.</p>
            <div class="modal-body">
                <div style="position: relative;">
                    <textarea id="note-text" class="note-input" maxlength="30" placeholder="Enter note here..."></textarea>
                    <div id="note-counter" style="position: absolute; right: 8px; bottom: 8px; font-size: 10px; color: #94a3b8; font-weight: 600;">0/30</div>
                </div>
            </div>
            <div class="modal-actions" style="margin-top: 8px; align-items: center;">
                <div class="cancel-link" onclick="closeModals()" style="letter-spacing: 0.5px; margin-right: 4px;">CANCEL</div>
                <button class="mui-btn mui-btn--raised mui-btn--primary" id="save-note-btn" style="border-radius: 10px; font-weight: 700; letter-spacing: 0.5px; padding: 0 24px; height: 42px; background-color: #2196F3;">SAVE NOTE</button>
            </div>
        </div>
    </div>

    <!-- PRICE MODAL -->
    <div id="price-modal" class="modal-overlay">
        <div class="custom-modal">
            <div class="modal-header">Change Price</div>
            <p style="color: #64748b; font-size: 13px;">Update the transaction amount manually.</p>
            <div class="modal-body">
                <div style="position: relative;">
                    <input type="number" id="price-input" class="note-input" style="min-height: auto; font-size: 18px; font-weight: 700; text-align: center;" placeholder="0.00" step="0.01">
                </div>
            </div>
            <div class="modal-actions" style="margin-top: 8px; align-items: center;">
                <div class="cancel-link" onclick="closeModals()" style="letter-spacing: 0.5px; margin-right: 4px;">CANCEL</div>
                <button class="mui-btn mui-btn--raised mui-btn--primary" onclick="savePrice()" style="border-radius: 10px; font-weight: 700; letter-spacing: 0.5px; padding: 0 24px; height: 42px; background-color: #2196F3;">SAVE PRICE</button>
            </div>
        </div>
    </div>

    <!-- AUTH TROUBLESHOOTER MODAL -->
    <div id="auth-trouble-modal" class="modal-overlay">
        <div class="custom-modal" style="border-top: 5px solid #ef4444;">
            <div class="modal-header" style="display:flex; align-items:center; gap:8px; color:#ef4444;">
                <i class="material-icons">warning</i> 
                <span>Login Error</span>
            </div>
            <div style="font-size: 14px; color: #1e293b; margin-bottom: 15px; font-weight: 600;">
                The request returned: <code id="auth-error-code" style="color:#ef4444; background:#fee2e2; padding:2px 4px; border-radius:4px;">auth/invalid-action...</code>
            </div>
            <div style="background: #f8fafc; border-radius: 12px; padding: 15px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
                <p style="font-size: 13px; font-weight: 700; color: #475569; margin: 0 0 10px 0;">Troubleshoot checklist:</p>
                <ul style="font-size: 12.5px; color: #64748b; margin: 0; padding-left: 20px; line-height: 1.6;">
                    <li><strong>Check URL:</strong> Ensure you are using <code style="font-weight:bold;">127.0.0.1:5500</code> (Not localhost if unauthorized).</li>
                    <li><strong>Authorized Domains:</strong> Add <code style="font-weight:bold;">127.0.0.1</code> to Firebase Console > Authentication > Settings.</li>
                    <li><strong>API Restrictions:</strong> Ensure your API key in Google Cloud Console allows this domain.</li>
                </ul>
            </div>
            <div class="modal-actions">
                <button class="mui-btn mui-btn--raised" onclick="closeModals()" style="border-radius:10px; font-weight:700; background:#f1f5f9; color:#475569;">CLOSE</button>
                <button class="mui-btn mui-btn--raised mui-btn--primary" onclick="window.location.reload()" style="border-radius:10px; font-weight:700;">RELOAD APP</button>
            </div>
        </div>
    </div>

    <!-- DELETE CONFIRMATION MODAL -->
    <div id="delete-modal" class="modal-overlay">
        <div class="custom-modal" style="text-align: center;">
            <div class="modal-header" style="color: #ef4444; justify-content: center; margin-bottom: 8px;">Delete Transaction?</div>
            <p style="color: #64748b; font-size: 13px; margin: 0 0 24px 0;">This action cannot be undone.</p>
            <div class="modal-actions" style="justify-content: center; gap: 16px;">
                <div class="cancel-link" onclick="closeModals()">CANCEL</div>
                <button class="mui-btn mui-btn--raised" onclick="confirmDelete()" style="border-radius: 12px; font-weight: 700; background: #ef4444; color: white; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);">DELETE</button>
            </div>
        </div>
    </div>

    <!-- MANUAL TRANSACTION MODAL -->
    <div id="manual-txn-modal" class="modal-overlay" style="align-items: flex-end; justify-content: center; backdrop-filter: blur(4px); background: rgba(0,0,0,0.4);">
        <div class="custom-modal" id="manual-modal-content" style="width: 100%; max-width: 100%; border-radius: 24px 24px 0 0; padding: 0; box-shadow: 0 -10px 40px rgba(0,0,0,0.1); height: 94vh; overflow-y: auto; position: relative; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); touch-action: pan-y;">
            
            <!-- Swipe Handle Area (includes title) -->
            <div id="modal-drag-handle" style="width: 100%; padding: max(12px, env(safe-area-inset-top)) 0 0 0; background: white; border-radius: 24px 24px 0 0; position: sticky; top: 0; z-index: 100; cursor: grab; border-bottom: 1px solid #f1f5f9;">
                <div style="display: flex; justify-content: center; margin-bottom: 12px;">
                    <div style="width: 40px; height: 4px; background: #cbd5e1; border-radius: 2px;"></div>
                </div>
                <div style="padding: 0 20px 16px 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <i class="material-icons" onclick="closeModals()" style="color: #64748b; font-size: 24px; cursor: pointer;">close</i>
                        <div id="modal-title" style="font-weight: 800; font-size: 16px; color: #1e293b;">New Transaction</div>
                        <div id="done-btn" style="font-weight: 700; font-size: 14px; color: #10b981; cursor: pointer;" onclick="saveManualTxn()">Done</div>
                    </div>
                </div>
            </div>
            
            <div style="padding: 0 20px 20px 20px;">
            <!-- Toggler -->
            <div style="display: flex; background: #f1f5f9; padding: 4px; border-radius: 12px; margin-bottom: 30px;">
                <div id="btn-expense" onclick="setTxnType('expense')" style="flex: 1; padding: 8px; text-align: center; background: #ef4444; color: #fff; font-weight: 700; border-radius: 8px; font-size: 13px; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3); transition: all 0.2s; cursor: pointer;">Expense</div>
                <div id="btn-income" onclick="setTxnType('income')" style="flex: 1; padding: 8px; text-align: center; color: #64748b; font-weight: 600; font-size: 13px; border-radius: 8px; transition: all 0.2s; cursor: pointer;">Income</div>
            </div>

            <!-- Amount Input -->
            <!-- Amount Input -->
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 12px; color: #94a3b8; font-weight: 700; letter-spacing: 1px; margin-bottom: 8px;">AMOUNT</div>
                <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                    <span style="font-size: 24px; font-weight: 700; color: #cbd5e1;">PHP</span>
                    <input type="number" id="manual-amt" placeholder="0.00" style="font-size: 48px; font-weight: 800; color: #1e293b; border: none; outline: none; width: 220px; text-align: center; background: transparent;" step="0.01">
                </div>
            </div>

            <!-- Category Section -->
            <div id="category-section" style="margin-bottom: 0;">
                <div style="font-size: 11px; color: #94a3b8; font-weight: 700; letter-spacing: 1px; margin-bottom: 12px; padding-left: 4px;">CATEGORY</div>
                <div id="manual-cat-list" style="display: flex; overflow-x: auto; gap: 20px; padding: 4px 4px 20px 4px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch;">
                    <!-- Categories injected by JS -->
                </div>
            </div>

            <!-- Details List -->
            <div style="display: flex; flex-direction: column; gap: 16px;">
                
                <!-- Date Row -->
                <div style="display: flex; align-items: center; background: #fff; border: 1px solid #e2e8f0; padding: 16px; border-radius: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); cursor: pointer;" onclick="document.getElementById('manual-date').showPicker()">
                    <div style="width: 40px; height: 40px; border-radius: 10px; background: #eff6ff; display: flex; align-items: center; justify-content: center; margin-right: 16px; color: #60a5fa;">
                        <i class="material-icons" style="font-size: 20px;">calendar_today</i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 10px; color: #94a3b8; font-weight: 700; text-transform: uppercase;">Date</div>
                        <input type="date" id="manual-date" style="border: none; outline: none; font-size: 14px; font-weight: 600; color: #1e293b; font-family: inherit; background: transparent; cursor: pointer; text-align: left; width: 100%;">
                    </div>
                </div>

                <!-- Merchant Name Row -->
                <div style="display: flex; align-items: center; background: #fff; border: 1px solid #e2e8f0; padding: 16px; border-radius: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
                    <div style="width: 40px; height: 40px; border-radius: 10px; background: #fffbeb; display: flex; align-items: center; justify-content: center; margin-right: 16px; color: #fbbf24;">
                        <i class="material-icons" style="font-size: 20px;">store</i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 10px; color: #94a3b8; font-weight: 700; text-transform: uppercase;">Merchant Name</div>
                        <input type="text" id="manual-merchant" maxlength="50" placeholder="Enter merchant name..." style="width: 100%; border: none; outline: none; font-size: 14px; font-weight: 600; color: #1e293b; background: transparent; padding: 0;">
                    </div>
                </div>

                <!-- Notes Row -->
                <div style="display: flex; align-items: center; background: #fff; border: 1px solid #e2e8f0; padding: 16px; border-radius: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
                    <div style="width: 40px; height: 40px; border-radius: 10px; background: #f8fafc; display: flex; align-items: center; justify-content: center; margin-right: 16px; color: #64748b;">
                        <i class="material-icons" style="font-size: 20px;">notes</i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 10px; color: #94a3b8; font-weight: 700; text-transform: uppercase;">Notes</div>
                        <input type="text" id="manual-note" maxlength="30" placeholder="Add notes..." style="width: 100%; border: none; outline: none; font-size: 14px; font-weight: 600; color: #1e293b; background: transparent; padding: 0;">
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <style>
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        /* Hide scrollbar for category list */
        #manual-cat-list::-webkit-scrollbar { display: none; }
        #manual-cat-list { -ms-overflow-style: none; scrollbar-width: none; }
        
        .manual-cat-item { display: flex; flex-direction: column; align-items: center; gap: 6px; min-width: 56px; cursor: pointer; opacity: 0.5; transition: all 0.2s; }
        .manual-cat-item.selected { opacity: 1; transform: scale(1.05); }
        .manual-cat-circle { width: 48px; height: 48px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: all 0.2s; border: 2px solid transparent; }
        .manual-cat-item.selected .manual-cat-circle { box-shadow: 0 8px 16px rgba(0,0,0,0.05); }
        .manual-cat-item span { font-size: 10px !important; }
    </style>

    <script>
        // Swipe-to-close functionality for manual transaction modal
        document.addEventListener('DOMContentLoaded', () => {
            const dragHandle = document.getElementById('modal-drag-handle');
            const modalContent = document.getElementById('manual-modal-content');
            let startY = 0;
            let currentY = 0;
            let isDragging = false;

            dragHandle.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
                isDragging = true;
                dragHandle.style.cursor = 'grabbing';
            });

            dragHandle.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                currentY = e.touches[0].clientY;
                const diff = currentY - startY;
                
                // Only allow downward swipe
                if (diff > 0) {
                    modalContent.style.transform = `translateY(${diff}px)`;
                    modalContent.style.transition = 'none';
                }
            });

            dragHandle.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;
                dragHandle.style.cursor = 'grab';
                
                const diff = currentY - startY;
                
                // If swiped down more than 100px, close the modal
                if (diff > 100) {
                    modalContent.style.transition = 'transform 0.3s ease-out';
                    modalContent.style.transform = 'translateY(100%)';
                    setTimeout(() => {
                        closeModals();
                        modalContent.style.transform = '';
                        modalContent.style.transition = '';
                    }, 300);
                } else {
                    // Snap back
                    modalContent.style.transition = 'transform 0.2s ease-out';
                    modalContent.style.transform = '';
                    setTimeout(() => {
                        modalContent.style.transition = '';
                    }, 200);
                }
            });
        });
    </script>



    <!-- TOAST BOX -->
    <div id="toast-box" class="toast-container">
        <i class="material-icons">check_circle</i>
        <span id="toast-msg">Updated</span>
    </div>

    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>
</body>
</html>