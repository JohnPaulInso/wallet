<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartWallet Sync - MUI HTML</title>
    
    <!-- Material UI CSS & Premium Fonts -->
    <link href="https://cdn.muicss.com/mui-0.10.3/css/mui.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e293b">

    <style>
        * { box-sizing: border-box; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none; }
        html, body { background: #f0f2f5; margin: 0; padding: 0; min-height: 100vh; display: flex; justify-content: center; font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }
        
        /* Mobile Wrapper with PC Scroll Simulation */
        .mobile-wrapper { width: 100%; max-width: 430px; background: #fff; min-height: 100vh; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow-x: hidden; overflow-y: auto; }
        @media (min-width: 431px) {
            .mobile-wrapper { height: 100vh; overflow-y: scroll; }
        }

        #header { padding: 30px 24px 10px; display: flex; align-items: center; justify-content: space-between; background: #fff; }
        .greeting-section { line-height: 1.2; }
        .greeting-text { font-size: 11px; color: #94a3b8; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; }
        .user-name { font-size: 24px; font-weight: 800; color: #1e293b; }
        
        #profile-badge { width: 42px; height: 42px; border-radius: 50%; background: #f1f5f9; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #profile-badge img { width: 100%; height: 100%; object-fit: cover; display: none; }
        #profile-badge i { font-size: 24px; color: #94a3b8; display: block; }
        #profile-badge.has-pic i { display: none; }
        #profile-badge.has-pic img { display: block; }

        /* ATM CARD STYLE (RICH BLACK - REALISTIC) */
        .balance-card { 
            margin: 20px 24px; 
            padding: 24px 24px 20px 24px;
            background: linear-gradient(135deg, #1c1c1e 0%, #000000 100%); 
            border-radius: 24px; /* Slightly tighter radius for realism */
            color: #fff; 
            position: relative; 
            overflow: hidden; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), inset 0 0 0 1px rgba(255, 255, 255, 0.1); 
            min-height: 210px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        /* Matte Texture Overlay */
        .balance-card::before { 
            content: ''; 
            position: absolute; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
            opacity: 0.6;
            pointer-events: none;
            mix-blend-mode: overlay;
        }

        /* Subtle Spotlight */
        .balance-card::after {
            content: '';
            position: absolute;
            top: -50%; right: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 60%);
            pointer-events: none;
            transform: rotate(-15deg);
        }

        /* Generated EMV Chip */
        .card-chip {
            width: 42px;
            height: 32px;
            background: linear-gradient(135deg, #e2cba6 0%, #d4af37 50%, #b8860b 100%);
            border-radius: 6px;
            position: relative;
            margin-bottom: 20px;
            margin-top: 15px;
            box-shadow: inset 0 1px 2px rgba(255,255,255,0.2), 0 1px 2px rgba(0,0,0,0.2);
        }
        .card-chip::before {
            content: '';
            position: absolute;
            top: 50%; left: 0; width: 100%; height: 1px;
            background: rgba(0,0,0,0.2);
            box-shadow: 0 -8px 0 rgba(0,0,0,0.2), 0 8px 0 rgba(0,0,0,0.2);
        }
        .card-chip::after {
            content: '';
            position: absolute;
            left: 50%; top: 15%; width: 1px; height: 70%;
            background: rgba(0,0,0,0.2);
            box-shadow: -10px 0 0 rgba(0,0,0,0.2), 10px 0 0 rgba(0,0,0,0.2);
            border-radius: 4px; /* Soften lines a bit */
        }

        /* Wifi Icon (Contactless) */
        .contactless-icon {
            position: absolute;
            top: 28px;
            right: 28px;
            color: rgba(255,255,255,0.5);
            transform: rotate(90deg);
            font-size: 24px;
        }

        /* Concentric Circles - Removed for cleaner 'less obvious' look as requested */
        .card-bg-circles { display: none; } 

        .card-label { font-size: 10px; font-weight: 700; color: rgba(255,255,255,0.5); margin-bottom: 2px; text-transform: uppercase; letter-spacing: 1.5px; }
        /* Fixed Balance - Inter/System font for numbers looks better */
        .balance-amount { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 30px; font-weight: 800; letter-spacing: -1px; margin-bottom: auto; text-shadow: 0 4px 8px rgba(0,0,0,0.3); padding-top: 4px; }
        
        /* Footer area pushed to bottom */
        .card-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 12px; position: relative; z-index: 2; }
        
        .card-number-box { line-height: 1.4; }
        .card-number-label { font-size: 9px; font-weight: 700; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 2px; }
        .card-number { font-size: 13px; font-weight: 700; color: rgba(255,255,255,0.9); letter-spacing: 3px; font-family: monospace; }
        
        .mastercard-circles { display: flex; position: relative; width: 44px; height: 28px; }
        .circle { width: 28px; height: 28px; border-radius: 50%; position: absolute; }
        .circle-1 { background: rgba(255,255,255,0.2); left: 0; backdrop-filter: blur(2px); }
        .circle-2 { background: rgba(255,255,255,0.15); left: 16px; backdrop-filter: blur(2px); }

        /* INTEGRATED SYNC BAR - Glassmorphic Pill */
        .card-sync-bar { 
            background: rgba(255,255,255,0.05); 
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 12px; 
            padding: 10px 14px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-size: 11px; 
            font-weight: 600; 
            color: rgba(255,255,255,0.8); 
            border: 1px solid rgba(255,255,255,0.08); 
            margin-top: 10px; 
            transition: all 0.3s; 
            position: relative;
            z-index: 2;
            width: 100%;
        }
        .card-sync-bar.active { background: rgba(255,255,255,0.1); }
        .card-sync-bar .dot { width: 6px; height: 6px; border-radius: 50%; background: #4caf50; box-shadow: 0 0 6px rgba(76, 175, 80, 0.5); }
        .card-sync-bar.syncing .dot { background: #3b82f6; box-shadow: 0 0 8px rgba(59, 130, 246, 0.6); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.3); } 100% { opacity: 1; transform: scale(1); } }

        .mui-container { width: 100%; max-width: 100% !important; margin: 0; padding: 0 24px 100px; }
        .control-panel { padding: 0; margin-bottom: 24px; background: transparent; box-shadow: none; }
        .status-labels { display: flex; gap: 10px; margin-bottom: 20px; }
        .status-chip { font-size: 11px; padding: 4px 10px; border-radius: 12px; border: 1px solid #e2e8f0; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-ready { border-color: #4caf50; color: #2e7d32; background: #f0fdf4; }

        /* ACCORDION */
        .month-accordion { margin-bottom: 16px; background: #fff; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #eef2f6; transition: box-shadow 0.2s; position: relative; }
        .month-accordion:hover { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .month-header { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; -webkit-user-select: none; user-select: none; }
        .month-header:hover { background: #f8fafc; }
        .month-header .month-title { font-weight: 700; font-size: 0.85rem; color: #1e293b; }
        .month-header .month-total { font-weight: 800; color: #3b82f6; font-size: 0.85rem; }
        .month-header .expand-icon { transition: transform 0.3s; color: #64748b; }
        .month-header.collapsed .expand-icon { transform: rotate(-90deg); }
        
        .month-content { border-top: 1px solid #f1f5f9; max-height: 5000px; transition: max-height 0.4s ease; position: relative; z-index: 10; }
        .month-content.collapsed { max-height: 0; overflow: hidden; border-top: none; }

        /* TRANSACTION ITEM - PREMIUM REDESIGN */
        .txn-item { padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f8fafc; position: relative; transition: all 0.2s; background: #fff; }
        .txn-item:last-child { border-bottom: none; }
        .txn-item:hover { background-color: #f8fafc; }
        
        .txn-left { display: flex; align-items: center; gap: 15px; flex: 1; }
        .txn-icon-box { min-width: 48px; width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative; }
        .txn-icon-box i { font-size: 22px; }
        
        /* CATEGORY COLORS */
        .cat-online { background-color: #fff7ed; color: #f97316; } /* Orange */
        .cat-vehicle { background-color: #f5f3ff; color: #8b5cf6; } /* Purple */
        .cat-shopping { background-color: #dbeafe; color: #3b82f6; } /* Soft Blue bg, Blue icon for Shopping */
        .cat-services { background-color: #f0fdf4; color: #22c55e; } /* Green - General Services */
        .cat-service-magenta { background-color: #fdf2f9; color: #d946ef; } /* Magenta - Telco/Specific Service */
        .cat-food { background-color: #fefce8; color: #eab308; } /* Yellow/Gold */
        .cat-life { background-color: #ecfdf5; color: #10b981; } /* Emerald */
        .cat-financial { background-color: #fef2f2; color: #ef4444; } /* Red */
        .cat-trading { background-color: #fff1f2; color: #ef4444; } /* Red - Trading */
        .cat-aqua { background-color: #ecfeff; color: #0891b2; } /* Dark Aqua/Cyan - Trade Copier */
        .cat-investments { background-color: #f0fdfa; color: #0d9488; } /* Teal/Dark Green */
        .cat-school { background-color: #eff6ff; color: #3b82f6; } /* Blue */
        .cat-red { background-color: #fef2f2; color: #ef4444 !important; } /* Force Red for Financial */
        
        .txn-info { display: flex; flex-direction: column; }
        .txn-merchant { font-weight: 700; font-size: 0.95rem; color: #1e293b; margin-bottom: 3px; letter-spacing: -0.2px; }
        .txn-subtitle { font-size: 0.8rem; color: #64748b; font-weight: 500; display: flex; align-items: center; gap: 4px; }
        .txn-dot { font-size: 14px; opacity: 0.5; }
        
        .txn-right { display: flex; align-items: center; gap: 8px; }
        .txn-amount { font-weight: 800; font-size: 1rem; color: #0f172a; white-space: nowrap; }

        /* EXCLUDED STATE - Only fade content, keep actions clear */
        .txn-item.txn-excluded .txn-left,
        .txn-item.txn-excluded .txn-amount { opacity: 0.35; filter: grayscale(1); text-decoration: line-through; }
        
        /* HOVER ACTION */
        .txn-actions { opacity: 0; transition: opacity 0.2s; position: relative; z-index: 60; }
        .txn-item:hover .txn-actions { opacity: 1; }
        .action-btn { background: none; border: none; cursor: pointer; color: #94a3b8; padding: 4px; border-radius: 50%; display: flex; align-items: center; }
        .action-btn:hover { background: #f1f5f9; color: #475569; }
        
        /* DROPDOWN MENU */
        .dropdown-menu { display: none; position: absolute; right: 0; top: 100%; background: #fff; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); border-radius: 8px; z-index: 100; border: 1px solid #e2e8f0; padding: 4px 0; }
        .dropdown-menu.show { display: block; }
        .dropdown-item { padding: 10px 16px; font-size: 13px; color: #475569; display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600; white-space: nowrap; }
        .dropdown-item:hover { background: #f1f5f9; }
        .dropdown-item.danger { color: #ef4444; }
        .dropdown-item.danger:hover { background: #fef2f2; }

        /* MODAL STYLES */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-overlay.show { display: flex; }
        .custom-modal { background: #fff; width: 92%; max-width: 380px; border-radius: 20px; padding: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); animation: modalIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes modalIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header { font-size: 1.1rem; font-weight: 700; color: #0f172a; margin-bottom: 4px; }
        .modal-body { margin-bottom: 12px; }
        .cat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 16px; }
        .cat-option { border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px; display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; transition: all 0.2s; }
        .cat-option:hover { border-color: #3b82f6; background: #eff6ff; }
        .cat-option.active { border-color: #3b82f6; background: #eff6ff; box-shadow: 0 0 0 2px #3b82f6; }
        .cat-option i { font-size: 24px; }
        .cat-option span { font-size: 12px; font-weight: 600; color: #475569; text-align: center; }
        .note-input { width: 100%; border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px 12px; font-size: 14px; min-height: 60px; resize: none; outline: none; transition: border-color 0.2s; color: #1e293b; }
        .note-input:focus { border-color: #3b82f6; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 16px; margin-top: 8px; }
        .cancel-link { color: #1e293b; font-weight: 700; font-size: 13px; text-transform: uppercase; cursor: pointer; padding: 10px 16px; border-radius: 4px; transition: background 0.2s; }
        .cancel-link:hover { background: #f1f5f9; }

        /* NOTE DISPLAY - INLINE */
        .txn-note-inline { font-size: 11px; font-style: italic; max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; background: transparent !important; padding: 0 !important; }
        
        /* TOAST NOTIFICATION */
        
        /* TOAST NOTIFICATION */
        .toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 12px 24px; border-radius: 50px; font-size: 14px; font-weight: 600; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); z-index: 2000; display: flex; align-items: center; gap: 8px; opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .toast-container.show { opacity: 1; bottom: 30px; pointer-events: auto; }
        .toast-container i { color: #4ade80; }

        #log-container { background: #1e293b; color: #4ade80; padding: 15px; border-radius: 8px; font-family: 'Consolas', monospace; height: 140px; overflow-y: auto; font-size: 13px; margin-top: 30px; border: 1px solid #334155; line-height: 1.5; }
        .log-entry { margin-bottom: 6px; border-bottom: 1px solid #334155; padding-bottom: 4px; }
        .log-error { color: #f87171; font-weight: bold; }
        
        .loading-overlay { display: none; text-align: center; padding: 60px; color: #64748b; }
        .btn-sync { background-color: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s, transform 0.1s; }
        .btn-sync:hover { background-color: #2563eb; }
        .btn-sync:active { transform: scale(0.98); }
        .btn-sync:disabled { background-color: #94a3b8; cursor: not-allowed; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }

        /* PIE CHART STYLES - THICKER & MODERN */
        .chart-card { background: #fff; border-radius: 24px; padding: 24px; margin-bottom: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .chart-container { position: relative; width: 220px; height: 220px; margin: 0 auto 24px; filter: drop-shadow(0 0 15px rgba(59, 130, 246, 0.05)); }
        .chart-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: #fff; width: 90px; height: 90px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: inset 0 4px 12px rgba(0,0,0,0.03); border: 4px solid #f8fafc; z-index: 10; pointer-events: none; gap: 2px; }
        .chart-center-label { font-size: 9px; color: #94a3b8; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; line-height: 1; margin: 0; }
        .chart-center-value { font-size: 16px; font-weight: 800; color: #0f172a; letter-spacing: -0.5px; line-height: 1; text-align: center; }
        
        /* Highlighted Transaction Styling */
        .premium-txn.highlight-txn { background-color: #f0fdf4 !important; border-left: 3px solid #4caf50; transition: background-color 0.3s; }
        
        /* Floating Chart Tooltip */
        #chart-tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(4px);
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            pointer-events: none;
            opacity: 0;
            transform: translate(-50%, -100%);
            transition: opacity 0.2s;
            z-index: 100;
            white-space: nowrap;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* SIMPLE LEGEND */
        .legend { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 15px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; color: #1e293b; font-weight: 600; }
        .legend-color { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; height: 75px; background: #fff; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-around; align-items: center; padding: 0 10px; z-index: 1000; box-shadow: 0 -5px 15px rgba(0,0,0,0.02); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #94a3b8; cursor: pointer; text-decoration: none; padding: 10px; transition: all 0.2s; }
        .nav-item.active { color: #10b981; }
        .nav-item i { font-size: 24px; }
        .nav-item span { font-size: 11px; font-weight: 700; }

        /* FAB */
        .fab { position: fixed; bottom: 100px; right: calc(50% - 215px + 24px); width: 62px; height: 62px; border-radius: 50%; background: #10b981; color: #fff; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3); z-index: 999; cursor: pointer; border: none; transition: transform 0.2s; }
        .fab:active { transform: scale(0.95); }
        .fab i { font-size: 32px; }
        
        @media (max-width: 430px) {
            .fab { right: 24px; }
            .bottom-nav { left: 0; transform: none; }
        }

        /* TREND CHART */
        .trend-card { background: #fff; border-radius: 20px; padding: 24px; margin-bottom: 24px; border: 1px solid #f1f5f9; box-shadow: 0 4px 20px rgba(0,0,0,0.02); }
        .trend-path { filter: drop-shadow(0 4px 6px rgba(59, 130, 246, 0.2)); }
        .trend-dot { fill: #fff; stroke: #3b82f6; stroke-width: 2.5; }
        .trend-label { font-size: 10px; fill: #94a3b8; font-weight: 600; }
        
        /* RECENT ACTIVITIES PREMIUM LIST */
        .recent-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding: 0 4px; }
        .recent-header h3 { margin: 0; font-weight: 700; font-size: 13px; color: #64748b; text-transform: uppercase; letter-spacing: 1.2px; }
        .recent-header .see-all { color: #10b981; font-size: 13px; font-weight: 800; text-decoration: none; text-transform: uppercase; }

        .premium-txn { padding: 12px 20px; display: flex; align-items: center; gap: 14px; border-bottom: 1px solid #f8fafc; background: #fff; }
        .premium-txn:last-child { border-bottom: none; }
        .premium-txn .icon-box { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
        .premium-txn .txn-details { flex: 1; min-width: 0; }
        .premium-txn .txn-merch { font-weight: 800; color: #1e293b; letter-spacing: -0.3px; font-size: 12.5px; text-transform: uppercase; }
        .premium-txn .txn-sub { font-size: 11px; color: #94a3b8; font-weight: 500; }
        .premium-txn .txn-amount { font-weight: 800; color: #1e293b; text-align: right; font-size: 13px; }
        .premium-txn .txn-amount.large { color: #991b1b; }
        .premium-txn .txn-note { font-size: 11px; font-weight: 500; margin-top: 1px; }
        
        /* ACTIONS & DROPDOWN */
        .premium-txn .txn-actions { opacity: 1; z-index: 100; }
        .premium-txn .dropdown-menu { right: 0; top: 28px; }
        
        /* EXCLUDED STATE FOR PREMIUM TRANSACTIONS */
        .premium-txn.txn-excluded { opacity: 0.4; }
        .premium-txn.txn-excluded .txn-merch,
        .premium-txn.txn-excluded .txn-sub,
        .premium-txn.txn-excluded .txn-amount,
        .premium-txn.txn-excluded .txn-note { text-decoration: line-through; }
        .premium-txn.txn-excluded .icon-box { filter: grayscale(1); opacity: 0.5; }
        
        /* iOS-STYLE LONG-PRESS BLUR EFFECT */
        .blur-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; }
        .blur-overlay.active { display: block; }
        
        /* Global Blur for elements */
        .mobile-wrapper.blur-active { filter: blur(8px) brightness(0.9); -webkit-filter: blur(8px) brightness(0.9); transition: filter 0.3s; pointer-events: none; }
        .fab.blur-active, .bottom-nav.blur-active { filter: blur(10px) brightness(0.6); -webkit-filter: blur(10px) brightness(0.6); pointer-events: none; }
        
        /* Shadow for the elevated clone */
        .premium-txn.elevated-clone { position: fixed; z-index: 2001; background: #fff; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); transform: scale(1.02); pointer-events: auto; border: 1px solid rgba(0,0,0,0.05); }
        
        .ios-action-menu { display: none; position: fixed; background: rgba(255,255,255,0.95); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); border-radius: 14px; padding: 4px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 2002; min-width: 180px; max-width: 200px; overflow: hidden; }
        .ios-action-menu.show { display: block; animation: menuSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes menuSlideIn { from { opacity: 0; transform: translateY(-10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        .ios-action-item { padding: 10px 14px; font-size: 13px; font-weight: 600; color: #1e293b; display: flex; align-items: center; gap: 8px; cursor: pointer; border-radius: 10px; transition: background 0.2s; -webkit-user-select: none; user-select: none; }
        .ios-action-item:hover { background: rgba(0,0,0,0.05); }
        .ios-action-item i { font-size: 18px; color: #3b82f6; }
        .ios-action-item.danger { color: #ef4444; }
        .ios-action-item.danger i { color: #ef4444; }
    </style>
</head>
<body>

    <!-- CHART TOOLTIP -->
    <div id="chart-tooltip"></div>

    <div class="mobile-wrapper">
        <div id="header">
            <div class="greeting-section">
                <div class="greeting-text">GOOD MORNING</div>
                <div class="user-name" id="user-display-name">Guest</div>
            </div>
            <div id="profile-badge" onclick="handleAuthClick()">
                <i class="material-icons">person</i>
                <img id="user-pic" src="" alt="Profile">
            </div>
        </div>

        <!-- RICH BLACK ATM CARD -->
        <div class="balance-card">
                <!-- Contactless Icon Removed -->
                <!-- EMV Chip Removed -->
                
                <div class="card-label">SPENDING BALANCE</div>
                <div class="balance-amount">PHP 0.00</div>
                
                <div class="card-footer">
                <div class="card-number-box">
                    <div class="card-number-label">Account Number</div>
                    <div class="card-number">**** **** 7312</div>
                </div>
                <div class="mastercard-circles">
                    <div class="circle circle-1"></div>
                    <div class="circle circle-2"></div>
                </div>
            </div>
            
            <!-- INTEGRATED SYNC BAR -->
            <div class="card-sync-bar" id="cardSyncBar">
                <div class="dot" id="syncDot"></div>
                <span id="syncStatusText">Gmail Synced</span>
            </div>
        </div>

        <div class="mui-container">
            <div class="control-panel">
                <div class="status-labels" style="justify-content: center; margin-bottom: 24px;">
                    <div id="gis-status" class="status-chip">GIS: Loading...</div>
                    <div id="db-status" class="status-chip">DB: Ready</div>
                </div>
                
                <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 30px;">
                    <button id="scan-btn" class="mui-btn mui-btn--flat" style="border-radius:20px; text-transform:none; font-weight:700; background:#f1f5f9; color:#475569;" onclick="handleScan(50)">
                        <i class="material-icons" style="font-size:18px; vertical-align:middle; margin-right:4px;">sync</i> Sync Gmail
                    </button>
                    <button class="mui-btn mui-btn--flat" style="border-radius:20px; text-transform:none; font-weight:700; background:#f1f5f9; color:#475569;" onclick="loadData()">History</button>
                </div>
            </div>

            <!-- EXPENSES STRUCTURE (WEB3 MODERN) -->
            <div id="chart-section" class="chart-card" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h3 style="margin: 0; font-size: 1.1rem; font-weight: 800; color: #1e293b; letter-spacing: -0.5px;">Expenses structure</h3>
                    <select id="chart-filter" onchange="filterChart()" class="mui-btn mui-btn--flat" style="font-size: 12px; font-weight: 600; color: #1e293b; background: #f8fafc; padding: 0 8px 0 12px; border-radius: 8px; height: 30px; text-transform: none; border: 1px solid #e2e8f0; outline: none; cursor: pointer; text-align: left; width: auto; min-width: 110px;">
                        <option value="today">Today</option>
                        <option value="this_month">This Month</option>
                        <option value="this_week">This Week</option>
                        <option value="last_week">Last Week</option>
                        <option value="first_15">First 15 of Month</option>
                        <option value="last_15">Last 15 of Month</option>
                        <option value="last_month">Last Month</option>
                        <option value="last_3_months">Last 3 Months</option>
                        <option value="last_6_months">Last 6 Months</option>
                        <option value="this_year">This Year</option>
                    </select>
                </div>

                <div style="display: flex; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <div style="font-size: 11px; color: #94a3b8; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Total Expenses</div>
                        <div style="font-size: 22px; font-weight: 800; color: #0f172a; letter-spacing: -0.5px;" id="expenses-total-summary">PHP 0.00</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 11px; color: #94a3b8; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">vs past period</div>
                        <div id="mom-growth-box" style="font-size: 22px; font-weight: 800; color: #ef4444; letter-spacing: -0.5px;"><span id="mom-growth"></span></div>
                    </div>
                </div>

                <div class="chart-container">
                    <svg id="pieChart" width="220" height="220" viewBox="0 0 240 240"></svg>
                    <div class="chart-center">
                        <div class="chart-center-label">TOTAL</div>
                        <div class="chart-center-value" id="chart-total-val">0</div>
                    </div>
                </div>
                <div id="chart-legend" class="legend">
                    <!-- Dynamic segments will go here -->
                </div>
            </div>

            <!-- TREND SECTION -->
            <div class="trend-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h3 style="margin: 0; font-size: 1.1rem; font-weight: 800; color: #1e293b;">Spending Trends</h3>
                    <select class="mui-btn mui-btn--flat" style="font-size: 12px; font-weight: 700; color: #1e293b; background: #f8fafc; padding: 0 16px; border-radius: 12px; height: 36px; text-transform: none; border: 1px solid #e2e8f0; border-bottom: none; -webkit-appearance: none; appearance: none;">
                        <option>This Month</option>
                    </select>
                </div>
                <div style="height: 140px; width: 100%; position: relative; margin-bottom: 20px;">
                    <svg id="trendChart" width="100%" height="140" viewBox="0 0 400 140" preserveAspectRatio="none">
                        <defs>
                            <linearGradient id="trendGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#3b82f6; stop-opacity:0.1" />
                                <stop offset="100%" style="stop-color:#3b82f6; stop-opacity:0" />
                            </linearGradient>
                        </defs>
                        <path id="trendArea" d="" fill="url(#trendGradient)"></path>
                        <path id="trendPath" class="trend-path" d="" fill="none" stroke="#3b82f6" stroke-width="4" stroke-linecap="round"></path>
                        <g id="trendDots"></g>
                    </svg>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; padding: 0 5px;">
                        <span class="trend-label">Week 1</span>
                        <span class="trend-label">Week 2</span>
                        <span class="trend-label">Week 3</span>
                        <span class="trend-label">Week 4</span>
                    </div>
                </div>
                <div style="border-top: 1px dashed #e2e8f0; padding-top: 16px; display: flex; justify-content: space-between; align-items: center; padding-top: 16px;">
                    <span style="font-size: 13px; color: #64748b; font-weight: 600;">Period Total</span>
                    <span style="font-size: 1.1rem; font-weight: 800; color: #10b981;" id="trend-period-total">PHP 0.00</span>
                </div>
            </div>

            <div class="recent-header">
                <h3>Recent Transactions</h3>
                <a href="#" class="see-all">See All</a>
            </div>

            <div id="loading-spinner" class="loading-overlay">
                <i class="material-icons spin" style="font-size: 48px; color: #1e293b;">sync</i>
            </div>

            <div id="history-container"></div>
            <div id="log-container"></div>
        </div>

        <button class="fab" onclick="openManualTxnModal()">
            <i class="material-icons">add</i>
        </button>

        <!-- BOTTOM NAV -->
        <div class="bottom-nav">
            <a href="#" class="nav-item active">
                <i class="material-icons">home</i>
                <span>Home</span>
            </a>
            <a href="#" class="nav-item">
                <i class="material-icons">history</i>
                <span>History</span>
            </a>
            <a href="#" class="nav-item">
                <i class="material-icons">account_balance_wallet</i>
                <span>Wallet</span>
            </a>
            <a href="#" class="nav-item">
                <i class="material-icons">settings</i>
                <span>Settings</span>
            </a>
        </div>
    </div>

    <!-- iOS-STYLE BLUR OVERLAY (NOW AT BODY LEVEL) -->
    <div class="blur-overlay" id="blurOverlay" onclick="closeIOSMenu()"></div>
    <div class="ios-action-menu" id="iosActionMenu"></div>

    <script>
        // Global bridge for GIS callback to avoid module race condition
        window.gisLoaded = function() {
            if (window.initGISModule) window.initGISModule();
            else window.gisReadyPending = true;
        };
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, collection, serverTimestamp, getDocs, query, orderBy, updateDoc, deleteField, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBHDN0xLi98qjYYjUf2RDCn5gJK0dzTk_M",
            authDomain: "atome-wallet.firebaseapp.com",
            projectId: "atome-wallet",
            storageBucket: "atome-wallet.firebasestorage.app",
            messagingSenderId: "64186651619",
            appId: "1:64186651619:web:cd7d426cfb663aab6606d6",
            measurementId: "G-2SHWJ6S3Z3"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ENABLE OFFLINE PERSISTENCE
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                log('Persistence failed: Multiple tabs open');
            } else if (err.code == 'unimplemented') {
                log('Persistence not supported');
            }
        });

        // REGISTER SERVICE WORKER
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker Registered'))
                .catch(err => console.log('SW Registration Failed', err));
        }

        // GOOGLE AUTH CONSTANTS
        const CLIENT_ID = '64186651619-3eb9ki680f4c8q2g2mese3c8hhfur23b.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/userinfo.profile';
        let tokenClient;
        let accessToken = localStorage.getItem('g_access_token');
        let expiry = localStorage.getItem('g_token_expiry');

        // INITIALIZE APP
        window.addEventListener('DOMContentLoaded', async () => {
            log('SmartWallet Sync - v1.2 Optimizing...');

            // 1. Immediate UI population from Cache
            const cachedName = localStorage.getItem('user_name');
            const cachedPic = localStorage.getItem('user_pic');
            if (cachedName) document.getElementById('user-display-name').innerText = cachedName;
            if (cachedPic) {
                const badge = document.getElementById('profile-badge');
                const picEl = document.getElementById('user-pic');
                picEl.src = cachedPic;
                badge.classList.add('has-pic');
            }
            
            // 2. Firebase Init
            try {
                if (!auth.currentUser) await signInAnonymously(auth);
                const dbBadge = document.getElementById('db-status');
                dbBadge.innerText = 'DB: Connected';
                dbBadge.classList.add('status-ready');
                log('Firebase connected.');
            } catch (e) { log('Firebase Fail: ' + e.message, 'error'); }

            // 3. Initial Data Load (Firestore)
            await loadData();

            // 4. Auto-refresh profile & Auto-sync if token is valid
            const expiry = localStorage.getItem('g_token_expiry');
            if (accessToken && expiry && Date.now() < parseInt(expiry)) {
                log('Google session valid. Refreshing profile...');
                fetchUserProfile(accessToken);
                // Auto-sync on load
                setTimeout(() => handleScan(300), 1000); 
            } else {
                log('No active Google session. Using cached profile.');
            }
        });

        // FETCH TRANSACTIONS FROM FIRESTORE
        async function loadData() {
            const container = document.getElementById('history-container');
            const spinner = document.getElementById('loading-spinner');
            
            spinner.style.display = 'block';
            try {
                if (!auth.currentUser) await signInAnonymously(auth);
                const uid = auth.currentUser.uid;
                let q = query(collection(db, "users", uid, "transactions"), orderBy("date", "desc"));
                let snap = await getDocs(q);

                // Fallback to guest-user if UID is new/empty
                if (snap.empty) {
                    const legacyQ = query(collection(db, "users", "guest-user", "transactions"), orderBy("date", "desc"));
                    snap = await getDocs(legacyQ);
                    if (!snap.empty) log('Fetched data from legacy guest session.');
                }

                let txns = [];
                const batchUpdates = []; // Collect updates for fuel notes

                snap.forEach(d => {
                    const data = d.data();
                    if (data.deleted) return; 

                    const t = { id: d.id, ...data };
                    txns.push(t);
                    
                    // PERSIST AUTOMATED FUEL NOTES
                    if (!t.note) {
                        const mapped = getMerchantDisplay(t.merchant || '', t);
                        if (mapped.category === 'Vehicle') {
                            const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                            const autoNote = (amt > 250) ? "Car Refill" : "Motor Refill";
                            
                            // Queue update to Firestore
                            const docRef = doc(db, "users", uid, "transactions", t.id);
                            batchUpdates.push(updateDoc(docRef, { note: autoNote }));
                            
                            // Update local object effectively immediately
                            t.note = autoNote; 
                        }
                    }
                });
                
                // Execute batch updates if any
                if (batchUpdates.length > 0) {
                    Promise.all(batchUpdates).then(() => log(`Persisted ${batchUpdates.length} automated notes.`));
                }

                // Store globally
                window.allTxns = txns;

                if (txns.length === 0) {
                    container.innerHTML = `
                        <div style="text-align:center; padding:60px 20px; color:#64748b; background: white; border-radius: 12px; border: 1px dashed #cbd5e1;">
                            <i class="material-icons" style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">inbox</i>
                            <p style="margin:0; font-weight: 500;">No transactions found.</p>
                            <p style="font-size: 13px; margin: 10px 0 0;">Click "Scan Gmail" to sync your Atome payments.</p>
                        </div>`;
                } else {
                    renderHistory(txns);
                    // Initial chart filter with Persistence
                    const savedFilter = localStorage.getItem('wallet_chart_filter');
                    const filterEl = document.getElementById('chart-filter');
                    
                    if (savedFilter && filterEl.querySelector(`option[value="${savedFilter}"]`)) {
                        filterEl.value = savedFilter;
                    } else {
                        // Default to 'this_week' if not saved
                        filterEl.value = 'this_week';
                    }
                    
                    filterChart();
                }
                window.highlightTransactions = (categoryName) => {
            const items = document.querySelectorAll('.premium-txn');
            items.forEach(item => {
                // If clicking the same category again, we could toggle off (optional), 
                // but for now let's just highlight the new one.
                item.classList.remove('highlight-txn');
                        
                        const catElement = item.querySelector('.txn-sub span:last-child');
                        if (catElement && catElement.innerText === categoryName) {
                            item.classList.add('highlight-txn');
                        }
                    });
                    
                    // Scroll to first highlighted
                    const first = document.querySelector('.highlight-txn');
                    if (first) first.scrollIntoView({ behavior: 'smooth', block: 'center' });
                };    } catch (e) { 
                log('Failed to load history: ' + e.message, 'error');
            } finally {
                spinner.style.display = 'none';
            }
        }
        window.loadData = loadData;

        // FILTERING LOGIC
        window.filterChart = () => {
            const filterEl = document.getElementById('chart-filter');
            const filter = filterEl.value;
            
            // Persist selection
            localStorage.setItem('wallet_chart_filter', filter);

            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const date = now.getDate();
            
            if (!window.allTxns) return;

            // Helper for week numbers
            const getWeek = (d) => {
                const onejan = new Date(d.getFullYear(), 0, 1);
                return Math.ceil((((d - onejan) / 86400000) + onejan.getDay() + 1) / 7);
            };

            const checkPeriod = (t, periodType, shift = 0) => {
                const d = new Date(t.date);
                const dYear = d.getFullYear();
                const dMonth = d.getMonth();
                const dDate = d.getDate();
                const dWeek = getWeek(d);
                const currentWeek = getWeek(now);

                if (periodType === 'today') {
                    // Current: Today (shift 0), Past: Yesterday (shift 1)
                    const target = new Date(now);
                    target.setDate(date - shift);
                    return dYear === target.getFullYear() && dMonth === target.getMonth() && dDate === target.getDate();
                }

                if (periodType === 'this_month') {
                    // Current (0): This Month, Past (1): Last Month
                    const targetMonth = (month - shift + 12) % 12;
                    const targetYear = year - Math.floor((12 - (month - shift) - 1) / 12); // Handle year wrap roughly, or simplified:
                    // Better:
                    const targetD = new Date(year, month - shift, 1);
                    return dMonth === targetD.getMonth() && dYear === targetD.getFullYear();
                }
                
                if (periodType === 'this_week') {
                     // Current (0): This week, Past (1): Last week
                     // Note: Simple logic assuming same year for simplicity or handling close year boundaries
                     if (shift === 0) return dWeek === currentWeek && dYear === year;
                     if (shift === 1) return dWeek === currentWeek - 1 && dYear === year;
                }
                
                if (periodType === 'last_week') {
                     // Current (0): Last week, Past (1): 2 weeks ago
                     if (shift === 0) return dWeek === currentWeek - 1 && dYear === year;
                     if (shift === 1) return dWeek === currentWeek - 2 && dYear === year;
                }

                if (periodType === 'first_15') {
                    // Current (0): <= 15th of THIS month
                    // Past (1): > 15th of PREVIOUS month
                    if (shift === 0) return dDate <= 15 && dMonth === month && dYear === year;
                    if (shift === 1) {
                        const prevMonthDate = new Date(year, month - 1, 1);
                        return dDate > 15 && dMonth === prevMonthDate.getMonth() && dYear === prevMonthDate.getFullYear();
                    }
                }
                
                if (periodType === 'last_15') {
                    // Current (0): > 15th of THIS month
                    // Past (1): <= 15th of THIS month
                    if (shift === 0) return dDate > 15 && dMonth === month && dYear === year;
                    if (shift === 1) return dDate <= 15 && dMonth === month && dYear === year;
                }
                
                if (periodType === 'last_month') {
                    // Current (0): Last month
                    // Past (1): 2 months ago
                    const targetDate = new Date(year, month - 1 - shift, 1);
                     return dMonth === targetDate.getMonth() && dYear === targetDate.getFullYear();
                }
                
                if (periodType === 'last_3_months') {
                    const limit = new Date(now);
                    limit.setMonth(limit.getMonth() - 3 - (shift * 3));
                    const upper = new Date(now);
                    if (shift > 0) upper.setMonth(upper.getMonth() - 3);
                    
                    return d >= limit && (shift === 0 || d < upper);
                }
                
                if (periodType === 'last_6_months') {
                    const limit = new Date(now);
                    limit.setMonth(limit.getMonth() - 6 - (shift * 6));
                    const upper = new Date(now);
                    if (shift > 0) upper.setMonth(upper.getMonth() - 6);
                    return d >= limit && (shift === 0 || d < upper);
                }
                
                if (periodType === 'this_year') {
                    return dYear === (year - shift);
                }
                
                return false;
            };

            const filtered = window.allTxns.filter(t => checkPeriod(t, filter, 0));
            const past = window.allTxns.filter(t => checkPeriod(t, filter, 1));
            
            const pastTotal = past.reduce((sum, t) => {
                 if (t.excluded) return sum;
                 return sum + (t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0));
            }, 0);

            refreshChart(filtered, pastTotal);
        };

        // CHART LOGIC
        const categoryConfig = {
            'Online shopping': { color: '#f97316', class: 'cat-online' },
            'Vehicle': { color: '#8b5cf6', class: 'cat-vehicle' },
            'Shopping': { color: '#3b82f6', class: 'cat-shopping' },
            'Service': { color: '#d946ef', class: 'cat-service-magenta' },
            'Food & Drinks': { color: '#eab308', class: 'cat-food' },
            'Life & Entertainment': { color: '#10b981', class: 'cat-life' },
            'Trading Expenses': { color: '#ef4444', class: 'cat-trading' },
            'Trade Copier': { color: '#0891b2', class: 'cat-aqua' },
            'Financial Expenses': { color: '#ef4444', class: 'cat-financial' }
        };

        function refreshChart(txns, pastTotal = 0) {
            const chartSection = document.getElementById('chart-section');
            if (txns.length === 0) {
                chartSection.style.display = 'none';
                return;
            }
            chartSection.style.display = 'block';

            const totals = {};
            let grandTotal = 0;

            txns.forEach(t => {
                if (t.excluded) return;
                const mapped = getMerchantDisplay(t.merchant, t);
                const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                // BACKWARD COMPATIBILITY & MAPPING
                let cat = mapped.category || 'Other';
                if (cat === 'Financial expenses') cat = 'Financial Expenses';
                if (cat === 'Trading expenses') cat = 'Trading Expenses';
                
                totals[cat] = (totals[cat] || 0) + amt;
                grandTotal += amt;
            });

            if (grandTotal === 0) {
                chartSection.style.display = 'none';
                return;
            }

            const segments = Object.entries(totals).map(([name, value]) => ({
                name,
                value,
                color: (categoryConfig[name] || categoryConfig['Other']).color,
                class: (categoryConfig[name] || categoryConfig['Other']).class
            })).sort((a, b) => b.value - a.value);

            // Update Summary Total
            const summaryTotalEl = document.getElementById('expenses-total-summary');
            if (summaryTotalEl) summaryTotalEl.innerText = `PHP ${grandTotal.toLocaleString(undefined, {minimumFractionDigits:2})}`;

            // Update Growth with passed pastTotal
            const growthEl = document.getElementById('mom-growth');
            const growthBox = document.getElementById('mom-growth-box');
            if (growthEl && growthBox) {
                if (pastTotal > 0) {
                    const diff = ((grandTotal - pastTotal) / pastTotal) * 100;
                    const diffAbs = Math.abs(Math.round(diff));
                    growthEl.innerText = `${diff >= 0 ? '+' : '-'}${diffAbs}%`;
                    growthBox.style.color = diff >= 0 ? '#ef4444' : '#10b981';
                } else {
                    growthEl.innerText = '+0%';
                    growthBox.style.color = '#94a3b8';
                }
            }
            
            drawPieChart(segments, grandTotal);
            
            // Update Center Label Default
            document.getElementById('chart-total-label').innerText = 'TOTAL';
            document.getElementById('chart-total-val').innerText = `${Math.round(grandTotal).toLocaleString()}`;
        }


        function drawTrendChart(txns) {
            const path = document.getElementById('trendPath');
            const area = document.getElementById('trendArea');
            const dots = document.getElementById('trendDots');
            const totalEl = document.getElementById('trend-period-total');
            if (!path || txns.length === 0) return;

            // Group by Week (4 weeks of current month)
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const weekTotals = [0, 0, 0, 0];
            let periodTotal = 0;

            txns.forEach(t => {
                const d = new Date(t.date);
                if (t.excluded || d.getMonth() !== month || d.getFullYear() !== year) return;
                
                const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                periodTotal += amt;
                
                const date = d.getDate();
                if (date <= 7) weekTotals[0] += amt;
                else if (date <= 14) weekTotals[1] += amt;
                else if (date <= 21) weekTotals[2] += amt;
                else weekTotals[3] += amt;
            });

            totalEl.innerText = `PHP ${periodTotal.toLocaleString(undefined, {minimumFractionDigits:2})}`;

            const points = weekTotals;
            const max = Math.max(...points, 1000) * 1.2;
            const w = 400;
            const h = 140;
            const padding = 40;
            const chartW = w - (padding * 2);
            const step = chartW / 3;

            // Curved Line Logic (Catmull-Rom approximate)
            let d = "";
            let areaD = "";
            dots.innerHTML = '';

            const getPoint = (i) => {
                const x = padding + (i * step);
                const y = h - (points[i] / max) * h;
                return { x, y };
            };

            for (let i = 0; i < points.length; i++) {
                const p = getPoint(i);
                
                // Add Dot
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', p.x);
                circle.setAttribute('cy', p.y);
                circle.setAttribute('r', '5');
                circle.setAttribute('class', 'trend-dot');
                dots.appendChild(circle);

                if (i === 0) {
                    d += `M ${p.x} ${p.y}`;
                    areaD += `M ${p.x} ${h} L ${p.x} ${p.y}`;
                } else {
                    const prev = getPoint(i - 1);
                    const cp1x = prev.x + (p.x - prev.x) / 2;
                    d += ` C ${cp1x} ${prev.y}, ${cp1x} ${p.y}, ${p.x} ${p.y}`;
                    areaD += ` C ${cp1x} ${prev.y}, ${cp1x} ${p.y}, ${p.x} ${p.y}`;
                }
            }

            areaD += ` L ${padding + 3 * step} ${h} Z`;
            path.setAttribute('d', d);
            area.setAttribute('d', areaD);
        }

        function drawPieChart(segments, total) {
            const svg = document.getElementById('pieChart');
            const legend = document.getElementById('chart-legend');
            const totalVal = document.getElementById('chart-total-val');
            
            svg.innerHTML = '';
            legend.innerHTML = '';
            totalVal.innerText = `${Math.round(total).toLocaleString()}`;

            const centerX = 110;
            const centerY = 110;
            const radius = 105; 
            let currentAngle = -90;
            
            // Handle Single Category (100%) case
            if (segments.length === 1) {
                const seg = segments[0];
                const innerRadius = 60;
                
                // Draw full donut
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                // Calculate d for full circle donut
                const d = [
                    `M ${centerX} ${centerY - radius}`,
                    `A ${radius} ${radius} 0 1 1 ${centerX} ${centerY + radius}`,
                    `A ${radius} ${radius} 0 1 1 ${centerX} ${centerY - radius}`,
                    `M ${centerX} ${centerY - innerRadius}`,
                    `A ${innerRadius} ${innerRadius} 0 1 0 ${centerX} ${centerY + innerRadius}`,
                    `A ${innerRadius} ${innerRadius} 0 1 0 ${centerX} ${centerY - innerRadius}`,
                    'Z'
                ].join(' ');

                path.setAttribute('d', d);
                path.setAttribute('fill', seg.color);
                path.setAttribute('fill-rule', 'evenodd');
                path.style.cursor = 'pointer';
                path.onclick = () => {
                    document.getElementById('chart-total-label').innerText = seg.name;
                    document.getElementById('chart-total-val').innerText = `${Math.round(seg.value).toLocaleString()}`;
                    window.highlightTransactions(seg.name);
                };
                
                svg.appendChild(path);
                
                // Legend
                const lItem = document.createElement('div');
                lItem.className = 'legend-item';
                lItem.innerHTML = `<div class="legend-color" style="background: ${seg.color}"></div><span>${seg.name}</span>`;
                legend.appendChild(lItem);
                return;
            }

            segments.forEach(seg => {
                const percent = (seg.value / total) * 100;
                if (percent < 0.5) return; 

                const angle = (seg.value / total) * 360;
                const endAngle = currentAngle + angle;

                const largeArc = angle > 180 ? 1 : 0;
                const innerRadius = 60; // Thicker pie
                
                const x1 = centerX + radius * Math.cos((currentAngle * Math.PI) / 180);
                const y1 = centerY + radius * Math.sin((currentAngle * Math.PI) / 180);
                const x2 = centerX + radius * Math.cos((endAngle * Math.PI) / 180);
                const y2 = centerY + radius * Math.sin((endAngle * Math.PI) / 180);
                
                const ix1 = centerX + innerRadius * Math.cos((currentAngle * Math.PI) / 180);
                const iy1 = centerY + innerRadius * Math.sin((currentAngle * Math.PI) / 180);
                const ix2 = centerX + innerRadius * Math.cos((endAngle * Math.PI) / 180);
                const iy2 = centerY + innerRadius * Math.sin((endAngle * Math.PI) / 180);

                const d = [
                    `M ${x1} ${y1}`,
                    `A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2}`,
                    `L ${ix2} ${iy2}`,
                    `A ${innerRadius} ${innerRadius} 0 ${largeArc} 0 ${ix1} ${iy1}`,
                    'Z'
                ].join(' ');

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', d);
                path.setAttribute('fill', seg.color);
                path.setAttribute('stroke', '#fff');
                path.setAttribute('stroke-width', '4'); 
                path.style.transition = 'all 0.3s';
                
                // Interaction Events
                const showTooltip = (e) => {
                    const tooltip = document.getElementById('chart-tooltip');
                    tooltip.innerHTML = `${seg.name}<br><span style="color:#d1fae5">${Math.round(seg.value).toLocaleString()}</span>`;
                    tooltip.style.opacity = '1';
                    
                    // Logic to position tooltip near cursor
                    // We need to account for scrolling and absolute positioning
                    const rect = svg.getBoundingClientRect();
                    // Because tooltip is fixed/absolute to body usually, or relative to container
                    // Let's rely on e.pageX/Y
                    tooltip.style.left = `${e.pageX}px`;
                    tooltip.style.top = `${e.pageY - 10}px`;
                };

                const hideTooltip = () => {
                    document.getElementById('chart-tooltip').style.opacity = '0';
                };

                path.onmouseenter = showTooltip;
                path.onmousemove = showTooltip;
                path.onmouseleave = hideTooltip;

                path.onclick = (e) => {
                    // Update Center Label
                    document.getElementById('chart-total-label').innerText = seg.name;
                    document.getElementById('chart-total-val').innerText = `${Math.round(seg.value).toLocaleString()}`;
                    window.highlightTransactions(seg.name);
                };
                
                svg.appendChild(path);

                // Add to legend (Simple style)
                const lItem = document.createElement('div');
                lItem.className = 'legend-item';
                lItem.innerHTML = `
                    <div class="legend-color" style="background: ${seg.color}"></div>
                    <span>${seg.name}</span>
                `;
                legend.appendChild(lItem);

                currentAngle = endAngle;
            });
        }

        // RENDER ACCORDIONS
        function renderHistory(txns) {
            const container = document.getElementById('history-container');
            container.innerHTML = '';
            
            // refreshChart is now called via filterChart separately, but we still need trend
            drawTrendChart(txns);

            // Update ATM Card Balance - HARDCODED TO 0 AS REQUESTED
            const balanceEl = document.querySelector('.balance-amount');
            if (balanceEl) balanceEl.innerText = `PHP 0.00`;
            
            const groups = {};
            txns.forEach(t => {
                if (!t.date) return;

                const d = new Date(t.date);
                if (isNaN(d)) return;
                const key = d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                if (!groups[key]) groups[key] = { items: [], total: 0 };
                
                groups[key].items.push(t);
                // ONLY add to total if NOT excluded
                if (!t.excluded) {
                    const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                    groups[key].total += amt;
                }
            });

            const entries = Object.entries(groups);
            entries.forEach(([month, data], index) => {
                const accordion = document.createElement('div');
                accordion.className = 'month-accordion';
                
                const isFirst = index === 0;
                const header = document.createElement('div');
                header.className = `month-header ${!isFirst ? 'collapsed' : ''}`;
                header.innerHTML = `
                    <span class="month-title">${month}</span>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span class="month-total">${data.total.toLocaleString(undefined, {minimumFractionDigits:2})}</span>
                        <i class="material-icons expand-icon">expand_more</i>
                    </div>
                `;
                
                const content = document.createElement('div');
                content.className = `month-content ${!isFirst ? 'collapsed' : ''}`;
                
                data.items.forEach(t => {
                    const mapped = getMerchantDisplay(t.merchant, t);
                    const item = document.createElement('div');
                    item.className = `premium-txn ${t.excluded ? 'txn-excluded' : ''}`;
                    const d = new Date(t.date);
                    const shortDate = d.toLocaleDateString('en-US', { day: '2-digit', month: 'short' });
                    const safeMerchant = (mapped.name).replace(/'/g, "\\'");
                    const amount = (t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0));
                    
                    // Automated Fuel Note Logic
                    let displayNote = t.note;
                    if (!displayNote) {
                        if (mapped.category === 'Vehicle') {
                            displayNote = (amount > 250) ? "Car Refill" : "Motor Refill";
                        }
                    }

                    item.innerHTML = `
                        <div class="icon-box ${mapped.catClass}" style="background: ${mapped.catClass === 'cat-red' ? '#fee2e2' : ''}; color: ${mapped.catClass === 'cat-red' ? '#ef4444' : ''};">
                            <i class="material-icons">${mapped.icon}</i>
                        </div>
                        <div class="txn-details" style="display: flex; flex-direction: column; gap: 2px;">
                            <div class="txn-merch">${mapped.name}</div>
                            <div class="txn-sub">
                                <span>${shortDate}</span>
                                <span style="margin: 0 4px; opacity: 0.5;"></span>
                                <span>${displayCategoryName(mapped.category)}</span>
                            </div>
                            ${displayNote ? `<div class="txn-note" style="color: ${categoryConfig[mapped.category]?.color || '#94a3b8'}; opacity: 0.8;">${displayNote}</div>` : ''}
                        </div>
                        <div class="txn-right" style="display: flex; align-items: center; justify-content: flex-end;">
                            <div class="txn-amount ${amount >= 1000 ? 'large' : ''}">
                                ${Math.abs(amount).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}
                            </div>
                        </div>
                    `;
                    
                    // Add long-press data attributes
                    item.dataset.txnId = t.id;
                    item.dataset.merchant = safeMerchant;
                    item.dataset.amount = amount;
                    item.dataset.excluded = t.excluded || false;
                    item.dataset.category = mapped.category;
                    item.dataset.note = t.note || '';
                    
                    content.appendChild(item);
                });

                header.onclick = () => {
                    const isCollapsedNow = content.classList.toggle('collapsed');
                    header.classList.toggle('collapsed', isCollapsedNow);
                };
                
                accordion.appendChild(header);
                accordion.appendChild(content);
                container.appendChild(accordion);
            });
            
            // Setup long-press handlers after rendering
            setTimeout(() => setupLongPressHandlers(), 100);
        }

        // GOOGLE IDENTITY SERVICES
        function initGIS() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (resp) => {
                        if (resp.error) return log('Login failed: ' + resp.error, 'error');
                        accessToken = resp.access_token;
                        const expMs = Date.now() + (resp.expires_in * 1000);
                        localStorage.setItem('g_access_token', accessToken);
                        localStorage.setItem('g_token_expiry', expMs);
                        fetchUserProfile(accessToken);
                        handleScan(300);
                    },
                });
                const gisBadge = document.getElementById('gis-status');
                gisBadge.innerText = 'GIS: Ready';
                gisBadge.classList.add('status-ready');
            } catch (e) { log('GIS Init Error: ' + e.message, 'error'); }
        }

        // Expose init to global bridge
        window.initGISModule = initGIS;
        if (window.gisReadyPending) initGIS();

        async function fetchUserProfile(token) {
            try {
                const res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.name) {
                    const firstName = data.name.split(' ')[0];
                    document.getElementById('user-display-name').innerText = firstName;
                    
                    const badge = document.getElementById('profile-badge');
                    const picEl = document.getElementById('user-pic');
                    picEl.src = data.picture;
                    badge.classList.add('has-pic');
                    
                    // Cache for persistence
                    localStorage.setItem('user_name', firstName);
                    localStorage.setItem('user_pic', data.picture);
                }
            } catch (e) { log('Profile refresh fail: ' + e.message, 'error'); }
        }

        window.handleAuthClick = () => {
            if (!tokenClient) {
                log('GIS not ready.', 'error');
                if (typeof google !== 'undefined' && google.accounts) initGIS();
                return;
            }
            tokenClient.requestAccessToken({ prompt: 'consent' });
        };
        
        window.handleSignout = () => {
            if (confirm('Sign out?')) {
                localStorage.clear();
                location.reload();
            }
        };

        // GMAIL SCAN (OPTIMIZED WITH PARALLELISM)
        window.handleScan = async (limit) => {
            const expiry = localStorage.getItem('g_token_expiry');
            const isExpired = !accessToken || !expiry || Date.now() > parseInt(expiry);
            
            if (isExpired) {
                log('Session expired. Prompting for re-authorization...');
                tokenClient.requestAccessToken({ prompt: '' }); // Request silent re-auth or prompt
                return; // The callback will trigger handleScan again
            }
            
            const btn = limit === 50 ? document.getElementById('scan-btn') : document.getElementById('deep-scan-btn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="material-icons spin" style="font-size:18px;">sync</i> Syncing...';
            const bar = document.getElementById('cardSyncBar');
            const statusText = document.getElementById('syncStatusText');
            if (bar) bar.classList.add('syncing');
            if (statusText) statusText.innerText = 'Scanning Gmail...';
            
            try {
                log(`Starting fast sync (Parallel processing)...`);
                let url = `https://gmail.googleapis.com/gmail/v1/users/me/messages?maxResults=${limit}&q=subject:"Transaction Confirmation" (from:Atome OR from:no-reply@atome.ph)`;
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${accessToken}` }});
                const data = await res.json();
                const msgs = data.messages || [];
                
                if (msgs.length === 0) {
                    log('No new transactions found.');
                } else {
                    log(`Parsing ${msgs.length} messages in parallel...`);
                    
                    // Parallel Processing with batches of 10
                    const batchSize = 10;
                    let savedCount = 0;
                    
                    for (let i = 0; i < msgs.length; i += batchSize) {
                        const batch = msgs.slice(i, i + batchSize);
                        const promises = batch.map(async (m) => {
                            try {
                                const detailRes = await fetch(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${m.id}`, { headers: { 'Authorization': `Bearer ${accessToken}` }});
                                const d = await detailRes.json();
                                const txn = parseAtomeEmail(d.snippet, d.internalDate);
                                if (txn) {
                                    if (!auth.currentUser) await signInAnonymously(auth);
                                    const uid = auth.currentUser.uid;
                                    await setDoc(doc(db, "users", uid, "transactions", txn.id), { ...txn, createdAt: serverTimestamp() }, { merge: true });
                                    return true;
                                }
                            } catch (err) { return false; }
                            return false;
                        });
                        
                        const results = await Promise.all(promises);
                        savedCount += results.filter(Boolean).length;
                        log(`Processed batch ${Math.floor(i/batchSize) + 1}...`);
                    }
                    
                    log(`Sync finished! ${savedCount} transactions processed.`);
                    loadData();
                }
            } catch (e) { log('Scan error: ' + e.message, 'error'); }
            finally {
              btn.disabled = false;
              btn.innerHTML = originalHTML;
              if (bar) bar.classList.remove('syncing');
              if (statusText) statusText.innerText = 'Gmail Synced';
            }
        };

        function parseAtomeEmail(text, ts) {
            const m = text.match(/payment of [^\d]*([\d,]+\.?\d*)\s+for\s+(.+?)\s+using/i);
            if (!m) return null;
            return {
                id: 'txn_' + ts,
                amount: parseFloat(m[1].replace(/,/g, '')),
                merchant: m[2].trim(),
                date: new Date(parseInt(ts)).toISOString().split('T')[0]
            };
        }

        // iOS-STYLE LONG-PRESS MENU
        let longPressTimer = null;
        let currentElevatedItem = null;
        let clonedItem = null;
        
        function setupLongPressHandlers() {
            document.querySelectorAll('.premium-txn').forEach(item => {
                // Remove old event listeners by cloning
                const newItem = item.cloneNode(true);
                item.parentNode.replaceChild(newItem, item);
                
                let startX, startY;
                
                const startLongPress = (e) => {
                    startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                    startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
                    
                    longPressTimer = setTimeout(() => {
                        showIOSMenu(newItem, e);
                    }, 500);
                };
                
                const cancelLongPress = (e) => {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                };
                
                const checkMove = (e) => {
                    const currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                    const currentY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                    const distance = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2));
                    
                    if (distance > 10) {
                        cancelLongPress();
                    }
                };
                
                newItem.addEventListener('mousedown', startLongPress);
                newItem.addEventListener('touchstart', startLongPress, { passive: true });
                newItem.addEventListener('mouseup', cancelLongPress);
                newItem.addEventListener('touchend', cancelLongPress);
                newItem.addEventListener('mousemove', checkMove);
                newItem.addEventListener('touchmove', checkMove, { passive: true });
                newItem.addEventListener('mouseleave', cancelLongPress);
            });
        }
        
        function showIOSMenu(item, event) {
            if (event.cancelable) event.preventDefault();
            
            const txnId = item.dataset.txnId;
            const merchant = item.dataset.merchant;
            const amount = parseFloat(item.dataset.amount);
            const isExcluded = item.dataset.excluded === 'true';
            const category = item.dataset.category;
            const note = item.dataset.note;
            
            // 1. Get exact position
            const rect = item.getBoundingClientRect();
            
            // 2. Hide original item
            currentElevatedItem = item;
            item.style.visibility = 'hidden';
            
            // 3. Create and position clone
            clonedItem = item.cloneNode(true);
            clonedItem.classList.add('elevated-clone');
            clonedItem.style.top = `${rect.top}px`;
            clonedItem.style.left = `${rect.left}px`;
            clonedItem.style.width = `${rect.width}px`;
            clonedItem.style.visibility = 'visible';
            clonedItem.onclick = closeIOSMenu; // Clicking clone also closes
            document.body.appendChild(clonedItem);
            
            // 4. Show blur and backdrop
            document.getElementById('blurOverlay').classList.add('active');
            document.querySelector('.mobile-wrapper').classList.add('blur-active');
            document.querySelector('.fab').classList.add('blur-active');
            document.querySelector('.bottom-nav').classList.add('blur-active');
            
            // 5. Build menu
            const menu = document.getElementById('iosActionMenu');
            menu.innerHTML = `
                <div class="ios-action-item" onclick="handleIOSAction('price', '${txnId}', ${amount})">
                    <i class="material-icons">edit</i>
                    <span>Change Price</span>
                </div>
                <div class="ios-action-item ${isExcluded ? '' : 'danger'}" onclick="handleIOSAction('exclude', '${txnId}', ${isExcluded}, '${merchant}')">
                    <i class="material-icons">${isExcluded ? 'add_circle' : 'block'}</i>
                    <span>${isExcluded ? 'Include' : 'Exclude'}</span>
                </div>
                <div class="ios-action-item" onclick="handleIOSAction('category', '${txnId}', '${merchant}', '${category}')">
                    <i class="material-icons">category</i>
                    <span>Change Category</span>
                </div>
                <div class="ios-action-item" onclick="handleIOSAction('note', '${txnId}', '${merchant}', \`${note.replace(/`/g, '\\`')}\`)">
                    <i class="material-icons">note_add</i>
                    <span>Add Note</span>
                </div>
                <div class="ios-action-item danger" onclick="handleIOSAction('delete', '${txnId}')">
                    <i class="material-icons">delete</i>
                    <span>Delete</span>
                </div>
            `;
            
            // 6. Position menu
            menu.classList.add('show'); // Show briefly to get offsetHeight
            const menuHeight = menu.offsetHeight || 180;
            const mobileWrapper = document.querySelector('.mobile-wrapper');
            const wrapperRect = mobileWrapper.getBoundingClientRect();
            
            menu.style.right = `${window.innerWidth - wrapperRect.right + 20}px`;
            
            // Decide if show above or below
            if (rect.bottom + menuHeight + 20 > window.innerHeight) {
                // Show above if not enough space below
                menu.style.top = `${rect.top - menuHeight - 12}px`;
            } else {
                // Show below
                menu.style.top = `${rect.bottom + 12}px`;
            }
            
            menu.style.transform = 'none';
        }
        
        window.closeIOSMenu = () => {
            document.getElementById('blurOverlay').classList.remove('active');
            document.getElementById('iosActionMenu').classList.remove('show');
            document.querySelector('.mobile-wrapper').classList.remove('blur-active');
            const fab = document.querySelector('.fab');
            const nav = document.querySelector('.bottom-nav');
            if (fab) fab.classList.remove('blur-active');
            if (nav) nav.classList.remove('blur-active');
            
            if (clonedItem) {
                clonedItem.remove();
                clonedItem = null;
            }
            if (currentElevatedItem) {
                currentElevatedItem.style.visibility = 'visible';
                currentElevatedItem = null;
            }
        };
        
        window.handleIOSAction = (action, txnId, ...args) => {
            closeIOSMenu();
            
            switch(action) {
                case 'price':
                    openPriceModal(txnId, args[0]);
                    break;
                case 'exclude':
                    toggleExclusion(txnId, args[1], args[0]);
                    break;
                case 'category':
                    openCategoryModal(txnId, args[0], args[1]);
                    break;
                case 'note':
                    openNoteModal(txnId, args[0], args[1]);
                    break;
                case 'delete':
                    openDeleteModal(txnId);
                    break;
            }
        };

        window.toggleExclusion = async (id, merchant, isCurrentlyExcluded) => {
            try {
                if (!auth.currentUser) await signInAnonymously(auth);
                const uid = auth.currentUser.uid;
                await updateDoc(doc(db, "users", uid, "transactions", id), { excluded: !isCurrentlyExcluded });
                log(`${isCurrentlyExcluded ? 'Included' : 'Excluded'}: ${merchant}`);
                loadData();
            } catch (e) { log('Toggle failed', 'error'); }
        };

        // DELETE LOGIC
        window.openDeleteModal = (id) => {
            currentTxnId = id;
            document.getElementById('delete-modal').classList.add('show');
        };

        window.confirmDelete = async () => {
            if (!currentTxnId) return;
            try {
                 if (!auth.currentUser) await signInAnonymously(auth);
                const uid = auth.currentUser.uid;
                // SOFT DELETE to prevent re-sync
                await updateDoc(doc(db, "users", uid, "transactions", currentTxnId), { deleted: true });
                showToast('Transaction deleted');
                closeModals();
                loadData();
            } catch (error) { log("Error deleting txn", "error"); }
        };

        // --- CUSTOMIZATION MODALS ---
        let currentTxnId = null;
        const CATEGORIES = [
            { id: 'Online shopping', icon: 'shopping_bag', label: 'Online Shopping', cls: 'cat-online' },
            { id: 'Shopping', icon: 'shopping_cart', label: 'Shopping', cls: 'cat-shopping' },
            { id: 'Vehicle', icon: 'local_gas_station', label: 'Vehicle', cls: 'cat-vehicle' },
            { id: 'Food & Drinks', icon: 'restaurant', label: 'Food & Drinks', cls: 'cat-food' },
            { id: 'Service', icon: 'settings_cell', label: 'Service', cls: 'cat-service-magenta' },
            { id: 'Trade Copier', icon: 'hub', label: 'Trade Copier', cls: 'cat-aqua' },
            { id: 'Trading Expenses', icon: 'insights', label: 'Trading Expenses', cls: 'cat-trading' },
            { id: 'Life & Entertainment', icon: 'confirmation_number', label: 'Life & Ent.', cls: 'cat-life' },
            { id: 'Financial Expenses', icon: 'payments', label: 'Financial Expenses', cls: 'cat-financial' }
        ];

        window.closeModals = () => {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('show'));
            currentTxnId = null;
        };

        // Close on outside click
        window.onclick = (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeModals();
            }
        };

        window.openCategoryModal = (id, merchant, currentCatId) => {
            currentTxnId = id;
            const grid = document.getElementById('cat-grid');
            grid.innerHTML = CATEGORIES.map(cat => `
                <div class="cat-option ${currentCatId === cat.id ? 'active' : ''}" onclick="window.saveCategory('${cat.id}')">
                    <i class="material-icons ${cat.cls}" style="padding: 10px; border-radius: 12px;">${cat.icon}</i>
                    <span>${cat.label}</span>
                </div>
            `).join('');
            document.getElementById('cat-modal').classList.add('show');
        };

        window.saveCategory = async (catId) => {
            if (!currentTxnId) return;
            try {
                if (!auth.currentUser) await signInAnonymously(auth);
                const uid = auth.currentUser.uid;
                await updateDoc(doc(db, "users", uid, "transactions", currentTxnId), { manualCategory: catId });
                showToast('Category updated');
                closeModals();
                loadData();
            } catch (error) { log("Error saving category", "error"); }
        };

        window.openNoteModal = (id, merchant, note) => {
            currentTxnId = id;
            const input = document.getElementById('note-text');
            const counter = document.getElementById('note-counter');
            input.value = note || '';
            counter.innerText = `${input.value.length}/30`;
            
            input.oninput = () => {
                counter.innerText = `${input.value.length}/30`;
            };

            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveNote();
                }
            };
            
            document.getElementById('note-modal').classList.add('show');
        };

        // Enforce Title Case Helper
        function toTitleCase(str) {
            return str.replace(/\w\S*/g, function(txt){
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            });
        }

        document.getElementById('save-note-btn').onclick = async () => {
            if (!currentTxnId) return;
            let note = document.getElementById('note-text').value.trim();
            
            // Enforce Capitalization
            note = toTitleCase(note);

            try {
                if (!auth.currentUser) await signInAnonymously(auth);
                const uid = auth.currentUser.uid;
                await updateDoc(doc(db, "users", uid, "transactions", currentTxnId), { note: note });
                showToast('Note saved');
                closeModals();
                loadData();
            } catch (error) { log("Error saving note", "error"); }
        };

        window.openPriceModal = (id, currentAmt) => {
            currentTxnId = id;
            const modal = document.getElementById('price-modal');
            const input = document.getElementById('price-input');
            input.value = currentAmt;
            modal.classList.add('show');
            setTimeout(() => input.focus(), 100);

            input.onkeydown = (e) => {
                if (e.key === 'Enter') savePrice();
            };
        };

        const savePrice = async () => {
            if (!currentTxnId) return;
            const val = document.getElementById('price-input').value;
            const amt = parseFloat(val);
            try {
                if (!auth.currentUser) await signInAnonymously(auth);
                const uid = auth.currentUser.uid;
                const docRef = doc(db, "users", uid, "transactions", currentTxnId);
                if (isNaN(amt) || val.trim() === "") {
                    await updateDoc(docRef, { manualAmount: deleteField() });
                } else {
                    await updateDoc(docRef, { manualAmount: amt });
                }
                showToast('Price updated');
                closeModals();
                loadData();
            } catch (error) { log("Error saving price", "error"); }
        };
        window.savePrice = savePrice;

        /* See listener above for save-note-btn, replaced to include title casing */

        function showToast(msg) {
            const toast = document.getElementById('toast-box');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function displayCategoryName(id) {
            const cat = CATEGORIES.find(c => c.id === id);
            return cat ? cat.label : id;
        }

        // MERCHANT MAPPING & CATEGORIZATION
        function getMerchantDisplay(name = '', t = {}) {
            let raw = name.toUpperCase();
            
            // 1. GENERAL CLEANUP (Remove PHL, Locations, messy suffixes)
            let cleaned = name
                .replace(/\s+PHL$/i, '')
                .replace(/\s+CEBU\s+CITY\s+PHL$/i, '')
                .replace(/\s+CEBU\s+CITY$/i, '')
                .replace(/\s+DUBAI\s+ARE$/i, '')
                .replace(/\s+LONDON\s+GBR$/i, '')
                .replace(/\s+PH\s+PHL$/i, '')
                .replace(/\s+PH$/i, '')
                .trim();
            
            // 2. PATTERN REPLACEMENT
            if (cleaned.toUpperCase().includes('GADC') || cleaned.toUpperCase().includes('MCDONALDS') || cleaned.toUpperCase().includes('MCDO')) {
                let u = cleaned.toUpperCase();
                if (u.includes('SOUTHCBU') || u.includes('325CLN')) {
                    cleaned = 'MCDONALDS SOUTH CEBU';
                } else {
                    // Standardize prefix
                    cleaned = cleaned.replace(/(GADC|MCDONALDS|MCDO)/i, 'MCDONALDS').trim();
                    // Strip alphanumeric codes like 325CLNS... but keep what's after if it looks like a name
                    cleaned = cleaned.replace(/MCDONALDS\s+\d+[A-Z]*/i, 'MCDONALDS').trim();
                }
            }
            
            if (cleaned.toUpperCase().includes('JOLLIBEE')) {
                cleaned = cleaned.replace(/JB\d+\s+\w+/i, '').trim();
            }

            if (cleaned.toUpperCase().includes('RIBSHACK')) {
                 cleaned = cleaned.replace(/PH\d+/i, '').trim();
            }

            if (cleaned.toUpperCase().includes('SHOPEE')) {
                cleaned = 'SHOPEE PH';
            }

            if (cleaned.toUpperCase().includes('TRADERSCONNECT')) {
                cleaned = 'TRADERS CONNECT';
            }

            if (cleaned.toUpperCase().includes('TIKTOK SHOP')) {
                cleaned = 'TIKTOK SHOP';
            }

            if (cleaned.toUpperCase().includes('SPOTIFY')) {
                cleaned = 'SPOTIFY';
            }

            let display = { name: cleaned, category: 'Financial expenses', icon: 'payments', catClass: 'cat-financial' };

            // 3. MANUAL OVERRIDE (USER CHOICE)
            if (t.manualCategory) {
                const userCat = CATEGORIES.find(c => c.id === t.manualCategory);
                if (userCat) {
                    display.category = userCat.id;
                    display.icon = userCat.icon;
                    // Find catClass
                    const catMap = {
                        'Online shopping': 'cat-online',
                        'Shopping': 'cat-shopping',
                        'Vehicle': 'cat-vehicle',
                        'Trade Copier': 'cat-aqua',
                        'Trading Expenses': 'cat-trading',
                        'Service': 'cat-service-magenta',
                        'Food & Drinks': 'cat-food',
                        'Life & Entertainment': 'cat-life',
                        'Financial Expenses': 'cat-financial'
                    };
                    display.catClass = catMap[userCat.id] || 'cat-financial';
                    return display;
                }
            }

            // 4. EXACT OVERRIDES
            const mapping = {
                'MR DIY BGCC BOGO': 'MR DIY BOGO',
                'MR DIY ZBOG BOGO': 'MR DIY BOGO',
                'TEC FUEL SAN REMIGIO': 'TECFUEL SAN REMIGIO',
                'J AND L SHOPPING BOGO': 'J AND L MALL BOGO',
                'TECFUEL BOGO CEBU': 'TECFUEL BOGO',
                'KKV SM J Mall Cebu': 'KKV SM J MALL CEBU',
                'SM STORE-CEBU': 'SM STORE - CEBU CITY',
                'GLOBE-BILLSPAY PH': 'GLOBE / GOMO LOAD',
                'SHELL FILLWISE BOGO CEBU': 'SHELL BOGO CEBU',
                'GLOBE WEBLOADING EC PH': 'GLOBE / GOMO LOAD',
                'WATSONS HISOLER BLDG B': 'WATSONS HISOLER BLDG BOGO',
                'SUPER METRO S/M-BOGO': 'SUPER METRO BOGO',
                'SM SUPERMARKET SM SRP CEBU': 'SM SUPERMARKET SRP',
                'OCTAGON AYALA CENTRAL CEBU': 'OCTAGON AYALA CENTRAL CEBU',
                'STARBUCKS 540 CENTRAL CEBU CITY': 'STARBUCKS 540 CENTRAL CEBU CITY',
                'ICE SKATING SM SRP CEB': 'ICE SKATING SM SRP CEBU',
                'TAP SURE LEVERAGE FUND': 'TAP SURE LEVERAGE FUND',
                'MRCRMT': 'MRCRMT',
                'TRADERSCONNECT.COM': 'TRADERS CONNECT',
                'TRADERSCONNECT': 'TRADERS CONNECT',
                'TRADERSCONNECT.COM': 'TRADERS CONNECT'
            };

            const finalRaw = cleaned.toUpperCase();
            if (mapping[cleaned]) display.name = mapping[cleaned];
            else if (mapping[finalRaw]) display.name = mapping[finalRaw];

            // 5. CATEGORY DETECTION
            if (finalRaw.includes('SHOPEE') || finalRaw.includes('TIKTOK') || finalRaw.includes('LAZADA') || finalRaw.includes('SHEIN') || finalRaw.includes('TEMU') || finalRaw.includes('SHOPIFY')) {
                display.category = 'Online shopping';
                display.icon = 'shopping_bag';
                display.catClass = 'cat-online';
            } else if (finalRaw.includes('FUEL') || finalRaw.includes('SHELL') || finalRaw.includes('TECFUEL') || finalRaw.includes('PETRON') || finalRaw.includes('SEAOIL')) {
                display.category = 'Vehicle';
                display.icon = 'local_gas_station';
                display.catClass = 'cat-vehicle';
            } else if (finalRaw.includes('MR DIY') || finalRaw.includes('WATSONS') || finalRaw.includes('SM STORE') || finalRaw.includes('KKV') || finalRaw.includes('SHOPPING') || finalRaw.includes('MALL') || finalRaw.includes('METRO') || finalRaw.includes('SUPERMARKET') || finalRaw.includes('OCTAGON')) {
                display.category = 'Shopping';
                display.icon = 'shopping_cart';
                display.catClass = 'cat-shopping';
            } else if (finalRaw.includes('TRADERSCONNECT') || finalRaw.includes('TRADERS CONNECT')) {
                display.category = 'Trade Copier';
                display.icon = 'hub';
                display.catClass = 'cat-aqua';
            } else if (finalRaw.includes('EQUITY EDGE') || finalRaw.includes('ANALYTICS') || finalRaw.includes('TRADING') || finalRaw.includes('LEVERAGE FUND') || finalRaw.includes('MRCRMT')) {
                display.category = 'Trading Expenses';
                display.icon = 'insights';
                display.catClass = 'cat-trading';
            } else if (finalRaw.includes('GLOBE') || finalRaw.includes('GOMO') || finalRaw.includes('BILLSPAY')) {
                display.category = 'Service';
                display.icon = 'settings_cell';
                display.catClass = 'cat-service-magenta';
            } else if (finalRaw.includes('JOLLIBEE') || finalRaw.includes('MCDO') || finalRaw.includes('MCDONALDS') || finalRaw.includes('FOOD') || finalRaw.includes('RESTAURANT') || finalRaw.includes('STARBUCKS') || finalRaw.includes('RIBSHACK')) {
                display.category = 'Food & Drinks';
                display.icon = 'restaurant';
                display.catClass = 'cat-food';
            } else if (finalRaw.includes('ICE SKATING') || finalRaw.includes('CINEMA') || finalRaw.includes('ENTERTAINMENT') || finalRaw.includes('SPOTIFY') || finalRaw.includes('NETFLIX')) {
                display.category = 'Life & Entertainment';
                display.icon = 'confirmation_number';
                display.catClass = 'cat-life';
            } else {
                display.category = 'Financial Expenses';
                display.icon = 'payments';
                display.catClass = 'cat-red';
            }

            return display;
        }

        function log(msg, type = 'info') {
            const container = document.getElementById('log-container');
            if (!container) return;
            const div = document.createElement('div');
            div.className = `log-entry ${type === 'error' ? 'log-error' : ''}`;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- MANUAL TRANSACTION LOGIC (INTEGRATED) ---
        let selectedManualCatId = 'Financial Expenses'; 
        let manualTxnType = 'expense';

        window.setTxnType = (type) => {
            manualTxnType = type;
            const btnExp = document.getElementById('btn-expense');
            const btnInc = document.getElementById('btn-income');
            
            if (type === 'expense') {
                btnExp.style.background = '#ef4444'; 
                btnExp.style.color = '#fff';
                btnExp.style.boxShadow = '0 4px 10px rgba(239, 68, 68, 0.3)';
                
                btnInc.style.background = 'transparent';
                btnInc.style.color = '#64748b';
                btnInc.style.boxShadow = 'none';
            } else {
                btnInc.style.background = '#10b981';
                btnInc.style.color = '#fff';
                btnInc.style.boxShadow = '0 4px 10px rgba(16, 185, 129, 0.3)';
                
                btnExp.style.background = 'transparent';
                btnExp.style.color = '#64748b';
                btnExp.style.boxShadow = 'none';
            }
        };

        window.openManualTxnModal = () => {
            document.getElementById('manual-amt').value = '';
            document.getElementById('manual-note').value = '';
            
            // Default Category
            selectedManualCatId = 'Financial Expenses';
            setTxnType('expense');
            
            // Set Date Input to Today
            const d = new Date().toISOString().split('T')[0];
            document.getElementById('manual-date').value = d;
            
            // Enable Button
            const btn = document.getElementById('done-btn');
            btn.style.pointerEvents = 'auto';
            btn.style.opacity = '1';

            renderManualCategories();
            document.getElementById('manual-txn-modal').classList.add('show');
            setTimeout(() => document.getElementById('manual-amt').focus(), 300);
        };

        window.renderManualCategories = () => {
            const list = document.getElementById('manual-cat-list');
            list.innerHTML = CATEGORIES.map(cat => {
                const isSelected = cat.id === selectedManualCatId;
                let bgStyle = '#f1f5f9';
                let colorStyle = '#64748b';
                
                if (isSelected) {
                     if (cat.cls.includes('food')) { bgStyle = '#fefce8'; colorStyle = '#ca8a04'; } // Yellow
                     else if (cat.cls.includes('shopping')) { bgStyle = '#fff7ed'; colorStyle = '#f97316'; } // Orange
                     else if (cat.cls.includes('vehicle')) { bgStyle = '#f5f3ff'; colorStyle = '#8b5cf6'; }
                     else if (cat.cls.includes('cat-aqua')) { bgStyle = '#ecfeff'; colorStyle = '#0891b2'; } // Dark Aqua
                     else if (cat.label.includes('Service')) { bgStyle = '#fdf4ff'; colorStyle = '#d946ef'; } // Magenta
                     else if (cat.label.includes('Financial') || cat.label.includes('Trading')) { bgStyle = '#fef2f2'; colorStyle = '#ef4444'; } // Red
                     else { bgStyle = '#f0fdf4'; colorStyle = '#10b981'; } 
                }

                return `
                <div class="manual-cat-item ${isSelected ? 'selected' : ''}" onclick="selectManualCategory('${cat.id}')">
                    <div class="manual-cat-circle" style="background: ${bgStyle}; color: ${colorStyle};">
                        <i class="material-icons">${cat.icon}</i>
                    </div>
                    <span style="font-size: 11px; font-weight: 600; color: #1e293b; text-align: center;">${cat.label}</span>
                </div>
                `;
            }).join('');
        };

        window.selectManualCategory = (id) => {
            selectedManualCatId = id;
            renderManualCategories();
        };

        window.saveManualTxn = async () => {
            const btn = document.getElementById('done-btn');
            const amtVal = document.getElementById('manual-amt').value;
            
            if (!amtVal || parseFloat(amtVal) <= 0) {
                showToast('Enter valid amount');
                return;
            }
            
            // Disable button
            btn.style.pointerEvents = 'none';
            btn.style.opacity = '0.5';
            
            let note = document.getElementById('manual-note').value.trim();
            // Enforce Title Case
            if (note) {
                note = note.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
            }

            const dateVal = document.getElementById('manual-date').value;
            const dateObj = dateVal ? new Date(dateVal) : new Date();
            
            const cat = CATEGORIES.find(c => c.id === selectedManualCatId);
            
            const newTxn = {
                date: dateObj.toISOString(),
                amount: parseFloat(amtVal),
                manualAmount: parseFloat(amtVal), 
                merchant: note ? note : cat.label,
                note: note,
                manualCategory: selectedManualCatId,
                category: selectedManualCatId,
                type: manualTxnType // 'expense' or 'income'
            };
            
            try {
                if (!auth.currentUser) await signInAnonymously(auth);
                const uid = auth.currentUser.uid;
                await addDoc(collection(db, "users", uid, "transactions"), newTxn);
                showToast('Transaction Saved');
                closeModals();
                loadData(); 
            } catch (e) {
                console.error(e);
                showToast('Error saving');
                // Re-enable on error
                btn.style.pointerEvents = 'auto';
                btn.style.opacity = '1';
            }
        };
    </script>
    
    <!-- CATEGORY MODAL -->
    <div id="cat-modal" class="modal-overlay">
        <div class="custom-modal">
            <div class="modal-header">Change Category</div>
            <p style="color: #64748b; font-size: 13px;">Select a new category for this transaction.</p>
            <div class="modal-body">
                <div id="cat-grid" class="cat-grid">
                    <!-- Categories injected here -->
                </div>
            </div>
            <div class="modal-actions">
                <div class="cancel-link" onclick="closeModals()">CANCEL</div>
            </div>
        </div>
    </div>

    <!-- NOTE MODAL -->
    <div id="note-modal" class="modal-overlay">
        <div class="custom-modal">
            <div class="modal-header">Add Note</div>
            <p style="color: #64748b; font-size: 13px;">Personalized note for this transaction.</p>
            <div class="modal-body">
                <div style="position: relative;">
                    <textarea id="note-text" class="note-input" maxlength="30" placeholder="Enter note here..."></textarea>
                    <div id="note-counter" style="position: absolute; right: 8px; bottom: 8px; font-size: 10px; color: #94a3b8; font-weight: 600;">0/30</div>
                </div>
            </div>
            <div class="modal-actions" style="margin-top: 8px; align-items: center;">
                <div class="cancel-link" onclick="closeModals()" style="letter-spacing: 0.5px; margin-right: 4px;">CANCEL</div>
                <button class="mui-btn mui-btn--raised mui-btn--primary" id="save-note-btn" style="border-radius: 10px; font-weight: 700; letter-spacing: 0.5px; padding: 0 24px; height: 42px; background-color: #2196F3;">SAVE NOTE</button>
            </div>
        </div>
    </div>

    <!-- PRICE MODAL -->
    <div id="price-modal" class="modal-overlay">
        <div class="custom-modal">
            <div class="modal-header">Change Price</div>
            <p style="color: #64748b; font-size: 13px;">Update the transaction amount manually.</p>
            <div class="modal-body">
                <div style="position: relative;">
                    <input type="number" id="price-input" class="note-input" style="min-height: auto; font-size: 18px; font-weight: 700; text-align: center;" placeholder="0.00" step="0.01">
                </div>
            </div>
            <div class="modal-actions" style="margin-top: 8px; align-items: center;">
                <div class="cancel-link" onclick="closeModals()" style="letter-spacing: 0.5px; margin-right: 4px;">CANCEL</div>
                <button class="mui-btn mui-btn--raised mui-btn--primary" onclick="savePrice()" style="border-radius: 10px; font-weight: 700; letter-spacing: 0.5px; padding: 0 24px; height: 42px; background-color: #2196F3;">SAVE PRICE</button>
            </div>
        </div>
    </div>

    <!-- DELETE CONFIRMATION MODAL -->
    <div id="delete-modal" class="modal-overlay">
        <div class="custom-modal">
            <div class="modal-header" style="color: #ef4444;">Delete Transaction?</div>
            <p style="color: #64748b; font-size: 13px;">This action cannot be undone. If this was synced, it will not reappear.</p>
            <div class="modal-actions" style="margin-top: 16px; align-items: center;">
                <div class="cancel-link" onclick="closeModals()" style="letter-spacing: 0.5px; margin-right: 4px;">CANCEL</div>
                <button class="mui-btn mui-btn--raised mui-btn--danger" onclick="confirmDelete()" style="border-radius: 10px; font-weight: 700; letter-spacing: 0.5px; padding: 0 24px; height: 42px; background-color: #ef4444; color: white;">DELETE</button>
            </div>
        </div>
    </div>

    <!-- MANUAL TRANSACTION MODAL -->
    <div id="manual-txn-modal" class="modal-overlay" style="align-items: flex-end; justify-content: center; backdrop-filter: none;">
        <div class="custom-modal" style="width: 100%; max-width: 100%; border-radius: 24px 24px 0 0; padding: 20px; box-shadow: 0 -10px 40px rgba(0,0,0,0.1); height: 85vh; overflow-y: auto; position: relative; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);">
            
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <i class="material-icons" onclick="closeModals()" style="color: #64748b; font-size: 24px; cursor: pointer;">close</i>
                <div style="font-weight: 800; font-size: 16px; color: #1e293b;">New Transaction</div>
                <div id="done-btn" style="font-weight: 700; font-size: 14px; color: #10b981; cursor: pointer;" onclick="saveManualTxn()">Done</div>
            </div>

            <!-- Toggler -->
            <div style="display: flex; background: #f1f5f9; padding: 4px; border-radius: 12px; margin-bottom: 30px;">
                <div id="btn-expense" onclick="setTxnType('expense')" style="flex: 1; padding: 8px; text-align: center; background: #ef4444; color: #fff; font-weight: 700; border-radius: 8px; font-size: 13px; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3); transition: all 0.2s; cursor: pointer;">Expense</div>
                <div id="btn-income" onclick="setTxnType('income')" style="flex: 1; padding: 8px; text-align: center; color: #64748b; font-weight: 600; font-size: 13px; border-radius: 8px; transition: all 0.2s; cursor: pointer;">Income</div>
            </div>

            <!-- Amount Input -->
            <!-- Amount Input -->
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 12px; color: #94a3b8; font-weight: 700; letter-spacing: 1px; margin-bottom: 8px;">AMOUNT</div>
                <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                    <span style="font-size: 24px; font-weight: 700; color: #cbd5e1;">PHP</span>
                    <input type="number" id="manual-amt" placeholder="0.00" style="font-size: 48px; font-weight: 800; color: #1e293b; border: none; outline: none; width: 220px; text-align: center; background: transparent;" step="0.01">
                </div>
            </div>

            <!-- Category Section -->
            <div style="margin-bottom: 0;">
                <div style="font-size: 11px; color: #94a3b8; font-weight: 700; letter-spacing: 1px; margin-bottom: 12px; padding-left: 4px;">CATEGORY</div>
                <div id="manual-cat-list" style="display: flex; overflow-x: auto; gap: 20px; padding: 4px 4px 20px 4px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch;">
                    <!-- Categories injected by JS -->
                </div>
            </div>

            <!-- Details List -->
            <div style="display: flex; flex-direction: column; gap: 16px;">
                
                <!-- Date Row -->
                <div style="display: flex; align-items: center; background: #fff; border: 1px solid #e2e8f0; padding: 16px; border-radius: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); cursor: pointer;" onclick="document.getElementById('manual-date').showPicker()">
                    <div style="width: 40px; height: 40px; border-radius: 10px; background: #f0fdf4; display: flex; align-items: center; justify-content: center; margin-right: 16px; color: #10b981;">
                        <i class="material-icons">calendar_today</i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 10px; color: #94a3b8; font-weight: 700; text-transform: uppercase;">Date</div>
                        <input type="date" id="manual-date" style="border: none; outline: none; font-size: 14px; font-weight: 600; color: #1e293b; font-family: inherit; width: 100%; background: transparent; cursor: pointer;">
                    </div>
                    <i class="material-icons" style="color: #cbd5e1;">chevron_right</i>
                </div>

                <!-- Note Row -->
                <div style="display: flex; align-items: center; background: #fff; border: 1px solid #e2e8f0; padding: 16px; border-radius: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
                    <div style="width: 40px; height: 40px; border-radius: 10px; background: #f8fafc; display: flex; align-items: center; justify-content: center; margin-right: 16px; color: #64748b;">
                        <i class="material-icons">notes</i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 10px; color: #94a3b8; font-weight: 700; text-transform: uppercase;">Note</div>
                        <input type="text" id="manual-note" maxlength="30" placeholder="Add description..." style="width: 100%; border: none; outline: none; font-size: 14px; font-weight: 600; color: #1e293b; background: transparent; padding: 0;">
                    </div>
                </div>

            </div>

        </div>
    </div>
    
    <style>
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        /* Hide scrollbar for category list */
        #manual-cat-list::-webkit-scrollbar { display: none; }
        #manual-cat-list { -ms-overflow-style: none; scrollbar-width: none; }
        
        .manual-cat-item { display: flex; flex-direction: column; align-items: center; gap: 8px; min-width: 64px; cursor: pointer; opacity: 0.5; transition: all 0.2s; }
        .manual-cat-item.selected { opacity: 1; transform: scale(1.05); }
        .manual-cat-circle { width: 56px; height: 56px; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 24px; transition: all 0.2s; border: 2px solid transparent; }
        .manual-cat-item.selected .manual-cat-circle { box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
    </style>



    <!-- TOAST BOX -->
    <div id="toast-box" class="toast-container">
        <i class="material-icons">check_circle</i>
        <span id="toast-msg">Updated</span>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
</body>
</html>
