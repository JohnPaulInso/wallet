<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SmartWallet - JP</title>
    <link rel="icon" type="image/png" href="applogo.png?v=4">
    <link rel="apple-touch-icon" href="applogo.png?v=4">
    
    <!-- Material UI CSS & Premium Fonts -->
    <link href="https://cdn.muicss.com/mui-0.10.3/css/mui.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Lexend:wght@700;800;900&display=swap">
    <link href="https://fonts.cdnfonts.com/css/lemon-milk" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="manifest" href="manifest.json?v=1">
    <meta name="theme-color" content="#121212">

    <style>
        * { box-sizing: border-box; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none; touch-action: manipulation; }
        html, body { background: #f0f2f5; margin: 0; padding: 0; min-height: 100vh; display: flex; justify-content: center; font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; touch-action: manipulation; }
        
        /* Mobile Wrapper with PC Scroll Simulation */
        .mobile-wrapper { 
            width: 100%; 
            max-width: 430px; 
            background: #fff; 
            height: 100vh; /* Fixed height for sticky to work on mobile */
            position: relative; 
            box-shadow: 0 0 50px rgba(0,0,0,0.1); 
            display: flex; 
            flex-direction: column; 
            overflow-x: hidden; 
            overflow-y: auto; 
        }
        @media (min-width: 431px) {
            .mobile-wrapper { height: 100vh; overflow-y: scroll; }
        }

        #header { padding: 15px 24px 10px; display: flex; align-items: center; justify-content: space-between; background: #fff; position: sticky; top: 0; z-index: 500; border-bottom: 1px solid rgba(0,0,0,0.02); transition: all 0.3s ease; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        #header.shrunk { padding: 12px 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .greeting-section { line-height: 1.2; transition: all 0.3s ease; }
        .greeting-text { font-size: 11px; color: #94a3b8; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; transition: all 0.3s ease; }
        #header.shrunk .greeting-text { font-size: 9px; letter-spacing: 1px; }
        .user-name { font-size: 18px; font-weight: 800; color: #1e293b; transition: all 0.3s ease; }
        #header.shrunk .user-name { font-size: 15px; }
        
        .header-logo { width: 48px; height: 30px; border-radius: 4px; object-fit: cover; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #header.shrunk .header-logo { width: 40px; height: 25px; }
        
        #profile-badge { transition: all 0.3s ease; }
        #header.shrunk #profile-badge { transform: scale(0.8); }
        
        #profile-badge { width: 42px; height: 42px; border-radius: 50%; background: #f1f5f9; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #profile-badge img { width: 100%; height: 100%; object-fit: cover; display: none; }
        #profile-badge i { font-size: 24px; color: #94a3b8; display: block; }
        #profile-badge.has-pic i { display: none; }
        #profile-badge.has-pic img { display: block; }

        /* PROFILE DROPDOWN MENU */
        .profile-container { position: relative; }
        .profile-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.12);
            min-width: 200px;
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 2000;
            border: 1px solid #f1f5f9;
            padding: 6px;
        }
        .profile-dropdown.active { display: flex; animation: dropIn 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes dropIn { from { opacity: 0; transform: translateY(-10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .dropdown-item {
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13.5px;
            font-weight: 700;
            color: #475569;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s;
        }
        .dropdown-item:hover { background: #f8fafc; color: #1e293b; }
        .dropdown-item i { font-size: 20px; color: #94a3b8; }
        .dropdown-item.logout { color: #ef4444; margin-top: 4px; border-top: 1px solid #f1f5f9; border-radius: 0 0 10px 10px; }
        .dropdown-item.logout i { color: #ef4444; }
        .dropdown-header { padding: 10px 14px 6px; font-size: 11px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }

        /* CARD CAROUSEL SYSTEM */
        .card-viewport {
            width: 100%;
            overflow: visible; 
            margin-top: 5px; 
            margin-bottom: 10px;
            z-index:10;
        }
        
        .card-carousel-scroll {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            /* Padding for 'peek' centering */
            padding: 30px 48px 25px 48px; 
            gap: 12px;
            cursor: grab;
        }
        .card-carousel-scroll:active { cursor: grabbing; }
        .card-carousel-scroll::-webkit-scrollbar { display: none; }

        .balance-card { 
            flex: 0 0 calc(100%);
            max-width: 334px;
            scroll-snap-align: center;
            scroll-snap-stop: always; /* Force 1 card per swipe */
            padding: 24px 20px 18px;
            border-radius: 20px;
            color: #fff; 
            position: relative; 
            overflow: hidden; 
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
            user-select: none;
            z-index:100;
            /* Inactive State: Smaller & Faded */
            transform: scale(0.92);
            opacity: 0.7;
            filter: grayscale(0.5);
        }
        
        .balance-card.active {
            transform: scale(1.0);
            opacity: 1;
            filter: grayscale(0);
            z-index: 200;
        }

        /* Add Card Placeholder */
        .add-card-placeholder {
            background: transparent;
            border: 2px dashed #cbd5e1;
            box-shadow: none !important;
            color: #94a3b8;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }
        .add-card-placeholder i { font-size: 32px; margin-bottom: 8px; color: #cbd5e1; }
        .add-card-placeholder span { font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; }
        
        /* CARD BACKGROUNDS */
        .atome-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #080808 100%);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            position: relative;
        }
        /* Premium Dot Mesh Texture */
        .atome-card::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(circle, #c0ff00 0.5px, transparent 0.5px);
            background-size: 10px 10px;
            opacity: 0.1;
            pointer-events: none;
            z-index: 1;
        }

        .atome-card.active {
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transform: scale(1.05); 
            border: 1px solid rgba(192, 255, 0, 0.15); /* Lime tint border */
        }

        .bpi-card {
            background: linear-gradient(135deg, #5c0a0a 0%, #1e0505 100%);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            position: relative;
        }
        
        /* BPI RAYS EFFECT */
        .bpi-rays {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                conic-gradient(from 70deg at -10% 50%, 
                    transparent 0deg, 
                    rgba(255,255,255,0.03) 10deg, 
                    transparent 20deg, 
                    rgba(255,255,255,0.02) 40deg, 
                    transparent 60deg, 
                    rgba(255,255,255,0.03) 90deg, 
                    transparent 110deg);
            mix-blend-mode: screen;
            filter: blur(8px);
            pointer-events: none;
        }

        .bpi-card.active {
            box-shadow: 0 5px 15px rgba(92, 10, 10, 0.4); 
            transform: scale(1.05);
            border: 1px solid rgba(255,255,255,0.08); /* Minimalist border */
        }

        /* PIE CHART ANIMATION */
        @keyframes spinPie {
            0% { transform: scale(0) rotate(-90deg); opacity: 0; }
            100% { transform: scale(1) rotate(-90deg); opacity: 1; }
        }
        .pie-animate {
            animation: spinPie 1s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            transform-origin: center;
        }

        /* CARD LOGOS */
        .card-brand-logo { 
            position: absolute;
            opacity: 0.15;
            pointer-events: none;
        }
        .atome-brand-logo {
            top: 20px;
            left: -12px;
            font-size: 200px;
            font-weight: 950;
            color: #c0ff00; /* Dark Lemon Lime */
            opacity: 0.1;
            line-height: 1;
            font-family: 'LEMON MILK', sans-serif;
            letter-spacing: -10px;
            z-index: 1;
        }
        .bpi-brand-logo {
            bottom: -30px;
            right: -30px;
            font-size: 160px;
            font-weight: 900;
            color: #fff;
            opacity: 0.04; /* Very subtle minimalist logo */
            font-family: 'Lexend', sans-serif;
            letter-spacing: -10px;
        }
        
        /* Matte Texture Overlay */
        .balance-card::before { 
            content: ''; 
            position: absolute; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, transparent 50%, rgba(0,0,0,0.05) 100%);
            opacity: 0.6;
            pointer-events: none;
            z-index: 1000;
        }

        .card-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; position: relative; z-index: 2; }
        .card-label { font-size: 10px; font-weight: 800; color: rgba(255,255,255,0.45); text-transform: uppercase; letter-spacing: 2px; }
        .card-type-label { font-size: 10px; font-weight: 700; color: rgba(255,255,255,0.25); text-transform: lowercase; }
        
        .balance-amount { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 32px; font-weight: 800; letter-spacing: -2px; margin-bottom: 10px; text-shadow: 0 4px 12px rgba(0,0,0,0.2); padding-top: 5px; position: relative; z-index: 2; }
        
        .card-footer { display: flex; justify-content: space-between; align-items: flex-end; position: relative; z-index: 2; margin-top: auto; }
        .card-number-box { line-height: 1.4; }
        .card-number-label { font-size: 8px; font-weight: 800; color: rgba(255,255,255,0.3); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 2px; }
        .card-number { font-size: 14px; font-weight: 600; color: rgba(255,255,255,1); letter-spacing: 2.5px; font-family: 'Courier New', monospace; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .mastercard-circles { display: flex; position: relative; width: 44px; height: 28px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); opacity: 0.9; }
        .circle { width: 28px; height: 28px; border-radius: 50%; position: absolute; }
        .circle-1 { background: #eb001b; left: 0; }
        .circle-2 { background: #f79e1b; left: 16px; mix-blend-mode: lighten; }

        /* NEW INTEGRATED SYNC STATUS CHIP */
        .card-sync-status-chip {
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 100px;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 0.5px solid rgba(255,255,255,0.1);
        }
        .card-sync-status-chip .dot { width: 5px; height: 5px; border-radius: 50%; background: #4caf50; box-shadow: 0 0 8px rgba(76, 175, 80, 0.6); }
        .card-sync-status-chip .status-text { font-size: 8px; font-weight: 800; text-transform: uppercase; color: rgba(255,255,255,0.6); letter-spacing: 0.5px; }

        .sync-icon-btn {
            background: rgba(255,255,255,0.1);
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            color: white;
            transition: all 0.2s;
        }
        .sync-icon-btn i { font-size: 12px; }
        .sync-icon-btn:hover { background: rgba(255,255,255,0.2); }
        .sync-icon-btn:disabled { opacity: 0.5; }

        .integrated-sync-btn {
            background: rgba(255,255,255,0.03);
            border: none;
            border-radius: 6px;
            color: rgba(255,255,255,0.7);
            padding: 3px 8px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            font-size: 8px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .integrated-sync-btn:hover { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.9); }
        .integrated-sync-btn:disabled { opacity: 0.5; cursor: default; }
        .spin { animation: spinRotate 1.5s linear infinite; }
        @keyframes spinRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .card-sync-bar.syncing .dot { background: #000000; box-shadow: 0 0 8px rgba(0, 0, 0, 0.6); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.3); } 100% { opacity: 1; transform: scale(1); } }

        .mui-container { width: 100%; max-width: 100% !important; margin: 0; padding: 0 24px 100px; }
        .control-panel { padding: 0; margin-bottom: 24px; background: transparent; box-shadow: none; }
        .status-labels { display: flex; gap: 10px; margin-bottom: 20px; }
        .status-chip { font-size: 11px; padding: 4px 10px; border-radius: 12px; border: 1px solid #e2e8f0; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-ready { border-color: #4caf50; color: #2e7d32; background: #f0fdf4; }
        .status-local { border-color: #f59e0b; color: #b45309; background: #fffbeb; }

        .sticky-banner { 
            position: relative;
            margin: -10px 24px 20px 24px;
            width: auto;
            max-width: none;
            background: #fff;
            border-radius: 20px;
            z-index: 100; 
            display: none; 
            align-items: center; 
            justify-content: space-between; 
            padding: 14px 20px; 
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 15px -5px rgba(0,0,0,0.05);
            animation: slideInDown 0.4s ease-out;
        }
        @keyframes slideInDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .banner-pill-btn { 
            background: #1e293b; 
            color: #fff; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 14px; 
            font-weight: 700; 
            font-size: 13px; 
            cursor: pointer; 
            transition: all 0.2s; 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        .banner-pill-btn:hover { background: #0f172a; transform: scale(1.05); }
        .banner-btn:active { transform: translateY(0) scale(0.98); }
        .local-nudge { animation: amberPulse 2s infinite; }
        @keyframes amberPulse { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }

        /* ACCORDION */
        .month-accordion { margin-bottom: 16px; background: #fff; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); border: 1px solid #e2e8f0; transition: box-shadow 0.2s; position: relative; }
        .month-accordion:hover { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .month-header { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; -webkit-user-select: none; user-select: none; }
        .month-header:hover { background: #f8fafc; }
        .month-header .month-title { font-weight: 700; font-size: 0.8rem; color: #1e293b; }
        .month-header .month-total { font-weight: 800; color: #2563eb; font-size: 0.8rem; }
        .month-header .expand-icon { transition: transform 0.3s; color: #64748b; }
        .month-header.collapsed .expand-icon { transform: rotate(-90deg); }
        
        .month-content { border-top: 1px solid #f1f5f9; max-height: 5000px; transition: max-height 0.4s ease; position: relative; z-index: 10; }
        .month-content.collapsed { max-height: 0; overflow: hidden; border-top: none; }

        /* TRANSACTION ITEM - PREMIUM REDESIGN */
        .txn-item { padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f1f5f9; position: relative; transition: all 0.2s; background: #fff; }
        .txn-item:last-child { border-bottom: none; }
        .txn-item:hover { background-color: #f8fafc; }
        
        .txn-left { display: flex; align-items: center; gap: 15px; flex: 1; }
        .txn-icon-box { min-width: 48px; width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative; }
        .txn-icon-box i { font-size: 22px; }
        
        /* CATEGORY COLORS */
        .cat-online { background-color: #f0f9ff; color: #0284c7; } /* Blue for Online shopping */
        .cat-vehicle { background-color: #f5f3ff; color: #8b5cf6; } /* Purple */
        .cat-shopping { background-color: #f0f9ff; color: #0284c7; } /* Blue for Shopping */
        .cat-services { background-color: #f0fdf4; color: #22c55e; } /* Green - General Services */
        .cat-service-magenta { background-color: #fdf4ff; color: #d946ef; } /* Magenta for Service */
        .cat-food { background-color: #fefce8; color: #eab308; } /* Yellow/Gold */
        .cat-life { background-color: #ecfdf5; color: #10b981; } /* Emerald */
        .cat-financial { background-color: #fef2f2; color: #ef4444; } /* Red */
        .cat-trading { background-color: #fff1f2; color: #ef4444; } /* Red - Trading */
        .cat-aqua { background-color: #ecfeff; color: #0891b2; } /* Dark Aqua/Cyan - Trade Copier */
        .cat-investments { background-color: #f0fdfa; color: #0d9488; } /* Teal/Dark Green */
        .cat-school { background-color: #eff6ff; color: #1d4ed8; } /* Blue */
        .cat-red { background-color: #fef2f2; color: #ef4444 !important; } /* Force Red for Financial */
        
        .txn-info { display: flex; flex-direction: column; }
        .txn-merchant { 
            font-weight: 700; 
            font-size: 0.88rem; 
            color: #1e293b; 
            margin-bottom: 3px; 
            letter-spacing: -0.2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            mask-image: linear-gradient(to right, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%);
        }
        .txn-subtitle { font-size: 0.7rem; color: #475569; font-weight: 700; display: flex; align-items: center; gap: 4px; }
        .txn-dot { font-size: 14px; opacity: 0.5; }
        
        .txn-right { display: flex; align-items: center; gap: 8px; }
        .txn-amount { font-weight: 800; font-size: 13px; color: #0f172a; white-space: nowrap; }

        /* EXCLUDED STATE - Only fade content, keep actions clear */
        .txn-item.txn-excluded .txn-left,
        .txn-item.txn-excluded .txn-amount { opacity: 0.35; filter: grayscale(1); text-decoration: line-through; }
        
        /* HOVER ACTION */
        .txn-actions { opacity: 0; transition: opacity 0.2s; position: relative; z-index: 60; }
        .txn-item:hover .txn-actions { opacity: 1; }
        .action-btn { background: none; border: none; cursor: pointer; color: #94a3b8; padding: 4px; border-radius: 50%; display: flex; align-items: center; }
        .action-btn:hover { background: #f1f5f9; color: #475569; }
        
        /* DROPDOWN MENU */
        .dropdown-menu { display: none; position: absolute; right: 0; top: 100%; background: #fff; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); border-radius: 8px; z-index: 100; border: 1px solid #e2e8f0; padding: 4px 0; }
        .dropdown-menu.show { display: block; }
        .dropdown-item { padding: 10px 16px; font-size: 13px; color: #475569; display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600; white-space: nowrap; }
        .dropdown-item:hover { background: #f1f5f9; }
        .dropdown-item.danger { color: #ef4444; }
        .dropdown-item.danger:hover { background: #fef2f2; }

        /* CATEGORY COLORS */
        .cat-online { background: #fff7ed; color: #ea580c; }
        .cat-shopping { background: #dbeafe; color: #3b82f6; }
        .cat-vehicle { background: #ede9fe; color: #8b5cf6; } 
        .cat-food { background: #fef9c3; color: #eab308; }
        .cat-life { background: #d1fae5; color: #10b981; } 
        .cat-service-magenta { background: #fce7f3; color: #d946ef; }
        .cat-aqua { background: #cffafe; color: #06b6d4; }
        .cat-trading { background: #fee2e2; color: #ef4444; }
        .cat-financial { background: #fee2e2; color: #ef4444; }
        .cat-credit-card { background: #fff7ed; color: #eaaf0c; }
        .cat-education { background: #eff6ff; color: #1d4ed8; }
        .cat-income { background: #dcfce7; color: #16a34a; }

        /* MODAL STYLES */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-overlay.show { display: flex; }
        .custom-modal { background: #fff; width: 92%; max-width: 380px; border-radius: 20px; padding: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); animation: modalIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes modalIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header { font-size: 1.1rem; font-weight: 700; color: #0f172a; margin-bottom: 4px; }
        .modal-body { margin-bottom: 12px; }
        .cat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 16px; }
        .cat-option { border: 1px solid #e2e8f0; border-radius: 12px; padding: 8px; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; transition: all 0.2s; }
        .cat-option:hover { border-color: #1d4ed8; background: #eff6ff; }
        .cat-option.active { border-color: #1d4ed8; background: #eff6ff; box-shadow: 0 0 0 2px #000; }
        .cat-option i { font-size: 24px; }
        .cat-option span { font-size: 12px; font-weight: 600; color: #475569; text-align: center; }
        .note-input { width: 100%; border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px 12px; font-size: 14px; min-height: 60px; resize: none; outline: none; transition: border-color 0.2s; color: #1e293b; }
        .note-input:focus { border-color: #1d4ed8; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 16px; margin-top: 8px; }
        .cancel-link { color: #1e293b; font-weight: 700; font-size: 13px; text-transform: uppercase; cursor: pointer; padding: 10px 16px; border-radius: 4px; transition: background 0.2s; }
        .cancel-link:hover { background: #f1f5f9; }

        /* NOTE DISPLAY - INLINE */
        .txn-note-inline { font-size: 11px; font-style: italic; max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; background: transparent !important; padding: 0 !important; }
        
        /* TOAST NOTIFICATION */
        
        /* TOAST NOTIFICATION */
        .toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 12px 24px; border-radius: 50px; font-size: 14px; font-weight: 600; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); z-index: 2000; display: flex; align-items: center; gap: 8px; opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .toast-container.show { opacity: 1; bottom: 30px; pointer-events: auto; }
        .toast-container i { color: #4ade80; }

        #log-container { background: #1e293b; color: #4ade80; padding: 15px; border-radius: 8px; font-family: 'Consolas', monospace; height: 140px; overflow-y: auto; font-size: 13px; margin-top: 30px; border: 1px solid #334155; line-height: 1.5; }
        .log-entry { margin-bottom: 6px; border-bottom: 1px solid #334155; padding-bottom: 4px; }
        .log-error { color: #f87171; font-weight: bold; }
        
        .loading-overlay { display: none; text-align: center; padding: 60px; color: #64748b; }
        .btn-sync { background-color: #000; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s, transform 0.1s; }
        .btn-sync:hover { background-color: #191919; }
        .btn-sync:active { transform: scale(0.98); }
        .btn-sync:disabled { background-color: #94a3b8; cursor: not-allowed; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }

        /* PIE CHART STYLES - THICKER & MODERN */
        .chart-card { background: #fff; border-radius: 24px; padding: 24px; margin-bottom: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; }
        .chart-container { 
            position: relative; width: 220px; height: 220px; margin: 0 auto 24px; 
            filter: drop-shadow(0 0 15px rgba(29, 78, 216, 0.05)); 
        }
        
        .chart-segment {
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .chart-segment:hover {
            transform: scale(1.02);
        }
        .chart-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: #fff; width: 90px; height: 90px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: inset 0 4px 12px rgba(0,0,0,0.03); border: 4px solid #f8fafc; z-index: 10; pointer-events: none; gap: 2px; }
        .chart-center-label { font-size: 9px; color: #94a3b8; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; line-height: 1; margin: 0; }
        .chart-center-value { font-size: 16px; font-weight: 800; color: #0f172a; letter-spacing: -0.5px; line-height: 1; text-align: center; }
        
        /* Highlighted Transaction Styling */
        .premium-txn.highlight-txn { transition: all 0.3s ease; }
        
        .legend-item.active { transform: scale(1.05); }
        .legend-item.active span { color: #000; font-weight: 800; }
        .legend-item { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); padding: 4px; border-radius: 8px; }
        .legend-item:hover { background: #f8fafc; }
        
        /* Floating Chart Tooltip */
        #chart-tooltip {
            position: absolute;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(4px);
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            pointer-events: none;
            opacity: 0;
            transform: translate(-50%, -100%);
            transition: opacity 0.2s;
            z-index: 100;
            white-space: nowrap;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* SIMPLE LEGEND */
        .legend { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 15px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; color: #1e293b; font-weight: 600; }
        .legend-color { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; height: 75px; background: #fff; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-around; align-items: center; padding: 0 10px; z-index: 1000; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #94a3b8; cursor: pointer; text-decoration: none; padding: 10px; transition: all 0.2s; }
        .nav-item:hover { text-decoration: none !important; color: #000; }
        .nav-item.active { color: #000; }
        .nav-item i { font-size: 24px; }
        .nav-item span { font-size: 11px; font-weight: 700; }

        /* FAB */
        .fab { position: fixed; bottom: 100px; right: calc(50% - 215px + 24px); width: 62px; height: 62px; border-radius: 50%; background: #000; color: #fff; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(0,0,0,0.4); z-index: 999; cursor: pointer; border: none; transition: transform 0.2s; }
        .fab:active { transform: scale(0.95); }
        .fab i { font-size: 32px; }
        
        @media (max-width: 430px) {
            .fab { right: 24px; }
            .bottom-nav { left: 0; transform: none; }
        }

        /* TREND CHART */
        .trend-card { background: #fff; border-radius: 20px; padding: 20px 24px 16px; margin-bottom: 24px; border: 1px solid #e2e8f0; box-shadow: 0 4px 20px rgba(0,0,0,0.02); }
        .trend-path { filter: drop-shadow(0 4px 6px rgba(29, 78, 216, 0.2)); }
        .trend-dot { fill: #fff; stroke: #000; stroke-width: 2.5; }
        .trend-label { font-size: 10px; fill: #94a3b8; font-weight: 600; }
        
        /* RECENT ACTIVITIES PREMIUM LIST */
        .recent-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding: 0 4px; }
        .recent-header h3 { margin: 0; font-weight: 700; font-size: 13px; color: #64748b; text-transform: uppercase; letter-spacing: 1.2px; }
        .recent-header .see-all { color: #000; font-size: 13px; font-weight: 800; text-decoration: none; text-transform: uppercase; }

        .premium-txn { padding: 12px 20px; display: flex; align-items: center; gap: 14px; border-bottom: 1px solid #f1f5f9; background: #fff; }
        .premium-txn:last-child { border-bottom: none; }
        .premium-txn .icon-box { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; position: relative; }
        .premium-txn .txn-details { flex: 1; min-width: 0; }
        .premium-txn .txn-merch { 
            font-weight: 800; 
            color: #1e293b; 
            letter-spacing: -0.3px; 
            font-size: 12px; 
            text-transform: uppercase; 
            white-space: nowrap;
            overflow: hidden;
            position: relative;
            padding-right: 25px;
            mask-image: linear-gradient(to right, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%);
        }
        .premium-txn .txn-sub { font-size: 9.5px; color: #475569; font-weight: 700; }
        .premium-txn .txn-amount { font-weight: 800; color: #1e293b; text-align: right; font-size: 13px; margin-left: auto; }
        .premium-txn .txn-amount.large { color: #ef4444; }
        .premium-txn .txn-note { 
            font-size: 9.5px; 
            font-weight: 700; 
            margin-top: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            mask-image: linear-gradient(to right, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%);
        }
        
        /* ACTIONS & DROPDOWN */
        .premium-txn .txn-actions { opacity: 1; z-index: 100; }
        .premium-txn .dropdown-menu { right: 0; top: 28px; }
        
        /* PRIVACY LOCK STYLING */
        .privacy-lock-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: #fff; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px;
        }
        .pin-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 10px; }
        .pin-btn { width: 72px; height: 72px; border-radius: 50%; border: 1.5px solid #f1f5f9; background: #fff; font-size: 26px; font-weight: 700; color: #1e293b; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; -webkit-tap-highlight-color: transparent; }
        .pin-btn:active { background: #f8fafc; transform: scale(0.9); }
        .pin-dots { display: flex; gap: 15px; margin-bottom: 40px; }
        .pin-dot { width: 14px; height: 14px; border-radius: 50%; background: #f1f5f9; transition: background 0.2s; border: 1px solid #e2e8f0; }
        .pin-dot.active { background: #000; border-color: #000; }
        
        /* ANALYTICS STYLING */
        .analytics-card {
            background: #fff; border-radius: 20px; padding: 20px; margin-bottom: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #f1f5f9;
        }
        .savings-chip { background: #dcfce7; color: #166534; font-size: 11px; font-weight: 800; padding: 4px 10px; border-radius: 20px; border: 1px solid rgba(0,0,0,0.03); }
        .bar-chart-wrap { display: flex; justify-content: space-between; align-items: flex-end; height: 100px; margin-top: 20px; }
        .bar-group { display: flex; flex-direction: column; align-items: center; flex: 1; }
        .bars-pair { display: flex; align-items: flex-end; gap: 4px; height: 80px; }
        .bar { width: 10px; border-radius: 3px 3px 0 0; transition: height 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .bar-income { background: #10b981; }
        .bar-expense { background: #ef4444; }
        .bar-label { margin-top: 8px; font-size: 9px; font-weight: 800; color: #94a3b8; text-transform: uppercase; }

        /* SUBSCRIPTION STYLING (REFINED) */
        .subscription-item { display: flex; flex-direction: column; gap: 4px; padding: 12px 0; border-bottom: 1px solid #f8fafc; }
        .subscription-item:last-child { border-bottom: none; }
        .sub-main-row { display: flex; align-items: center; gap: 10px; }
        .sub-icon { width: 34px; height: 34px; border-radius: 10px; display: flex; align-items: center; justify-content: center; background: #f8fafc; color: #64748b; }
        .sub-icon i { font-size: 18px; }
        .sub-info { flex: 1; }
        .sub-name { font-size: 12px; font-weight: 800; color: #1e293b; }
        .sub-meta { font-size: 9px; color: #94a3b8; font-weight: 700; text-transform: uppercase; }
        
        .sub-stats { text-align: right; }
        .sub-current-vs-avg { font-size: 11px; font-weight: 800; }
        .sub-avg-label { font-size: 9px; color: #94a3b8; font-weight: 700; text-transform: uppercase; margin-top: 2px; }
        
        .sub-item-progress-bg { height: 4px; background: #f1f5f9; border-radius: 2px; margin-top: 4px; overflow: hidden; width: 100%; }
        .sub-item-progress-fill { height: 100%; transition: width 0.6s ease; }
        
        .sub-limit-bar { height: 6px; background: #f1f5f9; border-radius: 3px; margin-top: 10px; overflow: hidden; }
        .sub-limit-fill { height: 100%; background: #3b82f6; transition: width 0.6s ease; }

        /* BUDGET STYLING */
        .budget-card {
            background: #fff; border-radius: 20px; padding: 20px; margin-bottom: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #f1f5f9;
        }
        .budget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .budget-progress-bg { background: #f1f5f9; height: 10px; border-radius: 5px; overflow: hidden; position: relative; }
        .budget-progress-fill { height: 100%; width: 0%; border-radius: 5px; transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), background 0.3s; }
        .budget-status { display: flex; justify-content: space-between; margin-top: 10px; font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }

        /* EXCLUDED STATE FOR PREMIUM TRANSACTIONS */
        .premium-txn.txn-excluded { opacity: 0.4; }
        .premium-txn.txn-excluded .txn-merch,
        .premium-txn.txn-excluded .txn-sub,
        .premium-txn.txn-excluded .txn-amount,
        .premium-txn.txn-excluded .txn-note { text-decoration: line-through; }
        .premium-txn.txn-excluded .icon-box { filter: grayscale(1); opacity: 0.5; }

        /* SEARCH STYLING */
        .search-container {
            margin: -4px 0px 20px;
            position: relative;
        }
        .search-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            padding: 0 14px;
            height: 48px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .search-wrapper:focus-within {
            background: #fff;
            border-color: #000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            transform: translateY(-1px);
        }
        .search-wrapper i {
            color: #94a3b8;
            font-size: 18px;
            margin-right: 12px;
        }
        #txn-search {
            background: none;
            border: none;
            outline: none;
            width: 100%;
            height: 100%;
            font-size: 13px;
            font-weight: 700;
            color: #1e293b;
        }
        #txn-search::placeholder {
            color: #94a3b8;
            font-weight: 600;
        }
        .search-clear {
            padding: 4px;
            cursor: pointer;
            color: #94a3b8;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .search-clear.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* iOS-STYLE LONG-PRESS BLUR EFFECT */
        .blur-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; }
        .blur-overlay.active { display: block; }
        
        /* Global Blur for elements */
        .mobile-wrapper.blur-active { filter: blur(8px) brightness(0.9); -webkit-filter: blur(8px) brightness(0.9); transition: filter 0.3s; pointer-events: none; }
        .fab.blur-active, .bottom-nav.blur-active { filter: blur(10px) brightness(0.6); -webkit-filter: blur(10px) brightness(0.6); pointer-events: none; }
        
        /* Shadow for the elevated clone */
        .premium-txn.elevated-clone { position: fixed; z-index: 2001; background: #fff; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); transform: scale(1.02); pointer-events: auto; border: 1px solid rgba(0,0,0,0.05); }
        
        /* BRAND LOGO BADGE */
        .brand-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1.5px solid #fff;
            z-index: 10;
            overflow: hidden;
        }
        .brand-badge img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transform: scale(1.15);
        }

        .ios-action-menu { display: none; position: fixed; background: rgba(255,255,255,0.95); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); border-radius: 14px; padding: 4px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 2002; min-width: 180px; max-width: 200px; overflow: hidden; }
        .ios-action-menu.show { display: block; animation: menuSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes menuSlideIn { from { opacity: 0; transform: translateY(-10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        .ios-action-item { padding: 10px 14px; font-size: 13px; font-weight: 600; color: #1e293b; display: flex; align-items: center; gap: 8px; cursor: pointer; border-radius: 10px; transition: background 0.2s; -webkit-user-select: none; user-select: none; }
        .ios-action-item:hover { background: rgba(0,0,0,0.05); }
        .ios-action-item i { font-size: 18px; color: #3b82f6; }
        .ios-action-item.danger { color: #ef4444; }
        .ios-action-item.danger i { color: #ef4444; }
        .ios-action-item.warning { color: #f59e0b; }
        .ios-action-item.warning i { color: #f59e0b; }

        /* GUEST GATE OVERLAY */
        /* GUEST GATE STYLING (MODERN) */
        
        /* APP DIALOG MODAL (REPLACES ALERT/PROMPT/CONFIRM) */
        .dialog-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            display: flex; align-items: center; justify-content: center; z-index: 99999;
            opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding: 20px;
        }
        .dialog-overlay.show { opacity: 1; pointer-events: auto; }
        .dialog-card {
            background: #fff; border-radius: 24px; width: 100%; max-width: 320px;
            padding: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            transform: scale(0.9); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .dialog-overlay.show .dialog-card { transform: scale(1); }
        .dialog-title { font-size: 18px; font-weight: 800; color: #1e293b; margin-bottom: 8px; letter-spacing: -0.5px; }
        .dialog-msg { font-size: 14px; color: #64748b; font-weight: 500; line-height: 1.5; margin-bottom: 20px; }
        .dialog-input { 
            width: 100%; padding: 12px 16px; border-radius: 12px; border: 2px solid #f1f5f9; 
            font-size: 16px; font-weight: 700; color: #1e293b; margin-bottom: 20px; outline: none; transition: border-color 0.2s;
        }
        .dialog-input:focus { border-color: #3b82f6; }
        .dialog-actions { display: flex; gap: 12px; }
        .dialog-btn {
            flex: 1; padding: 12px; border-radius: 14px; border: none; font-size: 14px; font-weight: 800;
            cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .dialog-btn--cancel { background: #f1f5f9; color: #64748b; }
        .dialog-btn--primary { background: #000; color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .dialog-btn:active { transform: scale(0.96); opacity: 0.8; }

        .guest-gate-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(18, 18, 18, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            z-index: 5000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
            animation: fadeIn 0.4s ease-out;
            overflow: hidden;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .guest-gate-card {
            background: #fff;
            padding: 32px 24px;
            border-radius: 28px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 340px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            overflow: visible;
        }
        .guest-gate-btn {
            background: #121212;
            color: #fff;
            border: none;
            padding: 14px 28px;
            border-radius: 50px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
            justify-content: center;
        }
        .guest-gate-btn:active { transform: scale(0.96); }
    </style>
</head>
<body>
    <!-- PRIVACY LOCK OVERLAY (NEW) -->
    <div id="privacy-lock" class="privacy-lock-overlay" style="display: none;">
        <div style="font-size: 22px; font-weight: 900; color: #1e293b; margin-bottom: 8px; letter-spacing: -0.5px;">Security Lock</div>
        <div style="font-size: 13px; color: #94a3b8; font-weight: 700; margin-bottom: 40px; text-transform: uppercase; letter-spacing: 0.5px;">Enter PIN to unlock Wallet</div>
        <div class="pin-dots" id="pin-dots">
            <div class="pin-dot"></div>
            <div class="pin-dot"></div>
            <div class="pin-dot"></div>
            <div class="pin-dot"></div>
        </div>
        <div class="pin-grid">
            <button class="pin-btn" onclick="handlePinInput('1')">1</button>
            <button class="pin-btn" onclick="handlePinInput('2')">2</button>
            <button class="pin-btn" onclick="handlePinInput('3')">3</button>
            <button class="pin-btn" onclick="handlePinInput('4')">4</button>
            <button class="pin-btn" onclick="handlePinInput('5')">5</button>
            <button class="pin-btn" onclick="handlePinInput('6')">6</button>
            <button class="pin-btn" onclick="handlePinInput('7')">7</button>
            <button class="pin-btn" onclick="handlePinInput('8')">8</button>
            <button class="pin-btn" onclick="handlePinInput('9')">9</button>
            <div></div>
            <button class="pin-btn" onclick="handlePinInput('0')">0</button>
            <button class="pin-btn" onclick="handlePinInput('back')"><i class="material-icons">backspace</i></button>
        </div>
        <button class="mui-btn mui-btn--flat" onclick="tryBiometricUnlock()" id="bio-btn" style="margin-top: 60px; color: #3b82f6; font-size: 11px; font-weight: 800; display: none; text-transform: uppercase;">
            <i class="material-icons" style="margin-right: 8px; font-size: 20px;">fingerprint</i>
            Use Biometrics
        </button>
    </div>

    <!-- CHART TOOLTIP -->
    <div id="chart-tooltip"></div>

    <div class="mobile-wrapper">
        <!-- GUEST LOGIN GATE -->
        <div id="guestGate" class="guest-gate-overlay">
            <div class="guest-gate-card">
                <div style="width: 64px; height: 64px; border-radius: 20px; background: #f8fafc; display: flex; align-items: center; justify-content: center;">
                    <i class="material-icons" style="font-size: 32px; color: #121212;">lock</i>
                </div>
                <div>
                    <h2 style="font-size: 22px; font-weight: 900; color: #121212; margin: 0 0 10px 0;">Sign in Required</h2>
                    <p style="font-size: 14px; color: #64748b; margin: 0; line-height: 1.6;">To start tracking your expenses and sync across devices, please sign in with Google first.</p>
                </div>
                <button class="guest-gate-btn" onclick="handleAuthClick()">
                    <svg viewBox="0 0 48 48" width="20px" xmlns="http://www.w3.org/2000/svg"><path d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z" fill="#FFF"/></svg>
                    Continue with Google
                </button>
            </div>
        </div>

        <div id="header">
            <div class="header-logo-box" style="display: flex; align-items: center; gap: 12px;">
                <!-- Dynamic Card Icon -->
                <svg id="header-card-icon" class="header-logo" viewBox="0 0 48 30" xmlns="http://www.w3.org/2000/svg">
                    <!-- Card Background -->
                    <rect width="48" height="30" rx="4" fill="#1a1a1a" id="card-bg"/>
                    
                    <!-- Mastercard Logo (bottom right) -->
                    <g transform="translate(32, 20)">
                        <circle cx="4" cy="4" r="3.5" fill="#eb001b" opacity="0.9"/>
                        <circle cx="8" cy="4" r="3.5" fill="#f79e1b" opacity="0.9"/>
                    </g>
                    
                    <!-- Card Chip (optional detail) -->
                    <rect x="6" y="8" width="8" height="6" rx="1" fill="#d4af37" opacity="0.3"/>
                </svg>
                
                <div class="greeting-section">
                    <div class="greeting-text">Hello,</div>
                    <div class="user-name" id="user-display-name">Guest</div>
                </div>
            </div>
            <div class="profile-container">
            <div id="profile-badge" onclick="toggleProfileDropdown(event)">
                <i class="material-icons">person</i>
                <img id="user-pic" src="" alt="Profile" referrerpolicy="no-referrer">
            </div>
            <div id="profile-dropdown" class="profile-dropdown">
                <div class="dropdown-item" onclick="handleAuthClick()">
                    <i class="material-icons">sync</i>
                    <span>Google Sync</span>
                </div>
                <div class="dropdown-item" onclick="promptSetPin()">
                    <i class="material-icons">lock</i>
                    <span>Privacy PIN</span>
                </div>
                <div class="dropdown-item logout" onclick="handleSignout()">
                    <i class="material-icons">logout</i>
                    <span>Log Out</span>
                </div>
            </div>
        </div>
        </div>

        <!-- SWIPEABLE CARD VIEWPORT -->
        <div class="card-viewport" id="cardViewport">
            <div class="card-carousel-scroll" id="cardCarouselScroll">
                <div class="balance-card atome-card" data-account="atome" id="atomeCard">
                    <div class="card-brand-logo atome-brand-logo">A</div>
                    
                    <div class="card-header-row">
                        <div class="card-label">Atome Spending</div>
                        <div class="card-sync-status-chip">
                            <div class="dot syncDot"></div>
                            <span class="status-text syncStatusText">Ready</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 8px;">
                         <div class="balance-amount" id="atome-balance">PHP 0.00</div>
                         <button onclick="toggleBalanceVisibility(event)" class="visibility-btn" style="background:none; border:none; color:rgba(255,255,255,0.5); cursor:pointer; padding:4px; display:flex; align-items:center;">
                            <i class="material-icons" style="font-size:16px;">visibility</i>
                         </button>
                    </div>
                    
                    <div class="card-footer">
                        <div class="card-number-box">
                            <div class="card-number-label">Account Number</div>
                            <div class="card-number">**** **** 7312</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button class="sync-icon-btn scan-btn" onclick="handleScan(400)" title="Sync Account">
                                <i class="material-icons">sync</i>
                            </button>
                            <div class="mastercard-circles">
                                <div class="circle circle-1"></div>
                                <div class="circle circle-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="balance-card bpi-card" data-account="bpi" id="bpiCard">
                    <div class="bpi-rays"></div>
                    
                    <div class="card-header-row">
                        <div style="display: flex; align-items: baseline; gap: 6px;">
                            <div class="card-label">BPI Card</div>
                            <div class="card-type-label">debit</div>
                        </div>
                        <div class="card-sync-status-chip">
                            <div class="dot syncDot"></div>
                            <span class="status-text syncStatusText">Ready</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 8px;">
                         <div class="balance-amount" id="bpi-balance">PHP 0.00</div>
                         <button onclick="toggleBalanceVisibility(event)" class="visibility-btn" style="background:none; border:none; color:rgba(255,255,255,0.5); cursor:pointer; padding:4px; display:flex; align-items:center;">
                            <i class="material-icons" style="font-size:16px;">visibility</i>
                         </button>
                    </div>
                    <div id="bpi-remaining-insight" style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: -8px; margin-bottom: 20px; font-weight: 700; opacity: 0; transition: opacity 0.3s; position: relative; z-index: 2; letter-spacing: 0.3px;">PHP 0.00 (0.00)</div>
                    
                    <div class="card-footer">
                        <div class="card-number-box">
                            <div class="card-number-label">Account Number</div>
                            <div class="card-number">0099 096727</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button class="sync-icon-btn scan-btn" onclick="handleScan(400)" title="Sync Account">
                                <i class="material-icons">sync</i>
                            </button>
                            <div class="mastercard-circles">
                                <div class="circle circle-1" style="background:#ea001b;"></div> 
                                <div class="circle circle-2" style="background:#f79e1b;"></div> 
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ADD CARD PLACEHOLDER -->
                <div class="balance-card add-card-placeholder" onclick="window.location.href='accounts.html'">
                    <div style="text-align:center;">
                        <i class="material-icons">add_circle_outline</i>
                        <div>Add Another Card</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SHARED SYNC BAR REMOVED AND MOVED INTO CARDS -->



        <!-- CHART TOOLTIP -->
        <div id="chart-tooltip" style="position: fixed; background: rgba(15, 23, 42, 0.95); color: #fff; padding: 10px 14px; border-radius: 10px; font-size: 12px; font-weight: 700; pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 9999; box-shadow: 0 10px 25px rgba(0,0,0,0.3); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); line-height: 1.4; white-space: nowrap;"></div>

        <div class="mui-container">
            <!-- Buttons integrated into card sync bar -->
            
            <!-- BUDGET CARD (NEW) -->
            <!-- <div class="budget-card" id="budget-card-section">
                <div class="budget-header">
                    <h3 style="margin:0; font-size: 1.1rem; font-weight: 800; color: #1e293b; letter-spacing: -0.5px;">Monthly Budget</h3>
                    <button class="mui-btn mui-btn--flat" onclick="promptSetBudget()" style="padding:0 8px; color:#3b82f6; font-size:11px; font-weight:800; text-transform:uppercase; border: 1px solid #dbeafe; border-radius: 6px; height: 26px;">Set Limit</button>
                </div>
                <div class="budget-progress-bg">
                    <div id="budget-fill" class="budget-progress-fill" style="background:#10b981;"></div>
                </div>
                <div class="budget-status">
                    <span id="budget-spent">0.00 spent</span>
                    <span id="budget-limit">0.00 limit</span>
                </div>
            </div> -->

            <!-- RELOCATED ANALYTICS SECTION -->

            <!-- SUBSCRIPTION CARD (MOVED BELOW HISTORY) -->

            <!-- EXPENSES STRUCTURE (WEB3 MODERN) -->
            <div id="chart-section" class="chart-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h3 style="margin: 0; font-size: 1.1rem; font-weight: 800; color: #1e293b; letter-spacing: -0.5px;">Expenses structure</h3>
                    <select id="chart-filter" onchange="filterChart()" class="mui-btn mui-btn--flat" style="font-size: 11px; font-weight: 600; color: #1e293b; background: #f8fafc; padding: 0 4px 0 10px; border-radius: 8px; height: 28px; text-transform: none; border: 1px solid #e2e8f0; outline: none; cursor: pointer; text-align: left; width: auto; min-width: 100px;">
                        
                        <option value="this_month" selected>This Month</option>
                        <option value="today">Today</option>
                        <option value="this_week">This Week</option>
                        <option value="last_week">Last Week</option>
                        <option value="first_15">First 15 of Month</option>
                        <option value="last_15">Last 15 of Month</option>
                        <option value="last_month">Last Month</option>
                        <option value="last_3_months">Last 3 Months</option>
                        <option value="last_6_months">Last 6 Months</option>
                        <option value="this_year">This Year</option>
                    </select>
                </div>

                <div style="display: flex; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <div style="font-size: 11px; color: #94a3b8; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Total Expenses</div>
                        <div style="font-size: 22px; font-weight: 800; color: #0f172a; letter-spacing: -0.5px;" id="expenses-total-summary">PHP 0.00</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 11px; color: #94a3b8; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">vs past period</div>
                        <div id="mom-growth-box" style="font-size: 22px; font-weight: 800; color: #ef4444; letter-spacing: -0.5px;"><span id="mom-growth"></span></div>
                    </div>
                </div>

                <div class="chart-container" id="chart-anim-container">
                    <svg id="pieChart" width="220" height="220" viewBox="0 0 240 240">
                        <g id="pieContent"></g>
                    </svg>
                    <div class="chart-center">
                        <div class="chart-center-label" id="chart-total-label">TOTAL</div>
                        <div class="chart-center-value" id="chart-total-val">0</div>
                    </div>
                </div>
                <div id="chart-legend" class="legend">
                    <!-- Dynamic segments will go here -->
                </div>
            </div>

            <!-- TREND SECTION -->
            <div class="trend-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h3 style="margin: 0; font-size: 1.1rem; font-weight: 800; color: #1e293b;">Spending Trends</h3>
                    <select id="trend-filter" onchange="refreshTrendChart()" class="mui-btn mui-btn--flat" style="font-size: 11px; font-weight: 600; color: #1e293b; background: #f1f5f9; padding: 0 4px 0 10px; border-radius: 6px; height: 26px; text-transform: none; border: none; outline: none; cursor: pointer; text-align: left; min-width: 90px;">
                        <option value="this_month" selected>This Month</option>
                        <option value="this_week">This Week</option>
                        <option value="last_3_months">Past 3 Months</option>
                        <option value="last_6_months">Past 6 Months</option>
                    </select>
                </div>
                <div style="height: 140px; width: 100%; position: relative; margin-bottom: 20px;">
                    <svg id="trendChart" width="100%" height="140" viewBox="0 0 400 140" preserveAspectRatio="none">
                        <defs>
                            <linearGradient id="trendGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#3b82f6; stop-opacity:0.1" />
                                <stop offset="100%" style="stop-color:#3b82f6; stop-opacity:0" />
                            </linearGradient>
                        </defs>
                        <path id="trendArea" d="" fill="url(#trendGradient)"></path>
                        <path id="trendPath" class="trend-path" d="" fill="none" stroke="#3b82f6" stroke-width="4" stroke-linecap="round"></path>
                        <g id="trendDots"></g>
                    </svg>
                    <div id="trend-labels" style="display: flex; justify-content: space-between; margin-top: 10px; padding: 0 5px;">
                        <span class="trend-label">Week 1</span>
                        <span class="trend-label">Week 2</span>
                        <span class="trend-label">Week 3</span>
                        <span class="trend-label">Week 4</span>
                    </div>
                </div>
                <div style="border-top: 1px dashed #e2e8f0; padding-top: 16px; display: flex; justify-content: space-between; align-items: center; padding-top: 16px;">
                    <span style="font-size: 13px; color: #64748b; font-weight: 600;">Period Total</span>
                    <span style="font-size: 1.1rem; font-weight: 800; color: #10b981;" id="trend-period-total">PHP 0.00</span>
                </div>
            </div>

            <div class="recent-header">
                <h3>Recent Transactions</h3>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="logo-toggle-wrapper" title="Toggle Brand Logos" onclick="toggleLogos()" style="background: #e0f2fe; padding: 4px 8px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                        <i class="material-icons" id="logo-toggle-icon" style="font-size: 16px; color: #0284c7;">visibility</i>
                        
                    </div>
                    <select id="txn-cat-filter" onchange="filterTxnList()" style="font-size: 10px; font-weight: 700; color: #64748b; background: #f8fafc; padding: 4px 8px; border-radius: 8px; border: 1px solid #e2e8f0; outline: none; cursor: pointer;">
                        <option value="all">All Items</option>
                    </select>
                </div>
            </div>

            <div class="search-container">
                <div class="search-wrapper">
                    <i class="material-icons">search</i>
                    <input type="text" id="txn-search" placeholder="Search merchant, note, or price..." oninput="handleSearchInput()">
                    <i class="material-icons search-clear" id="search-clear-btn" onclick="clearSearch()">cancel</i>
                </div>
            </div>

            <div id="loading-spinner" class="loading-overlay">
                <i class="material-icons spin" style="font-size: 48px; color: #1e293b;">sync</i>
            </div>

            <div id="history-container"></div>

            <!-- VISIBLE DIVIDER ABOVE ANALYTICS -->
            <div style="margin: 20px 0px 40px; height: 1px; background: #f1f5f9; width: 100%;"></div>

            <!-- ANALYTICS CARD (MOVED FROM TOP) -->
            <div class="analytics-card" id="analytics-section" style="margin: 20px 16px 10px; padding: 15px; border-radius: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin:0; font-size: 0.95rem; font-weight: 800; color: #1e293b; letter-spacing: -0.3px;">Cash Flow</h3>
                    <div class="savings-chip">Savings Rate: <span id="savings-rate-val">0%</span></div>
                </div>
                <div style="font-size: 11px; color: #94a3b8; font-weight: 600; margin-bottom: 15px;">Income vs Expenses (Last 6 Months)</div>
                <div class="bar-chart-wrap" id="cashflow-bars">
                    <!-- Bars generated via JS -->
                </div>
                <div style="display: flex; gap: 15px; margin-top: 15px; border-top: 1px dashed #f1f5f9; padding-top: 10px;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 8px; height: 8px; border-radius: 2px; background: #10b981;"></div>
                        <span style="font-size: 9px; font-weight: 700; color: #64748b; text-transform: uppercase;">Income</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 8px; height: 8px; border-radius: 2px; background: #ef4444;"></div>
                        <span style="font-size: 9px; font-weight: 700; color: #64748b; text-transform: uppercase;">Expense</span>
                    </div>
                </div>
            </div>

            <!-- RELOCATED SUBSCRIPTION SECTION -->
            <div class="analytics-card" id="subscription-section" style="display: none; margin: 10px 16px 20px; padding: 15px; border-radius: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <h3 style="margin:0; font-size: 0.95rem; font-weight: 800; color: #1e293b; letter-spacing: -0.3px;">Recurring Items</h3>
                        <span id="sub-count-badge" style="background:#f1f5f9; color:#64748b; font-size:9px; font-weight:800; padding:2px 6px; border-radius:10px;">0</span>
                    </div>
                    <div style="text-align: right;">
                        <div id="sub-limit-label" class="privacy-mask" onclick="promptSetSubLimit()" style="font-size: 9px; color: #94a3b8; font-weight: 700; text-transform: uppercase; cursor: pointer;">Limit: 0</div>
                        <div id="sub-total-label" class="privacy-mask" style="font-size: 11px; font-weight: 800; color: #1e293b;">0.00 / mo</div>
                    </div>
                </div>
                <div class="sub-limit-bar">
                    <div id="sub-limit-fill" class="sub-limit-fill" style="width: 0%;"></div>
                </div>
                <div id="subscription-list" style="margin-top: 5px;">
                    <!-- JS injected -->
                </div>
            </div>
            
            <!-- DATA MANAGEMENT SECTION (PREMIUM DESIGN) -->
            <div class="data-mgmt-card" style="margin: 30px 16px 20px; padding: 12px 16px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.02);">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <div style="width: 28px; height: 28px; border-radius: 6px; background: #eff6ff; color: #000; display: flex; align-items: center; justify-content: center;">
                        <i class="material-icons" style="font-size: 16px;">storage</i>
                    </div>
                    <div style="text-align: left;">
                        <div style="font-size: 11px; font-weight: 800; color: #1e293b; letter-spacing: -0.2px;">Account Backup</div>
                        <div style="font-size: 9px; color: #64748b; font-weight: 600;">Secure your data locally</div>
                    </div>
                </div>

                <div style="display: flex; gap: 8px;">
                    <button class="mui-btn mui-btn--flat" style="flex: 1; height: 34px; border-radius: 8px; text-transform: none; font-weight: 800; background: #000; color: #fff; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 6px; box-shadow: 0 4px 12px rgba(29, 78, 216, 0.15);" onclick="exportData()">
                        <i class="material-icons" style="font-size: 14px;">download</i> Export
                    </button>
                    <button class="mui-btn mui-btn--flat" style="flex: 1; height: 34px; border-radius: 8px; text-transform: none; font-weight: 800; background: #fff; color: #1e293b; border: 1px solid #e2e8f0; font-size: 11px; display: flex; align-items: center; justify-content: center; gap: 6px;" onclick="document.getElementById('import-file').click()">
                        <i class="material-icons" style="font-size: 14px;">upload</i> Import
                    </button>
                </div>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
            </div>

            <!-- TROUBLESHOOTING SECTION -->
            <div class="data-mgmt-card" style="margin: 0 16px 20px; padding: 12px 16px; border: 1px dashed #cbd5e1; border-radius: 12px; background: #fff;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="font-size: 11px; font-weight: 700; color: #64748b;">Having sync issues?</div>
                    <button onclick="window.hardRefresh()" style="background: #f1f5f9; border: none; padding: 6px 12px; border-radius: 6px; font-size: 10px; font-weight: 700; color: #ef4444; display: flex; align-items: center; gap: 4px; cursor: pointer;">
                        <i class="material-icons" style="font-size: 14px;">refresh</i> HARD REFRESH
                    </button>
                </div>
            </div>

            <!-- ADMIN CONTROLS (SECRETS) -->
            <div id="admin-controls" style="display: none; padding: 20px 16px;">
                <div class="status-labels" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 10px;">
                    <div id="gis-status" class="status-chip" style="height: auto; padding: 8px 12px; line-height: 1.4;">GIS:<br>READY</div>
                    <div id="mode-status" class="status-chip status-ready" style="height: auto; padding: 8px 12px; line-height: 1.4; text-align: left;">
                        MODE: CLOUD<br>
                        <span id="admin-email-display" style="font-size: 9px; opacity: 0.8;">(LOADING...)</span>
                    </div>
                </div>
            </div>

            <div id="log-container" style="display: none; margin-bottom: 80px; padding-bottom: 40px;"></div>
            
            <div class="footer-credits" style="text-align: center; padding: 20px 20px 40px; color: #cbd5e1; font-size: 10px; font-weight: 500; letter-spacing: 0.5px; opacity: 0.8;">
                <div onclick="toggleAdminMode()" style="cursor: default; -webkit-tap-highlight-color: transparent;">Developed by John Paul Inso | v1.2.8</div>
            </div>
        </div>

        <button class="fab" onclick="openManualTxnModal()">
            <i class="material-icons">add</i>
        </button>

        <!-- BOTTOM NAV -->
        <div class="bottom-nav">
            <a href="index.html" class="nav-item active">
                <i class="material-icons">account_balance_wallet</i>
                <span>Wallet</span>
            </a>
            <a href="calendar.html" class="nav-item">
                <i class="material-icons">calendar_today</i>
                <span>Calendar</span>
            </a>
            <a href="accounts.html" class="nav-item">
                <i class="material-icons">account_balance</i>
                <span>Accounts</span>
            </a>
            <a href="goals.html" class="nav-item">
                <i class="material-icons">track_changes</i>
                <span>Goals</span>
            </a>
        </div>
    </div>

    <!-- iOS-STYLE BLUR OVERLAY (NOW AT BODY LEVEL) -->
    <div class="blur-overlay" id="blurOverlay" onclick="closeIOSMenu()"></div>
    <div class="ios-action-menu" id="iosActionMenu"></div>

    <script>
        // Global bridge for GIS callback to avoid module race condition
        window.gisLoaded = function() {
            if (window.initGISModule) window.initGISModule();
            else window.gisReadyPending = true;
        };
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, serverTimestamp, getDocs, onSnapshot, query, orderBy, updateDoc, deleteDoc, deleteField, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBHDN0xLi98qjYYjUf2RDCn5gJK0dzTk_M",
            authDomain: "atome-wallet.firebaseapp.com",
            projectId: "atome-wallet",
            storageBucket: "atome-wallet.firebasestorage.app",
            messagingSenderId: "64186651619",
            appId: "1:64186651619:web:cd7d426cfb663aab6606d6",
            measurementId: "G-2SHWJ6S3Z3"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.closeModals = () => {
            document.querySelectorAll('.modal-overlay, .dialog-overlay').forEach(m => m.classList.remove('show'));
        };

        // UNIFIED PROMISE-BASED DIALOG SYSTEM
        window.showAppDialog = ({ title = 'Alert', message = '', input = false, value = '', confirm = false, callback = null }) => {
            return new Promise((resolve) => {
                const overlay = document.getElementById('app-dialog');
                const titleEl = document.getElementById('dialog-title');
                const msgEl = document.getElementById('dialog-msg');
                const inputCont = document.getElementById('dialog-input-container');
                const inputEl = document.getElementById('dialog-input');
                const cancelBtn = document.getElementById('dialog-cancel-btn');
                const okBtn = document.getElementById('dialog-ok-btn');

                titleEl.innerText = title;
                msgEl.innerText = message;
                
                if (input) {
                    inputCont.style.display = 'block';
                    inputEl.value = value;
                    setTimeout(() => inputEl.focus(), 300);
                } else {
                    inputCont.style.display = 'none';
                }

                cancelBtn.style.display = (confirm || input) ? 'block' : 'none';
                okBtn.innerText = (confirm || input) ? 'CONFIRM' : 'OK';

                const close = (res) => {
                    overlay.classList.remove('show');
                    // Remove listeners to avoid leaks
                    okBtn.onclick = null;
                    cancelBtn.onclick = null;
                    if (callback) callback(res);
                    resolve(res);
                };

                okBtn.onclick = () => close(input ? inputEl.value : true);
                cancelBtn.onclick = () => close(false);

                overlay.classList.add('show');
            });
        };


        // ENABLE OFFLINE PERSISTENCE
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                log('Persistence failed: Multiple tabs open');
            } else if (err.code == 'unimplemented') {
                log('Persistence not supported');
            }
        });

        // REGISTER SERVICE WORKER
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker Registered'))
                .catch(err => console.log('SW Registration Failed', err));
        }

        // GOOGLE AUTH CONSTANTS
        const CLIENT_ID = '64186651619-3eb9ki680f4c8q2g2mese3c8hhfur23b.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/userinfo.profile';
        let tokenClient;
        let accessToken = localStorage.getItem('g_access_token');
        let expiry = localStorage.getItem('g_token_expiry');

        if (window.location.search.includes('logout=true')) {
            // Force a deep reset on the first load after logout
            log(' Session purge complete. User isolated.', 'info');
        }

        // INITIALIZE APP
        window.addEventListener('DOMContentLoaded', async () => {
            log('SmartWallet Sync - v1.2.8 Active');
            const origin = window.location.origin;
            log('---  FINAL AUTH FIX ---', 'warn');
            log('You see "Requested action is invalid" because your local server address is not authorized.', 'error');
            log('1. Go to Firebase Console > Authentication > Settings > Authorized Domains');
            log('2. Add BOTH "127.0.0.1" AND "localhost" to the list.', 'info');
            log('3. Current URL: ' + window.location.href);
            log('4. Ensure your server is running on ' + origin, 'info');
            log('-------------------------', 'warn');

            // 1. Immediate UI population from Cache
            const cachedName = localStorage.getItem('user_name');
            const cachedPic = localStorage.getItem('user_pic');
            if (cachedName) document.getElementById('user-display-name').innerText = cachedName;
            if (cachedPic) {
                const badge = document.getElementById('profile-badge');
                const picEl = document.getElementById('user-pic');
                picEl.src = cachedPic;
                badge.classList.add('has-pic');
            }
            
            // Safety: Check if GIS already loaded (async/defer race)
            if (typeof google !== 'undefined' && google.accounts) {
                window.gisLoaded();
            }
            
            // 2. Auth State Observer
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    log('Establishing secure local session...');
                    signInAnonymously(auth).catch(e => log('Local session error: ' + e.message, 'error'));
                    return;
                }

                const dbBadge = document.getElementById('mode-status'); // Use mode-status for admin view
                const emailDisplay = document.getElementById('admin-email-display');
                
                if (dbBadge) {
                   dbBadge.className = 'status-chip ' + (user.isAnonymous ? 'status-local' : 'status-ready');
                   if (emailDisplay) emailDisplay.innerText = user.isAnonymous ? '(UNSYNCED)' : `(${user.email.toUpperCase()})`;
                }
                
                log('Auth Detected: ' + (user.isAnonymous ? 'Guest' : user.email) + ' [UID: ' + user.uid + ']');
                if (!user.isAnonymous) log('Cloud Sync Active!', 'info');
                
                // Update Profile Dropdown Content
                const dropdown = document.getElementById('profile-dropdown');
                if (user.isAnonymous) {
                     dropdown.innerHTML = `
                        <div class="dropdown-header">Guest Session</div>
                        <div class="dropdown-item" onclick="handleAuthClick()">
                            <i class="material-icons">cloud_upload</i>
                            <span>Sign in with Google</span>
                        </div>
                     `;
                } else {
                     dropdown.innerHTML = `
                        <div class="dropdown-header">${user.email}</div>
                        <div class="dropdown-item" onclick="handleAuthClick()">
                            <i class="material-icons">swap_horiz</i>
                            <span>Switch Account</span>
                        </div>
                        <div class="dropdown-item logout" onclick="handleSignout()">
                            <i class="material-icons">logout</i>
                            <span>Log Out</span>
                        </div>
                     `;
                }

                if (user.isAnonymous) {
                     // Nudge to claim data
                     const profileBadge = document.getElementById('profile-badge');
                     profileBadge.style.border = '2px solid #f59e0b';
                     profileBadge.classList.add('local-nudge');
                     
                     // Create/Show Floating Pill
                     let banner = document.getElementById('local-banner');
                     if (!banner) {
                         banner = document.createElement('div');
                         banner.id = 'local-banner';
                         banner.innerHTML = `
                            <div style="display:flex; align-items:center; gap:10px;">
                                <i class="material-icons" style="color:#f59e0b; font-size:20px;">cloud_off</i>
                                <span style="font-size:12px; font-weight:800; color:#1e293b; letter-spacing:0.2px;">SYNC YOUR DATA</span>
                            </div>
                            <button onclick="handleAuthClick()" class="banner-pill-btn">SIGN IN</button>
                         `;
                         banner.className = 'sticky-banner';
                         const viewport = document.getElementById('cardViewport');
                         if (viewport) viewport.after(banner);
                         else document.body.prepend(banner);
                     }
                     banner.style.display = 'flex';
                } else {
                     document.getElementById('profile-badge').style.border = 'none';
                     document.getElementById('profile-badge').classList.remove('local-nudge');
                     const banner = document.getElementById('local-banner');
                     if (banner) banner.style.display = 'none';
                }
                
                // Update Profile if synced
                if (!user.isAnonymous) {
                     const parts = user.displayName?.split(' ') || [];
                     const firstName = parts.length > 1 ? parts.slice(0, 2).join(' ') : (parts[0] || 'User');
                     document.getElementById('user-display-name').innerText = firstName;
                     localStorage.setItem('user_name', firstName);
                     
                     if (user.photoURL) {
                         const picEl = document.getElementById('user-pic');
                         // Force size for Google photos if needed
                         let photoUrl = user.photoURL;
                         if (photoUrl.includes('googleusercontent.com') && !photoUrl.includes('s96-c')) {
                             photoUrl = photoUrl.split('=')[0] + '=s96-c';
                         }
                         picEl.src = photoUrl;
                         document.getElementById('profile-badge').classList.add('has-pic');
                         localStorage.setItem('user_pic', photoUrl);
                     }
                } else {
                    document.getElementById('user-display-name').innerText = 'Guest';
                    document.getElementById('profile-badge').classList.remove('has-pic');
                }

                // Load Data for this UID
                await loadData();
                setupAccountSwitcher();
                
                // Hydrate others in background after short delay to prioritize current view
                setTimeout(() => window.hydrateAllCaches(), 3000);
                
                // Refresh global token state for handleScan
                accessToken = localStorage.getItem('g_access_token');
                expiry = localStorage.getItem('g_token_expiry');

                if (accessToken && expiry && Date.now() < parseInt(expiry)) {
                    // ADAPTIVE SYNC with Cooldown to prevent lag on page switch
                    const lastDeepSync = localStorage.getItem(`last_deep_sync_${window.currentAccount}`);
                    const lastQuickSync = localStorage.getItem(`last_quick_sync_${window.currentAccount}`);
                    const now = Date.now();
                    const dayInMs = 24 * 60 * 60 * 1000;
                    const quickSyncCooldown = 10 * 60 * 1000; // 10 minutes
                    
                    if (!lastDeepSync || (now - parseInt(lastDeepSync)) > dayInMs) {
                        log(`Deep sync scheduled for ${window.currentAccount} (800 items)...`);
                        setTimeout(() => handleScan(800), 2000);
                    } else if (!lastQuickSync || (now - parseInt(lastQuickSync)) > quickSyncCooldown) {
                        log(`Routine quick sync for ${window.currentAccount}...`);
                        setTimeout(() => handleScan(25), 1500);
                    } else {
                        log(`Sync cooldown active for ${window.currentAccount}. Skipping auto-scan.`, 'info');
                    }
                }
                
                applyUserView(user);
            });
        });

        function applyUserView(user) {
            const isAnon = !user || user.isAnonymous;
            const isAdmin = user && user.email === 'johnpaulinso123@gmail.com';
            
            // SHOW/HIDE GATE
            const gate = document.getElementById('guestGate');
            if (gate) gate.style.display = isAnon ? 'flex' : 'none';

            const bpiCard = document.getElementById('bpiCard');
            const atomeCard = document.getElementById('atomeCard');
            const scrollContainer = document.getElementById('cardCarouselScroll');
            const placeholder = document.querySelector('.add-card-placeholder');

            if (!isAdmin) {
                // GUEST/USER VIEW: Minimalist Black Card
                if (bpiCard) bpiCard.style.display = 'none';
                if (placeholder) placeholder.style.display = 'flex';
                
                // Keep carousel functional but simplify padding for 1-card feel
                if (scrollContainer) {
                    scrollContainer.style.overflowX = 'auto';
                    scrollContainer.style.scrollSnapType = 'x mandatory';
                    scrollContainer.style.padding = '30px 35px 25px 35px';
                    scrollContainer.style.justifyContent = 'flex-start';
                }

                if (atomeCard) {
                    const logo = atomeCard.querySelector('.atome-brand-logo');
                    if (logo) logo.style.display = 'none';
                    const label = atomeCard.querySelector('.card-label');
                    if (label) label.innerText = 'Personal Wallet';
                    
                    atomeCard.classList.add('active'); // Force active state
                    atomeCard.style.maxWidth = '360px';
                    atomeCard.style.flex = '0 0 calc(100% - 30px)';
                    
                    // Snap to center instantly
                    setTimeout(() => {
                        atomeCard.scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'center' });
                    }, 50);
                }
                
                // FORCE THEME TO BLACK
                applyTheme('atome');
                updateHeaderIcon('atome');
            } else {
                // ADMIN VIEW: Restore Atome/BPI Carousel
                if (bpiCard) bpiCard.style.display = 'flex';
                if (placeholder) placeholder.style.display = 'flex';
                if (scrollContainer) {
                    scrollContainer.style.overflowX = 'auto';
                    scrollContainer.style.scrollSnapType = 'x mandatory';
                    scrollContainer.style.padding = '30px 35px 25px 35px';
                    scrollContainer.style.justifyContent = 'flex-start';
                }
                if (atomeCard) {
                    const logo = atomeCard.querySelector('.atome-brand-logo');
                    if (logo) logo.style.display = 'block';
                    const label = atomeCard.querySelector('.card-label');
                    if (label) label.innerText = 'Atome Spending';
                    atomeCard.style.maxWidth = '360px';
                }
            }
        }

        // ACCOUNT MANAGEMENT & SWIPE LOGIC
        window.currentAccount = localStorage.getItem('wallet_current_account') || 'atome';

        window.getCollectionName = (accId) => {
            if (accId === 'atome') return "transactions";
            if (accId === 'bpi') return "bpi_transactions";
            return `txns_${accId}`;
        };
        
        // APPLY THEME ON LOAD
        window.addEventListener('DOMContentLoaded', () => {
            initPrivacyLock(); // Feature 5: Security first
            setTimeout(() => {
                const isAdmin = auth.currentUser && auth.currentUser.email === 'johnpaulinso123@gmail.com';
                if (!isAdmin) window.currentAccount = 'atome';
                applyTheme(window.currentAccount);
                updateHeaderIcon(window.currentAccount);
            }, 200);
        });

        // DYNAMIC THEME APPLICATOR
        window.applyTheme = (account) => {
            const themes = {
                'atome': {
                    primary: '#121212', 
                    nav: '#121212',     
                    trend: '#121212',   
                    light: '#334155'    
                },
                'bpi': {
                    primary: '#7A1616', 
                    nav: '#7A1616',     
                    trend: '#7A1616',   
                    light: '#931B1B'    
                },
                'default': {
                    primary: '#121212', 
                    nav: '#121212',
                    trend: '#121212',
                    light: '#334155'
                }
            };
            
            const isAdmin = auth.currentUser && auth.currentUser.email === 'johnpaulinso123@gmail.com';
            
            let targetAccount = account;
            if (account === 'bpi' && !isAdmin) targetAccount = 'atome'; 

            const theme = themes[targetAccount] || themes['default'];
            window.currentThemeTrend = theme.trend; 
            
            // 1. Update FAB
            const fab = document.querySelector('.fab');
            if(fab) {
                fab.style.backgroundColor = theme.primary;
                fab.style.transition = 'background-color 0.4s ease'; 
            }
            
            // 2. Update Active Nav Item
            const activeNav = document.querySelector('.nav-item.active');
            if(activeNav) {
                activeNav.style.color = theme.nav;
                activeNav.style.transition = 'color 0.4s ease';
            }

            // 3. Update Trend Chart Line & Text
            const trendPath = document.getElementById('trendPath');
            if(trendPath) {
                trendPath.setAttribute('stroke', theme.trend);
                trendPath.style.transition = 'stroke 0.5s ease';
            }
            
            const trendTotal = document.getElementById('trend-period-total');
            if(trendTotal) {
                trendTotal.style.color = theme.trend;
                trendTotal.style.transition = 'color 0.4s ease';
            }

            // 4. Update SVG Gradient
            const stop1 = document.querySelector('#trendGradient stop[offset="0%"]');
            const stop2 = document.querySelector('#trendGradient stop[offset="100%"]');
            if(stop1) {
                stop1.style.stopColor = theme.trend;
                stop1.setAttribute('stop-color', theme.trend);
                stop1.style.transition = 'stop-color 0.5s ease';
            }
            if(stop2) {
                stop2.style.stopColor = theme.trend;
                stop2.setAttribute('stop-color', theme.trend);
                stop2.style.transition = 'stop-color 0.5s ease';
            }
            
            // 5. Update Logo Toggle Icon (if active)
            const logoIcon = document.getElementById('logo-toggle-icon');
            if(logoIcon && logoIcon.innerText === 'visibility') {
                 logoIcon.style.color = theme.trend;
                 logoIcon.style.transition = 'color 0.4s ease';
            }

            // 6. Update Chart Summary Heading (Optional dramatic effect)
            const summaryAmount = document.getElementById('expenses-total-summary');
            // if(summaryAmount) summaryAmount.style.color = theme.trend;
        };

        // DYNAMIC CARDS LOADER
        function loadSavedCardsToIndex() {
            const scrollContainer = document.getElementById('cardCarouselScroll');
            const placeholder = document.querySelector('.add-card-placeholder');
            const savedAccounts = JSON.parse(localStorage.getItem('wallet_accounts') || '[]');
            
            savedAccounts.forEach(acc => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'balance-card';
                cardDiv.dataset.account = acc.id;
                cardDiv.style.background = acc.color;
                cardDiv.innerHTML = `
                    <div class="card-header-row">
                        <div class="card-label">${acc.name}</div>
                        <div class="card-sync-status-chip">
                            <div class="dot syncDot"></div>
                            <span class="status-text syncStatusText">Ready</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 8px;">
                         <div class="balance-amount">PHP ${acc.balance.toLocaleString(undefined, {minimumFractionDigits:2})}</div>
                         <button onclick="toggleBalanceVisibility(event)" class="visibility-btn" style="background:none; border:none; color:rgba(255,255,255,0.5); cursor:pointer; padding:4px; display:flex; align-items:center;">
                            <i class="material-icons" style="font-size:16px;">visibility</i>
                         </button>
                    </div>
                    
                    <div class="card-footer">
                        <div class="card-number-box">
                            <div class="card-number-label">Account Number</div>
                            <div class="card-number">   ${acc.last4}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <button class="sync-icon-btn scan-btn" onclick="handleScan(400)" title="Sync Account">
                                <i class="material-icons">sync</i>
                            </button>
                            <div class="mastercard-circles">
                                <div class="circle circle-1"></div>
                                <div class="circle circle-2"></div>
                            </div>
                        </div>
                    </div>
                `;
                // Insert before placeholder
                scrollContainer.insertBefore(cardDiv, placeholder);
            });
        }

        function setupAccountSwitcher() {
            loadSavedCardsToIndex();
            const viewport = document.getElementById('cardCarouselScroll');
            const cards = document.querySelectorAll('.balance-card');
            if (!viewport || cards.length === 0) return;

            // DRAG & SWIPE LOGIC (Both Touch + PC Mouse)
            let isDown = false;
            let startX;
            let scrollLeft;
            let hasDragged = false;

            // MOUSE EVENTS (PC Swipe)
            viewport.addEventListener('mousedown', (e) => {
                isDown = true;
                viewport.style.cursor = 'grabbing';
                viewport.style.scrollSnapType = 'none'; // Disable snapping while dragging
                startX = e.pageX - viewport.offsetLeft;
                scrollLeft = viewport.scrollLeft;
                hasDragged = false;
            });

            viewport.addEventListener('mouseleave', () => {
                if (!isDown) return;
                isDown = false;
                viewport.style.cursor = 'grab';
                viewport.style.scrollSnapType = 'x mandatory';
            });

            viewport.addEventListener('mouseup', () => {
                if (!isDown) return;
                isDown = false;
                viewport.style.cursor = 'grab';
                viewport.style.scrollSnapType = 'x mandatory';
            });

            viewport.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - viewport.offsetLeft;
                const walk = (x - startX) * 1.5; // Drag speed
                if (Math.abs(walk) > 5) hasDragged = true;
                viewport.scrollLeft = scrollLeft - walk;
            });

            // TOUCH EVENTS
            viewport.addEventListener('touchstart', (e) => {
                startX = e.touches[0].pageX - viewport.offsetLeft;
                scrollLeft = viewport.scrollLeft;
                isDown = true;
                hasDragged = false;
            }, { passive: true });

            viewport.addEventListener('touchend', () => {
                isDown = false;
            }, { passive: true });

            // SWIPE OBSERVER
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    // Only trigger if truly intersecting
                    if (entry.isIntersecting) {
                        const account = entry.target.dataset.account;
                        
                        // Update UI Scale/Shadow
                        cards.forEach(c => c.classList.remove('active'));
                        entry.target.classList.add('active');

                        if (window.currentAccount !== account) {
                            window.currentAccount = account;
                            localStorage.setItem('wallet_current_account', account);
                            
                            // Apply Dynamic Theme
                            applyTheme(account);

                            // Reset Pagination
                            window.historyLimit = 6;
                            
                            // CLEAR CHART DATA TO FIX PERSISTENCE BUGS
                            window.allTxns = []; 
                            const pieSvg = document.getElementById('pie-chart-svg');
                            const trendSvg = document.getElementById('trend-chart-svg');
                            if (pieSvg) pieSvg.innerHTML = '';
                            if (trendSvg) trendSvg.innerHTML = '';
                            
                            // Clear chart center labels
                            const chartTotalLabel = document.getElementById('chart-total-label');
                            const chartTotalVal = document.getElementById('chart-total-val');
                            if (chartTotalLabel) chartTotalLabel.innerText = 'TOTAL';
                            if (chartTotalVal) chartTotalVal.innerText = '0.00';
                            
                            // Clear legend
                            const legend = document.getElementById('chart-legend');
                            if (legend) legend.innerHTML = '';
                            
                            log(`Active: ${account.toUpperCase()}`);
                            
                            // Reset UI for new account
                            window.allTxns = [];
                            renderHistory([]);
                            
                            updateHeaderIcon(account); // Update sticky header icon

                            loadData(); 
                        }
                    }
                });
            }, { 
                threshold: 0.7, // Lower threshold for better sensitivity without skipping
                root: viewport
            });

            cards.forEach(card => observer.observe(card));
            
            // Initial Scroll to saved account
            const savedCard = document.querySelector(`.balance-card[data-account="${window.currentAccount}"]`);
            if (savedCard) {
                setTimeout(() => {
                    savedCard.scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'center' });
                    updateHeaderIcon(window.currentAccount);
                    applyTheme(window.currentAccount); // Ensure theme matches initial card
                }, 200);
            }
        }
        
        function updateHeaderIcon(account) {
            const cardBg = document.getElementById('card-bg');
            if (cardBg) {
                const isAdmin = auth.currentUser && auth.currentUser.email === 'johnpaulinso123@gmail.com';
                if (account === 'bpi' && isAdmin) {
                    cardBg.setAttribute('fill', '#8b0000'); // BPI red
                } else {
                    cardBg.setAttribute('fill', '#1a1a1a'); // Atome black (Default)
                }
            }
        }

        // FETCH TRANSACTIONS FROM FIRESTORE (REAL-TIME LISTENER)
        window.unsubscribeSnapshot = null; // Store listener to detach later

        async function loadData() {
            window.historyLimit = 6; 
            const container = document.getElementById('history-container');
            const spinner = document.getElementById('loading-spinner');
            
            // HARD REFRESH LOGIC: If this is a page reload, clear cache to force fresh fetch
            try {
                const nav = performance.getEntriesByType("navigation")[0];
                if (nav && nav.type === 'reload') {
                    // Only clear the current account's cache to be efficient, or all if preferred.
                    // Let's clear current account cache to fix perceived sync issues
                    const uid = auth.currentUser?.uid;
                    if (uid) {
                        log('Hard Reload Detected. Busting Cache...', 'warn');
                        localStorage.removeItem(`wallet_cache_${uid}_${window.currentAccount}`);
                        // Also clear deep/quick sync timestamps to force a scan if needed
                        localStorage.removeItem(`last_deep_sync_${window.currentAccount}`);
                        localStorage.removeItem(`last_quick_sync_${window.currentAccount}`);
                    }
                }
            } catch(e) { console.warn('Nav timing not supported'); }
            
            // If already listening, don't re-attach unless we are forcing a reset (handling logic elsewhere)
            if (window.unsubscribeSnapshot) {
                window.unsubscribeSnapshot();
                window.unsubscribeSnapshot = null;
            }

            // SNAPSHOT LOCK: Prevent stale snapshot data from overwriting new account data
            const currentSyncId = Date.now() + Math.random();
            window.activeSyncId = currentSyncId;

            const uid = auth.currentUser?.uid;
            if (!uid) return;

            // INSTANT CACHE LOAD for seamless switching
            const cacheKey = `wallet_cache_${uid}_${window.currentAccount}`;
            const cachedData = localStorage.getItem(cacheKey);
            if (cachedData) {
                try {
                    const cache = JSON.parse(cachedData);
                    const now = Date.now();
                    // 24 hour expiry (86400000 ms)
                    if (cache.txns && (now - cache.timestamp < 86400000)) {
                        window.allTxns = cache.txns;
                        renderHistory(cache.txns);
                        updateBalanceToThisMonth(cache.txns);
                        
                        // Robust Chart Initialization with slight delay to ensure DOM readiness
                        setTimeout(() => {
                            const filterEl = document.getElementById('chart-filter');
                            if (filterEl) {
                                filterEl.value = 'this_month';
                                filterChart();
                            }
                        }, 100);
                        
                        spinner.style.display = 'none'; 
                    }
                } catch(e) { console.warn("Cache error", e); }
            }

            spinner.style.display = 'block';
            try {
                const isAnon = auth.currentUser.isAnonymous;
                
                const syncStatusText = document.getElementById('syncStatusText');
                if (syncStatusText) syncStatusText.innerText = isAnon ? 'Local Storage Only' : 'Cloud Live Sync';
                
                // MULTI-ACCOUNT COLLECTION SELECTION
                const collectionName = getCollectionName(window.currentAccount);
                let q = query(collection(db, "users", uid, collectionName), orderBy("date", "desc"));
                
                // DATA ISOLATION: Query ONLY the current account's path.
                // Replaced getDocs with onSnapshot
                const syncAccount = window.currentAccount; // Capture for closure check
                window.unsubscribeSnapshot = onSnapshot(q, (snap) => {
                    // STALE CHECK: If user switched accounts while this listener was active
                if (window.activeSyncId !== currentSyncId || syncAccount !== window.currentAccount) {
                        return;
                    }
                    let txns = [];

                    // 1. QUICK COMPARISON (Check if first 5 IDs match and length matches)
                    const prevTxns = window.allTxns || [];
                    const snapCount = snap.docs.length;
                    
                    snap.docs.forEach(d => {
                        const data = d.data();
                        if (data.deleted) return; 
                        txns.push({ id: d.id, ...data });
                    });

                    // Sort locally
                    txns.sort((a, b) => {
                        const dateA = new Date(a.date).getTime();
                        const dateB = new Date(b.date).getTime();
                        if (dateB !== dateA) return dateB - dateA;
                        const createA = a.createdAt ? (a.createdAt.toMillis ? a.createdAt.toMillis() : new Date(a.createdAt).getTime()) : 0;
                        const createB = b.createdAt ? (b.createdAt.toMillis ? b.createdAt.toMillis() : new Date(b.createdAt).getTime()) : 0;
                        return createB - createA;
                    });

                    const isSame = prevTxns.length === txns.length && 
                                   txns.every((t, i) => 
                                       prevTxns[i] && 
                                       prevTxns[i].id === t.id && 
                                       prevTxns[i].note === t.note && 
                                       prevTxns[i].manualCategory === t.manualCategory &&
                                       prevTxns[i].manualAmount === t.manualAmount &&
                                       prevTxns[i].excluded === t.excluded &&
                                       prevTxns[i].refund === t.refund
                                   );

                    if (isSame && document.getElementById('history-container').children.length > 0) {
                        log(`Snapshot matches cache for ${syncAccount}. Render skipped.`);
                        
                        // Ensure chart is still rendered if it's currently empty
                        const filterEl = document.getElementById('chart-filter');
                        const chartVal = document.getElementById('chart-total-val');
                        if (filterEl && (filterEl.value !== 'this_month' || (chartVal && chartVal.innerText === '0'))) {
                           filterEl.value = 'this_month';
                           filterChart();
                        }

                        spinner.style.display = 'none';
                        return;
                    }

                    const batchUpdates = []; 
                    // No need to re-loop or re-sort if we already did it above or can reuse it
                    
                    // Store globally & Cache with timestamp
                    window.allTxns = txns;
                    const currentAccCacheKey = `wallet_cache_${uid}_${syncAccount}`;
                    localStorage.setItem(currentAccCacheKey, JSON.stringify({
                        txns: txns,
                        timestamp: Date.now()
                    }));
                    
                    updateBalanceToThisMonth(txns, syncAccount); 

                    if (txns.length === 0) {
                        // EMPTY STATE
                        document.getElementById('expenses-total-summary').innerText = 'PHP 0.00';
                        document.getElementById('trend-period-total').innerText = 'PHP 0.00';
                        document.getElementById('chart-total-val').innerText = '0';
                        const balanceEl = document.querySelector(`.balance-card[data-account="${syncAccount}"] .balance-amount`) || document.getElementById(`${syncAccount}-balance`);
                        if (balanceEl) {
                            balanceEl.innerText = 'PHP 0.00';
                            balanceEl.dataset.raw = 'PHP 0.00';
                            balanceEl.classList.add('privacy-mask');
                            if(localStorage.getItem('balance_hidden') === 'true') balanceEl.innerText = '******';
                        }
                        
                        if (window.drawPieChart) window.drawPieChart([], 0);
                        if (window.drawTrendChart) window.drawTrendChart([]);

                        container.innerHTML = `
                            <div style="text-align:center; padding:60px 20px; color:#64748b; background: white; border-radius: 12px; border: 1px dashed #cbd5e1;">
                                <i class="material-icons" style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;">inbox</i>
                                <p style="margin:0; font-weight: 500;">No transactions found.</p>
                                <p style="font-size: 13px; margin: 10px 0 0;">Click "Scan Gmail" to sync your Atome payments.</p>
                            </div>`;
                    } else {
                        renderHistory(txns);
                        
                        // Apply active category filter
                        if (window.filterTxnList) filterTxnList();

                        // Always default chart filter to 'this_month' on fresh data load/page return
                        const defaultFilter = 'this_month';
                        const filterEl = document.getElementById('chart-filter');
                        if (filterEl) {
                           filterEl.value = defaultFilter;
                           // Use a small delay if coming from fresh load to ensure components are ready
                           setTimeout(() => filterChart(), 50);
                        }
                    }
                }, (error) => {
                    log('Snapshot Error: ' + error.message, 'error');
                });

                // Hide spinner immediately - don't wait for data to load
                spinner.style.display = 'none';

                window.highlightTransactions = (categoryName, categoryColor = null) => {
                    const items = document.querySelectorAll('.premium-txn');
                    const normalizedTarget = categoryName ? categoryName.toLowerCase().trim() : null;
                    
                    items.forEach(item => {
                        item.classList.remove('highlight-txn');
                        item.style.backgroundColor = '';
                        item.style.borderLeft = '';
                        item.style.boxShadow = '';
                        
                        if (!normalizedTarget) return;

                        // Only highlight if the item is actually visible (not hidden by month filter or search)
                        const isVisible = item.offsetParent !== null; 
                        if (!isVisible) return;

                        const catElement = item.querySelector('.txn-sub span:last-child');
                        if (catElement) {
                            const itemCat = catElement.innerText.toLowerCase().trim();
                            if (itemCat === normalizedTarget) {
                                item.classList.add('highlight-txn');
                                if (categoryColor) {
                                    item.style.backgroundColor = categoryColor + '10'; // 10 is ~6% opacity hex
                                    item.style.borderLeft = `4px solid ${categoryColor}`;
                                    item.style.boxShadow = `inset 4px 0 0 ${categoryColor}`;
                                }
                            }
                        }
                    });
                };
            } catch (e) { 
                log('Failed to load history: ' + e.message, 'error');
                spinner.style.display = 'none';
            }
        }
        window.loadData = loadData;

        // BACKGROUND CACHE HYDRATION (Warm up all accounts)
        window.hydrateAllCaches = async () => {
            const uid = auth.currentUser?.uid;
            if (!uid) return;
            
            const savedAccounts = JSON.parse(localStorage.getItem('wallet_accounts') || '[]');
            const defaultAccounts = ['atome', 'bpi'];
            const allAccountIds = [...new Set([...defaultAccounts, ...savedAccounts.map(a => a.id)])];
            
            log(`Warming up cache for ${allAccountIds.length} accounts...`);
            
            for (const accId of allAccountIds) {
                if (accId === window.currentAccount) continue; // Current already handled
                
                try {
                    const collectionName = accId === 'atome' ? "transactions" : (accId === 'bpi' ? "bpi_transactions" : `txns_${accId}`);
                    // Use getDocs for one-time fetch to avoid many active listeners
                    const q = query(collection(db, "users", uid, collectionName), orderBy("date", "desc"), limit(100));
                    const snap = await getDocs(q);
                    
                    const txns = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(t => !t.deleted);
                    const cacheKey = `wallet_cache_${uid}_${accId}`;
                    localStorage.setItem(cacheKey, JSON.stringify({
                        txns: txns,
                        timestamp: Date.now()
                    }));
                } catch (e) { console.warn(`Silent hydrate failed for ${accId}`, e); }
            }
        };

        window.atomeBalanceVal = 0;
        window.bpiBalanceVal = 0;

        function updateBPIInsight() {
            const insightEl = document.getElementById('bpi-remaining-insight');
            if (!insightEl) return;

            // Try to pull from global state first, then fallback to DOM if global is 0
            let bpi = window.bpiBalanceVal;
            let atome = window.atomeBalanceVal;

            if (bpi === 0) {
                const bpiEl = document.getElementById('bpi-balance');
                if (bpiEl) bpi = parseFloat(bpiEl.innerText.replace(/[^\d.-]/g, '')) || 0;
            }
            if (atome === 0) {
                const atomeEl = document.getElementById('atome-balance');
                if (atomeEl) atome = parseFloat(atomeEl.innerText.replace(/[^\d.-]/g, '')) || 0;
            }

            if (bpi === 0 && atome === 0) return;

            const remaining = bpi + atome;
            const atomeLabel = (atome < 0 ? '-' : '+') + '' + Math.abs(atome).toLocaleString(undefined, {minimumFractionDigits:2});
            
            const rawHTML = `${remaining.toLocaleString(undefined, {minimumFractionDigits:2})} <span style="opacity: 0.6; font-weight: 600;">(${atomeLabel})</span>`;
            
            insightEl.dataset.raw = rawHTML;
            insightEl.classList.add('privacy-mask');
            
            if (localStorage.getItem('balance_hidden') === 'true') {
                insightEl.innerText = '******';
            } else {
                insightEl.innerHTML = rawHTML;
            }
            insightEl.style.opacity = '1';
        }

        window.toggleBalanceVisibility = (e) => {
             if(e) e.stopPropagation();
             const isHidden = localStorage.getItem('balance_hidden') === 'true';
             const newState = !isHidden;
             localStorage.setItem('balance_hidden', newState);
             
             console.log(' Privacy Toggle:', newState ? 'HIDING' : 'SHOWING');
             
             // Update all visibility buttons (eye icons)
             const buttons = document.querySelectorAll('.visibility-btn i');
             buttons.forEach(btn => {
                 btn.innerText = newState ? 'visibility_off' : 'visibility';
             });
             
             // Update ALL masked elements
             const maskedElements = document.querySelectorAll('.privacy-mask');
             console.log(' Found', maskedElements.length, 'privacy-mask elements');
             
             maskedElements.forEach((el, index) => {
                 const raw = el.dataset.raw || el.innerText;
                 if(!el.dataset.raw) el.dataset.raw = raw; // Init if missing
                 
                 console.log(`  [${index}] ${el.className}:`, raw, '', newState ? '******' : raw);
                 
                 // Apply mask or show raw
                 if(newState) {
                     el.innerText = '******';
                 } else {
                     el.innerText = raw;
                 }
             });
             
             // Update BPI insight if exists (Special case handling inside function)
             updateBPIInsight();
        };

        // SAFETY: Initialize visibility on load
        window.addEventListener('DOMContentLoaded', () => {
             const isHidden = localStorage.getItem('balance_hidden') === 'true';
             if(isHidden) {
                 setTimeout(() => {
                    const buttons = document.querySelectorAll('.visibility-btn i');
                    buttons.forEach(btn => btn.innerText = 'visibility_off');
                    
                    // Force mask on all elements that might have rendered early
                    const maskedElements = document.querySelectorAll('.privacy-mask');
                    maskedElements.forEach(el => {
                        if(!el.dataset.raw) el.dataset.raw = el.innerText;
                        el.innerText = '******';
                    });
                 }, 50);
             }
        });

        function updateBalanceToThisMonth(txns, targetAccount) {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            let incomeTotal = 0;
            let expenseTotal = 0;

            txns.forEach(t => {
                if (t.excluded || t.refund) return;
                const d = new Date(t.date);
                if (d.getFullYear() !== year || d.getMonth() !== month) return;

                const mapped = getMerchantDisplay(t.merchant, t);
                const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                
                if (mapped.category === 'Income') {
                    incomeTotal += amt;
                } else {
                    expenseTotal += amt;
                }
            });

            // Target the specific card's balance element
            const acc = targetAccount || window.currentAccount;
            const balanceEl = document.querySelector(`.balance-card[data-account="${acc}"] .balance-amount`) || document.getElementById(`${acc}-balance`);
            if (balanceEl) {
                const balance = incomeTotal - expenseTotal;
                const formatted = `PHP ${balance.toLocaleString(undefined, {minimumFractionDigits:2})}`;
                
                // Store raw for toggle
                balanceEl.dataset.raw = formatted;
                
                // Add privacy class
                balanceEl.classList.add('privacy-mask');
                
                // Apply visibility state
                const isHidden = localStorage.getItem('balance_hidden') === 'true';
                balanceEl.innerText = isHidden ? '******' : formatted;
                
                // Store globally and update insight
                if (acc === 'atome') window.atomeBalanceVal = balance;
                if (acc === 'bpi') window.bpiBalanceVal = balance;
                updateBPIInsight();
            }
        }

        window.toggleAdminMode = () => {
            const user = auth.currentUser;
            const adminEmail = 'johnpaulinso123@gmail.com';
            if (user && user.email && user.email.toLowerCase().trim() === adminEmail) {
                const adminDiv = document.getElementById('admin-controls');
                const logDiv = document.getElementById('log-container');
                if (!adminDiv || !logDiv) return showToast('Admin elements missing');
                const isHidden = adminDiv.style.display === 'none';
                adminDiv.style.display = isHidden ? 'block' : 'none';
                logDiv.style.display = isHidden ? 'block' : 'none';
                showToast(isHidden ? 'Admin View On' : 'Admin View Off');
            } else {
                showToast('Action restricted');
            }
        };

        window.exportData = () => {
            if (!window.allTxns || window.allTxns.length === 0) {
                showToast('No data to export');
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            
            // 1. JSON Export
            const dataStr = JSON.stringify(window.allTxns, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const jsonName = `wallet_backup_${today}.json`;
            const jsonLink = document.createElement('a');
            jsonLink.setAttribute('href', dataUri);
            jsonLink.setAttribute('download', jsonName);
            jsonLink.click();

            // 2. CSV Export
            setTimeout(() => {
                const headers = ['Date', 'Merchant', 'Amount', 'Category', 'Note', 'Excluded', 'Refund'];
                const csvRows = [headers.join(',')];
                
                window.allTxns.forEach(t => {
                    const mapped = getMerchantDisplay(t.merchant, t);
                    const row = [
                        new Date(t.date).toLocaleDateString(),
                        `"${(mapped.name || '').replace(/"/g, '""')}"`,
                        t.amount || (t.manualAmount || 0),
                        `"${(mapped.category || '').replace(/"/g, '""')}"`,
                        `"${(t.note || '').replace(/"/g, '""')}"`,
                        t.excluded ? 'Yes' : 'No',
                        t.refund ? 'Yes' : 'No'
                    ];
                    csvRows.push(row.join(','));
                });

                const csvStr = csvRows.join('\n');
                const csvUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvStr);
                const csvName = `wallet_export_${today}.csv`;
                const csvLink = document.createElement('a');
                csvLink.setAttribute('href', csvUri);
                csvLink.setAttribute('download', csvName);
                csvLink.click();
            }, 300);

            showToast('JSON + CSV Export Created');
        };

        window.importData = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedTxns = JSON.parse(e.target.result);
                    if (!Array.isArray(importedTxns)) throw new Error('Invalid format');
                    const confirmed = await showAppDialog({
                        title: 'Import Data',
                        message: `Import ${importedTxns.length} transactions? These will be merged with your current history.`,
                        confirm: true
                    });
                    if (!confirmed) return;
                    showToast('Importing...');
                    const uid = auth.currentUser.uid;
                    const txnsCol = collection(db, `users/${uid}/transactions`);
                    for (const t of importedTxns) {
                        const { id, ...cleanT } = t;
                        if (id) {
                            await setDoc(doc(db, `users/${uid}/transactions`, id), cleanT, { merge: true });
                        } else {
                            await addDoc(txnsCol, { ...cleanT, createdAt: serverTimestamp() });
                        }
                    }
                    showToast('Import Complete');
                    event.target.value = '';
                } catch (err) {
                    showToast('Import failed: ' + err.message);
                }
            };
            reader.readAsText(file);
        };

        // HARD REFRESH FUNCTION
        window.hardRefresh = () => {
             if(!confirm('This will clear local cache and reload the app to fix sync issues. Continue?')) return;
             
             // Clear Data Caches
             const keys = Object.keys(localStorage);
             for(let k of keys) {
                 if(k.startsWith('wallet_cache_') || k.startsWith('last_deep_sync_') || k.startsWith('last_quick_sync_')) {
                     localStorage.removeItem(k);
                 }
             }
             
             // Unregister Service Workers (Force Update)
             if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                    }
                });
             }
             
             // Force Reload
             window.location.reload();
        };

        // FILTERING LOGIC
        window.filterChart = () => {
            const filterEl = document.getElementById('chart-filter');
            const filter = filterEl.value;

            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const date = now.getDate();
            
            if (!window.allTxns) return;

            // Helper for week numbers
            const getWeek = (d) => {
                const onejan = new Date(d.getFullYear(), 0, 1);
                return Math.ceil((((d - onejan) / 86400000) + onejan.getDay() + 1) / 7);
            };

            const checkPeriod = (t, periodType, shift = 0) => {
                const d = new Date(t.date);
                const dYear = d.getFullYear();
                const dMonth = d.getMonth();
                const dDate = d.getDate();
                const dWeek = getWeek(d);
                const currentWeek = getWeek(now);

                if (periodType === 'today') {
                    // Current: Today (shift 0), Past: Yesterday (shift 1)
                    const target = new Date(now);
                    target.setDate(date - shift);
                    return dYear === target.getFullYear() && dMonth === target.getMonth() && dDate === target.getDate();
                }

                if (periodType === 'this_month') {
                    // Current (0): This Month, Past (1): Last Month
                    const targetMonth = (month - shift + 12) % 12;
                    const targetYear = year - Math.floor((12 - (month - shift) - 1) / 12); // Handle year wrap roughly, or simplified:
                    // Better:
                    const targetD = new Date(year, month - shift, 1);
                    return dMonth === targetD.getMonth() && dYear === targetD.getFullYear();
                }
                
                if (periodType === 'this_week') {
                     // Current (0): This week, Past (1): Last week
                     // Note: Simple logic assuming same year for simplicity or handling close year boundaries
                     if (shift === 0) return dWeek === currentWeek && dYear === year;
                     if (shift === 1) return dWeek === currentWeek - 1 && dYear === year;
                }
                
                if (periodType === 'last_week') {
                     // Current (0): Last week, Past (1): 2 weeks ago
                     if (shift === 0) return dWeek === currentWeek - 1 && dYear === year;
                     if (shift === 1) return dWeek === currentWeek - 2 && dYear === year;
                }

                if (periodType === 'first_15') {
                    // Current (0): <= 15th of THIS month
                    // Past (1): > 15th of PREVIOUS month
                    if (shift === 0) return dDate <= 15 && dMonth === month && dYear === year;
                    if (shift === 1) {
                        const prevMonthDate = new Date(year, month - 1, 1);
                        return dDate > 15 && dMonth === prevMonthDate.getMonth() && dYear === prevMonthDate.getFullYear();
                    }
                }
                
                if (periodType === 'last_15') {
                    // Current (0): > 15th of THIS month
                    // Past (1): <= 15th of THIS month
                    if (shift === 0) return dDate > 15 && dMonth === month && dYear === year;
                    if (shift === 1) return dDate <= 15 && dMonth === month && dYear === year;
                }
                
                if (periodType === 'last_month') {
                    // Current (0): Last month
                    // Past (1): 2 months ago
                    const targetDate = new Date(year, month - 1 - shift, 1);
                     return dMonth === targetDate.getMonth() && dYear === targetDate.getFullYear();
                }
                
                if (periodType === 'last_3_months') {
                    const limit = new Date(now);
                    limit.setMonth(limit.getMonth() - 3 - (shift * 3));
                    const upper = new Date(now);
                    if (shift > 0) upper.setMonth(upper.getMonth() - 3);
                    
                    return d >= limit && (shift === 0 || d < upper);
                }
                
                if (periodType === 'last_6_months') {
                    const limit = new Date(now);
                    limit.setMonth(limit.getMonth() - 6 - (shift * 6));
                    const upper = new Date(now);
                    if (shift > 0) upper.setMonth(upper.getMonth() - 6);
                    return d >= limit && (shift === 0 || d < upper);
                }
                
                if (periodType === 'this_year') {
                    return dYear === (year - shift);
                }
                
                return false;
            };

            const filtered = window.allTxns.filter(t => checkPeriod(t, filter, 0));
            const past = window.allTxns.filter(t => checkPeriod(t, filter, 1));
            
            const pastTotal = past.reduce((sum, t) => {
                 if (t.excluded || t.refund) return sum;
                 const mapped = getMerchantDisplay(t.merchant, t);
                 if (mapped.category === 'Income') return sum;
                 return sum + (t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0));
            }, 0);

            refreshChart(filtered, pastTotal);
        };

        // CHART LOGIC
        const categoryConfig = {
            'Online shopping': { color: '#f97316', darkColor: '#ea580c', class: 'cat-online' },
            'Vehicle': { color: '#8b5cf6', darkColor: '#7c3aed', class: 'cat-vehicle' },
            'Shopping': { color: '#3b82f6', darkColor: '#2563eb', class: 'cat-shopping' },
            'Service': { color: '#d946ef', darkColor: '#c026d3', class: 'cat-service-magenta' },
            'Food & Drinks': { color: '#eab308', darkColor: '#ca8a04', class: 'cat-food' },
            'Life & Entertainment': { color: '#10b981', darkColor: '#059669', class: 'cat-life' },
            'Trading Expenses': { color: '#ef4444', darkColor: '#dc2626', class: 'cat-trading' },
            'Trade Copier': { color: '#0891b2', darkColor: '#0e7490', class: 'cat-aqua' },
            'Financial Expenses': { color: '#ef4444', darkColor: '#dc2626', class: 'cat-financial' },
            'Credit Card Payment': { color: '#f59e0b', darkColor: '#d97706', class: 'cat-credit-card' },
            'Transportation': { color: '#8b5cf6', darkColor: '#7c3aed', class: 'cat-vehicle' },
            'Travel': { color: '#06b6d4', darkColor: '#0891b2', class: 'cat-aqua' },
            'Education': { color: '#1e40af', darkColor: '#1e3a8a', class: 'cat-shopping' }, /* Dark Blue */
            'Sport': { color: '#10b981', darkColor: '#059669', class: 'cat-life' },
            'Income': { color: '#16a34a', darkColor: '#15803d', class: 'cat-income' } /* Green */
        };

        function refreshChart(txns, pastTotal = 0) {
            const chartSection = document.getElementById('chart-section');
            const totals = {};
            let grandTotal = 0;

            let incomeTotal = 0;
            let expenseTotal = 0;

            txns.forEach(t => {
                if (t.excluded || t.refund) return;
                const mapped = getMerchantDisplay(t.merchant, t);
                const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                let cat = mapped.category || 'Other';
                if (cat === 'Financial expenses') cat = 'Financial Expenses';
                if (cat === 'Trading expenses') cat = 'Trading Expenses';
                
                if (cat === 'Income') {
                    incomeTotal += amt;
                } else {
                    totals[cat] = (totals[cat] || 0) + amt;
                    expenseTotal += amt;
                }
            });
            
            grandTotal = expenseTotal; // Chart shows Expenses only

            // Balance update removed from chart filter to stay as 'This Month'
            
            // Always show progress even if zero
            chartSection.style.display = 'block';

            const segments = Object.entries(totals).map(([name, value]) => ({
                name,
                value,
                color: (categoryConfig[name] || categoryConfig['Other']).color,
                class: (categoryConfig[name] || categoryConfig['Other']).class
            })).sort((a, b) => b.value - a.value);

            // Update Summary Total
            const summaryTotalEl = document.getElementById('expenses-total-summary');
            if (summaryTotalEl) {
                const formatted = `PHP ${grandTotal.toLocaleString(undefined, {minimumFractionDigits:2})}`;
                summaryTotalEl.dataset.raw = formatted;
                summaryTotalEl.classList.add('privacy-mask');
                summaryTotalEl.innerText = localStorage.getItem('balance_hidden') === 'true' ? '******' : formatted;
            }

            // Update Growth with passed pastTotal
            const growthEl = document.getElementById('mom-growth');
            const growthBox = document.getElementById('mom-growth-box');
            if (growthEl && growthBox) {
                if (pastTotal > 0) {
                    const diff = ((grandTotal - pastTotal) / pastTotal) * 100;
                    const diffAbs = Math.abs(Math.round(diff));
                    growthEl.innerText = `${diff >= 0 ? '+' : '-'}${diffAbs}%`;
                    growthBox.style.color = diff >= 0 ? '#ef4444' : '#10b981';
                } else {
                    growthEl.innerText = '+0%';
                    growthBox.style.color = '#94a3b8';
                }
            }
            
            drawPieChart(segments, grandTotal);
        }


        function drawTrendChart(txns) {
            const path = document.getElementById('trendPath');
            const area = document.getElementById('trendArea');
            const dots = document.getElementById('trendDots');
            const totalEl = document.getElementById('trend-period-total');
            const filterEl = document.getElementById('trend-filter'); // Correct ID for trend filter
            const filter = filterEl ? filterEl.value : 'this_month';
            
            if (!path || txns.length === 0) return;

            // Reset labels
            const labelsContainer = document.getElementById('trend-labels');
            if (labelsContainer) labelsContainer.innerHTML = '';

            const now = new Date();
            let periodTotal = 0;
            let dataPoints = [];
            let labels = [];

            if (filter === 'this_week') {
                // Group by Day (Sun-Sat) as requested
                dataPoints = [0,0,0,0,0,0,0];
                labels = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
                
                // Calculate Start of Week (Sunday)
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay()); // Go back to Sunday
                startOfWeek.setHours(0,0,0,0);

                txns.forEach(t => {
                    const d = new Date(t.date);
                    // Check exclusion, refund, and Income
                    const mappedTrn = getMerchantDisplay(t.merchant, t);
                    if (t.excluded || t.refund || d < startOfWeek || mappedTrn.category === 'Income') return; 

                    const diff = Math.floor((d - startOfWeek) / 86400000);
                    if (diff >= 0 && diff < 7) {
                        const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                        dataPoints[diff] += amt;
                        periodTotal += amt;
                    }
                });
            } else if (filter === 'last_6_months') {
                // Monthly View (6 Data Points)
                const monthsCount = 6;
                dataPoints = new Array(monthsCount).fill(0);
                
                // Generate labels (e.g. Jan, Feb)
                for (let i = monthsCount - 1; i >= 0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    labels.push(d.toLocaleString('default', { month: 'short' }));
                }

                const limitDate = new Date(now.getFullYear(), now.getMonth() - 5, 1); // Start of 6th month back

                txns.forEach(t => {
                    const d = new Date(t.date);
                    // Check exclusion, refund, and Income
                    const mappedTrn = getMerchantDisplay(t.merchant, t);
                    if (t.excluded || t.refund || d < limitDate || mappedTrn.category === 'Income') return;

                    // Calculate month difference
                    const monthDiff = (now.getFullYear() - d.getFullYear()) * 12 + (now.getMonth() - d.getMonth());
                    const idx = (monthsCount - 1) - monthDiff;
                    
                    if (idx >= 0 && idx < monthsCount) {
                        const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                        dataPoints[idx] += amt;
                        periodTotal += amt;
                    }
                });

            } else {
                // Default: Weekly Buckets (This Month: 4-5 weeks, 3M: 12 weeks)
                let weeksCount = 4;
                if (filter === 'last_3_months') weeksCount = 12;
                else if (filter === 'this_month') {
                    // Dynamic weeks in month
                    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    const used = firstDay.getDay() + lastDay.getDate();
                    weeksCount = Math.ceil(used / 7);
                }

                dataPoints = new Array(weeksCount).fill(0);
                
                let limitDate;
                if (filter === 'this_month') {
                     limitDate = new Date(now.getFullYear(), now.getMonth(), 1);
                } else {
                     limitDate = new Date(now);
                     limitDate.setDate(now.getDate() - (weeksCount * 7));
                }

                txns.forEach(t => {
                    const d = new Date(t.date);
                    // Check exclusion, refund, and Income
                    const mappedTrn = getMerchantDisplay(t.merchant, t);
                    if (t.excluded || t.refund || d < limitDate || mappedTrn.category === 'Income') return;
                    
                    let idx;
                    if (filter === 'this_month') {
                        // Week of the month (0-4)
                        const firstDay = new Date(d.getFullYear(), d.getMonth(), 1);
                        const dayOfWeek = firstDay.getDay(); // 0-6
                        const dayOfMonth = d.getDate();
                        const adjustedDate = dayOfMonth + dayOfWeek;
                        idx = Math.ceil(adjustedDate / 7) - 1;
                        if (idx >= weeksCount) idx = weeksCount - 1; // Clamp
                    } else {
                        // Rolling back from Now
                        const diffWeeks = Math.floor((now - d) / (7 * 86400000));
                        idx = (weeksCount - 1) - diffWeeks;
                    }

                    if (idx >= 0 && idx < weeksCount) {
                        const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                        dataPoints[idx] += amt;
                        periodTotal += amt;
                    }
                });

                // Labels
                for(let i=1; i<=weeksCount; i++) {
                    if (filter === 'this_month') {
                         labels.push(`Week ${i}`);
                    } else {
                        if (i % 4 === 1 || i === weeksCount) labels.push(`W${i}`);
                        else labels.push('');
                    }
                }
            }

            // Update Labels UI
            if (labelsContainer) {
                labels.forEach(l => {
                    const span = document.createElement('span');
                    span.className = 'trend-label';
                    // Simplify labels for small screens
                    span.innerText = l;
                    labelsContainer.appendChild(span);
                });
            }

            // Update Total
            // totalEl.style.color = '#000'; // REMOVED HARDCODE
            const periodFormatted = `PHP ${periodTotal.toLocaleString(undefined, {minimumFractionDigits:2})}`;
            totalEl.dataset.raw = periodFormatted;
            totalEl.classList.add('privacy-mask');
            totalEl.innerText = localStorage.getItem('balance_hidden') === 'true' ? '******' : periodFormatted;

            const points = dataPoints;
            const max = Math.max(...points, 500) * 1.2;
            const w = 400;
            const h = 130; 
            const padding = 20; 
            const chartW = w - (padding * 2);
            const step = chartW / (points.length - 1 || 1);

            let d = "";
            let areaD = "";
            dots.innerHTML = '';

            const getPoint = (i) => {
                const x = padding + (i * step);
                const y = h - (points[i] / max) * h;
                return { x, y };
            };

            for (let i = 0; i < points.length; i++) {
                const p = getPoint(i);
                
                if (i === 0) {
                    d += `M ${p.x} ${p.y}`;
                    areaD += `M ${p.x} ${h} L ${p.x} ${p.y}`;
                } else {
                    const prev = getPoint(i - 1);
                    const cp1x = prev.x + (p.x - prev.x) / 2;
                    d += ` C ${cp1x} ${prev.y}, ${cp1x} ${p.y}, ${p.x} ${p.y}`;
                    areaD += ` C ${cp1x} ${prev.y}, ${cp1x} ${p.y}, ${p.x} ${p.y}`;
                }
            }

            const lastP = getPoint(points.length - 1);
            areaD += ` L ${lastP.x} ${h} Z`;
                area.setAttribute('d', areaD);
                path.setAttribute('d', d);
                if (window.currentThemeTrend) {
                    path.setAttribute('stroke', window.currentThemeTrend);
                    totalEl.style.color = window.currentThemeTrend;
                }

                // Add Guide Line
                let guide = document.getElementById('trend-guide');
                if (!guide) {
                    guide = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    guide.id = 'trend-guide';
                    guide.setAttribute('y1', 0);
                    guide.setAttribute('y2', h);
                    guide.setAttribute('stroke', '#cbd5e1');
                    guide.setAttribute('stroke-width', '1');
                    guide.setAttribute('stroke-dasharray', '4 4');
                    guide.style.opacity = '0';
                    guide.style.transition = 'opacity 0.2s';
                    document.getElementById('trendChart').insertBefore(guide, path);
                }

                const trendSvg = document.getElementById('trendChart');
                trendSvg.onmousemove = (e) => {
                    const rect = trendSvg.getBoundingClientRect();
                    const mouseX = e.clientX - rect.left;
                    const viewBoxX = (mouseX / rect.width) * 400;
                    
                    // Find nearest point
                    let nearestIdx = 0;
                    let minDist = Infinity;
                    for (let i = 0; i < points.length; i++) {
                        const p = getPoint(i);
                        const dist = Math.abs(p.x - viewBoxX);
                        if (dist < minDist) {
                            minDist = dist;
                            nearestIdx = i;
                        }
                    }

                    const p = getPoint(nearestIdx);
                    guide.setAttribute('x1', p.x);
                    guide.setAttribute('x2', p.x);
                    guide.style.opacity = '1';

                    const tooltip = document.getElementById('chart-tooltip');
                    tooltip.innerHTML = `<div style="font-weight:800; margin-bottom:2px;">${labels[nearestIdx] || 'Period'}</div><div style="color:#d1fae5; font-size:13px;">${Math.round(points[nearestIdx]).toLocaleString()}</div>`;
                    tooltip.style.opacity = '1';
                    tooltip.style.display = 'block';
                    tooltip.style.left = `${e.pageX + 15}px`;
                    tooltip.style.top = `${e.pageY - 40}px`;
                };

                trendSvg.onmouseleave = () => {
                    guide.style.opacity = '0';
                    document.getElementById('chart-tooltip').style.opacity = '0';
                };
            }

        let selectedCategoryName = null;

        function drawPieChart(segments, total, isUpdate = false) {
            const svgGroup = document.getElementById('pieContent');
            const legend = document.getElementById('chart-legend');
            const totalVal = document.getElementById('chart-total-val');
            const totalLabel = document.getElementById('chart-total-label');
            
            svgGroup.innerHTML = '';
            legend.innerHTML = '';

            const centerX = 120; 
            const centerY = 120;
            const radius = 90; 
            const strokeWidth = 40; 
            const circumference = 2 * Math.PI * radius;
            
            const totalFormatted = total > 0 ? `${Math.round(total).toLocaleString()}` : "0";

            // State-based Label Logic
            if (totalLabel && totalVal) {
                if (!selectedCategoryName) {
                    totalLabel.innerText = 'TOTAL';
                    totalVal.innerText = localStorage.getItem('balance_hidden') === 'true' ? '******' : totalFormatted;
                    totalVal.dataset.raw = totalFormatted;
                } else {
                    const seg = segments.find(s => s.name === selectedCategoryName);
                    if (seg) {
                        totalLabel.innerText = seg.name;
                        const valText = `${Math.round(seg.value).toLocaleString()}`;
                        totalVal.dataset.raw = valText;
                        totalVal.innerText = localStorage.getItem('balance_hidden') === 'true' ? '******' : valText;
                    } else {
                        // Reset if category not found in current data
                        selectedCategoryName = null;
                        totalLabel.innerText = 'TOTAL';
                        totalVal.innerText = localStorage.getItem('balance_hidden') === 'true' ? '******' : totalFormatted;
                        totalVal.dataset.raw = totalFormatted;
                    }
                }
            }

            // 1. Reset Layer (Background)
            const bgLayer = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            bgLayer.setAttribute('cx', centerX);
            bgLayer.setAttribute('cy', centerY);
            bgLayer.setAttribute('r', 120);
            bgLayer.setAttribute('fill', 'transparent');
            bgLayer.style.cursor = 'default';
            bgLayer.onclick = () => resetSelection();
            svgGroup.appendChild(bgLayer);

            // 2. Track Ring
            const track = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            track.setAttribute('cx', centerX);
            track.setAttribute('cy', centerY);
            track.setAttribute('r', radius);
            track.setAttribute('fill', 'none');
            track.setAttribute('stroke', '#f1f5f9');
            track.setAttribute('stroke-width', strokeWidth);
            svgGroup.appendChild(track);

            // 3. Center Button (Reset)
            const centerBtn = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            centerBtn.setAttribute('cx', centerX);
            centerBtn.setAttribute('cy', centerY);
            centerBtn.setAttribute('r', radius - strokeWidth/2);
            centerBtn.setAttribute('fill', 'transparent');
            centerBtn.style.cursor = 'pointer';
            centerBtn.onclick = (e) => {
                e.stopPropagation();
                resetSelection();
            };
            svgGroup.appendChild(centerBtn);
            
            if (segments.length === 0 || total === 0) {
                legend.innerHTML = '<div style="font-size:12px; color:#94a3b8; font-weight:600; grid-column: span 2; text-align:center;">No data for this period</div>';
                return;
            }

            let currentAngle = -90;

            function resetSelection() {
                selectedCategoryName = null;
                drawPieChart(segments, total, true); 
                window.highlightTransactions(null);
            }

            segments.forEach((seg, index) => {
                const percent = seg.value / total;
                const arcLength = percent * circumference;
                const isSelected = selectedCategoryName === seg.name;
                const dimOpacity = selectedCategoryName && !isSelected ? 0.2 : 1;
                
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', centerX);
                circle.setAttribute('cy', centerY);
                circle.setAttribute('r', radius);
                circle.setAttribute('fill', 'none');
                circle.setAttribute('stroke', seg.color);
                circle.setAttribute('stroke-width', isSelected ? strokeWidth + 6 : strokeWidth);
                
                // Opening Animation Logic
                if (!isUpdate) {
                    circle.setAttribute('stroke-dasharray', `0 ${circumference}`);
                    setTimeout(() => {
                        circle.setAttribute('stroke-dasharray', `${arcLength} ${circumference}`);
                    }, 100 + (index * 40));
                } else {
                    circle.setAttribute('stroke-dasharray', `${arcLength} ${circumference}`);
                }
                
                circle.setAttribute('transform', `rotate(${currentAngle} ${centerX} ${centerY})`);
                circle.style.opacity = dimOpacity;
                circle.style.transition = 'all 0.4s cubic-bezier(0.16, 1, 0.3, 1)';
                circle.style.cursor = 'pointer';
                
                const handleInteraction = (e) => {
                    if(e) e.stopPropagation();
                    selectedCategoryName = (selectedCategoryName === seg.name) ? null : seg.name;
                    drawPieChart(segments, total, true);
                    window.highlightTransactions(selectedCategoryName, seg.color);
                };

                circle.onclick = handleInteraction;

                // Tooltip
                circle.onmouseenter = (e) => {
                    const tooltip = document.getElementById('chart-tooltip');
                    tooltip.innerHTML = `<div style="font-weight:800; margin-bottom:2px;">${seg.name}</div><div style="color:#d1fae5; font-size:13px;">${Math.round(seg.value).toLocaleString()} (${(percent*100).toFixed(1)}%)</div>`;
                    tooltip.style.opacity = '1';
                    tooltip.style.left = `${e.pageX + 15}px`;
                    tooltip.style.top = `${e.pageY - 40}px`;
                    circle.style.filter = 'brightness(1.1)';
                };
                circle.onmouseleave = () => {
                    document.getElementById('chart-tooltip').style.opacity = '0';
                    circle.style.filter = 'none';
                };

                svgGroup.appendChild(circle);
                currentAngle += (percent * 360);
                
                // Legend
                const lItem = document.createElement('div');
                lItem.className = `legend-item ${isSelected ? 'active' : ''}`;
                lItem.style.opacity = dimOpacity;
                lItem.style.transition = 'all 0.3s';
                lItem.style.cursor = 'pointer';
                lItem.innerHTML = `<div class="legend-color" style="background: ${seg.color}"></div><span>${seg.name}</span>`;
                lItem.onclick = handleInteraction;
                legend.appendChild(lItem);
            });
        }
        function drawPieChart_OLD_Implementation(segments, total) {
            const container = document.getElementById('chart-anim-container');
            const svgGroup = document.getElementById('pieContent');
            const legend = document.getElementById('chart-legend');
            const totalVal = document.getElementById('chart-total-val');
            
            svgGroup.innerHTML = '';
            legend.innerHTML = '';
            totalVal.innerText = total > 0 ? `${Math.round(total).toLocaleString()}` : "0";

            const centerX = 120; // Centered for the 240 viewBox
            const centerY = 120;
            const radius = 110; 
            const innerRadius = 70;
            let currentAngle = -90;
            
            // Handle Empty State (0 segments)
            if (segments.length === 0 || total === 0) {
                // Clear any previous chart first
                svgGroup.innerHTML = '';
                
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', centerX);
                circle.setAttribute('cy', centerY);
                circle.setAttribute('r', radius);
                circle.setAttribute('fill', '#f1f5f9');
                svgGroup.appendChild(circle);
                
                legend.innerHTML = '<div style="font-size:12px; color:#94a3b8; font-weight:600; grid-column: span 2; text-align:center;">No data for this period</div>';
                return;
            }
            if (segments.length === 1) {
                const seg = segments[0];
                
                // Draw full donut
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                // Calculate d for full circle donut
                const d = [
                    `M ${centerX} ${centerY - radius}`,
                    `A ${radius} ${radius} 0 1 1 ${centerX} ${centerY + radius}`,
                    `A ${radius} ${radius} 0 1 1 ${centerX} ${centerY - radius}`,
                    `M ${centerX} ${centerY - innerRadius}`,
                    `A ${innerRadius} ${innerRadius} 0 1 0 ${centerX} ${centerY + innerRadius}`,
                    `A ${innerRadius} ${innerRadius} 0 1 0 ${centerX} ${centerY - innerRadius}`,
                    'Z'
                ].join(' ');

                path.setAttribute('d', d);
                path.setAttribute('fill', seg.color);
                path.setAttribute('fill-rule', 'evenodd');
                path.classList.add('chart-segment'); 
                path.classList.add('pie-animate'); // Add spin animation
                path.style.cursor = 'pointer';
                path.onclick = () => {
                    const isHidden = localStorage.getItem('balance_hidden') === 'true';
                    document.getElementById('chart-total-label').innerText = seg.name;
                    const valText = `${Math.round(seg.value).toLocaleString()}`;
                    const valEl = document.getElementById('chart-total-val');
                    valEl.dataset.raw = valText;
                    valEl.innerText = isHidden ? '******' : valText;
                    window.highlightTransactions(seg.name);
                };
                
                svgGroup.appendChild(path);
                
                // Legend
                const lItem = document.createElement('div');
                lItem.className = 'legend-item';
                lItem.innerHTML = `<div class="legend-color" style="background: ${seg.color}"></div><span>${seg.name}</span>`;
                legend.appendChild(lItem);
                
                return;
            }

            segments.forEach(seg => {
                const percent = (seg.value / total) * 100;
                if (percent < 0.5) return; 

                const angle = (seg.value / total) * 360;
                const endAngle = currentAngle + angle;

                const largeArc = angle > 180 ? 1 : 0;
                
                const x1 = centerX + radius * Math.cos((currentAngle * Math.PI) / 180);
                const y1 = centerY + radius * Math.sin((currentAngle * Math.PI) / 180);
                const x2 = centerX + radius * Math.cos((endAngle * Math.PI) / 180);
                const y2 = centerY + radius * Math.sin((endAngle * Math.PI) / 180);
                
                const ix1 = centerX + innerRadius * Math.cos((currentAngle * Math.PI) / 180);
                const iy1 = centerY + innerRadius * Math.sin((currentAngle * Math.PI) / 180);
                const ix2 = centerX + innerRadius * Math.cos((endAngle * Math.PI) / 180);
                const iy2 = centerY + innerRadius * Math.sin((endAngle * Math.PI) / 180);

                const d = [
                    `M ${x1} ${y1}`,
                    `A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2}`,
                    `L ${ix2} ${iy2}`,
                    `A ${innerRadius} ${innerRadius} 0 ${largeArc} 0 ${ix1} ${iy1}`,
                    'Z'
                ].join(' ');

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', d);
                path.setAttribute('fill', seg.color);
                path.setAttribute('stroke', '#fff');
                path.setAttribute('stroke-width', '4'); 
                path.classList.add('pie-animate'); // Add spin animation
                path.style.transition = 'all 0.3s';
                path.style.cursor = 'pointer';
                path.style.transformOrigin = 'center';
                
                // Interaction Events
                const showTooltip = (e) => {
                    const tooltip = document.getElementById('chart-tooltip');
                    if (!tooltip) return;
                    
                    const percentText = percent.toFixed(1) + '%';
                    tooltip.innerHTML = `<div style="font-weight: 800; margin-bottom: 4px;">${seg.name}</div><div style="color:#d1fae5; font-size: 13px;">${Math.round(seg.value).toLocaleString()} <span style="opacity: 0.8;">(${percentText})</span></div>`;
                    tooltip.style.opacity = '1';
                    tooltip.style.display = 'block';
                    
                    // Better positioning - offset from cursor
                    const x = e.pageX || e.clientX;
                    const y = e.pageY || e.clientY;
                    tooltip.style.left = `${x + 15}px`;
                    tooltip.style.top = `${y - 40}px`;
                };

                const hideTooltip = () => {
                    const tooltip = document.getElementById('chart-tooltip');
                    if (!tooltip) return;
                    tooltip.style.opacity = '0';
                    setTimeout(() => {
                        tooltip.style.display = 'none';
                    }, 200);
                };

                // Hover effect
                path.addEventListener('mouseenter', (e) => {
                    path.style.filter = 'brightness(1.1)';
                    path.style.transform = 'scale(1.02)';
                    showTooltip(e);
                });
                
                path.addEventListener('mousemove', (e) => {
                    showTooltip(e);
                });
                
                path.addEventListener('mouseleave', () => {
                    path.style.filter = 'none';
                    path.style.transform = 'scale(1)';
                    hideTooltip();
                });

                // Touch events for mobile
                let touchTimeout;
                path.addEventListener('touchstart', (e) => {
                    clearTimeout(touchTimeout);
                    path.style.filter = 'brightness(1.1)';
                    path.style.transform = 'scale(1.02)';
                    showTooltip(e.touches[0]);
                }, { passive: true });
                
                path.addEventListener('touchend', () => {
                    touchTimeout = setTimeout(() => {
                        path.style.filter = 'none';
                        path.style.transform = 'scale(1)';
                        hideTooltip();
                    }, 1500); // Keep tooltip visible for 1.5s after touch
                });

                path.onclick = (e) => {
                    const isHidden = localStorage.getItem('balance_hidden') === 'true';
                    // Update Center Label
                    const percentText = percent.toFixed(1) + '%';
                    document.getElementById('chart-total-label').innerText = seg.name;
                    const valText = `${Math.round(seg.value).toLocaleString()} (${percentText})`;
                    const valEl = document.getElementById('chart-total-val');
                    valEl.dataset.raw = valText;
                    valEl.innerText = isHidden ? '******' : valText;
                    window.highlightTransactions(seg.name);
                };
                
                svgGroup.appendChild(path);

                // Add to legend (Simple style)
                const lItem = document.createElement('div');
                lItem.className = 'legend-item';
                lItem.innerHTML = `
                    <div class="legend-color" style="background: ${seg.color}"></div>
                    <span>${seg.name}</span>
                `;
                legend.appendChild(lItem);

                currentAngle = endAngle;
            });

            // Animation trigger removed as requested (Visibility fix)
        }

        // RENDER ACCORDIONS (OPTIMIZED)
        window.historyLimit = 6;
        function renderHistory(txns) {
            const container = document.getElementById('history-container');
            const fragment = document.createDocumentFragment();
            
            // Check visibility state ONCE at the start for consistency
            const isHidden = localStorage.getItem('balance_hidden') === 'true';
            
            drawTrendChart(txns);

            const groups = {};
            txns.forEach(t => {
                const d = new Date(t.date);
                if (isNaN(d)) return;
                const key = d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                if (!groups[key]) groups[key] = { items: [], total: 0 };
                
                groups[key].items.push(t);
                const mappedSumCheck = getMerchantDisplay(t.merchant, t);
                if (!t.excluded && !t.refund && mappedSumCheck.category !== 'Income') {
                    const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                    groups[key].total += amt;
                }
            });

            const entries = Object.entries(groups);
            // Ensure chronological order (descending)
            entries.sort((a, b) => new Date(b[1].items[0].date) - new Date(a[1].items[0].date));
            
            const visibleEntries = entries.slice(0, window.historyLimit);

            visibleEntries.forEach(([month, data], index) => {
                const accordion = document.createElement('div');
                accordion.className = 'month-accordion';
                
                const savedState = localStorage.getItem(`accordion_${month}`);
                const isCollapsed = savedState === 'collapsed' || (savedState === null && index !== 0);
                
                const header = document.createElement('div');
                header.className = `month-header ${isCollapsed ? 'collapsed' : ''}`;
                header.innerHTML = `
                    <span class="month-title">${month}</span>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span class="month-total privacy-mask" data-raw="${data.total.toLocaleString(undefined, {minimumFractionDigits:2})}">
                            ${isHidden ? '******' : '' + data.total.toLocaleString(undefined, {minimumFractionDigits:2})}
                        </span>
                        <i class="material-icons expand-icon">expand_more</i>
                    </div>
                `;

                
                const content = document.createElement('div');
                content.className = `month-content ${isCollapsed ? 'collapsed' : ''}`;
                
                let contentHTML = '';
                data.items.forEach(t => {
                    const mapped = getMerchantDisplay(t.merchant, t);
                    const isIncome = mapped.category === 'Income';
                    const isRefund = t.refund || false;
                    const excludedClass = t.excluded ? 'txn-excluded' : '';
                    
                    const d = new Date(t.date);
                    const shortDate = d.toLocaleDateString('en-US', { day: '2-digit', month: 'short' });
                    const amount = (t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0));
                    
                    let displayNote = t.note || '';
                    if (!displayNote && mapped.category === 'Vehicle') {
                        displayNote = (amount > 250) ? "Car Refill" : "Motor Refill";
                    }
                    
                    let displayAmtColor = '';
                    let displayTitleColor = '';

                    if (isIncome) {
                        displayAmtColor = 'color: #16a34a;';
                        displayTitleColor = 'color: #16a34a;';
                    } else if (isRefund) {
                        displayAmtColor = 'color: #f59e0b;';
                        displayTitleColor = 'color: #f59e0b;';
                    } else if (mapped.category === 'Credit Card Payment') {
                        // Credit Card / Atome Specific Styling
                        displayAmtColor = 'color: #f59e0b;'; // Orange Gold
                        displayTitleColor = 'color: #f59e0b;'; // Orange Gold
                    } else {
                        // Expense Logic
                        if (Math.abs(amount) >= 1000) {
                            displayAmtColor = 'color: #ef4444;'; // Red Red
                        } else if (window.currentAccount === 'bpi') {
                            displayAmtColor = 'color: #991b1b;'; // Dark Red
                        }
                    }
                    let displayName = (mapped.category === 'Credit Card Payment' || isIncome) ? mapped.name : mapped.name;
                    // Note: If merchant was set to 'Atome' in parse, it might be lowercase. 
                    // Let's ensure 'ATOME PAYMENT' is honored if that was the intent.
                    if (mapped.category === 'Credit Card Payment') displayName = 'ATOME PAYMENT';
                    // else if (isIncome) displayName = 'INCOME'; // REMOVED to allow database overrides
                    let refundChip = isRefund ? '<span class="refund-badge" style="display: inline-block; background: #fef3c7; color: #d97706; font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 4px; margin-left: 6px; letter-spacing: 0.3px;">REFUNDED</span>' : '';
                    
                    // LOGO DETECTION
                    const mUpper = mapped.name.toUpperCase();
                    let logo = null;
                    if (mUpper.includes('JOLLIBEE')) logo = 'logos/jollibee.png';
                    else if (mUpper.includes('MCDO') || mUpper.includes('MCDONALDS')) logo = 'logos/mcdo.png';
                    else if (mUpper.includes('SHELL')) logo = 'logos/shell.png';
                    else if (mUpper.includes('SHOPEE')) logo = 'logos/shopee.png';
                    else if (mUpper.includes('LAZADA')) logo = 'logos/lazada.jpg';
                    else if (mUpper.includes('GLOBE') || mUpper.includes('GOMO')) logo = 'logos/globe.png';
                    else if (mUpper.includes('SM') || mUpper.includes('SM STORE')) logo = 'logos/sm.png';
                    else if (mUpper.includes('SPOTIFY')) logo = 'logos/spotify.png';
                    else if (mUpper.includes('TIKTOK')) logo = 'logos/tiktokshop.png';
                    else if (mUpper.includes('TECFUEL')) logo = 'logos/tecfuel.png';
                    else if (mUpper.includes('MR DIY')) logo = 'logos/mrdiy.png';
                    else if (mUpper.includes('METRO')) logo = 'logos/supermetro.png';
                    
                    const logoHTML = logo ? `<div class="brand-badge" style="display: ${typeof showLogos !== 'undefined' && showLogos ? 'flex' : 'none'}"><img src="${logo}"></div>` : '';

                    const noteSafe = (t.note || '').replace(/"/g, '&quot;');
                    contentHTML += `
                        <div class="premium-txn ${excludedClass}" 
                             data-txn-id="${t.id}" 
                             data-merchant="${mapped.name.replace(/'/g, "\\'")}" 
                             data-amount="${amount}"
                             data-category="${mapped.category}"
                             data-note="${noteSafe}"
                             data-excluded="${t.excluded || false}"
                             data-refund="${t.refund || false}">
                            <div class="icon-box ${mapped.catClass}">
                                <i class="material-icons">${mapped.icon}</i>
                                ${logoHTML}
                            </div>
                            <div class="txn-details">
                                <div class="txn-merch" style="${displayTitleColor}">${displayName}${refundChip}</div>
                                <div class="txn-sub">
                                    <span>${shortDate}</span>  <span>${displayCategoryName(mapped.category)}</span>
                                </div>
                                ${displayNote ? `<div class="txn-note" style="color: ${isRefund ? '#f59e0b' : (categoryConfig[mapped.category]?.darkColor || '#475569')}; font-size: 11px; margin-top:2px;">${displayNote}</div>` : ''}
                            </div>
                            <div class="txn-right">
                                <div class="txn-amount privacy-mask ${Math.abs(amount) >= 1000 ? 'large' : ''}" style="${displayAmtColor}" data-raw="${(!isIncome && !isRefund && window.currentAccount !== 'atome') ? '-' : ''}${Math.abs(amount).toLocaleString(undefined, {minimumFractionDigits:2})}">
                                    ${isHidden ? '******' : ((!isIncome && !isRefund && window.currentAccount !== 'atome') ? '-' : '') + '' + Math.abs(amount).toLocaleString(undefined, {minimumFractionDigits:2})}
                                </div>
                            </div>
                        </div>`;
                });
                
                content.innerHTML = contentHTML;
                header.onclick = () => {
                    const isNowCollapsed = content.classList.toggle('collapsed');
                    header.classList.toggle('collapsed', isNowCollapsed);
                    localStorage.setItem(`accordion_${month}`, isNowCollapsed ? 'collapsed' : 'expanded');
                };
                
                accordion.appendChild(header);
                accordion.appendChild(content);
                fragment.appendChild(accordion);
            });
            
            container.innerHTML = '';
            container.appendChild(fragment);

            // Load More Button
            if (entries.length > window.historyLimit) {
                const loadMoreWrap = document.createElement('div');
                loadMoreWrap.style.cssText = 'padding: 10px 0 40px; text-align: center;';
                const btn = document.createElement('button');
                btn.style.cssText = 'display: inline-flex; align-items: center; justify-content: center; gap: 8px; color: #000; font-weight: 800; font-size: 11px; letter-spacing: 0.5px; text-transform: uppercase; background: #ebf5ff; border: none; border-radius: 25px; padding: 12px 32px; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(29, 78, 216, 0.08);';
                btn.innerHTML = '<span>Load More</span><i class="material-icons" style="font-size: 20px;">keyboard_arrow_down</i>';
                
                btn.onclick = () => {
                    btn.innerHTML = '<i class="material-icons spin" style="font-size: 20px;">sync</i>';
                    btn.style.opacity = '0.7';
                    btn.style.pointerEvents = 'none';
                    setTimeout(() => {
                        window.historyLimit += 6;
                        renderHistory(window.allTxns);
                    }, 400);
                };
                
                btn.onmouseenter = () => { btn.style.background = '#dbeafe'; btn.style.transform = 'translateY(-1px)'; };
                btn.onmouseleave = () => { btn.style.background = '#ebf5ff'; btn.style.transform = 'translateY(0)'; };
                
                loadMoreWrap.appendChild(btn);
                container.appendChild(loadMoreWrap);
            }

            // Re-apply search if it was active
            if ((document.getElementById('txn-search')?.value || '') !== '' || document.getElementById('txn-cat-filter').value !== 'all') {
                filterTxnList();
            }

            setTimeout(() => setupLongPressHandlers(), 50);

            // CRITICAL FIX: Force update all privacy-masked elements after rendering
            // This ensures that when switching wallets, the privacy state is respected
            if (isHidden) {
                setTimeout(() => {
                    const maskedElements = document.querySelectorAll('.privacy-mask');
                    maskedElements.forEach(el => {
                        if (!el.dataset.raw) el.dataset.raw = el.innerText;
                        el.innerText = '******';
                    });
                }, 10);
            }

            // FEATURE UPDATES (NEW)
            updateBudgetUI();
            drawCashFlowChart();
            detectSubscriptions();
        }

        // GOOGLE IDENTITY SERVICES
        function initGIS() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (resp) => {
                        if (resp.error) return log('Login failed: ' + resp.error, 'error');
                        accessToken = resp.access_token;
                        const expMs = Date.now() + (resp.expires_in * 1000);
                        localStorage.setItem('g_access_token', accessToken);
                        localStorage.setItem('g_token_expiry', expMs);
                        fetchUserProfile(accessToken);
                        handleScan(300);
                    },
                });
                const gisBadge = document.getElementById('gis-status');
                gisBadge.innerText = 'GIS: Ready';
                gisBadge.classList.add('status-ready');
            } catch (e) { log('GIS Init Error: ' + e.message, 'error'); }
        }

        // Expose init to global bridge
        window.initGISModule = initGIS;
        if (window.gisReadyPending) initGIS();

        async function fetchUserProfile(token) {
            try {
                const res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.name) {
                    const firstName = data.given_name || data.name.split(',')[0].split(' ').slice(0, 2).join(' ');
                    document.getElementById('user-display-name').innerText = firstName;
                    
                    const badge = document.getElementById('profile-badge');
                    const picEl = document.getElementById('user-pic');
                    picEl.src = data.picture;
                    badge.classList.add('has-pic');
                    
                    // Cache for persistence
                    localStorage.setItem('user_name', firstName);
                    localStorage.setItem('user_pic', data.picture);
                }
            } catch (e) { log('Profile refresh fail: ' + e.message, 'error'); }
        }

        window.handleAuthClick = async () => {
            log('Starting Google Sign-In...');
            const prevUid = auth.currentUser?.uid;
            const isAnonymous = auth.currentUser?.isAnonymous;

            const provider = new GoogleAuthProvider();
            provider.addScope('https://www.googleapis.com/auth/gmail.readonly');
            
            try {
                log('Calling signInWithPopup... Browser should show a window.');
                const result = await signInWithPopup(auth, provider);
                log('Popup Result Received!');
                
                if (!result || !result.user) {
                    log('Popup closed, but no user data found.', 'error');
                    return;
                }
                
                log('Sign-in success! Email: ' + result.user.email);
                
                const credential = GoogleAuthProvider.credentialFromResult(result);
                if (credential) {
                    accessToken = credential.accessToken;
                    const expMs = Date.now() + 3600000; // Default 1 hour
                    localStorage.setItem('g_access_token', accessToken);
                    localStorage.setItem('g_token_expiry', expMs);
                    log('Google Access Token secured.');
                } else {
                    log('Warning: Google Credential not returned, Gmail sync might wait.', 'warn');
                }
                
                log('Sign-in successful.');
                
                const user = result.user;
                if (user.displayName) {
                    const parts = user.displayName.split(' ');
                    // Always take first 2 parts (first name + middle name) if available
                    const firstName = parts.length > 1 
                                      ? parts.slice(0, 2).join(' ') 
                                      : parts[0];
                    document.getElementById('user-display-name').innerText = firstName;
                    localStorage.setItem('user_name', firstName);
                }
                if (user.photoURL) {
                    const badge = document.getElementById('profile-badge');
                    const picEl = document.getElementById('user-pic');
                    let photoUrl = user.photoURL;
                    if (photoUrl.includes('googleusercontent.com') && !photoUrl.includes('s96-c')) {
                        photoUrl = photoUrl.split('=')[0] + '=s96-c';
                    }
                    picEl.src = photoUrl;
                    badge.classList.add('has-pic');
                    localStorage.setItem('user_pic', photoUrl);
                } else {
                    document.getElementById('profile-badge').classList.remove('has-pic');
                }

                /* DISABLED AUTO-MERGE FOR STRICT PRIVACY
                   Only sync what's in the specific user's folder.
                log('Checking for data to sync...');
                // ... (Migration logic removed)
                */
                log('Cloud account active. Loading isolated user data...');

                await loadData();
                
                // PREPARE SYNC LIMITS
                const lastDeep = localStorage.getItem(`last_deep_sync_${window.currentAccount}`);
                const now = Date.now();
                const dayInMs = 24 * 60 * 60 * 1000;
                let limit = 25; // Default Quick Sync
                
                if (!lastDeep || (now - parseInt(lastDeep)) > dayInMs) {
                    limit = 400; // Deep Sync
                    log(`Deep sync needed for ${window.currentAccount}...`);
                }
                
                handleScan(limit);
            } catch (error) {
                log('Auth Error: ' + error.code, 'error');
                log('Message: ' + error.message, 'error');
                console.error('Detailed Auth Failure:', error);
                
                // Show high-visibility troubleshooter for common developer errors
                if (error.code === 'auth/invalid-action-code' || 
                    error.code === 'auth/unauthorized-domain' || 
                    error.code === 'auth/configuration-not-found' ||
                    error.message.includes('invalid action')) {
                    
                    const codeLabel = document.getElementById('auth-error-code');
                    if (codeLabel) {
                        codeLabel.innerText = error.code || 'Configuration Mismatch';
                        document.getElementById('auth-trouble-modal').classList.add('show');
                    }
                } else if (error.code === 'auth/popup-closed-by-user') {
                    showToast('Sign-in cancelled');
                } else {
                    showToast('Sign-in failed');
                }
            }
        };
        
        // PROFILE DROPDOWN LOGIC
        window.toggleProfileDropdown = (e) => {
            e.stopPropagation();
            const dropdown = document.getElementById('profile-dropdown');
            dropdown.classList.toggle('active');
        };

        // Close dropdown when clicking elsewhere
        window.addEventListener('click', (e) => {
            const dropdown = document.getElementById('profile-dropdown');
            if (dropdown && dropdown.classList.contains('active')) {
                const badge = document.getElementById('profile-badge');
                if (!badge.contains(e.target)) {
                    dropdown.classList.remove('active');
                }
            }
            
            // PIE CHART TOOLTIP CLOSE ON OUTSIDE TAP
            const tooltip = document.getElementById('chart-tooltip');
            if (tooltip && tooltip.style.opacity === '1') {
                const isSegment = e.target.classList.contains('chart-segment') || e.target.classList.contains('pie-animate');
                if (!isSegment) {
                    tooltip.style.opacity = '0';
                    setTimeout(() => { tooltip.style.display = 'none'; }, 200);
                }
            }
        });

        window.handleSignout = async () => {
            if (confirm('Sign out?')) {
                log(' Initiating deep sign-out and data purge...');
                
                // Detach realtime listener
                if (window.unsubscribeSnapshot) {
                    window.unsubscribeSnapshot();
                    window.unsubscribeSnapshot = null;
                }

                localStorage.clear();
                window.allTxns = [];
                const historyContainer = document.getElementById('history-container');
                const logContainer = document.getElementById('log-container');
                if (historyContainer) historyContainer.innerHTML = '';
                if (logContainer) logContainer.innerHTML = '';
                
                try {
                    await auth.signOut();
                    // Hard reload to flush all memory states and clear persistence
                    window.location.href = window.location.origin + window.location.pathname + '?logout=true&t=' + Date.now();
                } catch (e) {
                    log('Sign out error: ' + e.message, 'error');
                }
            }
        };

        const getBody = (payload) => {
            let body = "";
            if (payload.body && payload.body.data) {
                const b64 = payload.body.data.replace(/-/g, '+').replace(/_/g, '/');
                try {
                    // Standard way to handle UTF-8 in base64
                    body = decodeURIComponent(escape(atob(b64)));
                } catch(e) { body = atob(b64); }
            } else if (payload.parts) {
                payload.parts.forEach(part => {
                    body += getBody(part);
                });
            }
            return body;
        };

        const stripTags = (html) => {
            if (!html) return "";
            return html.replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
                       .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
                       .replace(/<br\s*\/?>/gi, '\n')
                       .replace(/<\/p>| <\/div>|<\/tr>/gi, '\n')
                       .replace(/<\/td>/gi, ' | ')
                       .replace(/<[^>]*>/g, ' ')
                       .replace(/[ \t]+/g, ' ')
                       .replace(/\n\s+/g, '\n')
                       .trim();
        };

        // GMAIL SCAN (OPTIMIZED WITH PARALLELISM)
        window.handleScan = async (limit) => {
            const syncAccount = window.currentAccount;
            if (auth.currentUser?.isAnonymous) {
                if (confirm('Your data is currently in "Local Mode". Sign in with Google to sync notes and exclusions to the cloud?')) {
                    handleAuthClick();
                    return;
                }
            }

            const expiry = localStorage.getItem('g_token_expiry');
            const isExpired = !accessToken || !expiry || Date.now() > parseInt(expiry);
            
            if (isExpired) {
                log('Session expired. Prompting for re-authorization...');
                tokenClient.requestAccessToken({ prompt: '' }); // Request silent re-auth or prompt
                return; // The callback will trigger handleScan again
            }
            
            const activeCard = document.querySelector(`.balance-card[data-account="${window.currentAccount}"]`);
            const btn = activeCard ? activeCard.querySelector('.scan-btn') : null;
            const statusText = activeCard ? activeCard.querySelector('.syncStatusText') : null;
            const originalHTML = btn ? btn.innerHTML : '';

            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="material-icons spin" style="font-size:12px;">sync</i>';
            }
            if (statusText) statusText.innerText = 'Syncing';
            
            try {
                log(`Syncing ${syncAccount.toUpperCase()}...`);
                
                // MULTI-ACCOUNT QUERY
                let query = '';
                if (syncAccount === 'atome') {
                    // Broader Atome Query
                    query = `(subject:"Transaction Confirmation" OR subject:"payment confirmation" OR subject:"Atome Card") (from:Atome OR from:no-reply@atome.ph OR from:noreply@atome.ph)`;
                } else {
                    // BPI Query
                    query = `(subject:"Funds Transfer" OR subject:"Fund Transfer" OR subject:"Interbank" OR subject:"Pay via QR" OR from:bpi_online@bpi.com.ph OR from:onlinebanking@bpi.com.ph OR from:bpiinstapay@bpi.com.ph OR from:BPI)`;
                }
                
                log(`Scanning ${syncAccount} (Target Limit: ${limit})...`);
                
                let savedCount = 0;
                let pageToken = '';
                let totalProcessed = 0;

                // Loop for pagination if limit > 500
                while (totalProcessed < limit) {
                    const maxResults = Math.min(500, limit - totalProcessed);
                    let url = `https://gmail.googleapis.com/gmail/v1/users/me/messages?maxResults=${maxResults}&q=${encodeURIComponent(query)}`;
                    if (pageToken) url += `&pageToken=${pageToken}`;

                    const res = await fetch(url, { headers: { 'Authorization': `Bearer ${accessToken}` }});
                    const data = await res.json();
                    const msgs = data.messages || [];
                    pageToken = data.nextPageToken;

                    if (msgs.length === 0) break;

                    const batchSize = 10;
                    for (let i = 0; i < msgs.length; i += batchSize) {
                        const batch = msgs.slice(i, i + batchSize);
                        const promises = batch.map(async (m) => {
                            try {
                                const detailRes = await fetch(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${m.id}`, { headers: { 'Authorization': `Bearer ${accessToken}` }});
                                const d = await detailRes.json();
                                
                                let txn = null;
                                const fullBody = getBody(d.payload);
                                // For parsing, we strip tags to handle HTML templates
                                const cleanText = stripTags(fullBody) || d.snippet;

                                if (syncAccount === 'atome') {
                                    txn = parseAtomeEmail(cleanText, d.internalDate);
                                } else {
                                    const subjectHeader = d.payload.headers.find(h => h.name.toLowerCase() === 'subject');
                                    const subject = subjectHeader ? subjectHeader.value : '';
                                    txn = parseBPIEmail(cleanText, d.internalDate, subject);
                                }

                                if (txn) {
                                    if (!auth.currentUser) await signInAnonymously(auth);
                                    const uid = auth.currentUser.uid;
                                    const collectionName = getCollectionName(syncAccount);
                                    const docRef = doc(db, "users", uid, collectionName, txn.id);
                                    
                                    const snap = await getDoc(docRef);
                                    if (snap.exists()) {
                                        // PROTECT MANUAL EDITS: Only restore if it was deleted. 
                                        // Do NOT overwrite existing merchant, notes, or categories.
                                        await updateDoc(docRef, { deleted: false });
                                    } else {
                                        await setDoc(docRef, { ...txn, deleted: false, createdAt: serverTimestamp() });
                                    }
                                    return true;
                                }
                            } catch (err) { return false; }
                            return false;
                        });
                        
                        const results = await Promise.all(promises);
                        savedCount += results.filter(Boolean).length;
                    }
                    
                    totalProcessed += msgs.length;
                    if (!pageToken) break; 
                }
                
                if (savedCount > 0) {
                    // Update sync timestamps
                    const now = Date.now();
                    localStorage.setItem(`last_quick_sync_${syncAccount}`, now);
                    if (limit >= 400) {
                        localStorage.setItem(`last_deep_sync_${syncAccount}`, now);
                    }
                    
                    // Final sanity check before reloading data
                    if (window.currentAccount !== syncAccount) {
                        log("Sync finished but account changed. Data saved to cloud.");
                        return;
                    }
                    if (limit > 100) localStorage.setItem(`last_deep_sync_${syncAccount}`, Date.now());
                    log(`Sync complete! +${savedCount} processed.`, 'success');
                    await loadData();
                } else {
                    log('Sync complete. No new valid txns found.');
                }
            } catch (e) { log('Scan error: ' + e.message, 'error'); }
            finally {
              if (btn) {
                  btn.disabled = false;
                  btn.innerHTML = originalHTML;
              }
              if (statusText) statusText.innerText = 'Synced';
            }
        };

        function parseAtomeEmail(text, ts) {
            // Updated Atome Regex to handle stripped HTML and different wordings
            const amtMatch = text.match(/payment\s+of[^\d]*([\d,]+\.?\d*)/i) || text.match(/amount[^\d]*([\d,]+\.?\d*)/i);
            const merchMatch = text.match(/for\s+([^,]+?)\s+using/i) || text.match(/at\s+([^,]+?)\s+(?:using|on)/i);
            
            if (!amtMatch) return null;
            
            return {
                id: 'txn_' + ts,
                amount: parseFloat(amtMatch[1].replace(/,/g, '')),
                merchant: merchMatch ? merchMatch[1].trim() : "Atome Transaction",
                date: new Date(parseInt(ts)).toISOString().split('T')[0]
            };
        }

        function parseBPIEmail(text, ts, subject) {
            let amount = 0;
            let merchant = "BPI Transfer";
            let note = "";
            let isIncome = false;
            let category = "Financial Expenses";
            let dateVal = new Date(parseInt(ts)).toISOString().split('T')[0];

            const tLower = text.toLowerCase();
            const sLower = subject.toLowerCase();

            // EXCLUSION: Skip marketing
            if (tLower.includes("never ask for your bank details") && !tLower.includes("confirmation number")) return null;

            // 1. Detect Amount
            const amtMatch = text.match(/(?:Transfer Amount|Total Amount|Amount)\s*PHP\s*([\d,]+\.\d{2})/i) || 
                             text.match(/(?:PHP|PHP\s|P)\s?([\d,]+\.\d{2})/i);
            if (amtMatch) amount = parseFloat(amtMatch[1].replace(/,/g, ''));
            if (amount === 0) return null;

            // 2. Detect Date from Body
            const dateMatch = text.match(/Transaction Date and Time\s+([^;\n\r]+)/i) || text.match(/Date and Time\s+([^;\n\r]+)/i);
            if (dateMatch) {
                const parsedDate = new Date(dateMatch[1].trim());
                if (!isNaN(parsedDate)) dateVal = parsedDate.toISOString().split('T')[0];
            }

            // 3. SPECIAL DETECTION: ATOME PAYMENTS & AUB
            // Regex tailored for pipe-separated table structure from stripTags
            const payToMatch = text.match(/Pay To\s*\|\s*([^|\n\r]+)/i);
            const bankNameMatch = text.match(/Bank Name\s*\|\s*([^|\n\r]+)/i);
            const refNoMatch = text.match(/Transaction Ref No\.\s*\|\s*([A-Z0-9]+)/i);

            const isAtome = (payToMatch && payToMatch[1].toLowerCase().includes("atome")) || 
                            (sLower.includes("pay atome")) ||
                            (bankNameMatch && (
                                bankNameMatch[1].toLowerCase().includes("aub") || 
                                bankNameMatch[1].toLowerCase().includes("asia united bank") ||
                                bankNameMatch[1].toLowerCase().includes("asian bank united")
                            ));

            if (isAtome) {
                merchant = "ATOME PAYMENT";
                category = "Credit Card Payment";
                if (refNoMatch) note = "Ref No: " + refNoMatch[1].trim();
                else if (bankNameMatch) note = "Ref No: " + bankNameMatch[1].trim(); // Fallback if no ref no
            } else if (sLower.includes("incoming") || tLower.includes("incoming") || tLower.includes("you have an incoming") || text.includes("Incoming Funds") || text.includes("received a transfer")) {
                // 4. INCOME
                isIncome = true;
                merchant = "INCOME"; 
                category = "Income";
                const bankMatch = bankNameMatch || text.match(/Transfer From\s*\|\s*([^|\n\r]+)/i);
                if (bankMatch) note = "FROM " + bankMatch[1].trim().toUpperCase();
            } else if (tLower.includes("transfer money") || sLower.includes("interbank") || sLower.includes("funds transfer") || sLower.includes("fund transfer") || payToMatch || text.includes("successfully submitted your")) {
                // 5. OUTGOING PAYMENTS
                isIncome = false;
                merchant = "PAYMENT";
                category = "Financial Expenses";
                
                let bank = bankNameMatch ? bankNameMatch[1].trim() : "";

                // USER REQUEST: STRICT NOTES "TO [BANK]"
                if (bank) {
                    note = "TO " + bank.toUpperCase();
                } else {
                    // Internal BPI transfers don't show "Bank Name", so default to BPI
                    note = "TO BPI";
                }
            }

            return {
                id: 'bpi_' + ts,
                amount: amount,
                merchant: merchant,
                note: note,
                date: dateVal,
                manualCategory: category
            };
        }

        // iOS-STYLE LONG-PRESS MENU
        let longPressTimer = null;
        let currentElevatedItem = null;
        let clonedItem = null;
        
        function setupLongPressHandlers() {
            document.querySelectorAll('.premium-txn').forEach(item => {
                // Remove old event listeners by cloning
                const newItem = item.cloneNode(true);
                item.parentNode.replaceChild(newItem, item);
                
                let startX, startY;
                
                const startLongPress = (e) => {
                    startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                    startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
                    
                    longPressTimer = setTimeout(() => {
                        showIOSMenu(newItem, e);
                    }, 400); // Faster response
                };
                
                const cancelLongPress = (e) => {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                };
                
                const checkMove = (e) => {
                    const currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                    const currentY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                    const distance = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2));
                    
                    if (distance > 10) {
                        cancelLongPress();
                    }
                };
                
                newItem.addEventListener('mousedown', startLongPress);
                newItem.addEventListener('touchstart', startLongPress, { passive: true });
                newItem.addEventListener('mouseup', cancelLongPress);
                newItem.addEventListener('touchend', cancelLongPress);
                newItem.addEventListener('mousemove', checkMove);
                newItem.addEventListener('touchmove', checkMove, { passive: true });
                newItem.addEventListener('mouseleave', cancelLongPress);
            });
        }
        
        function showIOSMenu(item, event) {
            if (event.cancelable) event.preventDefault();

            // Haptic feedback if available (Mobile feel)
            if (navigator.vibrate) navigator.vibrate(50);
            
            const txnId = item.dataset.txnId;
            const merchant = item.dataset.merchant || '';
            const amount = parseFloat(item.dataset.amount) || 0;
            const isExcluded = item.dataset.excluded === 'true';
            const category = item.dataset.category || '';
            const note = item.dataset.note || '';
            const isRefund = item.dataset.refund === 'true';
            
            // 1. Get exact position
            const rect = item.getBoundingClientRect();
            
            // 2. Hide original item
            currentElevatedItem = item;
            item.style.visibility = 'hidden';
            
            // 3. Create and position clone
            clonedItem = item.cloneNode(true);
            clonedItem.classList.add('elevated-clone');
            
            // Strip IDs to prevent duplicate conflicts
            clonedItem.removeAttribute('id');
            clonedItem.querySelectorAll('[id]').forEach(el => el.removeAttribute('id'));

            // Force exact positioning
            clonedItem.style.setProperty('position', 'fixed', 'important');
            clonedItem.style.setProperty('top', `${rect.top}px`, 'important');
            clonedItem.style.setProperty('left', `${rect.left}px`, 'important');
            clonedItem.style.setProperty('width', `${rect.width}px`, 'important');
            clonedItem.style.setProperty('height', `${rect.height}px`, 'important');
            clonedItem.style.setProperty('margin', '0', 'important');
            clonedItem.style.setProperty('z-index', '2001', 'important');
            clonedItem.style.setProperty('display', 'flex', 'important');
            
            clonedItem.style.visibility = 'visible';
            clonedItem.onclick = closeIOSMenu; 
            document.body.appendChild(clonedItem);
            
            // 4. Show blur and backdrop
            document.getElementById('blur-overlay').classList.add('active');
            document.querySelector('.mobile-wrapper').classList.add('blur-active');
            const fab = document.querySelector('.fab');
            if (fab) fab.classList.add('blur-active');
            const nav = document.querySelector('.bottom-nav');
            if (nav) nav.classList.add('blur-active');
            
            // Prevent scrolling
            document.body.style.overflow = 'hidden';
            document.querySelector('.mobile-wrapper').style.overflow = 'hidden';
            
            // 5. Build menu - escape values properly
            const menu = document.getElementById('ios-menu');
            const merchantSafe = merchant.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const noteSafe = note.replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/`/g, '\\`');
            const categorySafe = category.replace(/'/g, "\\'");
            
            menu.innerHTML = `
                <div class="ios-action-item" onclick="handleIOSAction('edit', '${txnId}', '${merchantSafe}', ${amount}, '${categorySafe}', '${noteSafe}')">
                    <i class="material-icons">edit</i>
                    <span>Edit Transaction</span>
                </div>
                <div class="ios-action-item ${isExcluded ? '' : 'danger'}" onclick="handleIOSAction('exclude', '${txnId}', ${isExcluded}, '${merchantSafe}')">
                    <i class="material-icons">${isExcluded ? 'add_circle' : 'block'}</i>
                    <span>${isExcluded ? 'Include' : 'Exclude'}</span>
                </div>
                <div class="ios-action-item warning" onclick="handleIOSAction('refund', '${txnId}', ${isRefund})">
                    <i class="material-icons">${isRefund ? 'undo' : 'sync_alt'}</i>
                    <span>${isRefund ? 'Unmark Refund' : 'Mark as Refund'}</span>
                </div>
                <div class="ios-action-item danger" onclick="handleIOSAction('delete', '${txnId}')">
                    <i class="material-icons">delete</i>
                    <span>Delete</span>
                </div>
            `;
            
            // 6. Position menu
            menu.classList.add('show');
            const menuHeight = menu.offsetHeight || 180;
            const menuWidth = menu.offsetWidth || 200;
            
            // Get mobile wrapper bounds
            const mobileWrapper = document.querySelector('.mobile-wrapper');
            const wrapperRect = mobileWrapper ? mobileWrapper.getBoundingClientRect() : { left: 0, right: window.innerWidth, top: 0, bottom: window.innerHeight };
            
            // Position menu below the transaction item
            let topPos = rect.bottom + 12;
            
            // If not enough space below, position above
            if (topPos + menuHeight > window.innerHeight - 20) {
                topPos = rect.top - menuHeight - 12;
            }
            
            // Ensure menu doesn't go above viewport
            if (topPos < 20) {
                topPos = rect.bottom + 12; // Force below if above doesn't work
            }
            
            // Align menu's right edge with transaction card's right edge
            let leftPos = rect.right - menuWidth;
            
            // Ensure menu stays within wrapper bounds
            if (leftPos < wrapperRect.left + 20) {
                leftPos = wrapperRect.left + 20;
            }
            
            menu.style.left = `${leftPos}px`;
            menu.style.top = `${topPos}px`;
            menu.style.right = 'auto';
            menu.style.transform = 'none';
        }
        
        window.closeIOSMenu = () => {
            document.getElementById('blur-overlay').classList.remove('active');
            document.getElementById('ios-menu').classList.remove('show');
            document.querySelector('.mobile-wrapper').classList.remove('blur-active');
            const fab = document.querySelector('.fab');
            const nav = document.querySelector('.bottom-nav');
            if (fab) fab.classList.remove('blur-active');
            if (nav) nav.classList.remove('blur-active');
            
            // Restore scrolling
            document.body.style.overflow = '';
            document.querySelector('.mobile-wrapper').style.overflow = 'auto';
            
            if (clonedItem) {
                clonedItem.remove();
                clonedItem = null;
            }
            if (currentElevatedItem) {
                currentElevatedItem.style.visibility = 'visible';
                currentElevatedItem = null;
            }
        };
        
        window.handleIOSAction = (action, txnId, ...args) => {
            closeIOSMenu();
            
            switch(action) {
                case 'edit':
                    openEditModal(txnId, args[0], args[1], args[2], args[3]);
                    break;
                case 'exclude':
                    toggleExclusion(txnId, args[1], args[0]);
                    break;
                case 'refund':
                    toggleRefund(txnId, args[0]);
                    break;
                case 'delete':
                    openDeleteModal(txnId);
                    break;
            }
        };

        window.toggleExclusion = async (id, merchant, isCurrentlyExcluded) => {
            if (auth.currentUser?.isAnonymous) {
                if (confirm('Your data is in "Local Mode". Sign in with Google to sync this exclusion to the cloud?')) {
                    handleAuthClick();
                    return;
                }
            }
            
            // OPTIMISTIC UPDATE
            const idx = window.allTxns.findIndex(t => t.id === id);
            const originalState = isCurrentlyExcluded;
            if (idx > -1) {
                window.allTxns[idx].excluded = !isCurrentlyExcluded;
                renderHistory(window.allTxns);
                updateBalanceToThisMonth(window.allTxns);
                // Also refresh charts/subscriptions if needed
                if (window.detectSubscriptions) detectSubscriptions();
                if (window.drawCashFlowChart) drawCashFlowChart();
            }

            try {
                if (!auth.currentUser) return;
                const uid = auth.currentUser.uid;
                const col = getCollectionName(window.currentAccount);
                await updateDoc(doc(db, "users", uid, col, id), { excluded: !isCurrentlyExcluded });
                showToast(isCurrentlyExcluded ? 'Transaction included' : 'Transaction excluded');
            } catch (e) { 
                log('Toggle failed', 'error');
                // Revert logic could be added here if critical
                 if (idx > -1) {
                    window.allTxns[idx].excluded = originalState;
                    renderHistory(window.allTxns);
                }
            }
        };

        window.toggleRefund = async (id, isCurrentlyRefund) => {
            if (auth.currentUser?.isAnonymous) {
                if (confirm('Your data is in "Local Mode". Sign in with Google to sync changes to the cloud?')) {
                    handleAuthClick();
                    return;
                }
            }
            
            // OPTIMISTIC UPDATE
            const idx = window.allTxns.findIndex(t => t.id === id);
            const originalState = isCurrentlyRefund;
            if (idx > -1) {
                window.allTxns[idx].refund = !isCurrentlyRefund;
                renderHistory(window.allTxns);
                updateBalanceToThisMonth(window.allTxns);
                if (window.drawCashFlowChart) drawCashFlowChart();
            }

            try {
                if (!auth.currentUser) return;
                const uid = auth.currentUser.uid;
                const col = getCollectionName(window.currentAccount);
                await updateDoc(doc(db, "users", uid, col, id), { refund: !isCurrentlyRefund });
                showToast(isCurrentlyRefund ? 'Unmarked as refund' : 'Marked as refund');
            } catch (e) { 
                log('Toggle refund failed: ' + e.message, 'error');
                 // Revert
                 if (idx > -1) {
                    window.allTxns[idx].refund = originalState;
                    renderHistory(window.allTxns);
                }
            }
        };

        // DELETE LOGIC
        window.openDeleteModal = (id) => {
            currentTxnId = id;
            document.getElementById('delete-modal').classList.add('show');
        };

        window.confirmDelete = async () => {
             if (auth.currentUser?.isAnonymous) {
                if (confirm('Your data is in "Local Mode". Sign in with Google to sync deletions to the cloud?')) {
                    handleAuthClick();
                    return;
                }
            }
            if (!currentTxnId) return;
            
            const btn = document.querySelector('#delete-modal button');
            if (btn) btn.innerHTML = '<i class="material-icons spin" style="font-size:18px;">sync</i> DELETING...';

            // OPTIMISTIC UPDATE
            const idx = window.allTxns.findIndex(t => t.id === currentTxnId);
            let deletedItem = null;
            if (idx > -1) {
                deletedItem = window.allTxns[idx];
                window.allTxns.splice(idx, 1); // Remove from array
                renderHistory(window.allTxns);
                updateBalanceToThisMonth(window.allTxns);
            }
            closeModals(); // Close immediately

            try {
                 if (!auth.currentUser) return;
                 const uid = auth.currentUser.uid;
                 const col = getCollectionName(window.currentAccount);
                await updateDoc(doc(db, "users", uid, col, currentTxnId), { deleted: true });
                showToast('Transaction deleted');
            } catch (error) { 
                log("Error deleting: " + error.message, "error");
                showToast('Delete failed');
                // Revert
                if (deletedItem) {
                    window.allTxns.push(deletedItem); // Add back (order might be wrong until refresh but better than nothing)
                    window.allTxns.sort((a,b) => new Date(b.date) - new Date(a.date)); // Simple re-sort
                    renderHistory(window.allTxns);
                }
            } finally {
               if(btn) btn.innerHTML = 'DELETE';
            }
        };

        // --- CUSTOMIZATION MODALS ---
        let currentTxnId = null;
        const CATEGORIES = [
            { id: 'Online shopping', icon: 'shopping_bag', label: 'Online Shopping', cls: 'cat-online' },
            { id: 'Shopping', icon: 'shopping_cart', label: 'Shopping', cls: 'cat-shopping' },
            { id: 'Vehicle', icon: 'local_gas_station', label: 'Vehicle', cls: 'cat-vehicle' },
            { id: 'Food & Drinks', icon: 'restaurant', label: 'Food & Drinks', cls: 'cat-food' },
            { id: 'Service', icon: 'settings_cell', label: 'Service', cls: 'cat-service-magenta' },
            { id: 'Trade Copier', icon: 'hub', label: 'Trade Copier', cls: 'cat-aqua' },
            { id: 'Trading Expenses', icon: 'insights', label: 'Trading Expenses', cls: 'cat-trading' },
            { id: 'Life & Entertainment', icon: 'confirmation_number', label: 'Life & Ent.', cls: 'cat-life' },
            { id: 'Financial Expenses', icon: 'payments', label: 'Financial Expenses', cls: 'cat-financial' },
            { id: 'Credit Card Payment', icon: 'credit_card', label: 'Credit Card', cls: 'cat-credit-card' },
            { id: 'Transportation', icon: 'directions_bus', label: 'Transportation', cls: 'cat-vehicle' },
            { id: 'Travel', icon: 'flight', label: 'Travel', cls: 'cat-aqua' },
            { id: 'Education', icon: 'school', label: 'Education', cls: 'cat-education' },
            { id: 'Sport', icon: 'fitness_center', label: 'Sport', cls: 'cat-life' },
            { id: 'Income', icon: 'savings', label: 'Income', cls: 'cat-income' }
        ];

        // Function to update main wallet balance (Total All-Time)
        function updateMainWalletBalance(allTxns) {
            let incomeTotal = 0;
            let expenseTotal = 0;
            
            allTxns.forEach(t => {
                if (t.excluded || t.refund || t.deleted) return;
                const mapped = getMerchantDisplay(t.merchant, t);
                const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                const cat = mapped.category;
                
                if (cat === 'Income') {
                    incomeTotal += amt;
                } else {
                    expenseTotal += amt;
                }
            });
            
            const balanceEl = document.getElementById(`${window.currentAccount}-balance`);
            if (balanceEl) {
                const balance = incomeTotal - expenseTotal;
                balanceEl.innerText = `PHP ${balance.toLocaleString(undefined, {minimumFractionDigits:2})}`;
            }
        }

        // Populate Transaction History Category Filter
        const populateTxnFilter = () => {
            const filter = document.getElementById('txn-cat-filter');
            if (!filter) return;
            
            // Keep "All Items"
            const allOption = filter.options[0];
            filter.innerHTML = '';
            filter.appendChild(allOption);
            
            CATEGORIES.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.label; // We match against the label in filterTxnList
                opt.innerText = cat.label;
                filter.appendChild(opt);
            });
        };
        populateTxnFilter();

        window.closeModals = () => {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('show'));
            currentTxnId = null;
            
            // Restore scroll
            const wrapper = document.querySelector('.mobile-wrapper');
            if (wrapper) wrapper.style.overflow = 'auto';
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.width = '';
        };

        // Close on outside click
        window.onclick = (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeModals();
            }
        };

        window.openCategoryModal = (id, merchant, currentCatId) => {
            currentTxnId = id;
            const grid = document.getElementById('cat-grid');
            grid.innerHTML = CATEGORIES.map(cat => `
                <div class="cat-option ${currentCatId === cat.id ? 'active' : ''}" onclick="window.saveCategory('${cat.id}')">
                    <i class="material-icons ${cat.cls}" style="padding: 10px; border-radius: 12px;">${cat.icon}</i>
                    <span>${cat.label}</span>
                </div>
            `).join('');
            document.getElementById('cat-modal').classList.add('show');
        };

        window.saveCategory = async (catId) => {
            if (auth.currentUser?.isAnonymous) {
                if (confirm('Your data is in "Local Mode". Sign in with Google to sync category changes to the cloud?')) {
                    handleAuthClick();
                    return;
                }
            }
            if (!currentTxnId) return;

            // OPTIMISTIC UPDATE
            const idx = window.allTxns.findIndex(t => t.id === currentTxnId);
            const originalCat = idx > -1 ? window.allTxns[idx].manualCategory : null;
            if (idx > -1) {
                window.allTxns[idx].manualCategory = catId;
                renderHistory(window.allTxns);
                updateBalanceToThisMonth(window.allTxns);
                if (window.detectSubscriptions) detectSubscriptions();
                if (window.drawCashFlowChart) drawCashFlowChart();
            }
            closeModals(); // Close immediately

            try {
                if (!auth.currentUser) return;
                const uid = auth.currentUser.uid;
                const col = getCollectionName(window.currentAccount);
                await updateDoc(doc(db, "users", uid, col, currentTxnId), { manualCategory: catId });
                showToast('Category updated');
            } catch (error) { 
                log("Error saving category: " + error.message, "error");
                showToast('Update failed');
                 // Revert
                 if (idx > -1) {
                    window.allTxns[idx].manualCategory = originalCat;
                    renderHistory(window.allTxns);
                }
            }
        };

        window.openNoteModal = (id, merchant, note) => {
            currentTxnId = id;
            const input = document.getElementById('note-text');
            const counter = document.getElementById('note-counter');
            input.value = note || '';
            counter.innerText = `${input.value.length}/30`;
            
            input.oninput = () => {
                counter.innerText = `${input.value.length}/30`;
            };

            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveNote();
                }
            };
            
            document.getElementById('note-modal').classList.add('show');
        };

        // Enforce Title Case Helper
        function toTitleCase(str) {
            return str.replace(/\w\S*/g, function(txt){
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            });
        }

        document.getElementById('save-note-btn').onclick = async () => {
             if (auth.currentUser?.isAnonymous) {
                if (confirm('Your data is in "Local Mode". Sign in with Google to sync your notes to the cloud?')) {
                    handleAuthClick();
                    return;
                }
            }
            if (!currentTxnId) return;
            let note = document.getElementById('note-text').value.trim();

             // OPTIMISTIC UPDATE
            const idx = window.allTxns.findIndex(t => t.id === currentTxnId);
            const originalNote = idx > -1 ? window.allTxns[idx].note : null;
            if (idx > -1) {
                window.allTxns[idx].note = note;
                renderHistory(window.allTxns);
            }
            closeModals();

            try {
                if (!auth.currentUser) return;
                const uid = auth.currentUser.uid;
                const col = getCollectionName(window.currentAccount);
                await updateDoc(doc(db, "users", uid, col, currentTxnId), { note: note });
                showToast('Note saved');
            } catch (error) { 
                log("Error saving note: " + error.message, "error"); 
                showToast('Save failed');
                 // Revert
                 if (idx > -1) {
                    window.allTxns[idx].note = originalNote;
                    renderHistory(window.allTxns);
                }
            }
        };

        window.openPriceModal = (id, currentAmt) => {
            currentTxnId = id;
            const modal = document.getElementById('price-modal');
            const input = document.getElementById('price-input');
            input.value = currentAmt;
            modal.classList.add('show');
            setTimeout(() => input.focus(), 100);

            input.onkeydown = (e) => {
                if (e.key === 'Enter') savePrice();
            };
        };

        const savePrice = async () => {
            if (auth.currentUser?.isAnonymous) {
                if (confirm('Your data is in "Local Mode". Sign in with Google to sync prices to the cloud?')) {
                    handleAuthClick();
                    return;
                }
            }
            if (!currentTxnId) return;
            const val = document.getElementById('price-input').value;
            const amt = parseFloat(val);
            const isValid = !isNaN(amt) && val.trim() !== "";
            
            // OPTIMISTIC UPDATE
            const idx = window.allTxns.findIndex(t => t.id === currentTxnId);
            const originalAmt = idx > -1 ? window.allTxns[idx].manualAmount : undefined;
            if (idx > -1) {
                if (isValid) {
                     window.allTxns[idx].manualAmount = amt;
                } else {
                     delete window.allTxns[idx].manualAmount;
                }
                renderHistory(window.allTxns);
                updateBalanceToThisMonth(window.allTxns);
                if (window.drawCashFlowChart) drawCashFlowChart();
            }
            closeModals();

            try {
                if (!auth.currentUser) return;
                const uid = auth.currentUser.uid;
                const col = getCollectionName(window.currentAccount);
                const docRef = doc(db, "users", uid, col, currentTxnId);
                if (!isValid) {
                    await updateDoc(docRef, { manualAmount: deleteField() });
                } else {
                    await updateDoc(docRef, { manualAmount: amt });
                }
                showToast('Price updated');
            } catch (error) { 
                log("Error saving price: " + error.message, "error"); 
                showToast('Update failed');
                // Revert
                 if (idx > -1) {
                    if (originalAmt === undefined) delete window.allTxns[idx].manualAmount;
                    else window.allTxns[idx].manualAmount = originalAmt;
                    renderHistory(window.allTxns);
                }
            }
        };
        window.savePrice = savePrice;

        /* See listener above for save-note-btn, replaced to include title casing */

        function showToast(msg) {
            const toast = document.getElementById('toast-box');
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function displayCategoryName(id) {
            const cat = CATEGORIES.find(c => c.id === id);
            return cat ? cat.label : id;
        }

        // MERCHANT MAPPING & CATEGORIZATION
        function getMerchantDisplay(name = '', t = {}) {
            let raw = name.toUpperCase();
            
            // 1. GENERAL CLEANUP (Remove PHL, Locations, messy suffixes)
            let cleaned = name
                .replace(/\s+PHL$/i, '')
                .replace(/\s+CEBU\s+CITY\s+PHL$/i, '')
                .replace(/\s+CEBU\s+CITY$/i, '')
                .replace(/\s+DUBAI\s+ARE$/i, '')
                .replace(/\s+LONDON\s+GBR$/i, '')
                .replace(/\s+PH\s+PHL$/i, '')
                .replace(/\s+PH$/i, '')
                .trim();
            
            // 2. PATTERN REPLACEMENT
            if (cleaned.toUpperCase().includes('GADC') || cleaned.toUpperCase().includes('MCDONALDS') || cleaned.toUpperCase().includes('MCDO')) {
                let u = cleaned.toUpperCase();
                if (u.includes('SOUTHCBU') || u.includes('325CLN')) {
                    cleaned = 'MCDONALDS SOUTH CEBU';
                } else {
                    // Standardize prefix
                    cleaned = cleaned.replace(/(GADC|MCDONALDS|MCDO)/i, 'MCDONALDS').trim();
                    // Strip alphanumeric codes like 325CLNS... but keep what's after if it looks like a name
                    cleaned = cleaned.replace(/MCDONALDS\s+\d+[A-Z]*/i, 'MCDONALDS').trim();
                }
            }
            
            if (cleaned.toUpperCase().includes('JOLLIBEE')) {
                cleaned = cleaned.replace(/JB\d+\s+\w+/i, '').trim();
            }

            if (cleaned.toUpperCase().includes('RIBSHACK')) {
                 cleaned = cleaned.replace(/PH\d+/i, '').trim();
            }

            if (cleaned.toUpperCase().includes('SHOPEE')) {
                cleaned = 'SHOPEE PH';
            }

            if (cleaned.toUpperCase().includes('TRADERSCONNECT')) {
                cleaned = 'TRADERS CONNECT';
            }

            if (cleaned.toUpperCase().includes('TIKTOK SHOP')) {
                cleaned = 'TIKTOK SHOP';
            }

            if (cleaned.toUpperCase().includes('SPOTIFY')) {
                cleaned = 'SPOTIFY';
            }

            let display = { name: cleaned, category: 'Financial expenses', icon: 'payments', catClass: 'cat-financial' };

            // 3. MANUAL OVERRIDE (USER CHOICE)
            if (t.manualCategory) {
                const userCat = CATEGORIES.find(c => c.id === t.manualCategory);
                if (userCat) {
                    display.category = userCat.id;
                    display.icon = userCat.icon;
                    // Find catClass
                    const catMap = {
                        'Online shopping': 'cat-online',
                        'Shopping': 'cat-shopping',
                        'Vehicle': 'cat-vehicle',
                        'Trade Copier': 'cat-aqua',
                        'Trading Expenses': 'cat-trading',
                        'Service': 'cat-service-magenta',
                        'Food & Drinks': 'cat-food',
                        'Life & Entertainment': 'cat-life',
                        'Financial Expenses': 'cat-financial',
                        'Credit Card Payment': 'cat-credit-card',
                        'Transportation': 'cat-vehicle',
                        'Travel': 'cat-aqua',
                        'Education': 'cat-education', /* Blue */
                        'Sport': 'cat-life',
                        'Income': 'cat-income'
                    };
                    display.catClass = userCat.cls || catMap[userCat.id] || 'cat-financial';
                    return display;
                }
            }

            // 4. EXACT OVERRIDES
            const mapping = {
                'MR DIY BGCC BOGO': 'MR DIY BOGO',
                'MR DIY ZBOG BOGO': 'MR DIY BOGO',
                'TEC FUEL SAN REMIGIO': 'TECFUEL SAN REMIGIO',
                'J AND L SHOPPING BOGO': 'J AND L MALL BOGO',
                'TECFUEL BOGO CEBU': 'TECFUEL BOGO',
                'KKV SM J Mall Cebu': 'KKV SM J MALL CEBU',
                'SM STORE-CEBU': 'SM STORE - CEBU CITY',
                'GLOBE-BILLSPAY PH': 'GLOBE / GOMO LOAD',
                'SHELL FILLWISE BOGO CEBU': 'SHELL BOGO CEBU',
                'GLOBE WEBLOADING EC PH': 'GLOBE / GOMO LOAD',
                'WATSONS HISOLER BLDG B': 'WATSONS HISOLER BLDG BOGO',
                'SUPER METRO S/M-BOGO': 'SUPER METRO BOGO',
                'SM SUPERMARKET SM SRP CEBU': 'SM SUPERMARKET SRP',
                'OCTAGON AYALA CENTRAL CEBU': 'OCTAGON AYALA CENTRAL CEBU',
                'STARBUCKS 540 CENTRAL CEBU CITY': 'STARBUCKS 540 CENTRAL CEBU CITY',
                'ICE SKATING SM SRP CEB': 'ICE SKATING SM SRP CEBU',
                'TAP SURE LEVERAGE FUND': 'TAP SURE LEVERAGE FUND',
                'MRCRMT': 'MRCRMT',
                'TRADERSCONNECT.COM': 'TRADERS CONNECT',
                'TRADERSCONNECT': 'TRADERS CONNECT',
                'TRADERSCONNECT.COM': 'TRADERS CONNECT'
            };

            const finalRaw = cleaned.toUpperCase();
            if (mapping[cleaned]) display.name = mapping[cleaned];
            else if (mapping[finalRaw]) display.name = mapping[finalRaw];

            // 5. CATEGORY DETECTION
            const lowerRaw = finalRaw.toLowerCase();
            const noteLower = (t.note || '').toLowerCase();

            if (finalRaw === 'INCOME' || finalRaw.includes('SALARY') || finalRaw.includes('DIVIDEND') || finalRaw.includes('REFUND SOURCE')) {
                display.category = 'Income';
                display.icon = 'savings';
                display.catClass = 'cat-income';
            } else {
                // Feature 2: Keyword-based Smart Categorization
                const keywordMap = [
                    { cat: 'Online shopping', key: ['shopee', 'tiktok', 'lazada', 'shein', 'temu', 'shopify', 'grabfood', 'foodpanda', 'amazon', 'ebay'] },
                    { cat: 'Shopping', key: ['mall', 'supermet', 'gaisano', 'mr diy', 'watsons', 'sm store', 'sm superm', 'robinsons', 'kkv', 'miniso', 'unitop', 'h&m', 'uniqlo'] },
                    { cat: 'Vehicle', key: ['tecfuel', 'shell', 'petron', 'seaoil', 'ptt', 'caltex', 'cleanfuel', 'fuel', 'gas', 'toyota', 'honda', 'mitsub', 'car wash', 'autoshop'] },
                    { cat: 'Food & Drinks', key: ['jollibee', 'mcdo', 'mcdonald', 'starbucks', 'chowking', 'kfc', 'mang inasal', 'greenwich', 'ribshack', 'coffee', 'resto', 'cafe', 'tea', 'bakery', 'j.co', 'dunkin', 'boba', 'pizza'] },
                    { cat: 'Service', key: ['globe', 'smart', 'pldt', 'tm', 'gomo', 'netflix', 'spotify', 'youtube', 'disney', 'prime', 'apple', 'icloud', 'google', 'subscription', 'bill', 'insurance', 'philhealth', 'sss', 'pag-ibig', 'veco', 'mcwd'] },
                    { cat: 'Transportation', key: ['grab car', 'grab ride', 'taxi', 'move it', 'joyride', 'angkas', 'jeep', 'bus', 'ferry', 'pier', 'airport', 'airline'] },
                    { cat: 'Education', key: ['school', 'university', 'tuition', 'book', 'udemy', 'coursera', 'skillshare', 'training'] },
                    { cat: 'Life & Entertainment', key: ['cinema', 'movie', 'game', 'playstation', 'xbox', 'steam', 'valve', 'riot', 'epic', 'skating', 'zoo', 'park', 'concert', 'spotify', 'netflix'] }
                ];

                for (const map of keywordMap) {
                    if (map.key.some(k => lowerRaw.includes(k) || noteLower.includes(k))) {
                        const findCat = CATEGORIES.find(c => c.id === map.cat);
                        if (findCat) {
                            display.category = findCat.id;
                            display.icon = findCat.icon;
                            display.catClass = findCat.cls || 'cat-financial';
                            display.autoSuggested = true; 
                            break;
                        }
                    }
                }

                if (finalRaw.includes('TRADERSCONNECT') || finalRaw.includes('TRADERS CONNECT')) {
                    display.category = 'Trade Copier';
                    display.icon = 'hub';
                    display.catClass = 'cat-aqua';
                } else if (finalRaw.includes('EQUITY EDGE') || finalRaw.includes('ANALYTICS') || finalRaw.includes('TRADING') || finalRaw.includes('LEVERAGE FUND') || finalRaw.includes('MRCRMT')) {
                    display.category = 'Trading Expenses';
                    display.icon = 'insights';
                    display.catClass = 'cat-trading';
                } else {
                    // Default fallback if no keyword matched
                    if (display.category === 'Financial expenses' || !display.category) {
                        display.category = 'Financial expenses';
                        display.catClass = 'cat-financial';
                    }
                }
            }

            return display;
        }

        function log(msg, type = 'info') {
            const container = document.getElementById('log-container');
            if (!container) return;
            const div = document.createElement('div');
            div.className = `log-entry ${type === 'error' ? 'log-error' : ''}`;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- MANUAL TRANSACTION LOGIC (INTEGRATED) ---
        let selectedManualCatId = 'Financial Expenses'; 
        let manualTxnType = 'expense';

        window.setTxnType = (type) => {
            manualTxnType = type;
            const btnExp = document.getElementById('btn-expense');
            const btnInc = document.getElementById('btn-income');
            
            if (type === 'expense') {
                btnExp.style.background = '#ef4444'; 
                btnExp.style.color = '#fff';
                btnExp.style.boxShadow = '0 4px 10px rgba(239, 68, 68, 0.3)';
                
                btnInc.style.background = 'transparent';
                btnInc.style.color = '#64748b';
                btnInc.style.boxShadow = 'none';
                
                // Show category section for expenses
                document.getElementById('category-section').style.display = 'block';
                if (!window.editingTxnId) selectedManualCatId = 'Financial Expenses';
            } else {
                btnInc.style.background = '#10b981';
                btnInc.style.color = '#fff';
                btnInc.style.boxShadow = '0 4px 10px rgba(16, 185, 129, 0.3)';
                
                btnExp.style.background = 'transparent';
                btnExp.style.color = '#64748b';
                btnExp.style.boxShadow = 'none';
                
                // Hide category section for income (only one category)
                document.getElementById('category-section').style.display = 'none';
                selectedManualCatId = 'Income';
            }
            renderManualCategories();
        };

        window.updateManualAccountUI = (val) => {
            const iconBox = document.getElementById('manual-account-icon-box');
            if (iconBox) {
                if (val === 'bpi') {
                    iconBox.style.background = '#8b0000'; // BPI Red
                } else {
                    iconBox.style.background = '#1a1a1a'; // Atome Black
                }
            }
        };

        window.openManualTxnModal = () => {
            window.editingTxnId = null; // Clear edit mode
            document.getElementById('manual-amt').value = '';
            document.getElementById('manual-merchant').value = '';
            document.getElementById('manual-note').value = '';
            
            // Default Account from switcher
            const activeAcc = window.currentAccount || 'atome';
            document.getElementById('manual-account').value = activeAcc;
            updateManualAccountUI(activeAcc);
            
            // Default Category
            selectedManualCatId = 'Financial Expenses';
            setTxnType('expense');
            
            // Set Date Input to Today
            const d = new Date().toISOString().split('T')[0];
            document.getElementById('manual-date').value = d;
            
            // Enable Button
            const btn = document.getElementById('done-btn');
            btn.style.pointerEvents = 'auto';
            btn.style.opacity = '1';
            
            // Update modal title
            document.getElementById('modal-title').innerText = 'New Transaction';

            renderManualCategories();
            document.getElementById('manual-txn-modal').classList.add('show');
            
            // ALLOW scroll (as requested)
            // const wrapper = document.querySelector('.mobile-wrapper');
            // if (wrapper) wrapper.style.overflow = 'hidden';
            // document.body.style.overflow = 'hidden';
            
            setTimeout(() => document.getElementById('manual-amt').focus(), 300);
        };

        window.openEditModal = (txnId, merchant, amount, category, note) => {
            window.editingTxnId = txnId; // Set edit mode
            window.originalAccount = window.currentAccount || (txnId.startsWith('bpi_') ? 'bpi' : 'atome'); 
            
            // Find the transaction to get all its data
            const txn = window.allTxns.find(t => t.id === txnId);
            if (!txn) return;
            
            // Populate fields
            document.getElementById('manual-amt').value = amount;
            document.getElementById('manual-merchant').value = merchant;
            document.getElementById('manual-note').value = note || '';
            
            // Account (Determine from current active if unknown, but usually we know)
            const activeAcc = window.currentAccount || 'atome';
            document.getElementById('manual-account').value = activeAcc;
            updateManualAccountUI(activeAcc);
            
            // Set date
            const d = new Date(txn.date);
            document.getElementById('manual-date').value = d.toISOString().split('T')[0];
            
            // Set category
            selectedManualCatId = txn.manualCategory || category;
            
            // Determine type based on category
            if (category === 'Income') {
                setTxnType('income');
            } else {
                setTxnType('expense');
            }
            
            // Disable Button to prevent double taps
            const btn = document.getElementById('done-btn');
            btn.style.pointerEvents = 'auto';
            btn.style.opacity = '1';
            btn.innerHTML = 'Done';
            
            // Update modal title
            document.getElementById('modal-title').innerText = 'Edit Transaction';

            renderManualCategories();
            document.getElementById('manual-txn-modal').classList.add('show');
            
            // ALLOW body scroll
            // document.body.style.overflow = 'hidden';
            
            setTimeout(() => document.getElementById('manual-amt').focus(), 100);
        };

        window.renderManualCategories = () => {
            const list = document.getElementById('manual-cat-list');
            // Filter out Income category when in expense mode
            const categoriesToShow = manualTxnType === 'expense' 
                ? CATEGORIES.filter(cat => cat.id !== 'Income')
                : CATEGORIES.filter(cat => cat.id === 'Income');
            
            list.innerHTML = categoriesToShow.map(cat => {
                const isSelected = cat.id === selectedManualCatId;
                let bgStyle = '#f1f5f9';
                let colorStyle = '#64748b';
                
                if (isSelected) {
                     if (cat.cls.includes('food')) { bgStyle = '#fefce8'; colorStyle = '#ca8a04'; } // Yellow
                     else if (cat.cls.includes('online')) { bgStyle = '#fff7ed'; colorStyle = '#ea580c'; } // Orange
                     else if (cat.cls.includes('shopping')) { bgStyle = '#f0f9ff'; colorStyle = '#0284c7'; } // Blue
                     else if (cat.cls.includes('vehicle')) { bgStyle = '#f5f3ff'; colorStyle = '#8b5cf6'; }
                     else if (cat.cls.includes('cat-aqua')) { bgStyle = '#ecfeff'; colorStyle = '#0891b2'; } // Dark Aqua
                     else if (cat.cls.includes('Service') || cat.cls.includes('magenta')) { bgStyle = '#fdf4ff'; colorStyle = '#d946ef'; } // Magenta
                     else if (cat.cls.includes('cat-education')) { bgStyle = '#eff6ff'; colorStyle = '#1d4ed8'; } // Dark Blue
                     else if (cat.label.includes('Financial') || cat.label.includes('Trading')) { bgStyle = '#fef2f2'; colorStyle = '#ef4444'; } // Red
                     else { bgStyle = '#f0fdf4'; colorStyle = '#10b981'; } 
                }

                return `
                <div class="manual-cat-item ${isSelected ? 'selected' : ''}" onclick="selectManualCategory('${cat.id}')">
                    <div class="manual-cat-circle" style="background: ${bgStyle}; color: ${colorStyle};">
                        <i class="material-icons">${cat.icon}</i>
                    </div>
                    <span style="font-size: 11px; font-weight: 600; color: #1e293b; text-align: center;">${cat.label}</span>
                </div>
                `;
            }).join('');
        };

        window.selectManualCategory = (id) => {
            selectedManualCatId = id;
            renderManualCategories();
        };

        window.saveManualTxn = async () => {
            if (auth.currentUser?.isAnonymous) {
                if (confirm('Your data is in "Local Mode". Sign in with Google to permanently save this to the cloud?')) {
                    handleAuthClick();
                    return;
                }
            }
            const btn = document.getElementById('done-btn');
            const amtVal = document.getElementById('manual-amt').value;
            const selectedAccount = document.getElementById('manual-account').value;
            
            if (!amtVal || parseFloat(amtVal) <= 0) {
                showToast('Enter valid amount');
                return;
            }
            
            // Disable button
            btn.style.pointerEvents = 'none';
            btn.style.opacity = '0.5';
            
            let note = document.getElementById('manual-note').value.trim();
            // Enforce Title Case
            if (note) {
                note = note.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
            }

            const dateVal = document.getElementById('manual-date').value;
            const dateObj = dateVal ? new Date(dateVal) : new Date();
            
            const cat = CATEGORIES.find(c => c.id === selectedManualCatId);
            
            const merchantName = document.getElementById('manual-merchant').value.trim();
            
            try {
                if (!auth.currentUser) return;
                const uid = auth.currentUser.uid;
                
                // Show loader on button
                btn.style.pointerEvents = 'none';
                btn.style.opacity = '0.7';
                btn.innerHTML = '<i class="material-icons spin" style="font-size:16px;">sync</i>';

                const updateData = {
                    date: dateObj.toISOString().split('T')[0],
                    amount: parseFloat(amtVal),
                    manualAmount: parseFloat(amtVal),
                    merchant: merchantName || (cat ? cat.label : 'Transaction'),
                    note: note || '',
                    manualCategory: selectedManualCatId,
                    category: selectedManualCatId,
                    type: manualTxnType
                };

                // Use the selected account in the modal
                const col = getCollectionName(selectedAccount);

                if (window.editingTxnId) {
                    const origAcc = window.originalAccount || (window.editingTxnId.startsWith('bpi_') ? 'bpi' : 'atome');
                    const originalCol = origAcc === 'atome' ? "transactions" : "bpi_transactions";
                    
                    if (selectedAccount !== origAcc) {
                        // MOVE TRANSACTION: Delete from old, Add to new (Keep same ID for consistency)
                        await deleteDoc(doc(db, "users", uid, originalCol, window.editingTxnId));
                        await setDoc(doc(db, "users", uid, col, window.editingTxnId), {
                            ...updateData,
                            createdAt: serverTimestamp()
                        });
                        showToast('Transaction moved & updated');
                    } else {
                        // Regular UPDATE
                        await updateDoc(doc(db, "users", uid, col, window.editingTxnId), updateData);
                        showToast('Transaction updated');
                    }
                } else {
                    // NEW TRANSACTION
                    await addDoc(collection(db, "users", uid, col), {
                        ...updateData,
                        createdAt: serverTimestamp()
                    });
                    showToast('Transaction saved');
                }
                
                closeModals();
            } catch (e) {
                console.error(e);
                showToast('Error saving');
            } finally {
                // Restore button
                btn.style.pointerEvents = 'auto';
                btn.style.opacity = '1';
                btn.innerHTML = 'Done';
            }
        };

        // NEW: TRANSACTION FILTERS & LOGO TOGGLE
        let showLogos = true;
        
        window.toggleLogos = () => {
            showLogos = !showLogos;
            const icon = document.getElementById('logo-toggle-icon');
            const wrapper = document.querySelector('.logo-toggle-wrapper');
            
            if (showLogos) {
                icon.innerText = 'visibility';
                icon.style.color = '#0284c7';
                wrapper.style.background = '#e0f2fe';
                document.querySelectorAll('.brand-badge').forEach(b => b.style.display = 'flex');
            } else {
                icon.innerText = 'visibility_off';
                icon.style.color = '#94a3b8';
                wrapper.style.background = '#f1f5f9';
                document.querySelectorAll('.brand-badge').forEach(b => b.style.display = 'none');
            }
        };

        window.filterTxnList = () => {
            const catSelection = document.getElementById('txn-cat-filter').value;
            const keyword = (document.getElementById('txn-search')?.value || '').toLowerCase().trim();
            const cleanKeyword = keyword.replace(/,/g, '');
            
            const accordions = document.querySelectorAll('.month-accordion');
            
            accordions.forEach(acc => {
                const txns = acc.querySelectorAll('.premium-txn');
                let visibleCount = 0;
                let filteredTotal = 0;
                
                txns.forEach(t => {
                    const itemCatId = t.dataset.category || '';
                    const itemCatLabel = displayCategoryName(itemCatId);
                    const merchantName = (t.dataset.merchant || '').toLowerCase();
                    const note = (t.dataset.note || '').toLowerCase();
                    const amount = (t.dataset.amount || '').toString();
                    const cleanAmount = amount.replace(/,/g, '');
                    
                    const matchCat = (catSelection === 'all') || 
                                   (itemCatId.toLowerCase() === catSelection.toLowerCase()) || 
                                   (itemCatLabel.toLowerCase() === catSelection.toLowerCase());

                    const matchKeyword = !keyword || 
                                       merchantName.includes(keyword) || 
                                       note.includes(keyword) || 
                                       amount.includes(keyword) || 
                                       (cleanKeyword.length > 0 && cleanAmount.includes(cleanKeyword));

                    if (matchCat && matchKeyword) {
                        t.style.display = 'flex';
                        visibleCount++;
                        
                        // Calculate total for header
                        const isExcluded = t.classList.contains('txn-excluded') || t.dataset.excluded === 'true';
                        const isRefund = t.dataset.refund === 'true';
                        
                        if (!isExcluded && !isRefund) {
                             const amt = parseFloat(t.dataset.amount) || 0;
                             const isIncome = (itemCatId === 'Income' || itemCatLabel === 'Income');
                             
                             if (catSelection === 'all') {
                                 // Default: Total = Sum of all non-income expenses
                                 if (!isIncome) filteredTotal += amt;
                             } else {
                                 // Specific filter: Sum everything that matched (Income or Expense)
                                 filteredTotal += amt;
                             }
                        }
                    } else {
                        t.style.display = 'none';
                    }
                });

                // Update Header Total for this month
                const totalEl = acc.querySelector('.month-total');
                if (totalEl) {
                    const isHidden = localStorage.getItem('balance_hidden') === 'true';
                    totalEl.dataset.raw = `${filteredTotal.toLocaleString(undefined, {minimumFractionDigits:2})}`;
                    totalEl.innerText = isHidden ? '******' : totalEl.dataset.raw;
                }

                // Auto-expand if search results found (only for specific searches >= 3 chars)
                const content = acc.querySelector('.month-content');
                const header = acc.querySelector('.month-header');
                const month = header.querySelector('.month-title').innerText;
                
                if (keyword.length >= 3 && visibleCount > 0) {
                    content.classList.remove('collapsed');
                    header.classList.remove('collapsed');
                } else if (keyword.length === 0) {
                    // Restore state from localStorage or default when search is cleared
                    const savedState = localStorage.getItem(`accordion_${month}`);
                    const index = Array.from(accordions).indexOf(acc);
                    const shouldBeCollapsed = savedState === 'collapsed' || (savedState === null && index !== 0);
                    
                    if (shouldBeCollapsed) {
                        content.classList.add('collapsed');
                        header.classList.add('collapsed');
                    } else {
                        content.classList.remove('collapsed');
                        header.classList.remove('collapsed');
                    }
                }

                // Hide the whole accordion if no visible items
                acc.style.display = visibleCount > 0 ? 'block' : 'none';
            });

            // Update Trends Chart based on filtered transactions
            if (window.allTxns) {
                const filteredTxns = window.allTxns.filter(t => {
                    const mapped = getMerchantDisplay(t.merchant, t);
                    const itemCatId = mapped.category || '';
                    const itemCatLabel = displayCategoryName(itemCatId);
                    const merchantName = (t.merchant || '').toLowerCase();
                    const note = (t.note || '').toLowerCase();
                    const amount = (t.amount || (t.manualAmount || 0)).toString();
                    const cleanAmount = amount.replace(/,/g, '');

                    const matchCat = (catSelection === 'all') || 
                                   (itemCatId.toLowerCase() === catSelection.toLowerCase()) || 
                                   (itemCatLabel.toLowerCase() === catSelection.toLowerCase());

                    const matchKeyword = !keyword || 
                                       merchantName.includes(keyword) || 
                                       note.includes(keyword) || 
                                       amount.includes(keyword) || 
                                       (cleanKeyword.length > 0 && cleanAmount.includes(cleanKeyword));
                    
                    return matchCat && matchKeyword;
                });
                drawTrendChart(filteredTxns);
            }
        };

        window.handleSearchInput = () => {
            const val = document.getElementById('txn-search').value;
            const clearBtn = document.getElementById('search-clear-btn');
            if (clearBtn) {
                if (val.length > 0) clearBtn.classList.add('active');
                else clearBtn.classList.remove('active');
            }
            filterTxnList();
        };

        window.clearSearch = () => {
            const input = document.getElementById('txn-search');
            input.value = '';
            document.getElementById('search-clear-btn').classList.remove('active');
            filterTxnList();
            input.focus();
        };

        // SMART BUDGETING LOGIC
        window.promptSetBudget = () => {
            const currentLimit = localStorage.getItem(`budget_${window.currentAccount}`) || '0';
            showAppDialog({
                title: 'Set Monthly Budget',
                message: 'Enter your maximum monthly spending goal (PHP).',
                input: true,
                value: currentLimit,
                callback: (limit) => {
                    if (limit !== null && limit !== false && !isNaN(limit)) {
                        localStorage.setItem(`budget_${window.currentAccount}`, limit);
                        updateBudgetUI();
                        showToast('Monthly budget updated!');
                    }
                }
            });
        };

        window.updateBudgetUI = () => {
            const limit = parseFloat(localStorage.getItem(`budget_${window.currentAccount}`)) || 0;
            const limitEl = document.getElementById('budget-limit');
            const spentEl = document.getElementById('budget-spent');
            const fillEl = document.getElementById('budget-fill');
            const card = document.getElementById('budget-card-section');

            if (!limit || limit <= 0) {
                if (card) card.style.display = 'none';
                return;
            }
            if (card) card.style.display = 'block';

            // Calculate spent this month
            let totalSpent = 0;
            if (window.allTxns) {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                window.allTxns.forEach(t => {
                    const d = new Date(t.date);
                    if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                        const mapped = getMerchantDisplay(t.merchant, t);
                        // Only count non-income, non-refunded, non-excluded expenses
                        if (!t.excluded && !t.refund && mapped.category !== 'Income') {
                            const amt = t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0);
                            totalSpent += Math.abs(amt);
                        }
                    }
                });
            }

            const percent = Math.min((totalSpent / limit) * 100, 100);
            
            // UI Updates
            limitEl.innerText = `${limit.toLocaleString()} limit`;
            spentEl.innerText = `${totalSpent.toLocaleString(undefined, {minimumFractionDigits:2})} spent`;
            fillEl.style.width = `${percent}%`;

            // Color logic
            if (percent >= 100) {
                fillEl.style.background = '#ef4444'; // Red
                spentEl.style.color = '#ef4444';
            } else if (percent >= 80) {
                fillEl.style.background = '#f59e0b'; // Amber
                spentEl.style.color = '#f59e0b';
            } else {
                fillEl.style.background = '#10b981'; // Green
                spentEl.style.color = '#64748b';
            }

            // Alerts (Throttle to prevent spam)
            const lastAlert = sessionStorage.getItem(`budget_alert_${window.currentAccount}`);
            if (percent >= 100 && lastAlert !== '100') {
                showToast(' Budget limit reached!', 5000);
                sessionStorage.setItem(`budget_alert_${window.currentAccount}`, '100');
            } else if (percent >= 80 && lastAlert !== '80' && lastAlert !== '100') {
                showToast(' 80% of budget reached.', 4000);
                sessionStorage.setItem(`budget_alert_${window.currentAccount}`, '80');
            }
        };

        // PRIVACY LOCK LOGIC
        let pinInputBuffer = "";
        window.handlePinInput = (val) => {
            if (val === 'back') {
                pinInputBuffer = pinInputBuffer.slice(0, -1);
            } else if (pinInputBuffer.length < 4) {
                pinInputBuffer += val;
            }
            updatePinDots();
            if (pinInputBuffer.length === 4) {
                setTimeout(checkPin, 200);
            }
        };

        const updatePinDots = () => {
            const dots = document.querySelectorAll('#privacy-lock .pin-dot');
            dots.forEach((dot, idx) => {
                if (idx < pinInputBuffer.length) dot.classList.add('active');
                else dot.classList.remove('active');
            });
        };

        const checkPin = () => {
            const storedPin = localStorage.getItem('wallet_privacy_pin');
            if (pinInputBuffer === storedPin) {
                document.getElementById('privacy-lock').style.display = 'none';
                sessionStorage.setItem('wallet_unlocked', 'true');
                showToast('Wallet Unlocked');
            } else {
                showToast('Incorrect PIN', 2000);
                pinInputBuffer = "";
                updatePinDots();
                const dotsWrap = document.getElementById('pin-dots');
                dotsWrap.style.animation = 'shake 0.3s';
                setTimeout(() => dotsWrap.style.animation = '', 300);
            }
        };

        window.promptSetPin = () => {
            const currentPin = localStorage.getItem('wallet_privacy_pin');
            if (currentPin) {
                showAppDialog({
                    title: 'Verify Identity',
                    message: 'Enter current PIN to change security settings.',
                    input: true,
                    callback: (oldInput) => {
                        if (oldInput !== currentPin) return showToast("Wrong PIN. Access denied.");
                        requestNewPin();
                    }
                });
            } else {
                requestNewPin();
            }

            function requestNewPin() {
                showAppDialog({
                    title: 'New Privacy PIN',
                    message: 'Enter new 4-digit PIN (Numbers only) or leave empty to disable.',
                    input: true,
                    callback: (newPin) => {
                        if (newPin && newPin.length === 4 && !isNaN(newPin)) {
                            localStorage.setItem('wallet_privacy_pin', newPin);
                            showToast("PIN set successfully!");
                        } else if (newPin === "" || newPin === null) {
                            localStorage.removeItem('wallet_privacy_pin');
                            showToast("PIN Security Disabled");
                        } else if (newPin !== false) {
                            showToast("Invalid PIN format.");
                        }
                    }
                });
            }
        };

        window.initPrivacyLock = () => {
            const pin = localStorage.getItem('wallet_privacy_pin');
            const isUnlocked = sessionStorage.getItem('wallet_unlocked') === 'true';
            if (pin && !isUnlocked) {
                document.getElementById('privacy-lock').style.display = 'flex';
                if (window.PublicKeyCredential) {
                    document.getElementById('bio-btn').style.display = 'flex';
                }
            }
        };

        window.tryBiometricUnlock = async () => {
            // Simplified biometric check - in a real app, this would use WebAuthn credentials
            const confirmed = await showAppDialog({
                title: 'Biometric Unlock',
                message: 'Authenticate using FaceID / Fingerprint?',
                confirm: true
            });
            if (confirmed) {
                document.getElementById('privacy-lock').style.display = 'none';
                sessionStorage.setItem('wallet_unlocked', 'true');
                showToast('Authenticated via Biometrics');
            }
        };

        // ANALYTICS LOGIC (BAR CHART)
        window.drawCashFlowChart = () => {
            const container = document.getElementById('cashflow-bars');
            if (!container || !window.allTxns) return;

            // Get last 6 months
            const months = [];
            for (let i = 5; i >= 0; i--) {
                const d = new Date();
                d.setDate(1); // Avoid month skipping near end of month
                d.setMonth(d.getMonth() - i);
                months.push({
                    name: d.toLocaleDateString('en-US', { month: 'short' }),
                    month: d.getMonth(),
                    year: d.getFullYear(),
                    income: 0,
                    expense: 0
                });
            }

            // Aggregate data
            window.allTxns.forEach(t => {
                const d = new Date(t.date);
                const mIdx = months.findIndex(m => m.month === d.getMonth() && m.year === d.getFullYear());
                if (mIdx > -1) {
                    const mapped = getMerchantDisplay(t.merchant, t);
                    const amt = Math.abs(t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0));
                    if (!t.excluded && !t.refund) {
                        if (mapped.category === 'Income') months[mIdx].income += amt;
                        else months[mIdx].expense += amt;
                    }
                }
            });

            // Find max for scaling
            const maxVal = Math.max(...months.map(m => Math.max(m.income, m.expense)), 1000);
            
            // Render Bars
            let html = '';
            months.forEach(m => {
                const incH = (m.income / maxVal) * 80;
                const expH = (m.expense / maxVal) * 80;
                html += `
                    <div class="bar-group">
                        <div class="bars-pair">
                            <div class="bar bar-income" style="height: ${incH}px;" title="Income: ${m.income.toLocaleString()}"></div>
                            <div class="bar bar-expense" style="height: ${expH}px;" title="Expense: ${m.expense.toLocaleString()}"></div>
                        </div>
                        <div class="bar-label">${m.name}</div>
                    </div>
                `;
            });
            container.innerHTML = html;

            // Savings Rate for current month
            const current = months[months.length - 1];
            const rate = current.income > 0 ? ((current.income - current.expense) / current.income) * 100 : 0;
            const rateEl = document.getElementById('savings-rate-val');
            if (rateEl) {
                rateEl.innerText = `${Math.max(0, rate).toFixed(1)}%`;
                const chip = rateEl.closest('.savings-chip');
                if (chip) chip.style.background = rate > 0 ? '#dcfce7' : '#fee2e2';
                if (chip) chip.style.color = rate > 0 ? '#166534' : '#991b1b';
            }
        };

        // SUBSCRIPTION DETECTION LOGIC
        // SUBSCRIPTION DETECTION LOGIC (WITH AVERAGES)
        window.detectSubscriptions = () => {
            const container = document.getElementById('subscription-list');
            const section = document.getElementById('subscription-section');
            if (!container || !window.allTxns) return;

            // Context: Current month for comparison
            const now = new Date(); 
            const targetMonth = now.getMonth();
            const targetYear = now.getFullYear();

            // Group by Merchant + Month
            const merchantData = {};
            window.allTxns.forEach(t => {
                const mapped = getMerchantDisplay(t.merchant, t);
                if (t.excluded || t.refund || mapped.category === 'Income') return;
                
                const amt = Math.abs(t.manualAmount !== undefined ? t.manualAmount : (t.amount || 0));
                if (amt < 50) return;

                const merchantKey = mapped.name.toLowerCase();
                const d = new Date(t.date);
                const monthKey = `${d.getMonth()}-${d.getFullYear()}`;

                if (!merchantData[merchantKey]) {
                    merchantData[merchantKey] = {
                        name: mapped.name,
                        icon: mapped.logo || 'receipt_long',
                        monthlySpend: {},
                        countMonths: 0,
                        currentMonthSpend: 0,
                        averageSpend: 0
                    };
                }

                if (!merchantData[merchantKey].monthlySpend[monthKey]) {
                    merchantData[merchantKey].monthlySpend[monthKey] = 0;
                }
                merchantData[merchantKey].monthlySpend[monthKey] += amt;
            });

            const subs = [];
            Object.values(merchantData).forEach(m => {
                const monthKeys = Object.keys(m.monthlySpend);
                if (monthKeys.length < 1) return;

                // Sort month keys chronologically: "M-YYYY"
                const sortedKeys = monthKeys.sort((a,b) => {
                    const [ma, ya] = a.split('-').map(Number);
                    const [mb, yb] = b.split('-').map(Number);
                    return ya === yb ? ma - mb : ya - yb;
                });

                // Check for 4 consecutive months
                let maxConsecutive = 0;
                let currentConsecutive = 0;
                let lastMonthIndex = -1;

                sortedKeys.forEach(k => {
                    const [mon, yr] = k.split('-').map(Number);
                    const monthIndex = yr * 12 + mon;
                    if (lastMonthIndex === -1 || monthIndex === lastMonthIndex + 1) {
                        currentConsecutive++;
                    } else {
                        currentConsecutive = 1;
                    }
                    lastMonthIndex = monthIndex;
                    if (currentConsecutive > maxConsecutive) maxConsecutive = currentConsecutive;
                });

                const mName = m.name.toLowerCase();
                const isWhitelisted = mName.includes('spotify') || mName.includes('traders connect');
                
                if (!isWhitelisted && maxConsecutive < 4) return;

                const currentKey = `${targetMonth}-${targetYear}`;
                m.currentMonthSpend = m.monthlySpend[currentKey] || 0;

                let historicalSum = 0;
                let historicalCount = 0;
                monthKeys.forEach(k => {
                    if (k !== currentKey) {
                        historicalSum += m.monthlySpend[k];
                        historicalCount++;
                    }
                });

                // If we have history, use average. If only current (whitelisted), use current.
                m.averageSpend = historicalCount > 0 ? (historicalSum / historicalCount) : m.currentMonthSpend;
                subs.push(m);
            });

            if (subs.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            let totalCurrent = 0;
            let totalAvg = 0;

            container.innerHTML = subs.sort((a,b) => b.currentMonthSpend - a.currentMonthSpend).map(g => {
                totalCurrent += g.currentMonthSpend;
                totalAvg += g.averageSpend;
                const perc = g.averageSpend > 0 ? (g.currentMonthSpend / g.averageSpend) * 100 : 0;
                const statusColor = g.currentMonthSpend > g.averageSpend ? '#ef4444' : '#10b981';
                const barColor = g.currentMonthSpend > g.averageSpend ? '#ef4444' : '#3b82f6';

                return `
                <div class="subscription-item">
                    <div class="sub-main-row">
                        <div class="sub-icon">
                            ${g.icon.length > 20 ? `<img src="${g.icon}" style="width:20px; border-radius:5px;">` : `<i class="material-icons">${g.icon}</i>`}
                        </div>
                        <div class="sub-info">
                            <div class="sub-name">${g.name}</div>
                            <div class="sub-meta">Avg: ${g.averageSpend.toLocaleString(undefined, {maximumFractionDigits:0})} / mo</div>
                        </div>
                        <div class="sub-stats">
                            <div class="sub-current-vs-avg" style="font-weight: 800; font-size: 11px;">
                                <span style="color: ${statusColor};">${g.currentMonthSpend.toLocaleString(undefined, {maximumFractionDigits:0})}</span>
                                <span style="color: #cbd5e1; margin: 0 2px;">/</span>
                                <span style="color: #94a3b8;">${g.averageSpend.toLocaleString(undefined, {maximumFractionDigits:0})}</span>
                            </div>
                        </div>
                    </div>
                    <div class="sub-item-progress-bg">
                        <div class="sub-item-progress-fill" style="width: ${Math.min(100, perc)}%; background: ${barColor};"></div>
                    </div>
                </div>
                `;
            }).join('');

            // Update UI Labels for Total
            const limit = parseFloat(localStorage.getItem('wallet_sub_limit') || totalAvg);
            document.getElementById('sub-count-badge').innerText = subs.length;
            document.getElementById('sub-total-label').innerText = `${totalCurrent.toLocaleString(undefined, {minimumFractionDigits:2})} spent`;
            document.getElementById('sub-limit-label').innerText = `Target: ${limit.toLocaleString(undefined, {maximumFractionDigits:0})}`;
            
            const totalPerc = limit > 0 ? (totalCurrent / limit) * 100 : 0;
            const fill = document.getElementById('sub-limit-fill');
            fill.style.width = Math.min(100, totalPerc) + '%';
            
            // Premium color for main bar
            fill.style.background = totalPerc >= 100 ? '#ef4444' : '#000'; // Black theme or Red if over

            // Ensure divider exists after progress bar
            let divider = document.getElementById('sub-main-divider');
            if (!divider) {
                divider = document.createElement('div');
                divider.id = 'sub-main-divider';
                divider.style = "height: 1px; background: #f1f5f9; margin: 15px 0 5px; width: 100%;";
                document.querySelector('.sub-limit-bar').after(divider);
            }
        };

        window.updateSubAmount = (name, val) => {
            const num = parseFloat(val);
            if (isNaN(num)) return;
            showToast(`Target updated for ${name}`);
            detectSubscriptions();
        };

        window.promptSetSubLimit = () => {
            showAppDialog({
                title: 'Set Target Spend',
                message: 'Adjust the total spend limit for recurring items.',
                input: true,
                value: localStorage.getItem('wallet_sub_limit') || '5000',
                callback: (val) => {
                    if (val) {
                        localStorage.setItem('wallet_sub_limit', val);
                        detectSubscriptions();
                        showToast('Target updated');
                    }
                }
            });
        };

        // NEW: Independent Trend Chart Logic
        window.refreshTrendChart = () => {
            if (!window.allTxns) return;
            drawTrendChart(window.allTxns);
        };

        // Override injectBrandLogos to respect visibility
        const originalInject = injectBrandLogos;
        injectBrandLogos = () => {
            const txns = document.querySelectorAll('.premium-txn');
            txns.forEach(txn => {
                const merchantEl = txn.querySelector('.txn-merch');
                if (!merchantEl) return;
                const merchantName = merchantEl.textContent.toUpperCase();
                const iconBox = txn.querySelector('.icon-box');
                if (!iconBox || iconBox.querySelector('.brand-badge')) return;
                
                let logo = null;
                if (merchantName.includes('JOLLIBEE')) logo = 'logos/jollibee.png';
                else if (merchantName.includes('MCDO') || merchantName.includes('MCDONALDS')) logo = 'logos/mcdo.png';
                else if (merchantName.includes('SHELL')) logo = 'logos/shell.png';
                else if (merchantName.includes('SHOPEE')) logo = 'logos/shopee.png';
                else if (merchantName.includes('LAZADA')) logo = 'logos/lazada.jpg';
                else if (merchantName.includes('GLOBE') || merchantName.includes('GOMO')) logo = 'logos/globe.png';
                else if (merchantName.includes('SM ') || merchantName.includes('SM STORE') || merchantName.includes('SM SUPERMARKET')) logo = 'logos/sm.png';
                else if (merchantName.includes('SPOTIFY')) logo = 'logos/spotify.png';
                else if (merchantName.includes('TIKTOK')) logo = 'logos/tiktokshop.png';
                else if (merchantName.includes('TECFUEL') || merchantName.includes('TEC FUEL')) logo = 'logos/tecfuel.png';
                else if (merchantName.includes('TRADERS')) logo = 'logos/tradersconnect.png';
                else if (merchantName.includes('AYALA')) logo = 'logos/ayala.png';
                else if (merchantName.includes('JNL') || merchantName.includes('JL')) logo = 'logos/jandlmall.png';
                else if (merchantName.includes('J AND L') || merchantName.includes('JNL')) logo = 'logos/jandlmall.png';
                else if (merchantName.includes('MR DIY')) logo = 'logos/mrdiy.png';
                else if (merchantName.includes('WATSONS')) logo = 'logos/watsons.png';

                if (logo) {
                    const badge = document.createElement('div');
                    badge.className = 'brand-badge';
                    badge.innerHTML = `<img src="${logo}" alt="brand">`;
                    badge.style.display = showLogos ? 'flex' : 'none';
                    iconBox.appendChild(badge);
                }
            });
        };
    </script>
    
    <!-- CATEGORY MODAL -->
    <div id="cat-modal" class="modal-overlay">
        <div class="custom-modal">
            <div class="modal-header">Change Category</div>
            <p style="color: #64748b; font-size: 13px;">Select a new category for this transaction.</p>
            <div class="modal-body">
                <div id="cat-grid" class="cat-grid">
                    <!-- Categories injected here -->
                </div>
            </div>
            <div class="modal-actions">
                <div class="cancel-link" onclick="closeModals()">CANCEL</div>
            </div>
        </div>
    </div>

    <!-- NOTE MODAL -->
    <div id="note-modal" class="modal-overlay">
        <div class="custom-modal">
            <div class="modal-header">Add Note</div>
            <p style="color: #64748b; font-size: 13px;">Personalized note for this transaction.</p>
            <div class="modal-body">
                <div style="position: relative;">
                    <textarea id="note-text" class="note-input" maxlength="30" placeholder="Enter note here..."></textarea>
                    <div id="note-counter" style="position: absolute; right: 8px; bottom: 8px; font-size: 10px; color: #94a3b8; font-weight: 600;">0/30</div>
                </div>
            </div>
            <div class="modal-actions" style="margin-top: 8px; align-items: center;">
                <div class="cancel-link" onclick="closeModals()" style="letter-spacing: 0.5px; margin-right: 4px;">CANCEL</div>
                <button class="mui-btn mui-btn--raised mui-btn--primary" id="save-note-btn" style="border-radius: 10px; font-weight: 700; letter-spacing: 0.5px; padding: 0 24px; height: 42px; background-color: #2196F3;">SAVE NOTE</button>
            </div>
        </div>
    </div>

    <!-- PRICE MODAL -->
    <div id="price-modal" class="modal-overlay">
        <div class="custom-modal">
            <div class="modal-header">Change Price</div>
            <p style="color: #64748b; font-size: 13px;">Update the transaction amount manually.</p>
            <div class="modal-body">
                <div style="position: relative;">
                    <input type="number" id="price-input" class="note-input" style="min-height: auto; font-size: 18px; font-weight: 700; text-align: center;" placeholder="0.00" step="0.01">
                </div>
            </div>
            <div class="modal-actions" style="margin-top: 8px; align-items: center;">
                <div class="cancel-link" onclick="closeModals()" style="letter-spacing: 0.5px; margin-right: 4px;">CANCEL</div>
                <button class="mui-btn mui-btn--raised mui-btn--primary" onclick="savePrice()" style="border-radius: 10px; font-weight: 700; letter-spacing: 0.5px; padding: 0 24px; height: 42px; background-color: #2196F3;">SAVE PRICE</button>
            </div>
        </div>
    </div>

    <!-- AUTH TROUBLESHOOTER MODAL -->
    <div id="auth-trouble-modal" class="modal-overlay">
        <div class="custom-modal" style="border-top: 5px solid #ef4444;">
            <div class="modal-header" style="display:flex; align-items:center; gap:8px; color:#ef4444;">
                <i class="material-icons">warning</i> 
                <span>Login Error</span>
            </div>
            <div style="font-size: 14px; color: #1e293b; margin-bottom: 15px; font-weight: 600;">
                The request returned: <code id="auth-error-code" style="color:#ef4444; background:#fee2e2; padding:2px 4px; border-radius:4px;">auth/invalid-action...</code>
            </div>
            <div style="background: #f8fafc; border-radius: 12px; padding: 15px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
                <p style="font-size: 13px; font-weight: 700; color: #475569; margin: 0 0 10px 0;">Troubleshoot checklist:</p>
                <ul style="font-size: 12.5px; color: #64748b; margin: 0; padding-left: 20px; line-height: 1.6;">
                    <li><strong>Check URL:</strong> Ensure you are using <code style="font-weight:bold;">127.0.0.1:5500</code> (Not localhost if unauthorized).</li>
                    <li><strong>Authorized Domains:</strong> Add <code style="font-weight:bold;">127.0.0.1</code> to Firebase Console > Authentication > Settings.</li>
                    <li><strong>API Restrictions:</strong> Ensure your API key in Google Cloud Console allows this domain.</li>
                </ul>
            </div>
            <div class="modal-actions">
                <button class="mui-btn mui-btn--raised" onclick="closeModals()" style="border-radius:10px; font-weight:700; background:#f1f5f9; color:#475569;">CLOSE</button>
                <button class="mui-btn mui-btn--raised mui-btn--primary" onclick="window.location.reload()" style="border-radius:10px; font-weight:700;">RELOAD APP</button>
            </div>
        </div>
    </div>

    <!-- DELETE CONFIRMATION MODAL -->
    <div id="delete-modal" class="modal-overlay">
        <div class="custom-modal" style="text-align: center;">
            <div class="modal-header" style="color: #ef4444; justify-content: center; margin-bottom: 8px;">Delete Transaction?</div>
            <p style="color: #64748b; font-size: 13px; margin: 0 0 24px 0;">This action cannot be undone.</p>
            <div class="modal-actions" style="justify-content: center; gap: 16px;">
                <div class="cancel-link" onclick="closeModals()">CANCEL</div>
                <button class="mui-btn mui-btn--raised" onclick="confirmDelete()" style="border-radius: 12px; font-weight: 700; background: #ef4444; color: white; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);">DELETE</button>
            </div>
        </div>
    </div>

    <!-- UNIFIED APP DIALOG MODAL -->
    <div id="app-dialog" class="dialog-overlay">
        <div class="dialog-card">
            <div id="dialog-title" class="dialog-title">Alert</div>
            <div id="dialog-msg" class="dialog-msg">Something happened.</div>
            <div id="dialog-input-container" style="display: none;">
                <input type="text" id="dialog-input" class="dialog-input">
            </div>
            <div class="dialog-actions">
                <button id="dialog-cancel-btn" class="dialog-btn dialog-btn--cancel" style="display: none;">Cancel</button>
                <button id="dialog-ok-btn" class="dialog-btn dialog-btn--primary">OK</button>
            </div>
        </div>
    </div>

    <!-- iOS STYLE LONG PRESS ELEMENTS -->
    <div class="blur-overlay" id="blur-overlay" onclick="closeIOSMenu()"></div>
    
    <div class="ios-action-menu" id="ios-menu">
        <div class="ios-action-item" id="ios-action-edit">
            <i class="material-icons">edit</i>
            <span>Edit Transaction</span>
        </div>
        <div class="ios-action-item" id="ios-action-exclude">
            <i class="material-icons">block</i>
            <span>Exclude</span>
        </div>
        <div class="ios-action-item warning" id="ios-action-refund">
            <i class="material-icons">undo</i>
            <span>Unmark Refund</span>
        </div>
        <div class="ios-action-item danger" id="ios-action-delete">
            <i class="material-icons">delete</i>
            <span>Delete</span>
        </div>
    </div>

    <!-- MANUAL TRANSACTION MODAL -->
    <div id="manual-txn-modal" class="modal-overlay" style="align-items: flex-end; justify-content: center; backdrop-filter: blur(4px); background: rgba(0,0,0,0.4);">
        <div class="custom-modal" id="manual-modal-content" style="width: 100%; max-width: 100%; border-radius: 24px 24px 0 0; padding: 0; box-shadow: 0 -10px 40px rgba(0,0,0,0.1); height: 96vh; overflow-y: auto; position: relative; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); touch-action: pan-y;">
            
            <!-- Swipe Handle Area (includes title) -->
            <div id="modal-drag-handle" style="width: 100%; padding: max(45px, env(safe-area-inset-top)) 0 8px 0; background: white; border-radius: 24px 24px 0 0; position: sticky; top: 0; z-index: 100; cursor: grab; border-bottom: 1px solid #f1f5f9;">
                <div style="display: flex; justify-content: center; margin-bottom: 12px;">
                    <div style="width: 40px; height: 4px; background: #cbd5e1; border-radius: 2px;"></div>
                </div>
                <div style="padding: 0 20px 16px 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <i class="material-icons" onclick="closeModals()" style="color: #64748b; font-size: 28px; cursor: pointer;">close</i>
                        <div id="modal-title" style="font-weight: 800; font-size: 18px; color: #1e293b;">New Transaction</div>
                        <div id="done-btn" style="font-weight: 800; font-size: 16px; color: #10b981; cursor: pointer; text-transform: uppercase;" onclick="saveManualTxn()">Done</div>
                    </div>
                </div>
            </div>
            
            <div style="padding: 0 20px 20px 20px;">
            <!-- Toggler -->
            <div style="display: flex; background: #f1f5f9; padding: 4px; border-radius: 12px; margin-bottom: 30px;">
                <div id="btn-expense" onclick="setTxnType('expense')" style="flex: 1; padding: 8px; text-align: center; background: #ef4444; color: #fff; font-weight: 700; border-radius: 8px; font-size: 13px; box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3); transition: all 0.2s; cursor: pointer;">Expense</div>
                <div id="btn-income" onclick="setTxnType('income')" style="flex: 1; padding: 8px; text-align: center; color: #64748b; font-weight: 600; font-size: 13px; border-radius: 8px; transition: all 0.2s; cursor: pointer;">Income</div>
            </div>

            <!-- Amount Input -->
            <!-- Amount Input -->
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 12px; color: #94a3b8; font-weight: 700; letter-spacing: 1px; margin-bottom: 8px;">AMOUNT</div>
                <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                    <span style="font-size: 24px; font-weight: 700; color: #cbd5e1;">PHP</span>
                    <input type="number" id="manual-amt" placeholder="0.00" style="font-size: 48px; font-weight: 800; color: #1e293b; border: none; outline: none; width: 220px; text-align: center; background: transparent;" step="0.01">
                </div>
            </div>

            <!-- Category Section -->
            <div id="category-section" style="margin-bottom: 0;">
                <div style="font-size: 11px; color: #94a3b8; font-weight: 700; letter-spacing: 1px; margin-bottom: 12px; padding-left: 4px;">CATEGORY</div>
                <div id="manual-cat-list" style="display: flex; overflow-x: auto; gap: 20px; padding: 4px 4px 20px 4px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch;">
                    <!-- Categories injected by JS -->
                </div>
            </div>

            <!-- Details List -->
            <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 10px;">
                
                <!-- Account Selection Row -->
                <div style="display: flex; align-items: center; background: #fff; border: 1px solid #e2e8f0; padding: 12px 16px; border-radius: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
                    <div id="manual-account-icon-box" style="width: 40px; height: 40px; border-radius: 12px; background: #1a1a1a; display: flex; align-items: center; justify-content: center; margin-right: 14px; color: #fff; transition: all 0.3s ease;">
                        <i class="material-icons" style="font-size: 20px;">account_balance_wallet</i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 9px; color: #94a3b8; font-weight: 700; text-transform: uppercase; margin-bottom: 2px;">Account</div>
                        <select id="manual-account" onchange="updateManualAccountUI(this.value)" style="width: 100%; border: none; outline: none; font-size: 14px; font-weight: 700; color: #1e293b; background: transparent; padding: 0; appearance: none; -webkit-appearance: none; cursor: pointer;">
                            <option value="atome">Atome Account</option>
                            <option value="bpi">BPI Account</option>
                        </select>
                    </div>
                    <i class="material-icons" style="color: #cbd5e1; font-size: 20px;">unfold_more</i>
                </div>

                <!-- Date Row -->
                <div style="display: flex; align-items: center; background: #fff; border: 1px solid #e2e8f0; padding: 12px 16px; border-radius: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); cursor: pointer;" onclick="document.getElementById('manual-date').showPicker()">
                    <div style="width: 40px; height: 40px; border-radius: 12px; background: #f0f9ff; display: flex; align-items: center; justify-content: center; margin-right: 14px; color: #0284c7;">
                        <i class="material-icons" style="font-size: 20px;">calendar_today</i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 9px; color: #94a3b8; font-weight: 700; text-transform: uppercase; margin-bottom: 2px;">Date</div>
                        <input type="date" id="manual-date" style="border: none; outline: none; font-size: 14px; font-weight: 700; color: #1e293b; font-family: inherit; background: transparent; cursor: pointer; text-align: left; width: 100%; padding: 0;">
                    </div>
                </div>

                <!-- Merchant Name Row -->
                <div style="display: flex; align-items: center; background: #fff; border: 1px solid #e2e8f0; padding: 12px 16px; border-radius: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
                    <div style="width: 40px; height: 40px; border-radius: 12px; background: #fefce8; display: flex; align-items: center; justify-content: center; margin-right: 14px; color: #ca8a04;">
                        <i class="material-icons" style="font-size: 20px;">store</i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 9px; color: #94a3b8; font-weight: 700; text-transform: uppercase; margin-bottom: 2px;">Merchant Name</div>
                        <input type="text" id="manual-merchant" maxlength="50" placeholder="Enter merchant name..." style="width: 100%; border: none; outline: none; font-size: 14px; font-weight: 600; color: #1e293b; background: transparent; padding: 0;">
                    </div>
                </div>

                <!-- Notes Row -->
                <div style="display: flex; align-items: center; background: #fff; border: 1px solid #e2e8f0; padding: 12px 16px; border-radius: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
                    <div style="width: 40px; height: 40px; border-radius: 12px; background: #f8fafc; display: flex; align-items: center; justify-content: center; margin-right: 14px; color: #64748b;">
                        <i class="material-icons" style="font-size: 20px;">notes</i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 9px; color: #94a3b8; font-weight: 700; text-transform: uppercase; margin-bottom: 2px;">Notes</div>
                        <input type="text" id="manual-note" maxlength="30" placeholder="Add notes..." style="width: 100%; border: none; outline: none; font-size: 14px; font-weight: 600; color: #1e293b; background: transparent; padding: 0;">
                    </div>
                </div>
            </div>

            </div>
        </div>
    </div>
    
    <style>
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        /* Hide scrollbar for category list */
        #manual-cat-list::-webkit-scrollbar { display: none; }
        #manual-cat-list { -ms-overflow-style: none; scrollbar-width: none; }
        
        .manual-cat-item { display: flex; flex-direction: column; align-items: center; gap: 6px; min-width: 56px; cursor: pointer; opacity: 0.5; transition: all 0.2s; }
        .manual-cat-item.selected { opacity: 1; transform: scale(1.05); }
        .manual-cat-circle { width: 48px; height: 48px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: all 0.2s; border: 2px solid transparent; }
        .manual-cat-item.selected .manual-cat-circle { box-shadow: 0 8px 16px rgba(0,0,0,0.05); }
        .manual-cat-item span { font-size: 10px !important; }
    </style>

    <script>
        // Swipe-to-close functionality for manual transaction modal
        document.addEventListener('DOMContentLoaded', () => {
            const dragHandle = document.getElementById('modal-drag-handle');
            const modalContent = document.getElementById('manual-modal-content');
            let startY = 0;
            let currentY = 0;
            let isDragging = false;

            dragHandle.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
                isDragging = true;
                dragHandle.style.cursor = 'grabbing';
            });

            dragHandle.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                currentY = e.touches[0].clientY;
                const diff = currentY - startY;
                
                // Only allow downward swipe
                if (diff > 0) {
                    modalContent.style.transform = `translateY(${diff}px)`;
                    modalContent.style.transition = 'none';
                }
            });

            dragHandle.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;
                dragHandle.style.cursor = 'grab';
                
                const diff = currentY - startY;
                
                // If swiped down more than 100px, close the modal
                if (diff > 100) {
                    modalContent.style.transition = 'transform 0.3s ease-out';
                    modalContent.style.transform = 'translateY(100%)';
                    setTimeout(() => {
                        closeModals();
                        modalContent.style.transform = '';
                        modalContent.style.transition = '';
                    }, 300);
                } else {
                    // Snap back
                    modalContent.style.transition = 'transform 0.2s ease-out';
                    modalContent.style.transform = '';
                    setTimeout(() => {
                        modalContent.style.transition = '';
                    }, 200);
                }
            });
        });
    </script>



    <!-- TOAST BOX -->
    <div id="toast-box" class="toast-container">
        <i class="material-icons">check_circle</i>
        <span id="toast-msg">Updated</span>
    </div>

    <script>
        // --- PREVENT PINCH-TO-ZOOM ---
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });

        document.addEventListener('gesturestart', (e) => {
            e.preventDefault();
        });
    </script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>
    <script>
        // Shrink Header on Scroll
        const header = document.getElementById('header');
        // If the workspace is simulated in a mobile-wrapper with overflow
        const scrollContainer = document.querySelector('.mobile-wrapper');
        
        const handleScroll = (container) => {
            if (container.scrollTop > 50) {
                header.classList.add('shrunk');
            } else {
                header.classList.remove('shrunk');
            }
        };

        if (scrollContainer) {
            scrollContainer.addEventListener('scroll', () => handleScroll(scrollContainer));
        }
        window.addEventListener('scroll', () => handleScroll(window.document.documentElement));
    </script>
</body>
</html>