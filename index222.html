<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartWallet - AI-Powered Finance Tracker</title>
    
    <!-- Material UI CSS -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    <!-- Google API Client Libraries -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    
    <!-- Firebase SDK (Modular) -->
    <script type="module">
        // Firebase imports will be handled in the main script section
    </script>
    
    <style>
        :root {
            --primary-blue: #22C55E;
            --primary-dark: #0D1B3E;
            --accent-green: #10B981;
            --accent-red: #EF4444;
            --accent-orange: #F97316;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --bg-light: #F8FAFC;
            --white: #FFFFFF;
            
            /* Forest Green Theme */
            --forest-green: #059669;
            --forest-green-light: #10B981;
            --forest-green-dark: #047857;
            
            /* Pie Chart Colors - Exact BudgetBaker Colors */
            --pie-green: #10B981;
            --pie-dark-green: #059669;
            --pie-blue: #3B82F6;
            --pie-light-blue: #60A5FA;
            --pie-red: #EF4444;
            --pie-purple: #A855F7;
            --pie-orange: #F97316;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, #F8FAFC 0%, #E2E8F0 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Container */
        .container {
            max-width: 430px;
            margin: 0 auto;
            background: var(--white);
            min-height: 100vh;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.08);
            position: relative;
        }
        
        /* Header */
        .header {
            padding: 40px 24px 24px;
            background: linear-gradient(135deg, var(--bg-light) 0%, var(--white) 100%);
        }
        
        .greeting {
            font-size: 14px;
            color: var(--text-secondary);
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: 500;
            margin-bottom: 4px;
            animation: fadeInDown 0.6s ease;
        }
        
        .user-name {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 24px;
            animation: fadeInDown 0.6s ease 0.1s backwards;
        }
        
        .profile-icon {
            position: absolute;
            top: 40px;
            right: 24px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #E2E8F0 0%, #CBD5E1 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        /* Force Hide Login Screen for Guest Mode */
        #loginScreen { display: none !important; }
        
        .profile-icon:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* Balance Card */
        .balance-card {
            background: linear-gradient(135deg, var(--forest-green) 0%, var(--forest-green-light) 100%);
            border-radius: 24px;
            padding: 28px;
            color: var(--white);
            position: relative;
            overflow: hidden;
            animation: scaleIn 0.6s ease 0.2s backwards;
            box-shadow: 0 12px 32px rgba(5, 150, 105, 0.3);
        }
        
        .balance-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 50%;
        }
        
        .balance-card::after {
            content: '';
            position: absolute;
            bottom: -30%;
            right: 10%;
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
        }
        
        .balance-label {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 500;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }
        
        .balance-amount {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 24px;
            position: relative;
            z-index: 1;
            letter-spacing: -1px;
        }
        
        .account-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        
        .account-number {
            font-size: 13px;
            opacity: 0.8;
        }
        
        .card-circles {
            display: flex;
            gap: 8px;
        }
        
        .card-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .card-circle:nth-child(2) {
            margin-left: -12px;
            background: rgba(255, 255, 255, 0.25);
        }
        
        /* Gmail Sync Status */
        .gmail-sync {
            margin-top: 16px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }
        
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10B981;
            animation: pulse 2s ease infinite;
        }
        
        /* Main Content */
        .main-content {
            padding: 24px;
        }
        
        /* Section Header */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .more-icon {
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .more-icon:hover {
            color: var(--text-primary);
            transform: scale(1.1);
        }
        
        /* Expenses Card */
        .expenses-card {
            background: var(--white);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.04);
            animation: fadeInUp 0.6s ease 0.3s backwards;
        }
        
        .expenses-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }
        
        .expenses-info {
            flex: 1;
        }
        
        .expenses-info h3 {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-bottom: 8px;
        }
        
        .expenses-top-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .expenses-amount {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -1px;
        }
        
        .expenses-period-selector {
            padding: 6px 12px;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            background: var(--white);
            color: var(--text-primary);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Plus Jakarta Sans', sans-serif;
            min-width: 110px;
        }
        
        .expenses-period-selector:hover {
            border-color: var(--primary-blue);
            background: var(--bg-light);
        }
        
        .change-indicator {
            padding: 6px 12px;
            background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
            color: var(--accent-red);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
        }
        
        .change-indicator.positive {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            color: var(--accent-green);
        }
        
        /* Pie Chart */
        .chart-container {
            position: relative;
            width: 240px;
            height: 240px;
            margin: 0 auto 28px;
        }
        
        .chart-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: var(--white);
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }
        
        .chart-center-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .chart-center-value {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-primary);
        }
        
        /* Legend */
        .legend {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .view-details {
            text-align: center;
            margin-top: 24px;
        }
        
        .view-details a {
            color: var(--forest-green);
            font-weight: 600;
            font-size: 15px;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .view-details a:hover {
            opacity: 0.8;
        }
        
        /* Spending Trends */
        .trends-card {
            background: var(--white);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.04);
            animation: fadeInUp 0.6s ease 0.4s backwards;
        }
        
        .trends-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .period-selector {
            padding: 8px 16px;
            border: 1px solid #E2E8F0;
            border-radius: 10px;
            background: var(--white);
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        
        .period-selector:hover {
            border-color: var(--forest-green);
            background: var(--bg-light);
        }
        
        .expenses-period-selector {
            padding: 6px 12px;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            background: var(--white);
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        
        .expenses-period-selector:hover {
            border-color: var(--forest-green);
            background: var(--bg-light);
        }
        
        .chart-area {
            height: 160px;
            position: relative;
            margin-top: 16px;
        }
        
        .week-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* Category Page */
        .category-page {
            display: none;
            background: var(--text-primary);
            min-height: 100vh;
            padding-top: 60px;
        }
        
        .category-page.active {
            display: block;
        }
        
        .category-header {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 430px;
            background: var(--text-primary);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 50;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .category-header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .category-header-left .material-icons {
            color: var(--white);
            cursor: pointer;
            font-size: 28px;
        }
        
        .category-header-title {
            color: var(--white);
            font-size: 24px;
            font-weight: 700;
        }
        
        .category-header-right {
            display: flex;
            gap: 16px;
        }
        
        .category-header-right .material-icons {
            color: var(--white);
            cursor: pointer;
            font-size: 28px;
        }
        
        .category-list {
            padding: 80px 0 100px;
        }
        
        .category-list-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px 24px;
            background: var(--text-primary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .category-list-item:active {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .category-list-icon {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }
        
        .category-list-name {
            color: var(--white);
            font-size: 18px;
            font-weight: 600;
        }
        
        /* History Page */
        .history-page {
            display: none;
            background: var(--bg-light);
            min-height: 100vh;
            padding-top: 60px;
        }
        
        .history-page.active {
            display: block;
        }
        
        .history-header {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 430px;
            background: var(--white);
            padding: 16px 24px;
            z-index: 50;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }
        
        .history-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .history-title {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
        }
        
        .sync-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #D1FAE5;
            color: var(--forest-green);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .sync-badge .material-icons {
            font-size: 16px;
            animation: pulse 2s ease infinite;
        }
        
        .filter-tabs {
            display: flex;
            gap: 12px;
        }
        
        .filter-tab {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            background: var(--bg-light);
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        
        .filter-tab.active {
            background: var(--white);
            color: var(--text-primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .history-content {
            padding: 80px 24px 100px;
        }
        
        .history-section {
            margin-bottom: 32px;
        }
        
        .history-section-title {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 16px;
        }
        
        .history-transaction {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--white);
            border-radius: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.2s ease;
        }
        
        .history-transaction:active {
            transform: scale(0.98);
        }
        
        .history-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .history-icon .material-icons {
            font-size: 28px;
        }
        
        .history-details {
            flex: 1;
        }
        
        .history-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .history-meta {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .history-amount-wrapper {
            text-align: right;
        }
        
        .history-amount {
            font-size: 17px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .history-amount.income {
            color: var(--accent-green);
        }
        
        .history-card {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .history-card.refund {
            color: var(--accent-green);
        }
        
        /* Wallet Page */
        .wallet-page {
            display: none;
            background: var(--bg-light);
            min-height: 100vh;
            padding-top: 60px;
        }
        
        .wallet-page.active {
            display: block;
        }
        
        .wallet-header {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 430px;
            background: var(--white);
            padding: 16px 24px;
            z-index: 50;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .wallet-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .wallet-header-left .material-icons {
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 28px;
        }
        
        .wallet-page-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
        }
        
        .wallet-content {
            padding: 80px 24px 100px;
        }
        
        .wallet-balance-section {
            background: var(--white);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.04);
        }
        
        .wallet-balance-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        .wallet-balance-amount {
            font-size: 36px;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -1px;
            margin-bottom: 16px;
        }
        
        .wallet-accounts {
            display: flex;
            gap: 12px;
        }
        
        .wallet-account-chip {
            padding: 8px 16px;
            background: var(--bg-light);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .wallet-account-chip.active {
            background: linear-gradient(135deg, var(--forest-green) 0%, var(--forest-green-light) 100%);
            color: var(--white);
        }
        
        .wallet-transaction-form {
            background: var(--white);
            border-radius: 20px;
            padding: 28px 24px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.04);
        }
        
        .wallet-form-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 24px;
        }
        
        /* Transactions */
        .transactions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .transactions-title {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .see-all {
            color: var(--forest-green);
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .see-all:hover {
            opacity: 0.8;
        }
        
        .transaction-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--white);
            border-radius: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s ease backwards;
        }
        
        .transaction-item:nth-child(1) { animation-delay: 0.5s; }
        .transaction-item:nth-child(2) { animation-delay: 0.6s; }
        .transaction-item:nth-child(3) { animation-delay: 0.7s; }
        
        .transaction-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }
        
        .transaction-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .transaction-icon.fuel {
            background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
        }
        
        .transaction-icon.shopping {
            background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%);
        }
        
        .transaction-icon.food {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
        }
        
        .transaction-details {
            flex: 1;
        }
        
        .transaction-name {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .transaction-meta {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .transaction-amount {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            text-align: right;
        }
        
        .transaction-amount.expense {
            color: var(--text-primary);
        }
        
        .transaction-amount.income {
            color: var(--accent-green);
        }
        
        .transaction-card {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: right;
            margin-top: 4px;
        }
        
        /* FAB Button */
        .fab {
            position: fixed;
            bottom: 80px;
            right: calc((100vw - 430px) / 2 + 24px);
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--forest-green) 0%, var(--forest-green-light) 100%);
            color: var(--white);
            border: none;
            box-shadow: 0 8px 24px rgba(5, 150, 105, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 100;
            animation: scaleIn 0.6s ease 0.8s backwards;
        }
        
        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 12px 32px rgba(5, 150, 105, 0.5);
        }
        
        .fab .material-icons {
            font-size: 32px;
        }
        
        @media (max-width: 430px) {
            .fab {
                right: 24px;
            }
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 430px;
            background: var(--white);
            border-top: 1px solid rgba(0, 0, 0, 0.06);
            display: flex;
            justify-content: space-around;
            padding: 12px 0 24px;
            box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.04);
            z-index: 99;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 8px 16px;
        }
        
        .nav-item.active {
            color: var(--forest-green);
        }
        
        .nav-item:hover {
            color: var(--forest-green);
        }
        
        .nav-item .material-icons {
            font-size: 24px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal.active {
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--white);
            width: 100%;
            max-width: 430px;
            border-radius: 24px 24px 0 0;
            padding: 32px 24px;
            animation: slideUp 0.4s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .modal-close {
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .modal-done {
            color: var(--accent-green);
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .modal-done:hover {
            opacity: 0.8;
        }
        
        /* Transaction Type Toggle */
        .type-toggle {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
        }
        
        .type-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 16px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-light);
            color: var(--text-secondary);
        }
        
        .type-btn.active {
            background: linear-gradient(135deg, var(--accent-green) 0%, #059669 100%);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .type-btn.income.active {
            background: linear-gradient(135deg, var(--forest-green) 0%, var(--forest-green-light) 100%);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }
        
        /* Amount Input */
        .amount-section {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .amount-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }
        
        .amount-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .currency {
            font-size: 24px;
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .amount-input {
            font-size: 48px;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -2px;
        }
        
        /* Category Selection */
        .category-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
        }
        
        .category-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }
        
        .category-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px 8px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-light);
        }
        
        .category-item:hover {
            transform: translateY(-2px);
        }
        
        .category-item.active {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
        }
        
        .category-icon {
            font-size: 32px;
        }
        
        .category-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* Form Fields */
        .form-field {
            margin-bottom: 20px;
        }
        
        .field-wrapper {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-light);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .field-wrapper:hover {
            background: #E2E8F0;
        }
        
        .field-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--white);
        }
        
        .field-icon .material-icons {
            color: var(--accent-green);
            font-size: 24px;
        }
        
        .field-content {
            flex: 1;
        }
        
        .field-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }
        
        .field-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .field-arrow {
            color: var(--text-secondary);
        }
        
        /* Note Input */
        .note-input {
            width: 100%;
            padding: 16px;
            border: none;
            background: var(--bg-light);
            border-radius: 16px;
            font-size: 14px;
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-primary);
            resize: none;
            transition: all 0.2s ease;
        }
        
        .note-input:focus {
            outline: none;
            background: #E2E8F0;
        }
        
        .note-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }
        
        /* Number Pad */
        .number-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .number-btn {
            aspect-ratio: 1;
            border: none;
            background: var(--bg-light);
            border-radius: 16px;
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        
        .number-btn:hover {
            background: #E2E8F0;
            transform: scale(1.05);
        }
        
        .number-btn:active {
            transform: scale(0.95);
        }
        
        .number-btn.action {
            color: var(--text-secondary);
        }
        
        .number-btn.dot {
            grid-column: 1;
        }
        
        .number-btn.zero {
            grid-column: 2;
        }
        
        /* Save Button */
        .save-btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--accent-green) 0%, #059669 100%);
            color: var(--white);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Plus Jakarta Sans', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }
        
        .save-btn:active {
            transform: translateY(0);
        }
        
        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        /* Loading State */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--bg-light);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .loading-text {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 430px) {
            .container {
                max-width: 100%;
            }
            
            .header {
                padding: 28px 18px 18px;
            }
            
            .greeting {
                font-size: 11px;
                letter-spacing: 1.5px;
            }
            
            .user-name {
                font-size: 24px;
            }
            
            .profile-icon {
                top: 28px;
                right: 18px;
                width: 38px;
                height: 38px;
            }
            
            .balance-card {
                padding: 20px;
            }
            
            .balance-label {
                font-size: 12px;
            }
            
            .balance-amount {
                font-size: 28px;
                margin-bottom: 20px;
            }
            
            .account-number {
                font-size: 11px;
            }
            
            .card-circle {
                width: 28px;
                height: 28px;
            }
            
            .gmail-sync {
                font-size: 11px;
                padding: 10px 14px;
            }
            
            .main-content {
                padding: 18px;
            }
            
            .section-title {
                font-size: 18px;
            }
            
            .expenses-card {
                padding: 18px;
                margin-bottom: 18px;
            }
            
            .expenses-info h3 {
                font-size: 10px !important;
            }
            
            .expenses-amount {
                font-size: 24px;
            }
            
            .expenses-period-selector {
                font-size: 10px !important;
                padding: 4px 8px !important;
                min-width: 90px !important;
            }
            
            .change-indicator {
                font-size: 12px;
                padding: 5px 10px;
            }
            
            /* CRITICAL PIE CHART FIX */
            .chart-container {
                width: 100% !important;
                max-width: 200px;
                height: 200px !important;
            }
            
            #pieChart {
                width: 200px !important;
                height: 200px !important;
            }
            
            .chart-center {
                width: 100px !important;
                height: 100px !important;
            }
            
            .chart-center-label {
                font-size: 10px;
            }
            
            .chart-center-value {
                font-size: 16px;
            }
            
            .legend {
                gap: 8px;
            }
            
            .legend-item {
                font-size: 11px;
            }
            
            .legend-color {
                width: 10px;
                height: 10px;
            }
            
            .view-details a {
                font-size: 13px;
            }
            
            .trends-card {
                padding: 18px;
                margin-bottom: 18px;
            }
            
            .period-selector {
                font-size: 11px;
                padding: 6px 10px;
            }
            
            .chart-area {
                height: 130px;
            }
            
            .week-labels {
                font-size: 10px;
            }
            
            .transactions-title {
                font-size: 11px;
            }
            
            .see-all {
                font-size: 12px;
            }
            
            .transaction-item {
                padding: 12px;
                gap: 12px;
                margin-bottom: 10px;
            }
            
            .transaction-icon {
                width: 44px;
                height: 44px;
            }
            
            .transaction-icon .material-icons {
                font-size: 22px;
            }
            
            .transaction-name {
                font-size: 13px;
            }
            
            .transaction-meta {
                font-size: 11px;
            }
            
            .transaction-amount {
                font-size: 14px;
            }
            
            .transaction-card {
                font-size: 10px;
            }
            
            .fab {
                right: 18px;
                width: 54px;
                height: 54px;
                bottom: 75px;
            }
            
            .fab .material-icons {
                font-size: 26px;
            }
            
            .bottom-nav {
                padding: 10px 0 18px;
            }
            
            .nav-item {
                font-size: 11px;
                gap: 3px;
                padding: 6px 10px;
            }
            
            .nav-item .material-icons {
                font-size: 22px;
            }
            
            /* Category Page Mobile */
            .category-header {
                padding: 12px 18px;
            }
            
            .category-header-title {
                font-size: 20px;
            }
            
            .category-list-item {
                padding: 16px 18px;
            }
            
            .category-list-icon {
                width: 48px;
                height: 48px;
            }
            
            .category-list-name {
                font-size: 15px;
            }
            
            /* History Page Mobile */
            .history-header {
                padding: 12px 18px;
            }
            
            .history-title {
                font-size: 24px;
            }
            
            .sync-badge {
                font-size: 10px;
                padding: 4px 8px;
            }
            
            .filter-tab {
                font-size: 13px;
                padding: 9px;
            }
            
            .history-content {
                padding: 75px 18px 100px;
            }
            
            .history-section-title {
                font-size: 11px;
            }
            
            .history-transaction {
                padding: 12px;
                margin-bottom: 10px;
            }
            
            .history-icon {
                width: 48px;
                height: 48px;
            }
            
            .history-icon .material-icons {
                font-size: 24px;
            }
            
            .history-name {
                font-size: 14px;
            }
            
            .history-meta {
                font-size: 11px;
            }
            
            .history-amount {
                font-size: 15px;
            }
            
            .history-card {
                font-size: 11px;
            }
            
            /* Wallet Page Mobile */
            .wallet-header-left .material-icons {
                font-size: 24px;
            }
            
            .wallet-page-title {
                font-size: 24px;
            }
            
            .wallet-content {
                padding: 75px 18px 100px;
            }
            
            .wallet-balance-section {
                padding: 18px;
            }
            
            .wallet-balance-label {
                font-size: 11px;
            }
            
            .wallet-balance-amount {
                font-size: 28px;
            }
            
            .wallet-account-chip {
                font-size: 11px;
            }
            
            .wallet-transaction-form {
                padding: 18px;
            }
            
            .wallet-form-title {
                font-size: 17px;
            }
            
            /* Modal Mobile */
            .modal-content {
                padding: 24px 18px;
            }
            
            .modal-title {
                font-size: 18px;
            }
            
            .type-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .amount-label {
                font-size: 11px;
            }
            
            .amount-display {
                margin-bottom: 10px;
            }
            
            .currency {
                font-size: 20px;
            }
            
            .amount-input {
                font-size: 36px;
            }
            
            .category-label {
                font-size: 11px;
            }
            
            .category-grid {
                gap: 10px;
            }
            
            .category-item {
                padding: 10px 6px;
            }
            
            .category-icon {
                font-size: 26px;
            }
            
            .category-name {
                font-size: 10px;
            }
            
            .field-wrapper {
                padding: 12px;
            }
            
            .field-icon {
                width: 42px;
                height: 42px;
            }
            
            .field-icon .material-icons {
                font-size: 22px;
            }
            
            .field-label {
                font-size: 10px;
            }
            
            .field-value {
                font-size: 14px;
            }
            
            .note-input {
                padding: 12px;
                font-size: 13px;
            }
            
            .number-pad {
                gap: 8px;
            }
            
            .number-btn {
                font-size: 20px;
            }
            
            .save-btn {
                padding: 14px;
                font-size: 14px;
            }
            
            /* Wallet Page Mobile */
            .wallet-header {
                padding: 14px 20px;
            }
            
            .wallet-page-title {
                font-size: 26px;
            }
            
            .wallet-content {
                padding: 80px 20px 100px;
            }
            
            .wallet-balance-amount {
                font-size: 32px;
            }
            
            .wallet-form-title {
                font-size: 18px;
            }
        }
        
        @media (max-width: 375px) {
            .user-name {
                font-size: 26px;
            }
            
            .balance-amount {
                font-size: 28px;
            }
            
            .section-title {
                font-size: 18px;
            }
            
            .expenses-amount {
                font-size: 26px;
            }
            
            .chart-container {
                width: 180px;
                height: 180px;
            }
            
            .legend-item {
                font-size: 11px;
            }
            
            .transaction-name {
                font-size: 13px;
            }
            
            .amount-input {
                font-size: 38px;
            }
            
            .category-grid {
                gap: 10px;
            }
            
            .category-item {
                padding: 10px 4px;
            }
            
            .category-icon {
                font-size: 24px;
            }
            
            .category-name {
                font-size: 10px;
            }
        }
        
        @media (max-width: 320px) {
            .header {
                padding: 28px 16px 16px;
            }
            
            .user-name {
                font-size: 24px;
            }
            
            .balance-amount {
                font-size: 26px;
            }
            
            .main-content {
                padding: 16px;
            }
            
            .section-title {
                font-size: 16px;
            }
            
            .expenses-amount {
                font-size: 24px;
            }
            
            .chart-container {
                width: 160px;
                height: 160px;
            }
            
            .chart-center {
                width: 80px;
                height: 80px;
            }
            
            .chart-center-value {
                font-size: 16px;
            }
            
            .legend {
                gap: 8px;
            }
            
            .legend-item {
                font-size: 10px;
            }
            
            .legend-color {
                width: 10px;
                height: 10px;
            }
            
            .transaction-item {
                padding: 12px;
                gap: 12px;
            }
            
            .transaction-icon {
                width: 40px;
                height: 40px;
            }
            
            .transaction-icon .material-icons {
                font-size: 20px;
            }
            
            .fab {
                width: 52px;
                height: 52px;
                right: 16px;
            }
            
            .fab .material-icons {
                font-size: 26px;
            }
        }
        
        /* Login Screen Styles */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, var(--forest-green) 0%, var(--forest-green-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.5s ease;
        }
        
        .login-screen.hidden {
            display: none;
        }
        
        .login-container {
            text-align: center;
            padding: 40px;
            max-width: 400px;
        }
        
        .login-logo {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            animation: scaleIn 0.6s ease;
        }
        
        .login-logo .material-icons {
            font-size: 48px;
            color: white;
        }
        
        .login-title {
            font-size: 36px;
            font-weight: 800;
            color: white;
            margin-bottom: 12px;
            animation: fadeInDown 0.6s ease 0.1s backwards;
        }
        
        .login-subtitle {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 48px;
            animation: fadeInDown 0.6s ease 0.2s backwards;
        }
        
        .google-signin-btn {
            background: white;
            color: var(--text-primary);
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            animation: scaleIn 0.6s ease 0.3s backwards;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        
        .google-signin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
        }
        
        .google-signin-btn:active {
            transform: translateY(0);
        }
        
        .google-icon {
            width: 24px;
            height: 24px;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        /* Profile Menu */
        .profile-menu {
            position: absolute;
            top: 90px;
            right: 24px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            padding: 12px;
            min-width: 200px;
            display: none;
            z-index: 100;
            animation: scaleIn 0.2s ease;
        }
        
        .profile-menu.active {
            display: block;
        }
        
        .profile-menu-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .profile-menu-item:hover {
            background: var(--bg-light);
        }
        
        .profile-menu-item .material-icons {
            font-size: 20px;
            color: var(--text-secondary);
        }
        
        .profile-menu-item.danger {
            color: var(--accent-red);
        }
        
        .profile-menu-item.danger .material-icons {
            color: var(--accent-red);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-logo">
                <span class="material-icons">account_balance_wallet</span>
            </div>
            <h1 class="login-title">SmartWallet</h1>
            <p class="login-subtitle">AI-Powered Finance Tracker with Gmail Integration</p>
            <button class="google-signin-btn" id="googleSignInBtn">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
            </button>
        </div>
    </div>
    
    <!-- Profile Menu -->
    <div class="profile-menu" id="profileMenu">
        <div class="profile-menu-item" onclick="syncGmail()">
            <span class="material-icons">sync</span>
            Sync Gmail
        </div>
        <div class="profile-menu-item" onclick="viewFirebaseData()">
            <span class="material-icons">cloud</span>
            View Cloud Data
        </div>
        <div class="profile-menu-item danger" onclick="handleSignOut()">
            <span class="material-icons">logout</span>
            Sign Out
        </div>
    </div>
    
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="greeting" id="greeting">GOOD MORNING</div>
            <h1 class="user-name" id="userName">Loading...</h1>
            <div class="profile-icon" id="profileIcon" onclick="toggleProfileMenu()">
                <img id="userPhoto" src="" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%; display: none;">
                <span class="material-icons" id="defaultProfileIcon" style="color: var(--text-secondary);">person</span>
            </div>
            
            <!-- Balance Card -->
            <div class="balance-card">
                <div class="balance-label">Total Balance</div>
                <div class="balance-amount" id="totalBalance">PHP 124,500.00</div>
                <div class="account-info">
                    <div class="account-number">
                        <small style="opacity: 0.7;">ACCOUNT NUMBER</small><br>
                        **** **** 7312
                    </div>
                    <div class="card-circles">
                        <div class="card-circle"></div>
                        <div class="card-circle"></div>
                    </div>
                </div>
                <div class="gmail-sync" id="gmailSyncContainer">
                    <div class="sync-dot" id="syncDot"></div>
                    <span id="syncText">Syncing Gmail...</span>
                    <button id="connectGmailBtn" style="display: none; background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; cursor: pointer; margin-left: auto;">Connect</button>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Expenses Structure -->
            <div class="expenses-card">
                <div class="section-header">
                    <h2 class="section-title">Expenses structure</h2>
                    <span class="material-icons more-icon">more_horiz</span>
                </div>
                
                <div class="expenses-header">
                    <div class="expenses-info">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <h3 style="margin: 0;">TOTAL EXPENSES</h3>
                            <select class="expenses-period-selector" onchange="updateExpensesPeriod(this.value)">
                                <option value="this_month">This Month</option>
                                <option value="this_week">This Week</option>
                                <option value="last_week">Last Week</option>
                                <option value="first_15">First 15 of Month</option>
                                <option value="last_15">Last 15 of Month</option>
                                <option value="last_month">Last Month</option>
                                <option value="last_3_months">Last 3 Months</option>
                                <option value="last_6_months">Last 6 Months</option>
                                <option value="this_year">This Year</option>
                            </select>
                        </div>
                        <div class="expenses-amount" id="totalExpenses">PHP 77,461.00</div>
                    </div>
                    <div class="change-indicator">+72%</div>
                </div>
                
                <!-- Pie Chart -->
                <div class="chart-container">
                    <svg id="pieChart" width="240" height="240" viewBox="0 0 240 240"></svg>
                    <div class="chart-center">
                        <div class="chart-center-label">ALL</div>
                        <div class="chart-center-value">77,461</div>
                    </div>
                </div>
                
                <!-- Legend -->
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--pie-green);"></div>
                        <span>Life & Entertainment</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--pie-dark-green);"></div>
                        <span>Investments</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--pie-blue);"></div>
                        <span>School Payment</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--pie-light-blue);"></div>
                        <span>Shopping</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--pie-red);"></div>
                        <span>Financial expenses</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--pie-purple);"></div>
                        <span>Vehicle</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--pie-orange);"></div>
                        <span>Food & Drinks</span>
                    </div>
                </div>
                
                <div class="view-details">
                    <a href="#" onclick="showDetails(); return false;">View Details</a>
                </div>
            </div>
            
            <!-- Spending Trends -->
            <div class="trends-card">
                <div class="trends-header">
                    <h2 class="section-title">Spending Trends</h2>
                    <select class="period-selector" onchange="updateTrendChart(this.value)">
                        <option value="this_month">This Month</option>
                        <option value="this_week">This Week</option>
                        <option value="last_week">Last Week</option>
                        <option value="first_15">First 15 of Month</option>
                        <option value="last_15">Last 15 of Month</option>
                        <option value="last_month">Last Month</option>
                        <option value="last_3_months">Last 3 Months</option>
                        <option value="last_6_months">Last 6 Months</option>
                        <option value="this_year">This Year</option>
                    </select>
                </div>
                
                <div class="chart-area">
                    <svg id="trendChart" width="100%" height="160"></svg>
                </div>
                
                <div class="week-labels" id="weekLabels">
                    <span>Week 1</span>
                    <span>Week 2</span>
                    <span>Week 3</span>
                    <span>Week 4</span>
                </div>

                <div id="trendSummary" style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #E2E8F0; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 13px; color: var(--text-secondary); font-weight: 500;">Period Total</div>
                    <div id="trendTotalValue" style="font-size: 18px; font-weight: 800; color: var(--forest-green);">PHP 0.00</div>
                </div>
            </div>
            
            <!-- Recent Transactions -->
            <div class="transactions-header">
                <h3 class="transactions-title">RECENT TRANSACTIONS</h3>
                <a href="#" class="see-all" onclick="showHistory(); return false;">SEE ALL</a>
            </div>
            
            <div id="transactionsList">
                <div class="transaction-item">
                    <div class="transaction-icon fuel">
                        <span class="material-icons" style="color: var(--accent-red);">local_gas_station</span>
                    </div>
                    <div class="transaction-details">
                        <div class="transaction-name">Shell Station</div>
                        <div class="transaction-meta">08 Jan  Fuel</div>
                    </div>
                    <div>
                        <div class="transaction-amount expense">- PHP 1,000</div>
                        <div class="transaction-card">Card 7312</div>
                    </div>
                </div>
                
                <div class="transaction-item">
                    <div class="transaction-icon shopping">
                        <span class="material-icons" style="color: var(--primary-blue);">shopping_bag</span>
                    </div>
                    <div class="transaction-details">
                        <div class="transaction-name">Shopee PH</div>
                        <div class="transaction-meta">08 Jan  Shopping</div>
                    </div>
                    <div>
                        <div class="transaction-amount income">+ PHP 125</div>
                        <div class="transaction-card">Refund</div>
                    </div>
                </div>
            </div>
            
            <div style="height: 100px;"></div>
        </div>
        
        <!-- FAB Button -->
        <button class="fab" onclick="showWallet()">
            <span class="material-icons">add</span>
        </button>
        
        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active">
                <span class="material-icons">home</span>
                <span>Home</span>
            </div>
            <div class="nav-item" onclick="showHistory()">
                <span class="material-icons">history</span>
                <span>History</span>
            </div>
            <div class="nav-item" onclick="showWallet()">
                <span class="material-icons">account_balance_wallet</span>
                <span>Wallet</span>
            </div>
            <div class="nav-item">
                <span class="material-icons">settings</span>
                <span>Settings</span>
            </div>
        </div>
    </div>
    
    <!-- Category Page -->
    <div class="category-page" id="categoryPage">
        <div class="category-header">
            <div class="category-header-left">
                <span class="material-icons" onclick="closeCategoryPage()">arrow_back</span>
                <h1 class="category-header-title">Category</h1>
            </div>
            <div class="category-header-right">
                <span class="material-icons">search</span>
                <span class="material-icons">settings</span>
            </div>
        </div>
        
        <div class="category-list">
            <div class="category-list-item" onclick="selectCategory('food')">
                <div class="category-list-icon" style="background: var(--pie-orange);">
                    <span style="font-size: 28px;"></span>
                </div>
                <div class="category-list-name">Food & Drinks</div>
            </div>
            
            <div class="category-list-item" onclick="selectCategory('shopping')">
                <div class="category-list-icon" style="background: #38BDF8;">
                    <span class="material-icons" style="color: white;">shopping_bag</span>
                </div>
                <div class="category-list-name">Shopping</div>
            </div>
            
            <div class="category-list-item" onclick="selectCategory('housing')">
                <div class="category-list-icon" style="background: var(--pie-orange);">
                    <span class="material-icons" style="color: white;">home</span>
                </div>
                <div class="category-list-name">Housing</div>
            </div>
            
            <div class="category-list-item" onclick="selectCategory('transportation')">
                <div class="category-list-icon" style="background: #FB923C;">
                    <span class="material-icons" style="color: white;">directions_bus</span>
                </div>
                <div class="category-list-name">Transportation</div>
            </div>
            
            <div class="category-list-item" onclick="selectCategory('vehicle')">
                <div class="category-list-icon" style="background: var(--pie-purple);">
                    <span class="material-icons" style="color: white;">directions_car</span>
                </div>
                <div class="category-list-name">Vehicle</div>
            </div>
            
            <div class="category-list-item" onclick="selectCategory('life')">
                <div class="category-list-icon" style="background: #22C55E;">
                    <span class="material-icons" style="color: white;">person</span>
                </div>
                <div class="category-list-name">Life & Entertainment</div>
            </div>
            
            <div class="category-list-item" onclick="selectCategory('communication')">
                <div class="category-list-icon" style="background: #6366F1;">
                    <span class="material-icons" style="color: white;">computer</span>
                </div>
                <div class="category-list-name">Communication, PC</div>
            </div>
            
            <div class="category-list-item" onclick="selectCategory('financial')">
                <div class="category-list-icon" style="background: var(--pie-red);">
                    <span class="material-icons" style="color: white;">account_balance</span>
                </div>
                <div class="category-list-name">Financial expenses</div>
            </div>
            
            <div class="category-list-item" onclick="selectCategory('investments')">
                <div class="category-list-icon" style="background: #059669;">
                    <span class="material-icons" style="color: white;">trending_up</span>
                </div>
                <div class="category-list-name">Investments</div>
            </div>
            
            <div class="category-list-item" onclick="selectCategory('income')">
                <div class="category-list-icon" style="background: #059669;">
                    <span class="material-icons" style="color: white;">payments</span>
                </div>
                <div class="category-list-name">Income</div>
            </div>
            
            <div class="category-list-item" onclick="selectCategory('school')">
                <div class="category-list-icon" style="background: #38BDF8;">
                    <span class="material-icons" style="color: white;">school</span>
                </div>
                <div class="category-list-name">School Payment</div>
            </div>
        </div>
    </div>
    
    <!-- History Page -->
    <div class="history-page" id="historyPage">
        <div class="history-header">
            <div class="history-header-top">
                <h1 class="history-title">History</h1>
                <div class="sync-badge">
                    <span class="material-icons">autorenew</span>
                    <span>SYNCING GMAIL</span>
                </div>
            </div>
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterHistory('card')">Card</button>
                <button class="filter-tab" onclick="filterHistory('cash')">Cash</button>
            </div>
        </div>
        
        <div class="history-content">
            <div class="history-section">
                <h3 class="history-section-title">RECENT TRANSACTIONS</h3>
                
                <div class="history-transaction">
                    <div class="history-icon" style="background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);">
                        <span class="material-icons" style="color: var(--accent-red);">local_gas_station</span>
                    </div>
                    <div class="history-details">
                        <div class="history-name">SHELL FILLWISE BOGO</div>
                        <div class="history-meta">08 Jan  10:24 AM</div>
                    </div>
                    <div class="history-amount-wrapper">
                        <div class="history-amount">1,000.00</div>
                        <div class="history-card">Card 7312</div>
                    </div>
                </div>
                
                <div class="history-transaction">
                    <div class="history-icon" style="background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%);">
                        <span class="material-icons" style="color: var(--primary-blue);">shopping_bag</span>
                    </div>
                    <div class="history-details">
                        <div class="history-name">SHOPEE PH PHL</div>
                        <div class="history-meta">08 Jan  09:12 AM</div>
                    </div>
                    <div class="history-amount-wrapper">
                        <div class="history-amount income">+125.00</div>
                        <div class="history-card refund">Refund</div>
                    </div>
                </div>
                
                <div class="history-transaction">
                    <div class="history-icon" style="background: linear-gradient(135deg, #E0E7FF 0%, #C7D2FE 100%);">
                        <span class="material-icons" style="color: #6366F1;">store</span>
                    </div>
                    <div class="history-details">
                        <div class="history-name">SHOPEE PH MANDALUYONG</div>
                        <div class="history-meta">04 Jan  04:45 PM</div>
                    </div>
                    <div class="history-amount-wrapper">
                        <div class="history-amount">247.00</div>
                        <div class="history-card">Card 7312</div>
                    </div>
                </div>
            </div>
            
            <div class="history-section">
                <h3 class="history-section-title">DECEMBER 2023</h3>
                
                <div class="history-transaction">
                    <div class="history-icon" style="background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);">
                        <span class="material-icons" style="color: #F59E0B;">shopping_cart</span>
                    </div>
                    <div class="history-details">
                        <div class="history-name">SHOPEE PH MANDALUYONG</div>
                        <div class="history-meta">02 Dec  11:30 AM</div>
                    </div>
                    <div class="history-amount-wrapper">
                        <div class="history-amount">147.00</div>
                        <div class="history-card">Card 7312</div>
                    </div>
                </div>
                
                <div class="history-transaction">
                    <div class="history-icon" style="background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);">
                        <span class="material-icons" style="color: var(--pie-orange);">restaurant</span>
                    </div>
                    <div class="history-details">
                        <div class="history-name">JOLLIBEE WORLDWIDE</div>
                        <div class="history-meta">28 Dec  01:20 PM</div>
                    </div>
                    <div class="history-amount-wrapper">
                        <div class="history-amount">580.00</div>
                        <div class="history-card">Card 7312</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- FAB for History -->
        <button class="fab" style="bottom: 80px;" onclick="showWallet()">
            <span class="material-icons">add</span>
        </button>
        
        <!-- Bottom Navigation for History -->
        <div class="bottom-nav">
            <div class="nav-item" onclick="showHome()">
                <span class="material-icons">home</span>
                <span>Summary</span>
            </div>
            <div class="nav-item active">
                <span class="material-icons">history</span>
                <span>History</span>
            </div>
            <div class="nav-item">
                <span class="material-icons">account_balance_wallet</span>
                <span>Wallet</span>
            </div>
            <div class="nav-item">
                <span class="material-icons">settings</span>
                <span>Settings</span>
            </div>
        </div>
    </div>
    
    <!-- Wallet Page -->
    <div class="wallet-page" id="walletPage">
        <div class="wallet-header">
            <div class="wallet-header-left">
                <span class="material-icons" onclick="showHome()">arrow_back</span>
                <h1 class="wallet-page-title">Wallet</h1>
            </div>
        </div>
        
        <div class="wallet-content">
            <!-- Balance Overview -->
            <div class="wallet-balance-section">
                <div class="wallet-balance-label">TOTAL BALANCE</div>
                <div class="wallet-balance-amount" id="walletBalance">PHP 124,500.00</div>
                <div class="wallet-accounts">
                    <div class="wallet-account-chip active">
                        <span class="material-icons" style="font-size: 16px;">account_balance_wallet</span>
                        <span>Bank Account</span>
                    </div>
                    <div class="wallet-account-chip">
                        <span class="material-icons" style="font-size: 16px;">credit_card</span>
                        <span>Card 7312</span>
                    </div>
                </div>
            </div>
            
            <!-- New Transaction Form -->
            <div class="wallet-transaction-form">
                <h2 class="wallet-form-title">New Transaction</h2>
                
                <div class="type-toggle">
                    <button class="type-btn active" id="walletExpenseBtn" onclick="setWalletType('expense')">Expense</button>
                    <button class="type-btn income" id="walletIncomeBtn" onclick="setWalletType('income')">Income</button>
                </div>
                
                <div class="amount-section">
                    <div class="amount-label">AMOUNT</div>
                    <div class="amount-display">
                        <span class="currency">PHP</span>
                        <span class="amount-input" id="walletAmountDisplay">0.00</span>
                    </div>
                </div>
                
                <div class="category-label">CATEGORY</div>
                <div class="category-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="category-item active" data-category="food" onclick="selectModalCategory(this)">
                        <div class="category-icon"></div>
                        <div class="category-name">Food</div>
                    </div>
                    <div class="category-item" data-category="shop" onclick="selectModalCategory(this)">
                        <div class="category-icon"></div>
                        <div class="category-name">Shop</div>
                    </div>
                    <div class="category-item" data-category="vehicle" onclick="selectModalCategory(this)">
                        <div class="category-icon"></div>
                        <div class="category-name">Vehicle</div>
                    </div>
                    <div class="category-item" data-category="life" onclick="selectModalCategory(this)">
                        <div class="category-icon"></div>
                        <div class="category-name">Life</div>
                    </div>
                    <div class="category-item" data-category="housing" onclick="selectModalCategory(this)">
                        <div class="category-icon"></div>
                        <div class="category-name">Housing</div>
                    </div>
                    <div class="category-item" data-category="transport" onclick="selectModalCategory(this)">
                        <div class="category-icon"></div>
                        <div class="category-name">Transport</div>
                    </div>
                    <div class="category-item" data-category="communication" onclick="selectModalCategory(this)">
                        <div class="category-icon"></div>
                        <div class="category-name">PC</div>
                    </div>
                    <div class="category-item" data-category="financial" onclick="selectModalCategory(this)">
                        <div class="category-icon"></div>
                        <div class="category-name">Financial</div>
                    </div>
                    <div class="category-item" data-category="investments" onclick="selectModalCategory(this)">
                        <div class="category-icon"></div>
                        <div class="category-name">Invest</div>
                    </div>
                    <div class="category-item" data-category="income" onclick="selectModalCategory(this)">
                        <div class="category-icon"></div>
                        <div class="category-name">Income</div>
                    </div>
                    <div class="category-item" data-category="school" onclick="selectModalCategory(this)">
                        <div class="category-icon"></div>
                        <div class="category-name">School</div>
                    </div>
                    <div class="category-item" data-category="more" onclick="showCategoryPage()">
                        <div class="category-icon"></div>
                        <div class="category-name">More</div>
                    </div>
                </div>
                
                <div class="form-field">
                    <div class="field-wrapper">
                        <div class="field-icon">
                            <span class="material-icons">event</span>
                        </div>
                        <div class="field-content">
                            <div class="field-label">DATE</div>
                            <div class="field-value" id="walletDateValue">Today, Jan 15</div>
                        </div>
                        <span class="material-icons field-arrow">chevron_right</span>
                    </div>
                </div>
                
                <div class="form-field">
                    <div class="field-wrapper">
                        <div class="field-icon">
                            <span class="material-icons">account_balance_wallet</span>
                        </div>
                        <div class="field-content">
                            <div class="field-label">ACCOUNT</div>
                            <div class="field-value">Bank Account</div>
                        </div>
                        <span class="material-icons field-arrow">chevron_right</span>
                    </div>
                </div>
                
                <div class="form-field">
                    <div class="field-wrapper" style="cursor: text;">
                        <div class="field-icon">
                            <span class="material-icons">notes</span>
                        </div>
                        <div class="field-content" style="flex: 1;">
                            <textarea class="note-input" id="walletNoteInput" placeholder="Add description..." rows="2"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="number-pad">
                    <button class="number-btn" onclick="addWalletNumber('1')">1</button>
                    <button class="number-btn" onclick="addWalletNumber('2')">2</button>
                    <button class="number-btn" onclick="addWalletNumber('3')">3</button>
                    <button class="number-btn" onclick="addWalletNumber('4')">4</button>
                    <button class="number-btn" onclick="addWalletNumber('5')">5</button>
                    <button class="number-btn" onclick="addWalletNumber('6')">6</button>
                    <button class="number-btn" onclick="addWalletNumber('7')">7</button>
                    <button class="number-btn" onclick="addWalletNumber('8')">8</button>
                    <button class="number-btn" onclick="addWalletNumber('9')">9</button>
                    <button class="number-btn dot" onclick="addWalletNumber('.')">.</button>
                    <button class="number-btn zero" onclick="addWalletNumber('0')">0</button>
                    <button class="number-btn action" onclick="deleteWalletNumber()"></button>
                </div>
                
                <button class="save-btn" onclick="saveWalletTransaction()">
                    <span class="material-icons">check</span>
                    <span>Save</span>
                </button>
            </div>
        </div>
        
        <!-- Bottom Navigation for Wallet -->
        <div class="bottom-nav">
            <div class="nav-item" onclick="showHome()">
                <span class="material-icons">home</span>
                <span>Summary</span>
            </div>
            <div class="nav-item" onclick="showHistory()">
                <span class="material-icons">history</span>
                <span>History</span>
            </div>
            <div class="nav-item active">
                <span class="material-icons">account_balance_wallet</span>
                <span>Wallet</span>
            </div>
            <div class="nav-item">
                <span class="material-icons">settings</span>
                <span>Settings</span>
            </div>
        </div>
    </div>
    
    <!-- Transaction Modal -->
    <div class="modal" id="transactionModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="material-icons modal-close" onclick="closeModal()">close</span>
                <h2 class="modal-title">New Transaction</h2>
                <span class="modal-done" onclick="saveTransaction()">Done</span>
            </div>
            
            <div class="type-toggle">
                <button class="type-btn active" id="expenseBtn" onclick="setType('expense')">Expense</button>
                <button class="type-btn income" id="incomeBtn" onclick="setType('income')">Income</button>
            </div>
            
            <div class="amount-section">
                <div class="amount-label">AMOUNT</div>
                <div class="amount-display">
                    <span class="currency">PHP</span>
                    <span class="amount-input" id="amountDisplay">720.00</span>
                </div>
            </div>
            
            <div class="category-label">CATEGORY</div>
            <div class="category-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="category-item active" data-category="food" onclick="selectModalCategory(this)">
                    <div class="category-icon"></div>
                    <div class="category-name">Food</div>
                </div>
                <div class="category-item" data-category="shop" onclick="selectModalCategory(this)">
                    <div class="category-icon"></div>
                    <div class="category-name">Shop</div>
                </div>
                <div class="category-item" data-category="vehicle" onclick="selectModalCategory(this)">
                    <div class="category-icon"></div>
                    <div class="category-name">Vehicle</div>
                </div>
                <div class="category-item" data-category="life" onclick="selectModalCategory(this)">
                    <div class="category-icon"></div>
                    <div class="category-name">Life</div>
                </div>
                <div class="category-item" data-category="housing" onclick="selectModalCategory(this)">
                    <div class="category-icon"></div>
                    <div class="category-name">Housing</div>
                </div>
                <div class="category-item" data-category="transport" onclick="selectModalCategory(this)">
                    <div class="category-icon"></div>
                    <div class="category-name">Transport</div>
                </div>
                <div class="category-item" data-category="communication" onclick="selectModalCategory(this)">
                    <div class="category-icon"></div>
                    <div class="category-name">PC</div>
                </div>
                <div class="category-item" data-category="financial" onclick="selectModalCategory(this)">
                    <div class="category-icon"></div>
                    <div class="category-name">Financial</div>
                </div>
                <div class="category-item" data-category="investments" onclick="selectModalCategory(this)">
                    <div class="category-icon"></div>
                    <div class="category-name">Invest</div>
                </div>
                <div class="category-item" data-category="income" onclick="selectModalCategory(this)">
                    <div class="category-icon"></div>
                    <div class="category-name">Income</div>
                </div>
                <div class="category-item" data-category="school" onclick="selectModalCategory(this)">
                    <div class="category-icon"></div>
                    <div class="category-name">School</div>
                </div>
                <div class="category-item" data-category="more" onclick="showCategoryPage()">
                    <div class="category-icon"></div>
                    <div class="category-name">More</div>
                </div>
            </div>
            
            <div class="form-field">
                <div class="field-wrapper">
                    <div class="field-icon">
                        <span class="material-icons">event</span>
                    </div>
                    <div class="field-content">
                        <div class="field-label">DATE</div>
                        <div class="field-value" id="dateValue">Today, Jan 15</div>
                    </div>
                    <span class="material-icons field-arrow">chevron_right</span>
                </div>
            </div>
            
            <div class="form-field">
                <div class="field-wrapper">
                    <div class="field-icon">
                        <span class="material-icons">account_balance_wallet</span>
                    </div>
                    <div class="field-content">
                        <div class="field-label">ACCOUNT</div>
                        <div class="field-value">Bank Account</div>
                    </div>
                    <span class="material-icons field-arrow">chevron_right</span>
                </div>
            </div>
            
            <div class="form-field">
                <div class="field-wrapper" style="cursor: text;">
                    <div class="field-icon">
                        <span class="material-icons">notes</span>
                    </div>
                    <div class="field-content" style="flex: 1;">
                        <textarea class="note-input" placeholder="Add description..." rows="2"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="number-pad">
                <button class="number-btn" onclick="addNumber('1')">1</button>
                <button class="number-btn" onclick="addNumber('2')">2</button>
                <button class="number-btn" onclick="addNumber('3')">3</button>
                <button class="number-btn" onclick="addNumber('4')">4</button>
                <button class="number-btn" onclick="addNumber('5')">5</button>
                <button class="number-btn" onclick="addNumber('6')">6</button>
                <button class="number-btn" onclick="addNumber('7')">7</button>
                <button class="number-btn" onclick="addNumber('8')">8</button>
                <button class="number-btn" onclick="addNumber('9')">9</button>
                <button class="number-btn dot" onclick="addNumber('.')">.</button>
                <button class="number-btn zero" onclick="addNumber('0')">0</button>
                <button class="number-btn action" onclick="deleteNumber()"></button>
            </div>
            
            <button class="save-btn" onclick="saveTransaction()">
                <span class="material-icons">check</span>
                <span>Save</span>
            </button>
        </div>
    </div>
    
    <script type="module">
        // Transaction state
        let transactions = JSON.parse(localStorage.getItem('wallet_transactions')) || [
            { id: 'initial-1', name: 'Shell Station', date: '08 Jan', category: 'Fuel', amount: -1000, type: 'expense' },
            { id: 'initial-2', name: 'Shopee PH', date: '08 Jan', category: 'Shopping', amount: 125, type: 'income', refund: true }
        ];
        let currentAmount = '0.00';
        let currentType = 'expense';
        let walletAmount = '0.00';
        let walletType = 'expense';
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof renderTransactions === 'function') {
                renderTransactions();
                updateTotals();
                drawPieChart();
                drawTrendChart();
                updateGreeting();
            }
        });

        let saveToLocalStorage = function() {
            localStorage.setItem('wallet_transactions', JSON.stringify(transactions));
        }
        
        // Greeting based on time - will be overridden by Firebase version
        function updateGreeting() {
            const hour = new Date().getHours();
            let greeting = 'GOOD MORNING';
            if (hour >= 12 && hour < 18) greeting = 'GOOD AFTERNOON';
            if (hour >= 18) greeting = 'GOOD EVENING';
            const greetingEl = document.querySelector('.greeting') || document.getElementById('greeting');
            if (greetingEl) greetingEl.textContent = greeting;
        }
        
        // Gmail Sync Simulation
        function simulateGmailSync() {
            setTimeout(() => {
                const syncEl = document.querySelector('.gmail-sync span');
                syncEl.textContent = 'Gmail synced  2 new transactions';
                
                // Add fetched transactions
                setTimeout(() => {
                    addTransactionFromGmail('Jollibee Worldwide', '28 Dec', 'Food & Drinks', -580);
                    addTransactionFromGmail('Shell Fillwise BOGO', '08 Jan', 'Fuel', -1000);
                }, 1000);
            }, 3000);
        }
        
        function addTransactionFromGmail(name, date, category, amount, gmailId) {
            // Check for duplicates
            if (transactions.some(t => t.gmailId === gmailId)) return;

            transactions.push({ 
                id: 'gmail-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                gmailId,
                name, 
                date, 
                category, 
                amount, 
                type: amount > 0 ? 'income' : 'expense', 
                fromGmail: true 
            });
            saveToLocalStorage();
            renderTransactions();
            updateTotals();
        }
        
        // Pie Chart
        function drawPieChart() {
            const data = [
                { value: 35, color: 'var(--pie-green)', label: 'Life & Entertainment' },
                { value: 25, color: 'var(--pie-dark-green)', label: 'Investments' },
                { value: 15, color: 'var(--pie-blue)', label: 'School Payment' },
                { value: 10, color: 'var(--pie-light-blue)', label: 'Shopping' },
                { value: 7, color: 'var(--pie-red)', label: 'Financial' },
                { value: 5, color: 'var(--pie-purple)', label: 'Vehicle' },
                { value: 3, color: 'var(--pie-orange)', label: 'Food' }
            ];
            
            const svg = document.getElementById('pieChart');
            const centerX = 120;
            const centerY = 120;
            const radius = 100;
            
            let currentAngle = -90;
            
            data.forEach(segment => {
                const angle = (segment.value / 100) * 360;
                const endAngle = currentAngle + angle;
                
                const x1 = centerX + radius * Math.cos((currentAngle * Math.PI) / 180);
                const y1 = centerY + radius * Math.sin((currentAngle * Math.PI) / 180);
                const x2 = centerX + radius * Math.cos((endAngle * Math.PI) / 180);
                const y2 = centerY + radius * Math.sin((endAngle * Math.PI) / 180);
                
                const largeArc = angle > 180 ? 1 : 0;
                
                const pathData = [
                    `M ${centerX} ${centerY}`,
                    `L ${x1} ${y1}`,
                    `A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2}`,
                    'Z'
                ].join(' ');
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', pathData);
                path.setAttribute('fill', segment.color);
                path.setAttribute('stroke', '#fff');
                path.setAttribute('stroke-width', '2');
                
                svg.appendChild(path);
                
                currentAngle = endAngle;
            });
        }
        
        // Trend Chart
        function drawTrendChart() {
            updateTrendChart('this_month');
        }
        
        function updateExpensesPeriod(period) {
            // Different expense amounts for different periods
            const expenseData = {
                'this_week': { amount: 12500, change: '+15%' },
                'last_week': { amount: 18200, change: '+24%' },
                'this_month': { amount: 77461, change: '+72%' },
                'first_15': { amount: 38000, change: '+45%' },
                'last_15': { amount: 39461, change: '+68%' },
                'last_month': { amount: 68000, change: '+58%' },
                'last_3_months': { amount: 196461, change: '+82%' },
                'last_6_months': { amount: 382461, change: '+95%' },
                'this_year': { amount: 77461, change: '+72%' }
            };
            
            const data = expenseData[period] || expenseData['this_month'];
            document.getElementById('totalExpenses').textContent = 
                `PHP ${data.amount.toLocaleString('en-PH', { minimumFractionDigits: 2 })}`;
            
            const indicator = document.querySelector('.expenses-header .change-indicator');
            indicator.textContent = data.change;
        }
        
        function updateTrendChart(period) {
            const svg = document.getElementById('trendChart');
            const labelsContainer = document.getElementById('weekLabels');
            
            // Clear existing chart
            svg.innerHTML = '';
            
            const width = svg.clientWidth;
            const height = 160;
            const padding = 20;
            
            // Different data sets for different periods
            let data = [];
            let labels = [];
            
            switch(period) {
                case 'this_week':
                    data = [
                        { amount: 2000 },
                        { amount: 3500 },
                        { amount: 1800 },
                        { amount: 4200 },
                        { amount: 3000 },
                        { amount: 5500 },
                        { amount: 4800 }
                    ];
                    labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                    break;
                    
                case 'last_week':
                    data = [
                        { amount: 1500 },
                        { amount: 2800 },
                        { amount: 3200 },
                        { amount: 2500 },
                        { amount: 4000 },
                        { amount: 3800 },
                        { amount: 5200 }
                    ];
                    labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                    break;
                    
                case 'first_15':
                    data = [
                        { amount: 8000 },
                        { amount: 12000 },
                        { amount: 15000 },
                        { amount: 18000 },
                        { amount: 22000 }
                    ];
                    labels = ['1-3', '4-6', '7-9', '10-12', '13-15'];
                    break;
                    
                case 'last_15':
                    data = [
                        { amount: 14000 },
                        { amount: 18000 },
                        { amount: 21000 },
                        { amount: 19000 },
                        { amount: 25000 }
                    ];
                    labels = ['16-18', '19-21', '22-24', '25-27', '28-31'];
                    break;
                    
                case 'last_6_months':
                    data = [
                        { amount: 55000 },
                        { amount: 62000 },
                        { amount: 58000 },
                        { amount: 71000 },
                        { amount: 68000 },
                        { amount: 77461 }
                    ];
                    labels = ['Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan'];
                    break;
                    
                case 'last_month':
                    data = [
                        { amount: 12000 },
                        { amount: 16000 },
                        { amount: 18000 },
                        { amount: 15000 }
                    ];
                    labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
                    break;
                    
                case 'last_3_months':
                    data = [
                        { amount: 58000 },
                        { amount: 71000 },
                        { amount: 68000 },
                        { amount: 77461 }
                    ];
                    labels = ['Oct', 'Nov', 'Dec', 'Jan'];
                    break;
                    
                case 'this_year':
                    data = [
                        { amount: 77461 }
                    ];
                    labels = ['Jan'];
                    break;
                    
                default: // this_month
                    data = [
                        { amount: 15000 },
                        { amount: 18000 },
                        { amount: 22000 },
                        { amount: 19000 },
                        { amount: 25000 }
                    ];
                    labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5'];
            }
            
            // Update labels
            labelsContainer.innerHTML = labels.map(label => `<span>${label}</span>`).join('');
            
            const maxAmount = Math.max(...data.map(d => d.amount));
            const stepX = (width - padding * 2) / Math.max(data.length - 1, 1);
            
            // Create gradient
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
            gradient.setAttribute('id', 'areaGradient');
            gradient.setAttribute('x1', '0%');
            gradient.setAttribute('y1', '0%');
            gradient.setAttribute('x2', '0%');
            gradient.setAttribute('y2', '100%');
            
            const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop1.setAttribute('offset', '0%');
            stop1.setAttribute('style', 'stop-color:#059669;stop-opacity:0.2');
            
            const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop2.setAttribute('offset', '100%');
            stop2.setAttribute('style', 'stop-color:#059669;stop-opacity:0');
            
            gradient.appendChild(stop1);
            gradient.appendChild(stop2);
            defs.appendChild(gradient);
            svg.appendChild(defs);
            
            // Create smooth curve path for area using cubic bezier
            let areaPath = `M ${padding} ${height}`;
            
            if (data.length === 1) {
                // Single point - just draw a simple shape
                const x = width / 2;
                const y = height - padding - ((data[0].amount / maxAmount) * (height - padding * 2));
                areaPath += ` L ${x} ${y} L ${x} ${height} Z`;
            } else {
                // Add first point
                const y0 = height - padding - ((data[0].amount / maxAmount) * (height - padding * 2));
                areaPath += ` L ${padding} ${y0}`;
                
                // Create smooth curve through points
                for (let i = 0; i < data.length - 1; i++) {
                    const x1 = padding + i * stepX;
                    const y1 = height - padding - ((data[i].amount / maxAmount) * (height - padding * 2));
                    const x2 = padding + (i + 1) * stepX;
                    const y2 = height - padding - ((data[i + 1].amount / maxAmount) * (height - padding * 2));
                    
                    // Control points for smooth curve
                    const cx1 = x1 + stepX * 0.5;
                    const cy1 = y1;
                    const cx2 = x2 - stepX * 0.5;
                    const cy2 = y2;
                    
                    areaPath += ` C ${cx1} ${cy1}, ${cx2} ${cy2}, ${x2} ${y2}`;
                }
                
                areaPath += ` L ${padding + (data.length - 1) * stepX} ${height} Z`;
            }
            
            const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            area.setAttribute('d', areaPath);
            area.setAttribute('fill', 'url(#areaGradient)');
            svg.appendChild(area);
            
            // Create smooth line path
            let linePath = '';
            
            if (data.length === 1) {
                // Single point - just draw a horizontal line
                const x = width / 2;
                const y = height - padding - ((data[0].amount / maxAmount) * (height - padding * 2));
                linePath = `M ${padding} ${y} L ${width - padding} ${y}`;
            } else {
                for (let i = 0; i < data.length; i++) {
                    const x = padding + i * stepX;
                    const y = height - padding - ((data[i].amount / maxAmount) * (height - padding * 2));
                    
                    if (i === 0) {
                        linePath += `M ${x} ${y}`;
                    } else {
                        const prevX = padding + (i - 1) * stepX;
                        const prevY = height - padding - ((data[i - 1].amount / maxAmount) * (height - padding * 2));
                        
                        // Control points for smooth curve
                        const cx1 = prevX + stepX * 0.5;
                        const cy1 = prevY;
                        const cx2 = x - stepX * 0.5;
                        const cy2 = y;
                        
                        linePath += ` C ${cx1} ${cy1}, ${cx2} ${cy2}, ${x} ${y}`;
                    }
                }
            }
            
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            line.setAttribute('d', linePath);
            line.setAttribute('stroke', '#059669');
            line.setAttribute('stroke-width', '3');
            line.setAttribute('fill', 'none');
            line.setAttribute('stroke-linecap', 'round');
            line.setAttribute('stroke-linejoin', 'round');
            svg.appendChild(line);

            // Update Total Value Display
            const total = data.reduce((sum, d) => sum + d.amount, 0);
            document.getElementById('trendTotalValue').textContent = `PHP ${total.toLocaleString('en-PH', { minimumFractionDigits: 2 })}`;
        }
        
        // Modal Functions
        function openModal() {
            document.getElementById('transactionModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('transactionModal').classList.remove('active');
        }
        
        function setType(type) {
            currentType = type;
            document.getElementById('expenseBtn').classList.toggle('active', type === 'expense');
            document.getElementById('incomeBtn').classList.toggle('active', type === 'income');
        }
        
        // Category Selection
        function selectModalCategory(element) {
            document.querySelectorAll('.category-item').forEach(i => i.classList.remove('active'));
            element.classList.add('active');
        }
        
        // Number Pad
        function addNumber(num) {
            if (currentAmount === '0.00') currentAmount = '';
            if (num === '.' && currentAmount.includes('.')) return;
            currentAmount += num;
            updateAmountDisplay();
        }
        
        function deleteNumber() {
            currentAmount = currentAmount.slice(0, -1);
            if (currentAmount === '' || currentAmount === '.') currentAmount = '0.00';
            updateAmountDisplay();
        }
        
        function updateAmountDisplay() {
            document.getElementById('amountDisplay').textContent = currentAmount;
        }
        
        // Save Transaction
        function saveTransaction() {
            const amount = parseFloat(currentAmount);
            if (amount === 0 || isNaN(amount)) {
                alert('Please enter a valid amount');
                return;
            }
            const categoryElement = document.querySelector('#transactionModal .category-item.active');
            const category = categoryElement ? categoryElement.dataset.category : 'more';
            const note = document.querySelector('#transactionModal .note-input').value;
            
            const transaction = {
                id: 'man-' + Date.now(),
                name: note || getCategoryName(category),
                date: 'Today',
                category: category,
                amount: currentType === 'expense' ? -amount : amount,
                type: currentType
            };
            
            transactions.unshift(transaction);
            saveToLocalStorage();
            renderTransactions();
            updateTotals();
            closeModal();
            resetModal();
        }
        
        function getCategoryName(category) {
            const names = {
                food: 'Food & Drinks',
                shop: 'Shopping',
                vehicle: 'Vehicle',
                life: 'Life & Entertainment'
            };
            return names[category] || 'Transaction';
        }
        
        function resetModal() {
            currentAmount = '0.00';
            updateAmountDisplay();
            document.querySelector('.note-input').value = '';
        }
        
        // Render Transactions
        function renderTransactions() {
            const list = document.getElementById('transactionsList');
            list.innerHTML = '';
            
            transactions.slice(0, 3).forEach(t => {
                const item = document.createElement('div');
                item.className = 'transaction-item';
                
                const iconBg = getIconBackground(t.category);
                const icon = getIcon(t.category);
                
                item.innerHTML = `
                    <div class="transaction-icon ${iconBg}">
                        <span class="material-icons" style="color: ${getIconColor(t.category)};">${icon}</span>
                    </div>
                    <div class="transaction-details">
                        <div class="transaction-name">${t.name}</div>
                        <div class="transaction-meta">${t.date}  ${t.category}</div>
                    </div>
                    <div>
                        <div class="transaction-amount ${t.type}">
                            ${t.amount > 0 ? '+' : ''} PHP ${Math.abs(t.amount).toLocaleString()}
                        </div>
                        <div class="transaction-card">${t.refund ? 'Refund' : 'Card 7312'}</div>
                    </div>
                `;
                
                list.appendChild(item);
            });
        }
        
        function getIconBackground(category) {
            const map = {
                'Fuel': 'fuel',
                'Shopping': 'shopping',
                'Food & Drinks': 'food',
                'food': 'food',
                'shop': 'shopping',
                'vehicle': 'fuel'
            };
            return map[category] || 'shopping';
        }
        
        function getIcon(category) {
            const map = {
                'Fuel': 'local_gas_station',
                'Shopping': 'shopping_bag',
                'Food & Drinks': 'restaurant',
                'food': 'restaurant',
                'shop': 'shopping_bag',
                'vehicle': 'local_gas_station',
                'life': 'celebration'
            };
            return map[category] || 'attach_money';
        }
        
        function getIconColor(category) {
            const map = {
                'Fuel': 'var(--accent-red)',
                'Shopping': 'var(--primary-blue)',
                'Food & Drinks': 'var(--accent-orange)',
                'food': 'var(--accent-orange)',
                'shop': 'var(--primary-blue)',
                'vehicle': 'var(--accent-red)',
                'life': 'var(--pie-purple)'
            };
            return map[category] || 'var(--primary-blue)';
        }
        
        // Update Totals
        function updateTotals() {
            const totalExpenses = transactions
                .filter(t => t.amount < 0)
                .reduce((sum, t) => sum + Math.abs(t.amount), 0);
            
            const totalIncome = transactions
                .filter(t => t.amount > 0)
                .reduce((sum, t) => sum + t.amount, 0);
            
            const balance = 124500 + totalIncome - totalExpenses;
            
            document.getElementById('totalExpenses').textContent = `PHP ${totalExpenses.toLocaleString('en-PH', { minimumFractionDigits: 2 })}`;
            document.getElementById('totalBalance').textContent = `PHP ${balance.toLocaleString('en-PH', { minimumFractionDigits: 2 })}`;
        }
        
        // Navigation
        function showHistory() {
            document.querySelector('.container').style.display = 'none';
            document.getElementById('categoryPage').classList.remove('active');
            document.getElementById('historyPage').classList.add('active');
            document.getElementById('walletPage').classList.remove('active');
        }
        
        function showHome() {
            document.querySelector('.container').style.display = 'block';
            document.getElementById('categoryPage').classList.remove('active');
            document.getElementById('historyPage').classList.remove('active');
            document.getElementById('walletPage').classList.remove('active');
        }
        
        function showWallet() {
            document.querySelector('.container').style.display = 'none';
            document.getElementById('categoryPage').classList.remove('active');
            document.getElementById('historyPage').classList.remove('active');
            document.getElementById('walletPage').classList.add('active');
            
            // Update wallet balance
            const balance = document.getElementById('totalBalance').textContent;
            document.getElementById('walletBalance').textContent = balance;
        }
        
        function showCategoryPage() {
            document.querySelector('.container').style.display = 'none';
            document.getElementById('historyPage').classList.remove('active');
            document.getElementById('walletPage').classList.remove('active');
            document.getElementById('categoryPage').classList.add('active');
        }
        
        function closeCategoryPage() {
            showHome();
        }
        
        function selectCategory(category) {
            console.log('Selected category:', category);
            closeCategoryPage();
            showWallet();
        }
        
        function filterHistory(type) {
            const tabs = document.querySelectorAll('.filter-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            console.log('Filtering by:', type);
        }
        
        function showDetails() {
            alert('Detailed expense breakdown would be shown here');
        }
        
        // Wallet Page Functions
        function setWalletType(type) {
            walletType = type;
            document.getElementById('walletExpenseBtn').classList.toggle('active', type === 'expense');
            document.getElementById('walletIncomeBtn').classList.toggle('active', type === 'income');
        }
        
        function addWalletNumber(num) {
            if (walletAmount === '0.00') walletAmount = '';
            if (num === '.' && walletAmount.includes('.')) return;
            walletAmount += num;
            updateWalletAmountDisplay();
        }
        
        function deleteWalletNumber() {
            walletAmount = walletAmount.slice(0, -1);
            if (walletAmount === '' || walletAmount === '.') walletAmount = '0.00';
            updateWalletAmountDisplay();
        }
        
        function updateWalletAmountDisplay() {
            document.getElementById('walletAmountDisplay').textContent = walletAmount;
        }
        
        function saveWalletTransaction() {
            const amount = parseFloat(walletAmount);
            if (amount === 0 || isNaN(amount)) {
                alert('Please enter a valid amount');
                return;
            }
            
            const categoryElement = document.querySelector('.wallet-transaction-form .category-item.active');
            const category = categoryElement ? categoryElement.dataset.category : 'more';
            const note = document.getElementById('walletNoteInput').value;
            
            const transaction = {
                id: 'man-' + Date.now(),
                name: note || getCategoryName(category),
                date: 'Today',
                category: category,
                amount: walletType === 'expense' ? -amount : amount,
                type: walletType
            };
            
            transactions.unshift(transaction);
            saveToLocalStorage();
            renderTransactions();
            updateTotals();
            
            // Reset form
            walletAmount = '0.00';
            updateWalletAmountDisplay();
            document.getElementById('walletNoteInput').value = '';
            
            // Show success and go to home
            alert('Transaction saved successfully!');
            showHome();
        }
        
        // Close modal on outside click
        document.getElementById('transactionModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        // ============================================
        // FIREBASE AUTHENTICATION & GMAIL INTEGRATION
        // ============================================
        
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, doc, setDoc, updateDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, doc, setDoc, updateDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBHDN0xLi98qjYYjUf2RDCn5gJK0dzTk_M",
            authDomain: "atome-wallet.firebaseapp.com",
            projectId: "atome-wallet",
            storageBucket: "atome-wallet.firebasestorage.app",
            messagingSenderId: "64186651619",
            appId: "1:64186651619:web:cd7d426cfb663aab6606d6",
            measurementId: "G-2SHWJ6S3Z3"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Global variables
        let currentUser = { uid: 'guest-user', displayName: 'My Wallet', email: 'guest@local' };
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;

        // Custom Logger
        function logToConsole(message, type = 'info') {
            const consoleEl = document.getElementById('debugLogContent');
            const logEntry = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            
            let color = '#00ff00';
            if (type === 'error') color = '#ff0000';
            if (type === 'warn') color = '#ffff00';
            
            logEntry.style.color = color;
            logEntry.style.marginBottom = '2px';
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            if (consoleEl) {
                consoleEl.appendChild(logEntry);
                // Auto scroll to bottom
                const container = document.getElementById('debugConsole');
                container.scrollTop = container.scrollHeight;
            }
            
            // Also log to regular console
            if (type === 'error') console.error(message);
            else console.log(message);
        }

        // Show console by default for diagnosis
        document.getElementById('debugConsole').style.display = 'block';
        logToConsole('Application initialized. Waiting for actions...');
        
        // Environment Check
        logToConsole('Environment: ' + window.location.protocol + '//' + window.location.host);
        if (window.location.protocol === 'file:') {
            logToConsole('CRITICAL ERROR: Google Sign-In requires a web server (http://localhost). It will NOT work from a file.', 'error');
            alert(' YOU ARE RUNNING FROM A FILE!\n\nGoogle Features will NOT work unless you run this on a local server.\n\nI can help you start one.');
        } else if (window.location.hostname === '127.0.0.1') {
            logToConsole('CRITICAL ERROR: Google Auth forbids "127.0.0.1". Redirecting to "localhost"...', 'error');
            alert(' WRONG ADDRESS Detected\n\nGoogle blocks "127.0.0.1".\n\nRedirecting you to "localhost" which is authorized...');
            window.location.hostname = 'localhost';
        }
        
        // Gmail API Configuration
        const GMAIL_DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest';
        const GMAIL_SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';
        
        // Initialize GAPI (Gmail API)
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: firebaseConfig.apiKey,
                discoveryDocs: [GMAIL_DISCOVERY_DOC],
            });
            gapiInited = true;
            console.log('Gmail API initialized');
        }
        
        // Initialize GIS (Google Identity Services)
        function gisLoaded() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: '64186651619-3eb9ki680f4c8q2g2mese3c8hhfur23b.apps.googleusercontent.com',
                    scope: GMAIL_SCOPES,
                    callback: '', // defined dynamically
                });
                gisInited = true;
                logToConsole('GIS initialized successfully');
            } catch (err) {
                logToConsole('Error initializing GIS: ' + err.message, 'error');
            }
        }
        
        // Load Gmail API when page loads
        window.addEventListener('load', () => {
            logToConsole('Window loaded, checking Google scripts...');
            
            // Check GAPI
            if (typeof gapi !== 'undefined') {
                gapiLoaded();
            } else {
                logToConsole('GAPI not found immediately', 'warn');
                // Retry checking
                setTimeout(() => {
                    if (typeof gapi !== 'undefined') gapiLoaded();
                    else logToConsole('GAPI still not found after 1s', 'error');
                }, 1000);
            }
            
            // Check GIS
            if (typeof google !== 'undefined' && google.accounts) {
                gisLoaded();
            } else {
                logToConsole('Google Accounts not found immediately', 'warn');
                 // Retry checking
                setTimeout(() => {
                     if (typeof google !== 'undefined' && google.accounts) gisLoaded();
                     else logToConsole('Google Accounts still not found after 1s', 'error');
                }, 1000);
            }
        });
        
        // Emergency Popup Trigger
        window.emergencyPopup = function() {
            logToConsole('>>> FORCE POPUP CLICKED <<<');
            if (tokenClient) {
                logToConsole('Requesting Token via Force Button...');
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                logToConsole('TokenClient is missing! Re-initializing...', 'warn');
                gisLoaded();
                if (tokenClient) {
                     tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                     alert('CRITICAL: Google Scripts not loaded. Please check your internet connection.');
                }
            }
        };

        // Authentication State Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                console.log('User detected:', user.isAnonymous ? 'Guest' : user.email);
                
                // Update UI Header
                if (document.getElementById('userName')) {
                    document.getElementById('userName').textContent = user.displayName || (user.isAnonymous ? 'Guest User' : 'Standard User');
                }
                updateGreeting();
                
                // Profile Pic
                if (user.photoURL && document.getElementById('userPhoto')) {
                    document.getElementById('userPhoto').src = user.photoURL;
                    document.getElementById('userPhoto').style.display = 'block';
                    if (document.getElementById('defaultProfileIcon')) document.getElementById('defaultProfileIcon').style.display = 'none';
                }

                // Isolation: Load Data
                await loadTransactionsFromFirestore();
                
                // Sync Status Label
                updateSyncStatus(user.isAnonymous ? 'Local Mode (Unsynced)' : `Cloud Synced (${user.email})`, !user.isAnonymous);
            } else {
                signInAnonymously(auth);
            }
        });
        
        // Check for redirect result on page load
        async function checkRedirectResult() {
            try {
                logToConsole('Checking for redirect result...');
                const result = await getRedirectResult(auth);
                
                if (result) {
                    logToConsole(`Redirect sign-in successful! User: ${result.user.email}`);
                    
                    // Access the credential to get the access token
                    const credential = GoogleAuthProvider.credentialFromResult(result);
                    const token = credential.accessToken;
                    
                    logToConsole(`Access Token received: ${token ? 'YES' : 'NO'}`);
                    
                    // Save user to Firestore
                    await saveUserToFirestore(result.user);
                    
                    alert('Successfully signed in via Redirect!');
                } else {
                    logToConsole('No redirect result found (Normal page load)');
                }
            } catch (error) {
                logToConsole(`Redirect Error: ${error.message}`, 'error');
                logToConsole(`Error Code: ${error.code}`, 'error');
                
                if (error.code === 'auth/unauthorized-domain') {
                    alert('DOMAIN ERROR: This domain is not authorized in Firebase Console.\nPlease add "localhost" to Authentication > Settings > Authorized Domains.');
                }
            }
        }
        
        // Call it immediately
        checkRedirectResult();

        // Google Sign In with Popup + Sync
        document.getElementById('googleSignInBtn').addEventListener('click', async () => {
            logToConsole('>>> Starting Popup Sign-In... <<<');
            const prevUid = auth.currentUser?.uid;
            const isAnonymous = auth.currentUser?.isAnonymous;

            try {
                const provider = new GoogleAuthProvider();
                provider.addScope('https://www.googleapis.com/auth/gmail.readonly');
                
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                logToConsole(`Success! Logged in as: ${user.email}`);

                // MIGRATION / SYNC ENGINE
                logToConsole('Checking if guest data needs to be claimed...');
                const sources = [];
                if (isAnonymous && prevUid) sources.push(prevUid);
                sources.push('guest-user');

                let totalMigrated = 0;
                for (const sourceId of sources) {
                    if (sourceId === user.uid) continue;
                    const oldSnap = await getDocs(query(collection(db, "users", sourceId, "transactions")));
                    if (!oldSnap.empty) {
                        logToConsole(`Merging ${oldSnap.size} items from ${sourceId === 'guest-user' ? 'Legacy' : 'Local'}...`);
                        const batch = [];
                        oldSnap.forEach(d => {
                            batch.push(setDoc(doc(db, "users", user.uid, "transactions", d.id), d.data(), { merge: true }));
                        });
                        await Promise.all(batch);
                        totalMigrated += oldSnap.size;
                    }
                }
                
                if (totalMigrated > 0) {
                    alert(`Successfully synced ${totalMigrated} items to your Google Account!`);
                } else {
                    logToConsole('Cloud account already unified.');
                }

                // Close login screen if it was visible
                const loginScreen = document.getElementById('loginScreen');
                if (loginScreen) loginScreen.classList.add('hidden');

            } catch (error) {
                logToConsole(`Sign In Error: ${error.message}`, 'error');
                alert(`Error: ${error.message}`);
            }
        });
        
        // Sign Out
        async function handleSignOut() {
            try {
                await signOut(auth);
                console.log('Sign out successful');
                toggleProfileMenu();
            } catch (error) {
                console.error('Sign out error:', error);
                alert('Sign out failed: ' + error.message);
            }
        }
        
        // Toggle Profile Menu
        function toggleProfileMenu() {
            const menu = document.getElementById('profileMenu');
            menu.classList.toggle('active');
        }
        
        // Close profile menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('profileMenu');
            const profileIcon = document.getElementById('profileIcon');
            if (!menu.contains(e.target) && !profileIcon.contains(e.target)) {
                menu.classList.remove('active');
            }
        });
        
        // Update greeting based on time
        function updateGreeting() {
            const hour = new Date().getHours();
            const greetingEl = document.getElementById('greeting');
            
            if (hour < 12) {
                greetingEl.textContent = 'GOOD MORNING';
            } else if (hour < 18) {
                greetingEl.textContent = 'GOOD AFTERNOON';
            } else {
                greetingEl.textContent = 'GOOD EVENING';
            }
        }
        
        // ============================================
        // FIRESTORE DATABASE FUNCTIONS
        // ============================================
        
        // Save user to Firestore
        async function saveUserToFirestore(user) {
            if (user.uid === 'guest-user') return; // Skip for guest
            try {
                const userRef = doc(db, 'users', user.uid);
                await setDoc(userRef, {
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    createdAt: serverTimestamp(),
                    lastSync: serverTimestamp()
                }, { merge: true });
                console.log('User saved to Firestore');
            } catch (error) {
                console.error('Error saving user:', error);
            }
        }
        
        // Load transactions from Firestore
        async function loadTransactionsFromFirestore() {
            if (!currentUser) return;
            const isAnon = currentUser.isAnonymous;
            
            try {
                const transactionsRef = collection(db, 'users', currentUser.uid, 'transactions');
                const q = query(transactionsRef, orderBy('date', 'desc')); // Match index.html field name
                let querySnapshot = await getDocs(q);
                
                // Legacy fallback ONLY for guests
                if (querySnapshot.empty && isAnon) {
                    const legacyQ = query(collection(db, 'users', 'guest-user', 'transactions'), orderBy('date', 'desc'));
                    querySnapshot = await getDocs(legacyQ);
                    if (!querySnapshot.empty) console.log('Loaded from legacy guest-user storage');
                }
                
                const firestoreTransactions = [];
                querySnapshot.forEach((doc) => {
                    firestoreTransactions.push({ id: doc.id, ...doc.data() });
                });
                
                console.log(`Loaded ${firestoreTransactions.length} transactions from Firestore`);
                
                // Clear local and add fresh from Firestore
                transactions.length = 0; 
                firestoreTransactions.forEach(ft => transactions.push(ft));
                
                // Re-render
                renderTransactions();
                updateTotals();
                
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }
        
        // Save transaction to Firestore
        async function saveTransactionToFirestore(transaction) {
            if (!currentUser) return;
            try {
                const transactionsRef = collection(db, 'users', currentUser.uid, 'transactions');
                await setDoc(doc(transactionsRef, transaction.id), {
                    ...transaction,
                    timestamp: serverTimestamp()
                }, { merge: true });
                console.log('Saved to Cloud:', transaction.id);
            } catch (error) {
                console.error('Error saving transaction:', error);
            }
        }
        
        // Override saveToLocalStorage to also save to Firestore
        const originalSaveToLocalStorage = saveToLocalStorage;
        saveToLocalStorage = async function() {
            originalSaveToLocalStorage();
            
            // Save latest transaction to Firestore
            if (currentUser && currentUser.uid !== 'guest-user' && transactions.length > 0) {
                const latestTransaction = transactions[0];
                await saveTransactionToFirestore(latestTransaction);
            }
        };
        
        // ============================================
        // GMAIL API INTEGRATION
        // ============================================
        
        // Sync Gmail
        async function syncGmail() {
            toggleProfileMenu();
            document.getElementById('debugConsole').style.display = 'block';
            logToConsole('>>> Sync Gmail Clicked <<<');
            
            updateSyncStatus('Syncing Gmail...', true, true);
            
            try {
                // Double check initialization
                if (!tokenClient) {
                    logToConsole('TokenClient was undefined, trying to init now...', 'warn');
                    if (typeof google !== 'undefined' && google.accounts) {
                        gisLoaded();
                    }
                    if (!tokenClient) {
                         throw new Error('Google Identity Services not loaded. Please refresh the page.');
                    }
                }
                
                // Set the callback dynamically
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        logToConsole('GIS Callback Error: ' + JSON.stringify(resp), 'error');
                        throw (resp);
                    }
                    
                    logToConsole('Permissions granted! Access Token received.');
                    // Search for transaction emails
                    await searchTransactionEmails();
                };
                
                logToConsole('Requesting Access Token (Popup should appear)...');
                
                if (gapi.client.getToken() === null) {
                    // Prompt the user to select a Google Account and ask for consent
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    // Skip display of account chooser and consent dialog
                    tokenClient.requestAccessToken({prompt: ''});
                }
                
            } catch (error) {
                logToConsole('Gmail sync error: ' + error.message, 'error');
                console.error('Gmail sync error:', error);
                updateSyncStatus('Sync failed', false);
                alert('Gmail sync failed: ' + error.message);
            }
        }
        
        // Search for transaction emails
        async function searchTransactionEmails() {
            try {
                // Search for emails with transaction keywords
                const queries = [
                    'subject:(transaction OR payment OR purchase OR atome)',
                    'from:(atome OR bank OR payment)',
                ];
                
                let allMessages = [];
                
                for (const searchQuery of queries) {
                    const response = await gapi.client.gmail.users.messages.list({
                        'userId': 'me',
                        'q': searchQuery,
                        'maxResults': 20
                    });
                    
                    if (response.result.messages) {
                        allMessages = allMessages.concat(response.result.messages);
                    }
                }
                
                console.log('Found emails:', allMessages.length);
                
                // Remove duplicates
                const uniqueMessages = Array.from(new Set(allMessages.map(m => m.id)))
                    .map(id => allMessages.find(m => m.id === id));
                
                // Process each email
                let newTransactionsCount = 0;
                for (const message of uniqueMessages) {
                    const extracted = await extractTransactionFromEmail(message.id);
                    if (extracted) {
                        newTransactionsCount++;
                    }
                }
                
                updateSyncStatus(`Synced ${newTransactionsCount} new transactions`, true);
                
                // Update UI
                renderTransactions();
                updateTotals();
                
                // Update last sync time in Firestore
                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, {
                    lastSync: serverTimestamp()
                });
                
                alert(`Gmail sync complete! Found ${newTransactionsCount} new transactions.`);
                
            } catch (error) {
                console.error('Error searching emails:', error);
                updateSyncStatus('Sync failed', false);
                throw error;
            }
        }
        
        // Extract transaction from email
        async function extractTransactionFromEmail(messageId) {
            try {
                const response = await gapi.client.gmail.users.messages.get({
                    'userId': 'me',
                    'id': messageId,
                    'format': 'full'
                });
                
                const message = response.result;
                const headers = message.payload.headers;
                
                // Get subject and sender
                const subject = headers.find(h => h.name === 'Subject')?.value || '';
                const from = headers.find(h => h.name === 'From')?.value || '';
                const date = headers.find(h => h.name === 'Date')?.value || '';
                
                // Get email body
                let body = '';
                if (message.payload.body.data) {
                    body = atob(message.payload.body.data.replace(/-/g, '+').replace(/_/g, '/'));
                } else if (message.payload.parts) {
                    const textPart = message.payload.parts.find(p => p.mimeType === 'text/plain' || p.mimeType === 'text/html');
                    if (textPart && textPart.body.data) {
                        body = atob(textPart.body.data.replace(/-/g, '+').replace(/_/g, '/'));
                    }
                }
                
                // Extract transaction details
                const transaction = parseTransactionFromEmail(subject, body, from, date, messageId);
                
                if (transaction) {
                    // Check if already exists
                    const exists = transactions.find(t => t.emailId === messageId);
                    if (!exists) {
                        transactions.unshift(transaction);
                        await saveTransactionToFirestore(transaction);
                        console.log('Extracted transaction:', transaction);
                        return true;
                    }
                }
                
                return false;
                
            } catch (error) {
                console.error('Error extracting transaction:', error);
                return false;
            }
        }
        
        // Parse transaction details from email content
        function parseTransactionFromEmail(subject, body, from, dateStr, emailId) {
            // Extract amount (look for PHP, $, or number patterns)
            const amountPatterns = [
                /PHP\s*([\d,]+\.?\d*)/i,
                /\s*([\d,]+\.?\d*)/i,
                /\$\s*([\d,]+\.?\d*)/i,
                /amount[:\s]+([\d,]+\.?\d*)/i,
                /total[:\s]+([\d,]+\.?\d*)/i,
            ];
            
            let amount = 0;
            for (const pattern of amountPatterns) {
                const match = (subject + ' ' + body).match(pattern);
                if (match) {
                    amount = parseFloat(match[1].replace(/,/g, ''));
                    break;
                }
            }
            
            if (amount === 0) return null; // No valid amount found
            
            // Extract merchant name
            let merchantName = 'Transaction';
            const merchantPatterns = [
                /merchant[:\s]+([^\n]+)/i,
                /at\s+([A-Z][a-zA-Z\s]+)/,
                /from\s+([A-Z][a-zA-Z\s]+)/,
            ];
            
            for (const pattern of merchantPatterns) {
                const match = (subject + ' ' + body).match(pattern);
                if (match) {
                    merchantName = match[1].trim().substring(0, 50);
                    break;
                }
            }
            
            // Categorize based on keywords
            const category = categorizeTransaction(subject + ' ' + body + ' ' + merchantName);
            
            // Parse date
            const transactionDate = new Date(dateStr);
            const dateString = transactionDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            
            return {
                id: 'gmail-' + emailId,
                name: merchantName,
                amount: -amount, // Negative for expense
                category: category,
                date: dateString,
                type: 'expense',
                source: 'gmail',
                emailId: emailId,
                timestamp: transactionDate.getTime()
            };
        }
        
        // Categorize transaction based on keywords
        function categorizeTransaction(text) {
            const textLower = text.toLowerCase();
            
            // Shopping keywords
            const shoppingKeywords = ['mall', 'supermetro', 'gaisano', 'shopee', 'lazada', 'tiktok shop', 'mr diy', 'store', 'shop'];
            if (shoppingKeywords.some(kw => textLower.includes(kw))) {
                return 'Shopping';
            }
            
            // Fuel keywords
            const fuelKeywords = ['tecfuel', 'shell', 'petron', 'seaoil', 'ptt', 'caltex', 'gas', 'fuel'];
            if (fuelKeywords.some(kw => textLower.includes(kw))) {
                return 'Fuel';
            }
            
            // Food keywords
            const foodKeywords = ['jollibee', 'mcdo', 'mcdonald', 'restaurant', 'food', 'cafe', 'coffee', 'starbucks'];
            if (foodKeywords.some(kw => textLower.includes(kw))) {
                return 'Food & Drinks';
            }
            
            // Service keywords
            const serviceKeywords = ['globe', 'smart', 'pldt', 'tm', 'bill', 'subscription', 'netflix', 'spotify'];
            if (serviceKeywords.some(kw => textLower.includes(kw))) {
                return 'service';
            }
            
            return 'more'; // Default category
        }
        
        // Update sync status UI
        function updateSyncStatus(message, isActive, isAnimating = false) {
            const syncText = document.getElementById('syncText');
            const syncDot = document.getElementById('syncDot');
            
            syncText.textContent = message;
            
            if (isAnimating) {
                syncDot.style.animation = 'pulse 2s ease infinite';
            } else {
                syncDot.style.animation = isActive ? 'pulse 2s ease infinite' : 'none';
            }
        }
        
        // View Firebase Data (open Firebase Console)
        function viewFirebaseData() {
            toggleProfileMenu();
            window.open('https://console.firebase.google.com/project/atome-wallet/firestore', '_blank');
        }
        
        // Make functions globally accessible (Required for modules)
        // Make functions globally accessible (Required for modules)
        window.renderTransactions = renderTransactions;
        window.updateTotals = updateTotals;
        window.drawPieChart = drawPieChart;
        window.drawTrendChart = drawTrendChart;
        window.showHistory = showHistory;
        window.showHome = showHome;
        window.showWallet = showWallet;
        window.showCategoryPage = showCategoryPage;
        window.selectCategory = selectCategory;
        window.filterHistory = filterHistory;
        window.showDetails = showDetails;
        window.addNumber = addNumber;
        window.deleteNumber = deleteNumber;
        window.saveTransaction = saveTransaction;
        window.setWalletType = setWalletType;
        window.addWalletNumber = addWalletNumber;
        window.deleteWalletNumber = deleteWalletNumber;
        window.saveWalletTransaction = saveWalletTransaction;
        window.closeModal = closeModal;
        window.syncGmail = syncGmail;
        window.handleSignOut = handleSignOut;
        window.toggleProfileMenu = toggleProfileMenu;
        window.viewFirebaseData = viewFirebaseData;
        window.simulateGmailSync = simulateGmailSync;

        console.log('SmartWallet module fully loaded and listeners attached');
        console.log('Current user:', auth.currentUser ? auth.currentUser.email : 'None');
    </script>
    <!-- Debug Console -->
    <div id="debugConsole" style="
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 200px;
        background: rgba(0, 0, 0, 0.9);
        color: #00ff00;
        font-family: monospace;
        font-size: 12px;
        padding: 10px;
        overflow-y: auto;
        z-index: 9999;
        display: none;
        border-top: 2px solid #00ff00;
    ">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 5px;">
            <strong>DEBUG CONSOLE (Fixing Auth Issues)</strong>
            <button onclick="document.getElementById('debugConsole').style.display = 'none'" style="background:none; border:none; color:white; cursor:pointer;">[X] Close</button>
        </div>
        <div id="debugLogContent"></div>
        <div style="margin-top: 10px; border-top: 1px solid #333; padding-top: 5px;">
            <button onclick="emergencyPopup()" style="background: #ff0000; color: white; border: 1px solid white; padding: 5px;"> FORCE GOOGLE POPUP</button>
            <button onclick="window.location.reload()" style="background: #333; color: white; border: 1px solid white; padding: 5px;">Reload App</button>
        </div>
    </div>

    <button onclick="document.getElementById('debugConsole').style.display = 'block'" style="
        position: fixed; 
        bottom: 10px; 
        right: 10px; 
        z-index: 9998; 
        background: #000; 
        color: #fff; 
        border: 1px solid #fff; 
        padding: 5px 10px; 
        font-size: 10px; 
        opacity: 0.5;
    ">Show Debug Log</button>

</body>
</html>